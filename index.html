<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
  />
  <title>GET THE $BAG — Dice</title>

  <!-- SEO -->
  <meta name="description" content="Utility on Chain. Culture on Brand. XRPL’s heaviest meme. Official $BAG token. 1T supply. Powered by XRP.">
  <meta name="keywords" content="BAG,$BAG,XRPL,XRP Ledger,crypto,meme coin,BAG token,getthebag.io">

  <!-- Open Graph / Twitter -->
  <meta property="og:title" content="GET THE $BAG — Dice">
  <meta property="og:description" content="Roll it. Risk it. Double it. Play with XRP or $BAG.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://getthebag.io/">
  <meta property="og:site_name" content="$BAG">
  <meta property="og:image" content="https://getthebag.io/assets/logo.png">
  <meta name="twitter:card" content="summary_large_image">

  <link rel="icon" href="/assets/favicon.png">
  <link rel="manifest" href="/assets/site.webmanifest">

  <style>
    :root {
      --bg:#0b0b0c; --fg:#e8e8ea; --muted:#a2a6ad; --accent:#20df5c;
      --card:#141418; --edge:#1c1c21; --warn:#ffcc00; --danger:#ff5a5a;
    }
    * { box-sizing:border-box; }
    html,body { height:100%; }
    body {
      margin:0; background:var(--bg); color:var(--fg);
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .wrap { max-width:980px; margin:0 auto; padding:24px; }
    header { padding:8px 0 16px; }
    h1 {
      margin:0 0 8px; font-size:28px; font-weight:700; letter-spacing:.2px;
      display:flex; align-items:center; gap:10px;
    }
    .brand { display:inline-flex; align-items:center; gap:10px; }
    .brand img { width:36px; height:36px; display:block; }
    .sub { color:var(--muted); font-size:14px; margin-top:2px; }

    /* PRACTICE banner: centered, line break under the title */
    .practice-banner {
      display:none; text-align:center; margin:10px auto 16px; padding:10px 14px;
      border:1px dashed var(--warn); color:var(--warn); border-radius:10px;
      background:rgba(255,204,0,.06); max-width:560px; line-height:1.2;
      font-weight:700;
    }
    .practice-banner small { display:block; margin-top:6px; font-weight:600; opacity:.85; }

    .row { display:flex; gap:16px; flex-wrap:wrap; }
    .card {
      background:linear-gradient(180deg, var(--card), #0f0f12);
      border:1px solid var(--edge); border-radius:14px; padding:16px;
      box-shadow:0 6px 20px rgba(0,0,0,.26);
    }
    .card.half { flex:1 1 420px; }
    .card.full { flex:1 1 100%; }

    .controls { display:flex; flex-wrap:wrap; gap:10px; }
    button, .pill {
      appearance:none; border:none; border-radius:12px; padding:10px 14px;
      background:#1b1f24; color:#eaecef; border:1px solid #2a2f36;
      font-weight:700; cursor:pointer; transition:.18s;
    }
    button:hover { transform:translateY(-1px); }
    button.accent { background:var(--accent); color:#04130a; border-color:#1a7f3b; }
    button.warn { background:#2b2505; color:#ffd84a; border-color:#4d3e07; }
    button.ghost { background:transparent; }
    button[disabled] { opacity:.45; cursor:not-allowed; transform:none; }
    .kvs { display:grid; grid-template-columns: 1fr 1fr; gap:8px; font-size:14px; }
    .kv { background:#0f0f13; border:1px solid #1b1b21; border-radius:10px; padding:10px; }
    .kv b { display:block; color:#b8bcc4; font-weight:600; margin-bottom:4px; }
    .kv span { font-weight:700; }

    .dice-box { display:flex; gap:14px; align-items:center; justify-content:center; min-height:120px; }
    .payouts { color:var(--muted); font-size:13px; margin-top:8px; }
    .status { margin-top:10px; font-size:13px; color:#b4bac4; }
    .ok { color:#52ffa1; }
    .bad { color:var(--danger); }

    .toggle-line { display:flex; align-items:center; justify-content:space-between; gap:12px; margin:10px 0 0; }
    .switch { display:inline-flex; align-items:center; gap:8px; }
    .switch input { width:42px; height:24px; accent-color:var(--accent); }

    .balances { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .chip { background:#101014; border:1px solid #1b1b21; border-radius:999px; padding:6px 10px; font-size:13px; }
    .muted { color:var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 class="brand">
        <img src="/assets/logo.png" alt="$BAG">
        <span>$BAG Dice — Pass Line</span>
      </h1>

      <!-- Centered banner w/ line break (only shows in Practice) -->
      <div id="practiceBanner" class="practice-banner">
        PRACTICE MODE
        <small>Demo rolls — no wallet required</small>
      </div>

      <div class="toggle-line">
        <div class="sub">Roll it. Risk it. Double it.</div>

        <!-- Optional Practice toggle (persists in localStorage) -->
        <label class="switch">
          <input id="practiceToggle" type="checkbox" />
          <span>Practice</span>
        </label>
      </div>
    </header>

    <section class="row">
      <div class="card half">
        <h3 style="margin:0 0 10px;">Wallet & Session</h3>
        <div class="controls" style="margin-bottom:10px;">
          <button id="btnConnect">Connect</button>
          <button id="btnStart" class="accent">Start Session</button>
          <button id="btnTopUp">Top-Up</button>
          <button id="btnEnd" class="ghost">End</button>
        </div>
        <div class="balances">
          <div class="chip">Addr: <span id="addr" class="muted">—</span></div>
          <div class="chip">Live Bal: <span id="liveBal" class="muted">—</span></div>
          <div class="chip" id="demoBalWrap" style="display:none;">Demo Bal: <span id="demoBal">1,000.00</span></div>
        </div>
        <div class="kvs" style="margin-top:10px;">
          <div class="kv"><b>XRP Price</b><span id="pxXrp">—</span></div>
          <div class="kv"><b>$BAG Price (AMM)</b><span id="pxBag">—</span></div>
        </div>
        <div class="status" id="gateMsg">Status: <span class="bad">Live mode requires Connect → Start Session</span></div>
      </div>

      <div class="card half">
        <h3 style="margin:0 0 10px;">Dice</h3>
        <div class="dice-box">
          <div id="die1" class="pill">—</div>
          <div id="die2" class="pill">—</div>
          <div id="sum" class="pill">Total: —</div>
        </div>

        <div class="controls" style="justify-content:center; margin-top:10px;">
          <input id="stake" type="number" min="1" step="1" value="5" style="width:120px; background:#0d0d10; color:#e8e8ea; border:1px solid #1f1f25; border-radius:10px; padding:10px;" />
          <select id="currency" style="background:#0d0d10; color:#e8e8ea; border:1px solid #1f1f25; border-radius:10px; padding:10px;">
            <option value="XRP">XRP</option>
            <option value="BAG">$BAG</option>
          </select>
          <button id="btnRoll" class="accent" disabled>Roll</button>
        </div>

        <div class="payouts">
          Payouts preview: Point <b>1.00×</b> • Normal <b>1.25×</b> • Jackpot <b>2.00×</b>
        </div>
        <div class="status">Result: <span id="result">—</span></div>
      </div>

      <div class="card full">
        <h3 style="margin:0 0 10px;">Notes</h3>
        <div class="sub">
          • Live mode resolves on server authority. • Practice mode resolves locally for instant demo rolls. • Min bet $1.
        </div>
      </div>
    </section>
  </div>

  <!-- Audio & SW -->
  <audio id="sfx" preload="auto">
    <source src="/assets/roll.wav" type="audio/wav">
  </audio>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/assets/sw.js').catch(()=>{});
    }
  </script>

  <!-- Xaman SDK (keep included; actual flows wired below) -->
  <script src="https://xumm.app/assets/cdn/xumm.min.js" defer></script>

  <script>
    // -------------------
    // Constants & State
    // -------------------
    const LS_KEY = 'bag_practice_v1';
    const ENABLE_PRACTICE_TOGGLE = true; // optional toggle visible
    const url = new URL(location.href);
    const qDemo = url.searchParams.get('demo') === '1';

    let state = {
      practice: false,
      connected: false,
      sessionActive: false,
      address: null,
      demoBalance: 1000.00, // shown only in Practice
    };

    // -------------------
    // Elements
    // -------------------
    const elPracticeToggle = document.getElementById('practiceToggle');
    const elPracticeBanner = document.getElementById('practiceBanner');
    const elBtnConnect = document.getElementById('btnConnect');
    const elBtnStart = document.getElementById('btnStart');
    const elBtnTopUp = document.getElementById('btnTopUp');
    const elBtnEnd = document.getElementById('btnEnd');
    const elBtnRoll = document.getElementById('btnRoll');
    const elStake = document.getElementById('stake');
    const elCurrency = document.getElementById('currency');
    const elAddr = document.getElementById('addr');
    const elLiveBal = document.getElementById('liveBal');
    const elDemoWrap = document.getElementById('demoBalWrap');
    const elDemoBal = document.getElementById('demoBal');
    const elGateMsg = document.getElementById('gateMsg');
    const elDie1 = document.getElementById('die1');
    const elDie2 = document.getElementById('die2');
    const elSum = document.getElementById('sum');
    const elResult = document.getElementById('result');
    const elPxXrp = document.getElementById('pxXrp');
    const elPxBag = document.getElementById('pxBag');
    const sfx = document.getElementById('sfx');

    // -------------------
    // Practice Mode init
    // -------------------
    function loadPractice() {
      // precedence: ?demo=1 → ON; else localStorage; default OFF
      if (qDemo) return true;
      const saved = localStorage.getItem(LS_KEY);
      return saved === '1';
    }

    function setPractice(on) {
      state.practice = !!on;
      localStorage.setItem(LS_KEY, state.practice ? '1' : '0');

      // UI flips
      elPracticeBanner.style.display = state.practice ? 'block' : 'none';
      elDemoWrap.style.display = state.practice ? 'inline-flex' : 'none';
      elPracticeToggle.checked = !!state.practice;

      if (state.practice) {
        // Enable instant rolling, ignore wallet/session gates
        elBtnRoll.disabled = false;
        elGateMsg.innerHTML = 'Status: <span class="ok">Practice — instant demo rolls</span>';
      } else {
        // Require Connect → Start
        elBtnRoll.disabled = !(state.connected && state.sessionActive);
        elGateMsg.innerHTML = 'Status: <span class="bad">Live mode requires Connect → Start Session</span>';
      }
    }

    // -------------------
    // Wallet / Session (stubs wired to your server later)
    // -------------------
    async function connectWallet() {
      // Wire to Xaman/Xumm if desired; keep simple placeholder for now
      // On success:
      state.connected = true;
      state.address = state.address || 'r•••yourAddress';
      elAddr.textContent = state.address;
      if (!state.practice) elBtnRoll.disabled = !state.sessionActive;
    }

    async function startSession() {
      // POST /api/session/start — verify deposit → credit server balance
      // On success:
      state.sessionActive = true;
      elLiveBal.textContent = 'On-ledger';
      if (!state.practice) elBtnRoll.disabled = !(!state.practice && state.connected && state.sessionActive) ? true : false;
      // after session: re-check gate
      if (!state.practice && state.connected && state.sessionActive) {
        elGateMsg.innerHTML = 'Status: <span class="ok">Live — session active</span>';
        elBtnRoll.disabled = false;
      }
    }

    async function topUp() {
      // POST /api/session/topup
      // no-op for frontend stub
    }

    async function endSession() {
      // POST /api/session/end
      state.sessionActive = false;
      if (!state.practice) {
        elBtnRoll.disabled = true;
        elGateMsg.innerHTML = 'Status: <span class="bad">Live mode requires Connect → Start Session</span>';
      }
    }

    // -------------------
    // Pricing
    // -------------------
    async function fetchXrpUsd() {
      try {
        const r = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=ripple&vs_currencies=usd', { cache:'no-store' });
        const j = await r.json();
        if (j && j.ripple && j.ripple.usd) {
          elPxXrp.textContent = `$${(+j.ripple.usd).toFixed(4)} USD`;
        } else { elPxXrp.textContent = 'N/A'; }
      } catch { elPxXrp.textContent = 'N/A'; }
    }

    // Your locked config: first try XRPL AMM price (BAG/XRP). If unavailable, fall back to cached API.
    async function fetchBagPrice() {
      try {
        // Prefer your API which already follows: AMM first, then cache
        const r = await fetch('https://api.getthebag.io/info', { cache:'no-store' });
        const j = await r.json();
        // Expecting something like { prices: { bag_per_xrp: ..., xrp_usd: ... } } — adjust if needed
        if (j && j.prices && j.prices.bag_per_xrp && j.prices.xrp_usd) {
          const bag_per_xrp = +j.prices.bag_per_xrp;
          const xrp_usd = +j.prices.xrp_usd;
          const bag_usd = (xrp_usd / bag_per_xrp);
          elPxBag.textContent = `$${bag_usd.toFixed(8)} USD`;
          return;
        }
      } catch {}
      // Fallback text
      elPxBag.textContent = 'From AMM/cache: N/A';
    }

    // -------------------
    // Dice (frontend preview logic only in Practice)
    // -------------------
    function randDie() { return (Math.random()*6|0)+1; }

    function classify(sum) {
      // Simple preview classifier:
      // 7 or 11 => Jackpot (2.00×)
      // 2, 3, 12 => Point (1.00×)  [you can rename if desired]
      // else => Normal (1.25×)
      if (sum === 7 || sum === 11) return { kind:'Jackpot', mult:2.00 };
      if (sum === 2 || sum === 3 || sum === 12) return { kind:'Point', mult:1.00 };
      return { kind:'Normal', mult:1.25 };
    }

    function format(n) { return Number(n).toLocaleString(undefined, { minimumFractionDigits:2, maximumFractionDigits:2 }); }

    function applyDemoPayout(kind, mult, stake, currency) {
      // Only touches demo balance in Practice
      const delta = (mult - 1.00) * stake;
      if (mult >= 1.00) state.demoBalance += delta;
      else state.demoBalance -= (1.00 - mult) * stake; // (not used by current table)
      elDemoBal.textContent = format(state.demoBalance);
      return delta;
    }

    function showRoll(d1, d2, sum, cls, stake, currency) {
      elDie1.textContent = d1;
      elDie2.textContent = d2;
      elSum.textContent = `Total: ${sum}`;
      const label = `${cls.kind} — ${cls.mult.toFixed(2)}×`;
      elResult.textContent = `${label} on ${stake} ${currency}`;
    }

    async function doRoll() {
      const stake = Math.max(1, Math.floor(+elStake.value || 1));
      elStake.value = String(stake);
      const currency = elCurrency.value;

      if (!state.practice) {
        // Live: defer to server
        // POST /api/roll { address, stake, currency } → returns { d1,d2,sum,kind,mult,newBalance }
        // For now, just gate:
        if (!(state.connected && state.sessionActive)) return;
        elResult.textContent = 'Rolling… (server-authoritative)';
        // TODO: integrate real roll endpoint
        return;
      }

      // Practice: local preview
      const d1 = randDie(), d2 = randDie(), sum = d1 + d2;
      const cls = classify(sum);
      try { sfx.currentTime = 0; sfx.play().catch(()=>{}); } catch {}
      showRoll(d1, d2, sum, cls, stake, currency);
      applyDemoPayout(cls.kind, cls.mult, stake, currency);
    }

    // -------------------
    // Wire up
    // -------------------
    (function init() {
      // Toggle visibility control
      document.querySelector('.switch').style.display = ENABLE_PRACTICE_TOGGLE ? 'inline-flex' : 'none';

      // Init practice state
      setPractice(loadPractice());

      // Query param ?demo=1 implies ON, but allow user to switch back
      elPracticeToggle.addEventListener('change', (e)=> setPractice(e.target.checked));

      // Wallet buttons
      elBtnConnect.addEventListener('click', connectWallet);
      elBtnStart.addEventListener('click', startSession);
      elBtnTopUp.addEventListener('click', topUp);
      elBtnEnd.addEventListener('click', endSession);

      // Roll
      elBtnRoll.addEventListener('click', doRoll);

      // Prices
      fetchXrpUsd();
      fetchBagPrice();
      // Refresh occasionally
      setInterval(fetchXrpUsd, 60_000);
      setInterval(fetchBagPrice, 60_000);
    })();
  </script>
</body>
</html>
