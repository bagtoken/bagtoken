<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>GET THE $BAG — Test</title>

<!-- Social/SEO minimal -->
<meta name="description" content="Utility on Chain. Culture on Brand. XRPL’s heaviest meme.">
<meta property="og:title" content="$BAG — Test">
<meta property="og:image" content="/assets/favicon-512x512.png">

<!-- Icons (ABSOLUTE) -->
<link rel="icon" href="/assets/favicon.ico" type="image/x-icon">
<link rel="icon" type="image/png" sizes="16x16"   href="/assets/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32"   href="/assets/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="48x48"   href="/assets/favicon-48x48.png">
<link rel="icon" type="image/png" sizes="64x64"   href="/assets/favicon-64x64.png">
<link rel="icon" type="image/png" sizes="128x128" href="/assets/favicon-128x128.png">
<link rel="icon" type="image/png" sizes="180x180" href="/assets/favicon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192" href="/assets/favicon-192x192.png">
<link rel="icon" type="image/png" sizes="256x256" href="/assets/favicon-256x256.png">
<link rel="icon" type="image/png" sizes="512x512" href="/assets/favicon-512x512.png">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon-180x180.png">

<!-- Manifest with ABSOLUTE icon paths (fixes /assets/assets) -->
<link rel="manifest" href="/assets/site.webmanifest?v=test-audio-guard-1">

<!-- Theme -->
<meta name="theme-color" content="#0c1a12">
<meta name="mobile-web-app-capable" content="yes">

<!-- Preload the ONLY good audio -->
<link rel="preload" href="/assets/sounds/casinomusic.mp3?v=guard1" as="audio">

<style>
  :root{--gold:#ffd700;--bg:#020703;--fg:#f5f7f4;--muted:#aeb7af}
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  h1{margin:16px 0}
  .banner{margin:24px auto;text-align:center}
  .banner img{width:100%;max-width:960px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.45)}
  #guardLog{position:fixed;left:0;right:0;bottom:0;background:#3b0a0a;color:#fff;padding:8px 12px;
    font:12px/1.4 ui-monospace,Menlo,Consolas,monospace;z-index:99999;border-top:2px solid #b33}
  #guardLog b{color:#ffd7d7}
  #guardLog small{opacity:.8}
  .muted{color:var(--muted)}
</style>

<!-- AUDIO & NETWORK GUARD — runs before anything else -->
<script>
(function(){
  const LEGACY = 'here-come-the-money.mp3';
  const GOOD   = '/assets/sounds/casinomusic.mp3?v=guard1';

  // UI log strip
  const guardBar = document.createElement('div');
  guardBar.id = 'guardLog';
  guardBar.textContent = 'Audio Guard active. Waiting…';
  document.documentElement.appendChild(guardBar);
  const log = (msg) => guardBar.innerHTML = msg;

  const stamp = () => new Date().toLocaleTimeString();

  // Utility: stack trace text
  function stackText(){
    try { throw new Error('trace'); } catch(e){ return (e.stack||'').split('\n').slice(2).join('\n'); }
  }

  // Block fetch/XHR of legacy file
  const isLegacyUrl = (u) => u && (''+u).includes(LEGACY);

  const _fetch = window.fetch;
  window.fetch = function(input, init){
    try{
      const url = typeof input === 'string' ? input : (input && input.url) || '';
      if (isLegacyUrl(url)){
        console.error('[GUARD] BLOCKED fetch of legacy audio:', url);
        log(`<b>[${stamp()}]</b> Blocked <b>fetch</b> → ${url}<br><small>${stackText().replaceAll('<','&lt;')}</small>`);
        return Promise.reject(new Error('Legacy audio blocked by guard'));
      }
    }catch(_){}
    return _fetch.apply(this, arguments);
  };

  const _open = XMLHttpRequest.prototype.open;
  XMLHttpRequest.prototype.open = function(method, url){
    if (isLegacyUrl(url)){
      console.error('[GUARD] BLOCKED XHR of legacy audio:', url);
      log(`<b>[${stamp()}]</b> Blocked <b>XHR</b> → ${url}<br><small>${stackText().replaceAll('<','&lt;')}</small>`);
      // neuter this XHR
      return _open.apply(this, [method, 'about:blank', ...Array.prototype.slice.call(arguments,2)]);
    }
    return _open.apply(this, arguments);
  };

  // Wrap Audio constructor
  const NativeAudio = window.Audio;
  function GuardedAudio(src){
    if (src && isLegacyUrl(src)){
      console.error('[GUARD] BLOCKED new Audio() legacy src:', src);
      log(`<b>[${stamp()}]</b> Blocked <b>new Audio()</b> → ${src}<br><small>${stackText().replaceAll('<','&lt;')}</small>`);
      src = 'about:blank';
    }
    const a = src ? new NativeAudio(src) : new NativeAudio();
    a.playsInline = true;
    return a;
  }
  GuardedAudio.prototype = NativeAudio.prototype;
  Object.defineProperty(GuardedAudio, 'name', { value:'Audio' });
  window.Audio = GuardedAudio;

  // Intercept creation of <audio>/<video>
  const _create = Document.prototype.createElement;
  Document.prototype.createElement = function(tag){
    const el = _create.apply(this, arguments);
    try{
      const t = (tag||'').toString().toLowerCase();
      if (t === 'audio' || t === 'video'){
        const origSetAttr = el.setAttribute;
        el.setAttribute = function(name, val){
          if (name === 'src' && isLegacyUrl(val)){
            console.error('[GUARD] BLOCKED setAttribute src legacy:', val);
            log(`<b>[${stamp()}]</b> Blocked <b>setAttribute('src')</b> → ${val}<br><small>${stackText().replaceAll('<','&lt;')}</small>`);
            val = 'about:blank';
          }
          return origSetAttr.call(this, name, val);
        };
      }
    }catch(_){}
    return el;
  };

  // Patch src property on HTMLMediaElement
  const desc = Object.getOwnPropertyDescriptor(HTMLMediaElement.prototype, 'src');
  if (desc && desc.set){
    const orig = desc.set;
    desc.set = function(v){
      if (isLegacyUrl(v)){
        console.error('[GUARD] BLOCKED media.src legacy:', v);
        log(`<b>[${stamp()}]</b> Blocked <b>media.src=</b> → ${v}<br><small>${stackText().replaceAll('<','&lt;')}</small>`);
        v = 'about:blank';
      }
      return orig.call(this, v);
    };
    Object.defineProperty(HTMLMediaElement.prototype, 'src', desc);
  }

  // Block play() if currentSrc is legacy, with full trace
  const _play = HTMLMediaElement.prototype.play;
  HTMLMediaElement.prototype.play = function(){
    const s = this.currentSrc || this.src || '';
    if (isLegacyUrl(s)){
      try { this.pause(); this.currentTime = 0; } catch(_){}
      console.error('[GUARD] BLOCKED play() of legacy audio:', s);
      log(`<b>[${stamp()}]</b> Blocked <b>media.play()</b> → ${s}<br><small>${stackText().replaceAll('<','&lt;')}</small>`);
      return Promise.reject(new Error('Legacy audio blocked on play()'));
    }
    return _play.apply(this, arguments);
  };

  // WebAudio guard: wrap AudioContext/BufferSource.start to expose whoever plays anything
  function wrapCtx(Ctx){
    if (!Ctx) return;
    const _createBufferSource = Ctx.prototype.createBufferSource;
    Ctx.prototype.createBufferSource = function(){
      const node = _createBufferSource.apply(this, arguments);
      const _start = node.start;
      node.start = function(){
        // We can’t identify the MP3 name here, but we DO expose stack for the caller
        console.warn('[GUARD] WebAudio start() invoked. Stack below — if legacy plays, this is your caller.');
        console.warn(stackText());
        return _start.apply(this, arguments);
      };
      return node;
    };
  }
  wrapCtx(window.AudioContext);
  wrapCtx(window.webkitAudioContext);

  // Public helpers for you in console
  window.__AUDIO_GUARD__ = {
    stopAll(){
      document.querySelectorAll('audio,video').forEach(m=>{ try{ m.pause(); m.currentTime=0; }catch(_){} });
      console.warn('[GUARD] stopAll issued');
      log(`<b>[${stamp()}]</b> stopAll() — paused every media tag`);
    },
    log
  };

  // Warn if any SW still controls scope
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(rs=>{
      if (navigator.serviceWorker.controller){
        console.warn('[GUARD] ServiceWorker is ACTIVE for this page:', navigator.serviceWorker.controller.scriptURL);
        log(`<b>[${stamp()}]</b> <b>Warning:</b> ServiceWorker is controlling this page scope.`);
      } else if (rs.length){
        console.warn('[GUARD] SW registrations exist but not controlling this page. Count:', rs.length);
      }
    });
  }
})();
</script>
</head>
<body>
<div class="wrap">
  <h1>$BAG — Test Page</h1>
  <p class="muted">Tap/click once to unlock audio. Scroll the banner fully into view to play <code>casinomusic.mp3</code>. Any attempt to load/play <code>here-come-the-money.mp3</code> is blocked and logged with a stack trace.</p>

  <div class="banner">
    <a href="/casino/" aria-label="Open $BAG Casino">
      <img id="bag-casino-img" src="/assets/bag-casino-1024.png" width="1024" height="683" alt="$BAG Casino" loading="lazy" decoding="async">
    </a>
  </div>

  <p class="muted">Console helpers: <code>__AUDIO_GUARD__.stopAll()</code></p>
</div>

<!-- The ONLY allowed SFX flow on this page -->
<script>
(function(){
  const SRC = '/assets/sounds/casinomusic.mp3?v=guard1';
  const TARGET_ID = 'bag-casino-img';
  const THRESHOLD = 0.6;

  // One global audio
  const sfx = new Audio(SRC);
  sfx.preload = 'auto';
  sfx.playsInline = true;
  sfx.crossOrigin = 'anonymous';

  let unlocked = false;
  const tryUnlock = async () => {
    if (unlocked) return;
    try {
      sfx.muted = true;
      await sfx.play();
      sfx.pause(); sfx.currentTime = 0; sfx.muted = false;
      unlocked = true;
      window.removeEventListener('pointerdown', tryUnlock, true);
      document.removeEventListener('keydown', tryUnlock, true);
      console.info('[TEST] Unlocked audio OK');
    } catch(e){
      console.warn('[TEST] Unlock blocked:', e && e.name);
    }
  };
  window.addEventListener('pointerdown', tryUnlock, true);
  document.addEventListener('keydown', tryUnlock, true);

  // Visibility trigger
  const io = new IntersectionObserver((entries)=>{
    for (const e of entries){
      if (!unlocked) return;
      if (e.target.id !== TARGET_ID) return;
      if (e.isIntersecting && e.intersectionRatio >= THRESHOLD){
        sfx.currentTime = 0;
        sfx.play().then(()=> console.info('[TEST] Playing casinomusic.mp3')).catch(err=> console.warn('[TEST] play blocked', err && err.name));
      }
    }
  }, { threshold: THRESHOLD });

  document.addEventListener('DOMContentLoaded', ()=>{
    const img = document.getElementById(TARGET_ID);
    if (img) io.observe(img);
    // sanity HEAD check
    fetch(SRC, { method:'HEAD', cache:'reload' })
      .then(r=> console.info('[TEST] HEAD casinomusic:', r.status, r.ok?'OK':'Not OK'))
      .catch(e=> console.error('[TEST] HEAD failed', e));
  });
})();
</script>
</body>
</html>
