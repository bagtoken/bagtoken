<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="format-detection" content="telephone=no" />
<title>$BAG Air Hockey ‚Äî Arcade P2E</title>

<link rel="preconnect" href="https://api.coingecko.com" crossorigin>
<script src="https://xaman.app/assets/cdn/xumm.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
<script>window.__BAG_FORCE_DEMO=false;</script>

<style>
*{box-sizing:border-box}
:root{
  --gold:#ffe175;--bg:#020703;--panel:#0b1b13;--panel2:#0d2217;
  --muted:#aeb7af;--fg:#f5f7f4;--green:#2fbf6b;--line:#173524;
  --shadow:rgba(0,0,0,.35);--lose:#e25b5b;--warn:#e8a85c;
}
html,body{margin:0;background:var(--bg);color:var(--fg);
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  line-height:1.55;overflow-x:hidden;}
img{display:block;max-width:100%;height:auto}
button,input{font-size:16px}
a[x-apple-data-detectors]{color:inherit!important;text-decoration:none!important;pointer-events:none!important}
.back-casino{
  position:fixed;top:18px;left:18px;z-index:1000;
  background:linear-gradient(180deg,#ffe175 0%,#f5c94c 100%);
  color:#08130d;text-decoration:none;font-weight:800;
  padding:8px 14px;border-radius:10px;box-shadow:0 4px 0 #b08a19;
}
.panel{background:linear-gradient(180deg,var(--panel),var(--panel2));
  border:1px solid var(--line);border-radius:16px;
  box-shadow:0 8px 24px var(--shadow);}
.pad{padding:16px}
.marquee{text-align:center;font-weight:900;letter-spacing:.08em;
  color:#ffe9a6;background:linear-gradient(180deg,#17311f,#0e2419);
  border:1px solid #254a33;border-radius:12px;padding:8px}
.table{background:#07140e;border:1px solid #1b4a2f;border-radius:14px;padding:14px}
.felt{display:grid;gap:12px;background:#091a13;border:1px solid #24533a;
  border-radius:12px;padding:12px;overflow:hidden}
.stage3d{height:540px;position:relative;border-radius:10px;overflow:hidden}
canvas{display:block;width:100%;height:100%}
.hudbar{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
  gap:6px;align-items:center;margin:6px 2px 0}
.pill{background:#0a1e15;border:1px solid #244330;border-radius:999px;
  padding:6px 10px;font-size:12px;color:#cfe6d8}
.pill.balance{grid-column:1/-1;font-size:14px;padding:8px 12px;font-weight:800}
</style>

<!-- UNIVERSAL BAG MODULES -->
<script src="/js/bag-overlay.js"></script>
<script src="/js/bag-session.js"></script>
<script src="/js/bag-quick-amounts.js"></script>
<script src="/js/bag-stake-wire.js"></script>

  </head>
<body>
<a href="/casino/" class="back-casino">‚¨ÖÔ∏è Back to Casino</a>

<section class="game-header" style="text-align:center;padding:36px 10px 14px">
  <picture>
    <source type="image/webp"
            srcset="/assets/bag-airhockey-960.webp 960w, /assets/bag-airhockey-1024.webp 1024w"
            sizes="(min-width:900px) 420px, 70vw">
    <img class="hero-img"
         src="/assets/bag-airhockey-1024.png"
         srcset="/assets/bag-airhockey-960.png 960w, /assets/bag-airhockey-1024.png 1024w"
         sizes="(min-width:900px) 420px, 70vw"
         alt="$BAG Air Hockey" loading="lazy" decoding="async">
  </picture>
  <h2>üèí $BAG Air Hockey ‚Äî Arcade P2E</h2>
  <p class="micro" style="margin-top:4px;opacity:.9;">
    üí∞ <strong>All payouts are in $BAG.</strong> $XRP bets convert automatically at the live rate.
  </p>
</section>

<section class="game-teaser" aria-labelledby="game-teaser-title"
 style="padding:10px 16px 60px;background:
  radial-gradient(1200px 600px at 10% -10%, #0e2c1d 0%, transparent 60%),
  radial-gradient(900px 500px at 110% 20%, #0b2318 0%, transparent 55%),#060806;
  border-top:1px solid #131313;border-bottom:1px solid #131313">
<div class="game-wrap" style="max-width:1080px;margin:0 auto;display:grid;gap:22px">
<div class="panel pad">

  <!-- CONNECT -->
  <div id="connectRow" style="display:flex;justify-content:space-between;align-items:center;margin:-2px 0 10px 0%">
    <div id="connectStatus" class="micro" style="opacity:.9">
      Wallet: <span style="color:#e8a85c">not connected</span>
    </div>
    <button id="connectBtn" class="btn"
      style="min-width:auto;padding:10px 14px;border:0;border-radius:12px;
             font-weight:900;cursor:pointer;color:#08130d;
             background:linear-gradient(180deg,#ffe175,#f5c94c);
             box-shadow:0 4px 0 #b08a19;">Connect Xaman</button>
  </div>

  <!-- SESSION -->
  <div id="sessionRow" style="display:flex;justify-content:space-between;align-items:center;margin:6px 0 10px 0%">
    <div id="sessionStatus" class="micro" style="opacity:.9">
      Session: <span style="color:#2fbf6b">Practice:</span>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="startSessionBtn" class="btn"
        style="min-width:auto;padding:8px 12px;border:0;border-radius:12px;
               font-weight:900;cursor:pointer;color:#08130d;
               background:linear-gradient(180deg,#ffe175,#f5c94c);
               box-shadow:0 4px 0 #b08a19;">Start Session</button>
      <button id="topUpBtn" class="btn" style="display:none;">Top Up</button>
      <button id="endSessionBtn" class="btn alt" style="display:none;">End</button>
    </div>
  </div>

  <div class="section-title" style="font-weight:800;font-size:1.2rem;margin:0 0 12px">Stake & Prices</div>

  <div class="stake-box" style="padding:14px">
    <div class="stack" style="display:grid;gap:10px">
      <!-- AMOUNT -->
      <div>
        <div class="micro">Amount</div>
        <div style="display:flex;gap:10px;align-items:center">
          <input id="usdBet" class="mono" type="number" min="0" max="2000" step="0.01"
            placeholder="0.00"
            style="width:140px;background:#0b2217;border:1px solid #1b4a2f;
                   border-radius:10px;color:#f3f5f0;padding:10px">
          <span class="micro unit">USD</span>
        </div>
        <div class="preset-chips" id="usdPresets"
          data-quick-amounts data-target-usd="#usdBet" data-target-qty="#betQty"
          data-currency-toggle="#curToggle" data-min-usd="1" data-max-usd="2000">
          <button type="button" class="preset-chip" data-usd="1">$1</button>
          <button type="button" class="preset-chip" data-usd="5">$5</button>
          <button type="button" class="preset-chip" data-usd="10">$10</button>
          <button type="button" class="preset-chip" data-usd="20">$20</button>
          <button type="button" class="preset-chip" data-usd="50">$50</button>
          <button type="button" class="preset-chip" data-usd="100">$100</button>
          <button type="button" class="preset-chip" data-usd="max">Max</button>
        </div>
      </div>

      <!-- CURRENCY -->
      <div>
        <div class="micro">Bet currency</div>
        <div class="choice" id="curToggle">
          <label class="chip"><input type="radio" name="betCur" value="XRP" checked> XRP</label>
          <label class="chip"><input type="radio" name="betCur" value="BAG"> BAG</label>
        </div>
      </div>

      <!-- BET AMOUNT -->
      <div>
        <div class="micro">Bet amount</div>
        <div style="display:flex;gap:10px;align-items:center">
          <input id="betQty" class="mono" type="number" min="0" step="any" value="1"
            style="width:140px;background:#0b2217;border:1px solid #1b4a2f;
                   border-radius:10px;color:#f3f5f0;padding:10px">
          <span class="unit">XRP</span>
        </div>
        <div class="micro" id="betLimits" style="margin-top:6px"></div>
      </div>

      <div class="divider" style="height:1px;background:#123221;margin:10px 0"></div>

      <div class="micro">Live prices</div>
      <div class="muted mono" id="liveLine">
        <span id="liveDot" class="warn">‚óè</span>
        BAG $<span id="liveBAG">‚Äî</span> ¬∑ XRP $<span id="liveXRP">‚Äî</span>
        <span id="liveNote"></span>
        <div class="micro" id="liveConv" style="margin-top:4px;opacity:.9;">
          1 BAG ‚âà ‚Äî XRP ¬∑ 1 XRP ‚âà ‚Äî BAG
        </div>
      </div>

      <div class="divider" style="height:1px;background:#123221;margin:10px 0"></div>

      <!-- PAYOUT PREVIEW -->
      <div id="dice-win-readout"></div>
    </div>
  </div>

  <div class="divider" style="height:1px;background:#123221;margin:14px 0"></div>

  <div class="marquee">$BAG AIR HOCKEY</div>
  <div class="table">
    <div class="felt">
      <!-- GAME STAGE ‚Äî Air Hockey Canvas goes here -->
      <div class="stage3d" id="hockeyStage"></div>

      <div class="hudbar" id="diceHud">
        <span class="pill balance">Balance: <b id="balLbl">‚Äî</b> <span id="ccyLbl">BAG</span></span>
        <span class="pill">Mode: <b id="modeLbl">Demo</b></span>
        <span class="pill">Bet: <b id="betLbl">1</b></span>
        <span class="pill">Last: <b id="lastLbl">‚Äî</b></span>
      </div>
    </div>
  </div>

</div></div></section>

<script>
(function(){
  const HOUSE_FEE = 0.05;
  const MODE = new URLSearchParams(location.search).get('mode') || 'cpu';

  const config = {
    type: Phaser.AUTO,
    parent: 'hockeyStage',
    width: 1024,           // üëà restore fixed full game size
    height: 1536,
    scale: {
      mode: Phaser.Scale.FIT,      // keep original aspect, auto center
      autoCenter: Phaser.Scale.CENTER_BOTH
    },
    backgroundColor: '#021107',
    physics: { default: 'arcade', arcade: { debug: false, fps: 120, step: 1/240 } },
    scene: { preload, create, update }
  };

  let game, puck, player, cpu, scoreText, topGoal, bottomGoal;
  let scorePlayer = 0, scoreCPU = 0;
  let touchTarget = { x: 0, y: 0, active: false };
  let prevPlayer = { x: 0, y: 0 };
  let lastHit = 0;

  function preload() {
    this.load.image('table','/arcade/assets/img/airhockey_table-1024.webp');
    this.load.image('puck','/arcade/assets/img/puck-1024.webp');
    this.load.image('paddle_gold','/arcade/assets/img/paddle_gold-1024.webp');
    this.load.image('paddle_green','/arcade/assets/img/paddle_green-1024.webp');
  }

  function create() {
    const w = this.scale.width, h = this.scale.height, cx = w/2, cy = h/2;
    this.add.image(cx, cy, 'table').setDisplaySize(w, h);

    const goalW = w * 0.26, goalH = h * 0.03;
    topGoal = this.add.rectangle(cx, h * 0.045, goalW, goalH, 0xff0000, 0.35);
    bottomGoal = this.add.rectangle(cx, h * 0.955, goalW, goalH, 0x00ff00, 0.35);

    this.physics.world.setBounds(40, 40, w - 80, h - 80);

    puck = this.physics.add.image(cx, cy, 'puck').setScale(0.07);
    puck.setCollideWorldBounds(true).setBounce(0.99).setDamping(true)
        .setDrag(0.99,0.99).setMaxVelocity(1600);
    puck.body.setCircle(puck.width*0.6);

    player = this.physics.add.image(cx, h*0.85, 'paddle_gold').setScale(0.1);
    cpu = this.physics.add.image(cx, h*0.15, 'paddle_green').setScale(0.1);
    player.setImmovable(true);
    cpu.setImmovable(true);

    this.physics.add.collider(puck, player, onHit, null, this);
    this.physics.add.collider(puck, cpu, onHit, null, this);

    const translatePointer = (p) => {
      const rect = this.game.canvas.getBoundingClientRect();
      return { x: p.x - rect.left, y: p.y - rect.top };
    };

    this.input.on('pointerdown', p=>{
      const pos = translatePointer(p);
      if(pos.y > h*0.5){
        touchTarget.active = true;
        touchTarget.x = pos.x;
        touchTarget.y = pos.y;
      }
    });
    this.input.on('pointermove', p=>{
      if(!touchTarget.active) return;
      const pos = translatePointer(p);
      if(pos.y > h*0.5){ touchTarget.x = pos.x; touchTarget.y = pos.y; }
    });
    this.input.on('pointerup', ()=>touchTarget.active=false);

    scoreText = this.add.text(cx, 40, '0 - 0', {
      fontFamily:'Orbitron',fontSize:'48px',color:'#ffe175',
      stroke:'#2fbf6b',strokeThickness:3
    }).setOrigin(0.5,0);

    resetPuck.call(this);
  }

  function onHit(puck, paddle){
    const now = performance.now();
    if(now - lastHit < 50) return;
    lastHit = now;
    const dx = puck.x - paddle.x, dy = puck.y - paddle.y;
    const dist = Math.sqrt(dx*dx + dy*dy) || 1;
    const nx = dx / dist, ny = dy / dist;
    const vx = paddle.x - prevPlayer.x, vy = paddle.y - prevPlayer.y;
    const speed = Math.sqrt(vx*vx + vy*vy);
    const impulse = Phaser.Math.Clamp(400 + speed*220, 400, 1700);
    puck.body.velocity.x = nx * impulse;
    puck.body.velocity.y = ny * impulse;
  }

  function update(){
    const w=this.scale.width, h=this.scale.height;
    prevPlayer.x = player.x; prevPlayer.y = player.y;

    if(touchTarget.active){
      const dx = touchTarget.x - player.x;
      const dy = touchTarget.y - player.y;
      player.x += dx * 0.5;
      player.y += dy * 0.5;
    }

    player.x = Phaser.Math.Clamp(player.x, 60, w-60);
    player.y = Phaser.Math.Clamp(player.y, h*0.55, h-60);

    if(MODE==='cpu'){
      cpu.x += (puck.x - cpu.x)*0.08;
      cpu.y += (puck.y - cpu.y)*0.05;
      cpu.x = Phaser.Math.Clamp(cpu.x, 60, w-60);
      cpu.y = Phaser.Math.Clamp(cpu.y, 60, h*0.45);
    }

    const goalHalf = w * 0.13;
    if(puck.y < topGoal.y && Math.abs(puck.x - w/2) < goalHalf) handleGoal('player', this);
    if(puck.y > bottomGoal.y && Math.abs(puck.x - w/2) < goalHalf) handleGoal('cpu', this);
  }

  function handleGoal(who, scene){
    if(who==='player') scorePlayer++; else scoreCPU++;
    scoreText.setText(`${scorePlayer} - ${scoreCPU}`);
    resetPuck.call(scene);
  }

  function resetPuck(){
    const w=this.scale.width, h=this.scale.height;
    puck.setPosition(w/2, h/2);
    const angle = Phaser.Math.Between(30,150)*(Phaser.Math.Between(0,1)?1:-1);
    const speed = Phaser.Math.Between(600,750);
    puck.setVelocity(Math.cos(angle*Math.PI/180)*speed,
                     Math.sin(angle*Math.PI/180)*speed);
  }

  window.addEventListener('load',()=>{ game = new Phaser.Game(config); });
})();
</script>



  <script>
(function(){
  // reuse Dice payout preview
  const nfBAG=new Intl.NumberFormat('en-US',{maximumFractionDigits:6});
  const nfUSD=new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits:2,maximumFractionDigits:2});
  const PREVIEW={
    el:null, rules:{ win:1.5, loss:0 }, state:{ stakeBag:0, usdPerBag:0 },
    init(sel){ this.el=document.querySelector(sel); this.render(); },
    update({stakeBag,usdPerBag}){ this.state.stakeBag=stakeBag; this.state.usdPerBag=usdPerBag; this.render(); },
    amt(bag){ const usd=(bag||0)*(this.state.usdPerBag||0); return `${nfBAG.format(bag||0)} BAG (${nfUSD.format(usd)})`; },
    render(){ if(!this.el)return; const s=this.state.stakeBag||0, r=this.rules;
      const win=s*r.win, lose=s*r.loss;
      this.el.innerHTML=`
      <div class="row"><div class="title">PAYOUT PREVIEW:</div><div>Air Hockey Match</div></div>
      <div class="row"><div>Win (${r.win.toFixed(2)}√ó):</div><div>${this.amt(win)}</div></div>
      <div class="row"><div>Loss (${r.loss.toFixed(2)}√ó):</div><div>${this.amt(lose)}</div></div>
      <div class="note">Stake shown in BAG with live USD equivalent (5% house fee applies to wins).</div>`; }
  };
  function PR(){ return window.__PRICES__||{bagUsd:0}; }
  function stakeBag(){
    const q=parseFloat(document.getElementById('betQty')?.value||0)||0;
    if(!q)return 0; const {bagUsd,xrpUsd}=PR();
    const cur=document.querySelector('#curToggle input[name="betCur"]:checked')?.value||'XRP';
    return cur==='BAG'? q : (bagUsd>0&&xrpUsd>0? q*(xrpUsd/bagUsd):0);
  }
  function repaint(){ PREVIEW.update({stakeBag:stakeBag(),usdPerBag:PR().bagUsd}); }
  document.addEventListener('DOMContentLoaded',()=>{ PREVIEW.init('#dice-win-readout'); repaint(); });
  addEventListener('bag:pricesUpdated',repaint);
  addEventListener('bag:hudRefresh',repaint);
})();
</script>

  <button class="rules-fab" id="rulesFab">‚ÑπÔ∏è Rules</button>
<div class="rules-overlay" id="rulesOverlay" style="display:none;place-items:center;
  position:fixed;inset:0;z-index:3000;backdrop-filter:blur(6px);background:rgba(0,0,0,.45);padding:18px;">
  <div class="rules-modal" style="width:min(680px,92vw);background:linear-gradient(180deg,var(--panel),var(--panel2));
    border:1px solid var(--line);border-radius:16px;padding:18px;color:var(--fg);position:relative;">
    <button class="rules-close" id="rulesClose" style="position:absolute;top:8px;right:12px;border:0;background:transparent;
      color:#e9efe9;font-size:24px;cursor:pointer;">√ó</button>
    <h3>üèí $BAG Air Hockey Rules</h3>
    <ul>
      <li>Score 7 points to win the match.</li>
      <li>Each match deducts a 5% house fee from winnings.</li>
      <li>Player vs CPU (default) ¬∑ Add ?mode=pvp for Player vs Player when enabled.</li>
      <li>All stakes and payouts occur in $BAG at live XRPL AMM rate.</li>
    </ul>
    <div class="rules-note" style="color:#aeb7af;margin-top:10px">Demo mode uses virtual balances only.</div>
  </div>
</div>

<footer style="text-align:center;padding:12px 0;line-height:1.6;">
  ¬© 2025 $BAG Protocol | getthebag.io | Powered by $XRP <br>
  <a href="https://x.com/getthebag_io" target="_blank" rel="noopener"
     style="color:#e0c66f;text-decoration:none;font-weight:700;">ùïè @getthebag_io</a>
  &nbsp;|&nbsp;
  <a href="https://t.me/getthebag_io" target="_blank" rel="noopener"
     style="color:#e0c66f;text-decoration:none;font-weight:700;">Telegram @getthebag_io</a>
</footer>

<script>
(function(){
  const fab=document.getElementById('rulesFab'),
        ov=document.getElementById('rulesOverlay'),
        x=document.getElementById('rulesClose');
  const open=()=>ov.style.display='grid';
  const close=()=>ov.style.display='none';
  fab?.addEventListener('click',open);
  x?.addEventListener('click',close);
  ov?.addEventListener('click',e=>{if(e.target===ov)close();});
  addEventListener('keydown',e=>{if(e.key==='Escape')close();});
})();
</script>

<script>
  BAGStakeWire.init({
    usdInput:'#usdBet', qtyInput:'#betQty', currencyToggle:'#curToggle',
    unitLabels:'.unit', limitsLabel:'#betLimits', presetsRoot:'#usdPresets',
    minUsd:1,maxUsd:2000,activeClass:'active',syncOnPrice:true
  });
</script>

<script>
if('serviceWorker' in navigator){navigator.serviceWorker.register('/service-worker.js').catch(()=>{});}
document.addEventListener('gesturestart',e=>e.preventDefault(),{passive:false});
document.addEventListener('dblclick',e=>e.preventDefault(),{capture:true});
window.addEventListener('wheel',e=>{if(e.ctrlKey)e.preventDefault();},{passive:false});
</script>

</body>
</html>

