<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<meta name="format-detection" content="telephone=no"/>
<title>$BAG Air Hockey ‚Äî Arcade P2E</title>
<style>
  *{box-sizing:border-box}
  :root{
    --gold:#ffe175;--bg:#020703;--panel:#0b1b13;--panel2:#0d2217;--muted:#aeb7af;--fg:#f5f7f4;
    --green:#2fbf6b;--green-600:#249a55;--line:#173524;--shadow:rgba(0,0,0,.35);
  }
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.55}
  body{touch-action:manipulation}
  img{display:block;max-width:100%;height:auto}
  button,input{font-size:16px}

  .wrap{max-width:1120px;margin:0 auto;padding:16px}
  .back-casino{
    position:fixed;top:16px;left:16px;z-index:1000;background:linear-gradient(180deg,#ffe175,#f5c94c);
    color:#08130d;text-decoration:none;font-weight:800;padding:8px 14px;border-radius:10px;box-shadow:0 4px 0 #b08a19
  }

  .hero{text-align:center;padding:64px 10px 16px}
  .hero h2{font-size:clamp(1.6rem,5vw,2.2rem);margin:8px 0 0}
  .micro{font-size:.92rem;color:#cfe1d6}

  .panel{background:linear-gradient(180deg,var(--panel) 0%,var(--panel2) 100%);border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 24px var(--shadow)}
  .pad{padding:16px}
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:20px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}

  .section-title{font-weight:800;font-size:1.1rem;margin:6px 0 10px}
  .divider{height:1px;background:#123221;margin:12px 0}

  .hudbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0 0}
  .pill{background:#0a1e15;border:1px solid #244330;border-radius:999px;padding:6px 10px;font-size:12px;color:#cfe6d8}
  .pill b{font-weight:800}
  .mono{font-variant-numeric:tabular-nums}

  .preset-chips{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .preset-chip{
    appearance:none;border:1px solid var(--green-600);background:var(--green);color:#fff;border-radius:999px;
    padding:10px 14px;font-weight:900;letter-spacing:.2px;cursor:pointer;
    box-shadow:0 4px 10px rgba(47,191,107,.18), inset 0 1px 0 rgba(255,255,255,.12)
  }
  .preset-chip.active{box-shadow:0 0 0 2px rgba(255,255,255,.25) inset, 0 8px 22px rgba(47,191,107,.25)}

  .board-card{position:relative;border-radius:16px;overflow:hidden}
  .board-top{padding:8px 12px;border-bottom:1px solid #123221;background:linear-gradient(180deg,#0e2419,#0a1b13)}
  .board-top .title{font-weight:900;letter-spacing:.08em;color:#ffe9a6;text-align:center}
  .board-wrap{position:relative;background:#07140e}
  canvas#air{display:block;width:100%;height:auto;touch-action:none}

  .start-overlay{position:absolute;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.38);z-index:5;backdrop-filter:blur(2px)}
  .start-box{
    background:linear-gradient(180deg,var(--panel) 0%,var(--panel2) 100%);
    border:1px solid var(--line);border-radius:14px;padding:14px 16px;text-align:center;
    box-shadow:0 20px 50px rgba(0,0,0,.45);max-width:min(92vw,520px)
  }
  .btn{min-width:140px;padding:12px 14px;border:0;border-radius:12px;font-weight:900;cursor:pointer;color:#08130d;background:linear-gradient(180deg,#ffe175,#f5c94c)}
  .btn.alt{color:#e9efe9;background:#15261c;border:1px solid #2b6a48}

  .countdown{position:absolute;top:10px;left:50%;transform:translateX(-50%);background:#0e2a1c;border:1px solid #2b6a48;border-radius:999px;padding:6px 12px;font-weight:900;z-index:4}
</style>
</head>
<body>

<a href="/casino/" class="back-casino">‚¨ÖÔ∏è Back to Casino</a>

<main class="wrap">
  <!-- HERO -->
  <section class="hero">
    <picture>
      <source type="image/webp" srcset="/arcade/assets/img/bag-airhockey-1024.webp 1024w, /arcade/assets/img/bag-airhockey-960.webp 960w" sizes="(min-width:900px) 560px, 90vw">
      <img src="/arcade/assets/img/bag-airhockey-960.png" alt="$BAG Air Hockey" width="1024" height="576" loading="eager" decoding="async" style="margin:0 auto 10px;filter:drop-shadow(0 10px 24px rgba(46,191,107,.18))">
    </picture>
    <h2>üèí $BAG AIR HOCKEY</h2>
    <p class="micro" style="margin-top:4px;opacity:.9;">All payouts settle in $BAG. $XRP wagers auto-convert at the live rate.</p>
  </section>

  <section class="grid">
    <!-- LEFT: Controls / Practice / Prices -->
    <div class="panel pad">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <div id="sessionStatus" class="micro" style="opacity:.9">Session: <span style="color:#2fbf6b">Practice</span></div>
        <div style="display:flex;gap:8px">
          <button id="startSessionBtn" class="btn">Start Session</button>
          <button id="topUpBtn" class="btn" style="display:none">Top Up</button>
          <button id="endSessionBtn" class="btn" style="display:none">End</button>
        </div>
      </div>

      <!-- Practice readout -->
      <div id="practiceReadout" class="hudbar" style="margin-top:10px">
        <span class="pill"><b>BAG</b>: <span id="pracBag" class="mono">‚Äî</span></span>
        <span class="pill"><b>XRP</b>: <span id="pracXrp" class="mono">‚Äî</span></span>
        <span class="pill"><b>USD</b>: <span id="pracUsd" class="mono">‚Äî</span></span>
      </div>

      <!-- Live prices BELOW practice -->
      <div class="divider"></div>
      <div class="micro">Live prices</div>
      <div class="hudbar">
        <span class="pill">Source: <b id="priceSrc">‚Äî</b></span>
        <span class="pill">BAG: <b id="bagUsd" class="mono">‚Äî</b> USD</span>
        <span class="pill">XRP: <b id="xrpUsd" class="mono">‚Äî</b> USD</span>
        <span class="pill">1 XRP ‚âà <b id="bagPerXrp" class="mono">‚Äî</b> BAG</span>
      </div>

      <div class="divider"></div>
      <div class="section-title">Match Setup</div>
      <div class="micro">Series</div>
      <div class="hudbar" role="group" aria-label="Best-of series">
        <label class="pill"><input type="radio" name="series" value="3" checked> Best of 3</label>
        <label class="pill"><input type="radio" name="series" value="5"> Best of 5</label>
        <label class="pill"><input type="radio" name="series" value="7"> Best of 7</label>
      </div>

      <div class="micro" style="margin-top:8px">Target score (per game)</div>
      <div class="hudbar" role="group" aria-label="Target score">
        <label class="pill"><input type="radio" name="target" value="5" checked> 5</label>
        <label class="pill"><input type="radio" name="target" value="7"> 7</label>
        <label class="pill"><input type="radio" name="target" value="10"> 10</label>
      </div>

      <div class="divider"></div>
      <div class="section-title">Head-to-Head</div>
      <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center">
        <button id="createMatchBtn" class="btn">Create Match</button>
        <input id="matchCodeInput" class="mono" placeholder="Enter code"
               style="width:160px;background:#0b2217;border:1px solid #1b4a2f;border-radius:10px;color:#f5f7f4;padding:10px">
        <button id="joinMatchBtn" class="btn">Join Match</button>
        <span id="matchStatus" class="micro" style="opacity:.9;margin-left:6px">Not connected</span>
      </div>

      <div class="divider"></div>
      <div class="section-title">Wager</div>
      <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center">
        <div style="display:flex;gap:6px;align-items:center">
          <input id="wagerQty" class="mono" type="number" inputmode="decimal" min="0" step="any" value="1"
                 style="width:140px;background:#0b2217;border:1px solid #1b4a2f;border-radius:10px;color:#f5f7f4;padding:12px">
          <span class="micro">XRP</span>
        </div>
        <button id="proposeWagerBtn" class="btn">Propose</button>
        <button id="lockStakeBtn" class="btn">Lock Stake</button>
        <span id="wagerStatus" class="micro" style="opacity:.9;margin-left:6px">No wager</span>
      </div>

      <div class="preset-chips" id="wagerPresets" style="margin-top:8px">
        <button type="button" class="preset-chip" data-xrp="1">1 XRP</button>
        <button type="button" class="preset-chip" data-xrp="2">2 XRP</button>
        <button type="button" class="preset-chip" data-xrp="5">5 XRP</button>
        <button type="button" class="preset-chip" data-xrp="10">10 XRP</button>
        <button type="button" class="preset-chip" data-xrp="25">25 XRP</button>
      </div>
    </div>

    <!-- RIGHT: Board -->
    <div class="panel board-card">
      <div class="board-top"><div class="title">$BAG AIR HOCKEY</div></div>
      <div class="board-wrap" id="boardWrap">
        <div class="countdown" id="countdown" style="display:none">3</div>
        <div class="start-overlay" id="startOverlay">
          <div class="start-box">
            <div style="font-weight:900;margin-bottom:6px">Ready to play</div>
            <div class="micro" style="margin-bottom:12px">
              Pick series & target, set wager, then start.
              <br>Head-to-Head requires both players to lock stakes.
            </div>
            <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
              <button id="startBtn" class="btn">Start Game</button>
              <button id="practiceBtn" class="btn alt">Practice (solo)</button>
            </div>
          </div>
        </div>
        <canvas id="air" width="900" height="560" aria-label="Air Hockey table"></canvas>
      </div>
    </div>
  </section>
</main>

<!-- AUDIO (paddle hit only) + countdown + buzzer -->
<script>
(function(){
  const AC = new (window.AudioContext||window.webkitAudioContext)();
  let primed=false; function prime(){ if(primed) return; primed=true; AC.resume().catch(()=>{}); }
  ['pointerdown','touchstart','keydown','wheel','mousedown'].forEach(e=>addEventListener(e,prime,{once:true,passive:true}));

  function hit(){
    const t=AC.currentTime;
    const o=AC.createOscillator(); o.type='square';
    const g=AC.createGain();
    o.frequency.setValueAtTime(1700,t); o.frequency.exponentialRampToValueAtTime(650,t+.06);
    g.gain.setValueAtTime(.0001,t); g.gain.linearRampToValueAtTime(.22,t+.008); g.gain.exponentialRampToValueAtTime(.0001,t+.12);
    o.connect(g).connect(AC.destination); o.start(t); o.stop(t+.14);
  }
  function beeps(n=3,interval=.6){
    const start=AC.currentTime;
    for(let i=0;i<n;i++){
      const t=start+i*interval;
      const o=AC.createOscillator(); o.type='sine';
      const g=AC.createGain();
      o.frequency.setValueAtTime(800+i*80,t);
      g.gain.setValueAtTime(.0001,t); g.gain.linearRampToValueAtTime(.25,t+.02); g.gain.exponentialRampToValueAtTime(.0001,t+.24);
      o.connect(g).connect(AC.destination); o.start(t); o.stop(t+.24);
    }
  }
  function buzzer(){
    const t=AC.currentTime;
    const src=AC.createBufferSource(), buf=AC.createBuffer(1, AC.sampleRate*0.35|0, AC.sampleRate);
    const d=buf.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*((1-i/d.length)**2)*.45;
    const lp=AC.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=360;
    const g=AC.createGain(); g.gain.setValueAtTime(.2,t); g.gain.exponentialRampToValueAtTime(.0001,t+.35);
    src.buffer=buf; src.connect(lp).connect(g).connect(AC.destination); src.start(t); src.stop(t+.36);
  }
  window.__AH_AUDIO__ = { hit, beeps, buzzer, resume:()=>AC.resume().catch(()=>{}) };
})();
</script>

<!-- PRICES: XRP (Coingecko), BAG (XRPL AMM) with cached fallback -->
<script>
(function(){
  const PRICE_REFRESH_MS=15000, FETCH_TIMEOUT_MS=8000, VIEW_TTL=6*60*60*1000, LIVE_TTL=24*60*60*1000;
  const VIEW_KEY='bag_prices_v8', LAST_LIVE='bag_last_live_v1', XRP_KEY='xrp_usd';
  const PRICES=(window.__PRICES__={ bagUsd:0, xrpUsd:0, source:'‚Äî' });

  const elSrc=document.getElementById('priceSrc'), elB=document.getElementById('bagUsd'), elX=document.getElementById('xrpUsd'), elC=document.getElementById('bagPerXrp');
  const fmt=(n,d=6)=>Number(n||0).toLocaleString(undefined,{maximumFractionDigits:d});
  const cacheSet=(k,v)=>{try{localStorage.setItem(k,JSON.stringify({t:Date.now(),v}))}catch{}};
  const cacheGet=(k,ttl)=>{try{const o=JSON.parse(localStorage.getItem(k)||'null'); if(!o) return null; return (Date.now()-o.t)<=ttl?o.v:null;}catch{return null;}};
  const timedFetch=(u,opts={},to=FETCH_TIMEOUT_MS)=>{const c=new AbortController(), id=setTimeout(()=>c.abort(),to); return fetch(u,{...opts,signal:c.signal,cache:'no-store'}).finally(()=>clearTimeout(id));};

  function paint(){
    elSrc.textContent = PRICES.source==='live-amm'?'AMM Live':(PRICES.source==='last-live'?'Last Live':'‚Äî');
    elB.textContent   = fmt(PRICES.bagUsd,6);
    elX.textContent   = Number(PRICES.xrpUsd||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
    elC.textContent   = (PRICES.bagUsd>0 && PRICES.xrpUsd>0) ? (PRICES.xrpUsd/PRICES.bagUsd).toLocaleString(undefined,{maximumFractionDigits:6}) : '‚Äî';
    dispatchEvent(new Event('bag:pricesUpdated'));
  }

  async function xrpUsd(){
    try{
      const r=await timedFetch('https://api.coingecko.com/api/v3/simple/price?ids=ripple&vs_currencies=usd');
      const v=(await r.json())?.ripple?.usd; if(Number(v)>0){ PRICES.xrpUsd=Number(v); cacheSet(XRP_KEY,PRICES.xrpUsd); return true; }
    }catch{} return false;
  }
  async function bagViaAMM(){
    const ISS='rNeYbfb9EDV8c7mNfUuooEEYYzMcEuDFbr', CODE='BAG';
    const req={id:1,command:'amm_info',asset:{currency:CODE,issuer:ISS},asset2:{currency:'XRP'}};
    const price = await new Promise(res=>{
      const ws=new WebSocket('wss://s1.ripple.com'); const t=setTimeout(()=>{try{ws.close();}catch{};res(null)},7000);
      ws.onopen=()=>ws.send(JSON.stringify(req));
      ws.onerror=()=>{clearTimeout(t);try{ws.close();}catch{};res(null);}
      ws.onmessage=e=>{try{const m=JSON.parse(e.data); if(m.id!==1||!m.result?.amm) return;
        clearTimeout(t);try{ws.close();}catch{};
        const bag=Number(m.result.amm.amount?.value||0), xrp=Number(m.result.amm.amount2?.value||0);
        res(bag>0&&xrp>0? xrp/bag : null);
      }catch{res(null)}};
    });
    if(!(price>0) || !(PRICES.xrpUsd>0)) return false;
    PRICES.bagUsd = PRICES.xrpUsd * price; PRICES.source='live-amm';
    cacheSet(LAST_LIVE,{bagUsd:PRICES.bagUsd,xrpUsd:PRICES.xrpUsd});
    cacheSet(VIEW_KEY,{bagUsd:PRICES.bagUsd,xrpUsd:PRICES.xrpUsd});
    return true;
  }
  function lastLive(){ const v=cacheGet(LAST_LIVE,LIVE_TTL); if(v&&Number(v.bagUsd)>0){ PRICES.bagUsd=Number(v.bagUsd); if(Number(v.xrpUsd)>0) PRICES.xrpUsd=Number(v.xrpUsd); PRICES.source='last-live'; return true;} return false; }
  function view(){ const v=cacheGet(VIEW_KEY,VIEW_TTL), x=cacheGet(XRP_KEY,VIEW_TTL); let ok=false;
    if(v&&Number(v.bagUsd)>0){ PRICES.bagUsd=Number(v.bagUsd); if(Number(v.xrpUsd)>0) PRICES.xrpUsd=Number(v.xrpUsd); ok=true; }
    if(!PRICES.xrpUsd && Number(x)>0){ PRICES.xrpUsd=Number(x); ok=true; }
    if(ok && PRICES.source==='‚Äî') PRICES.source='last-live';
    return ok;
  }

  async function refresh(){ const a=await xrpUsd(), b=await bagViaAMM(); if(!(a&&b)){ if(!lastLive()) view(); } paint(); }
  refresh(); setInterval(refresh, PRICE_REFRESH_MS);
})();
</script>

<!-- DEMO SESSION (Practice $2,000 seeding) -->
<script>
(function(){
  const START_USD=2000, DEMO_BAL='__bag_demo_bag_v2', DEMO_INIT='__bag_demo_init_v2';
  const sEl=document.getElementById('sessionStatus'), bEl=document.getElementById('pracBag'), xEl=document.getElementById('pracXrp'), uEl=document.getElementById('pracUsd');
  const startBtn=document.getElementById('startSessionBtn'), topBtn=document.getElementById('topUpBtn'), endBtn=document.getElementById('endSessionBtn');

  const PR=()=>window.__PRICES__||{bagUsd:0,xrpUsd:0};
  const get=()=>{try{const n=Number(localStorage.getItem(DEMO_BAL)); return Number.isFinite(n)&&n>0?n:0;}catch{return 0}};
  const set=v=>{try{localStorage.setItem(DEMO_BAL,String(Math.max(0,Number(v)||0)));}catch{}};
  const nf=(n,d=6)=>Number(n||0).toLocaleString(undefined,{maximumFractionDigits:d});
  const usd=(n)=> (Number(n)||0).toLocaleString(undefined,{style:'currency',currency:'USD',minimumFractionDigits:2,maximumFractionDigits:2});

  function ensureSeed(){
    if(localStorage.getItem(DEMO_INIT)) return true;
    const {bagUsd}=PR(); if(!(bagUsd>0)) return false;
    set(START_USD/bagUsd); localStorage.setItem(DEMO_INIT,'1'); return true;
  }
  function render(){
    const {bagUsd,xrpUsd}=PR(); const bag=get();
    const valUSD = bagUsd>0? bag*bagUsd : START_USD;
    const valXRP = (bagUsd>0 && xrpUsd>0)? (bag*(bagUsd/xrpUsd)) : 0;
    sEl.innerHTML='Session: <span style="color:#2fbf6b">Practice</span>';
    bEl.textContent=nf(bag); xEl.textContent=nf(valXRP); uEl.textContent=usd(valUSD);
    startBtn.style.display='inline-block'; topBtn.style.display='none'; endBtn.style.display='none';
  }

  window.__bagSession={
    active:()=>true,
    get:()=>({addr:'demo',bag:get(),ts:Date.now()}),
    spend:(bag)=>{ const b=get(); if(!(bag>0)||b<bag) return false; set(b-bag); render(); dispatchEvent(new Event('bag:hudRefresh')); return true; },
    credit:(bag)=>{ if(!(bag>0)) return false; set(get()+bag); render(); dispatchEvent(new Event('bag:hudRefresh')); return true; }
  };

  function boot(){ if(!localStorage.getItem(DEMO_INIT)){ if(ensureSeed()) render(); } else render(); }
  addEventListener('bag:pricesUpdated', boot);
  boot();
  topBtn?.addEventListener('click', ()=>{ const {bagUsd}=PR(); if(bagUsd>0){ set(START_USD/bagUsd); render(); } });
})();
</script>

<!-- H2H state + wager (demo escrow) -->
<script>
(function(){
  const S=(window.__AH_MATCH__={role:null,code:null,connected:false,peerReady:false,youReady:false,wagerXrp:0, stakeYouLocked:0, stakePeerLocked:0});
  const $=s=>document.querySelector(s); const info=t=>{ const el=$('#matchStatus'); if(el) el.textContent=t; };
  const code=()=>{const A='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let o=''; for(let i=0;i<6;i++) o+=A[(Math.random()*A.length)|0]; return o; };

  $('#createMatchBtn')?.addEventListener('click',()=>{ if(S.connected) return; S.role='host'; S.code=code(); S.connected=true; S.youReady=true; info(`Hosting ${S.code} ‚Äî waiting for opponent`); });
  $('#joinMatchBtn')?.addEventListener('click',()=>{ if(S.connected) return; const c=($('#matchCodeInput')?.value||'').trim().toUpperCase(); if(!c) return alert('Enter a match code');
    S.role='guest'; S.code=c; S.connected=true; S.youReady=true; info(`Joined ${S.code} ‚Äî waiting for host`); });

  window.AH_MARK_PEER_READY=()=>{ S.peerReady=true; info(`Connected: ${S.code}`); };
  window.AH_CAN_START=()=> !S.connected || (S.connected && S.peerReady && S.stakeYouLocked>0 && S.stakePeerLocked>0);
})();
</script>

<script>
(function(){
  const S=window.__AH_MATCH__; const $=s=>document.querySelector(s);
  const PR=()=>window.__PRICES__||{bagUsd:0,xrpUsd:0};
  const xrp2bag=(x)=>{ const {bagUsd,xrpUsd}=PR(); return (bagUsd>0&&xrpUsd>0)? (x*xrpUsd)/bagUsd : 0; };
  const spend=(b)=>window.__bagSession?.spend?.(b); const credit=(b)=>window.__bagSession?.credit?.(b);
  const stat=t=>{ const el=$('#wagerStatus'); if(el) el.textContent=t; };
  const nf=(n,d=6)=>Number(n||0).toLocaleString(undefined,{maximumFractionDigits:d});

  // quick chips
  (function(){ const root=document.getElementById('wagerPresets'); if(!root) return;
    root.querySelectorAll('button[data-xrp]').forEach(btn=>btn.addEventListener('click',()=>{ const v=parseFloat(btn.getAttribute('data-xrp')||'0')||0;
      const inp=document.getElementById('wagerQty'); if(inp) inp.value=String(v);
      root.querySelectorAll('button').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
    }));
  })();

  document.getElementById('proposeWagerBtn')?.addEventListener('click',()=>{ const amt=parseFloat(document.getElementById('wagerQty')?.value||'0')||0;
    if(!(amt>0)) return alert('Enter a wager'); S.wagerXrp=amt; S.stakeYouLocked=0; S.stakePeerLocked=0; stat(`Proposed ${nf(amt)} XRP ‚Äî waiting peer`); });

  window.AH_ON_PEER_WAGER=(xrp)=>{ S.wagerXrp=Number(xrp)||0; S.stakeYouLocked=0; S.stakePeerLocked=0; stat(`Peer proposed ${nf(S.wagerXrp)} XRP ‚Äî lock to accept`); };

  document.getElementById('lockStakeBtn')?.addEventListener('click',()=>{
    if(!(S.wagerXrp>0)) return alert('No wager set');
    const need=xrp2bag(S.wagerXrp); if(!(need>0)) return alert('Live price unavailable');
    if(!spend(need)) return alert('Insufficient Practice balance');
    S.stakeYouLocked=need; stat(`You locked ${nf(S.wagerXrp)} XRP (${nf(need)} BAG). Waiting peer.`); dispatchEvent(new Event('bag:hudRefresh'));
  });

  window.AH_ON_PEER_LOCK=()=>{ S.stakePeerLocked=xrp2bag(S.wagerXrp||0); stat('Both locked'); dispatchEvent(new Event('bag:hudRefresh')); };

  window.AH_PAYOUT_SERIES=(result)=>{ const total=(S.stakeYouLocked||0)+(S.stakePeerLocked||0); if(!total) return;
    if(result==='win') credit(total); S.stakeYouLocked=0; S.stakePeerLocked=0; stat('No wager'); dispatchEvent(new Event('bag:hudRefresh')); };
})();
</script>

<!-- GAME CORE -->
<script>
(function(){
  const canvas=document.getElementById('air'), ctx=canvas.getContext('2d');
  function fit(){ const wrap=document.getElementById('boardWrap'); if(!wrap) return; const w=Math.min(wrap.clientWidth,1024), r=canvas.height/canvas.width;
    canvas.style.width=w+'px'; canvas.style.height=Math.round(w*r)+'px'; } addEventListener('resize',fit); fit();

  const W=canvas.width,H=canvas.height, GOAL=160, RINK={x:20,y:20,w:W-40,h:H-40,r:22}, MID=H/2;

  const puck={x:W/2,y:H/2,r:14,vx:0,vy:0,max:12,damp:0.995};
  const p1={x:W/2,y:H-90,r:26,isDown:false,ox:0,oy:0,lastX:null,lastY:null};
  const cpu={x:W/2,y:90,r:26,speed:7};

  let running=false, counting=false, bestOf=3, target=5, gameNo=1, g1=0,g2=0, s1=0,s2=0;
  const cd=document.getElementById('countdown'), ov=document.getElementById('startOverlay');
  const startBtn=document.getElementById('startBtn'), pracBtn=document.getElementById('practiceBtn');

  function clamp(v,a,b){return v<a?a:(v>b?b:v);}
  function resetPuck(dir=(Math.random()<0.5?1:-1)){
    puck.x=W/2;puck.y=H/2;
    const a=(Math.random()*Math.PI/3)+(Math.PI/6), s=6.5;
    puck.vx=s*Math.cos(a)*dir; puck.vy=s*Math.sin(a)*(Math.random()<0.5?-1:1);
  }
  function resetGame(){ g1=0; g2=0; resetPuck(); }
  function readOpts(){
    bestOf=parseInt(document.querySelector('input[name="series"]:checked')?.value||'3',10);
    target=parseInt(document.querySelector('input[name="target"]:checked')?.value||'5',10);
  }
  function canStart(){ return (typeof window.AH_CAN_START==='function')? window.AH_CAN_START() : true; }

  startBtn.onclick=()=>{ if(!canStart()) return alert('Both players must connect and lock stakes'); readOpts(); ov.style.display='none'; countdown(()=>{ gameNo=1;s1=0;s2=0; resetGame(); running=true; }); };
  pracBtn.onclick =()=>{ readOpts(); ov.style.display='none'; countdown(()=>{ gameNo=1;s1=0;s2=0; resetGame(); running=true; }); };

  async function countdown(cb){
    counting=true; cd.style.display='block'; window.__AH_AUDIO__?.beeps(3,.6);
    for(let i=3;i>0;i--){ cd.textContent=String(i); await new Promise(r=>setTimeout(r,600)); }
    cd.textContent='GO'; await new Promise(r=>setTimeout(r,300)); cd.style.display='none'; counting=false; cb&&cb();
  }

  // Pointer ‚Äî smooth slide (no hop)
  let pid=null;
  function xy(e){ const r=canvas.getBoundingClientRect(); return {x:(e.clientX-r.left)*(canvas.width/r.width),y:(e.clientY-r.top)*(canvas.height/r.height)}; }
  canvas.addEventListener('pointerdown',e=>{
    if(pid!==null) return; pid=e.pointerId||0; const {x,y}=xy(e);
    const dx=x-p1.x,dy=y-p1.y; if(dx*dx+dy*dy<= (p1.r*1.6)**2){ p1.isDown=true; p1.ox=x-p1.x; p1.oy=y-p1.y; p1.lastX=x; p1.lastY=y; }
    canvas.setPointerCapture && canvas.setPointerCapture(pid); e.preventDefault();
  },{passive:false});
  canvas.addEventListener('pointermove',e=>{
    if(pid!==(e.pointerId||0)||!p1.isDown) return; const {x,y}=xy(e);
    const nx=clamp(x-p1.ox, RINK.x+p1.r, RINK.x+RINK.w-p1.r);
    const ny=clamp(y-p1.oy, MID+p1.r, RINK.y+RINK.h-p1.r);
    const a=0.7; p1.x = p1.lastX? p1.x*(1-a)+nx*a : nx; p1.y = p1.lastY? p1.y*(1-a)+ny*a : ny;
    p1.lastX=nx; p1.lastY=ny; e.preventDefault();
  },{passive:false});
  addEventListener('pointerup',e=>{ if(pid!==(e.pointerId||0)) return; p1.isDown=false; pid=null; canvas.releasePointerCapture && canvas.releasePointerCapture(e.pointerId||0); },{passive:false});
  addEventListener('pointercancel',e=>{ if(pid!==(e.pointerId||0)) return; p1.isDown=false; pid=null; },{passive:false});

  function cpuAI(){
    const ty = (puck.y < MID || puck.vy < 0) ? clamp(puck.y, cpu.r, MID-cpu.r) : cpu.y;
    const tx = clamp(puck.x, RINK.x+cpu.r, RINK.x+RINK.w-cpu.r);
    const dx=tx-cpu.x, dy=ty-cpu.y, d=Math.hypot(dx,dy)||1, step=Math.min(cpu.speed,d);
    cpu.x+=dx/d*step; cpu.y+=dy/d*step;
  }

  function collide(a,b){
    const dx=b.x-a.x, dy=b.y-a.y, dist=Math.hypot(dx,dy), min=a.r+b.r;
    if(dist<min){
      const nx=dx/(dist||1), ny=dy/(dist||1), pen=min-dist;
      b.x+=nx*pen*0.6; b.y+=ny*pen*0.6;
      const dot=puck.vx*nx+puck.vy*ny;
      puck.vx=puck.vx-2*dot*nx; puck.vy=puck.vy-2*dot*ny;
      const sp=Math.hypot(puck.vx,puck.vy), m=puck.max; if(sp>m){ puck.vx=puck.vx/sp*m; puck.vy=puck.vy/sp*m; }
      if(a===p1) window.__AH_AUDIO__?.hit(); // sound ONLY on paddle hit
    }
  }

  function walls(){
    if(puck.x-puck.r<RINK.x){ puck.x=RINK.x+puck.r; puck.vx=-puck.vx; }
    if(puck.x+puck.r>RINK.x+RINK.w){ puck.x=RINK.x+RINK.w-puck.r; puck.vx=-puck.vx; }
    const L=W/2-GOAL/2, R=W/2+GOAL/2;
    if(puck.y-puck.r<RINK.y){
      if(puck.x>L && puck.x<R) score(1); else { puck.y=RINK.y+puck.r; puck.vy=-puck.vy; }
    }
    if(puck.y+puck.r>RINK.y+RINK.h){
      if(puck.x>L && puck.x<R) score(2); else { puck.y=RINK.y+RINK.h-puck.r; puck.vy=-puck.vy; }
    }
  }

  function score(who){
    p1.x=W/2; p1.y=H-90; cpu.x=W/2; cpu.y=90;
    if(who===1) g1++; else g2++;
    if(g1>=target || g2>=target){
      if(g1>g2) s1++; else s2++;
      window.__AH_AUDIO__?.buzzer();
      if(s1>bestOf/2 || s2>bestOf/2){
        // series end -> payout demo & reset
        window.AH_PAYOUT_SERIES && window.AH_PAYOUT_SERIES(s1>s2?'win':'loss');
        running=false; ov.style.display='grid'; return;
      } else { gameNo++; g1=0; g2=0; }
    }
    resetPuck(who===2?1:-1);
  }

  function step(){
    if(running && !counting){
      cpuAI();
      puck.x+=puck.vx; puck.y+=puck.vy; puck.vx*=puck.damp; puck.vy*=puck.damp;
      collide(p1,puck); collide(cpu,puck); walls();
    }
    draw(); requestAnimationFrame(step);
  }

  function draw(){
    ctx.clearRect(0,0,W,H);
    // table
    ctx.fillStyle='#0b2016'; ctx.strokeStyle='#1b4a2f'; ctx.lineWidth=2; roundRect(RINK.x,RINK.y,RINK.w,RINK.h,RINK.r); ctx.fill(); ctx.stroke();
    ctx.strokeStyle='#1f5a3a'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(RINK.x,MID); ctx.lineTo(RINK.x+RINK.w,MID); ctx.stroke();
    ctx.strokeStyle='#2b6a48'; ctx.lineWidth=4; ctx.beginPath(); ctx.moveTo(W/2-GOAL/2,RINK.y); ctx.lineTo(W/2+GOAL/2,RINK.y); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(W/2-GOAL/2,RINK.y+RINK.h); ctx.lineTo(W/2+GOAL/2,RINK.y+RINK.h); ctx.stroke();
    // hud
    ctx.fillStyle='#ffe175'; ctx.font='700 20px Inter, system-ui, sans-serif';
    ctx.textAlign='left'; ctx.fillText(`You ${g1}`, RINK.x+8, MID+44);
    ctx.textAlign='right'; ctx.fillText(`CPU ${g2}`, RINK.x+RINK.w-8, MID-12);
    ctx.fillStyle='#cfe1d6'; ctx.font='700 14px Inter, system-ui, sans-serif'; ctx.textAlign='center';
    ctx.fillText(`Game ${gameNo} / Best of ${bestOf} ¬∑ First to ${target}`, W/2, 34);
    ctx.fillText(`Series: You ${s1} ‚Äî ${s2} CPU`, W/2, 54);
    // actors
    ctx.fillStyle='#e0f2ea'; circ(puck.x,puck.y,puck.r); ctx.fill();
    ctx.fillStyle='#36c77a'; circ(p1.x,p1.y,p1.r); ctx.fill();
    ctx.fillStyle='#5aa0ff'; circ(cpu.x,cpu.y,cpu.r); ctx.fill();
  }
  function circ(x,y,r){ ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); }
  function roundRect(x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }

  resetGame(); draw(); step();
})();
</script>

<footer class="wrap" style="text-align:center;padding:14px 0;color:#a9b9af">
  ¬© 2025 $BAG Protocol ‚Äî getthebag.io ¬∑ Powered by $XRP
</footer>

</body>
</html>
