<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>$BAG Air Hockey — Arcade P2E</title>
<script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
<style>
html,body{margin:0;padding:0;height:100%;background:#021107;overflow:hidden;}
canvas{display:block;margin:auto;}
</style>
</head>
<body>
<script>
const config={
  type:Phaser.AUTO,
  scale:{mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH,width:1024,height:1536},
  backgroundColor:'#021107',
  physics:{default:'arcade',arcade:{debug:false,fps:120}},
  scene:{preload,create,update}
};

let puck,player,cpu,scoreText,topGoal,bottomGoal;
let scorePlayer=0,scoreCPU=0;
let touchTarget={x:0,y:0,active:false};
let prevPlayer={x:0,y:0};
let lastHit=0; // prevents multi-frame weak hits

new Phaser.Game(config);

/* ---------------- PRELOAD ---------------- */
function preload(){
  this.load.image('table','/arcade/assets/img/airhockey_table-1024.webp');
  this.load.image('puck','/arcade/assets/img/puck-1024.webp');
  this.load.image('paddle_gold','/arcade/assets/img/paddle_gold-1024.webp');
  this.load.image('paddle_green','/arcade/assets/img/paddle_green-1024.webp');
}

/* ---------------- CREATE ---------------- */
function create(){
  const w=this.scale.width,h=this.scale.height,cx=w/2,cy=h/2;
  this.add.image(cx,cy,'table').setDisplaySize(w,h);

  const goalW=260,goalH=40;
  topGoal=this.add.rectangle(cx,70,goalW,goalH,0xff0000,0.4);
  bottomGoal=this.add.rectangle(cx,h-70,goalW,goalH,0x00ff00,0.4);

  this.physics.world.setBounds(80,80,w-160,h-160);

  puck=this.physics.add.image(cx,cy,'puck').setScale(0.07);
  puck.setCollideWorldBounds(true).setBounce(0.99).setDamping(true)
      .setDrag(0.99,0.99).setMaxVelocity(1500);

  player=this.physics.add.image(cx,h*0.85,'paddle_gold').setScale(0.1);
  cpu=this.physics.add.image(cx,h*0.15,'paddle_green').setScale(0.1);

  player.body.collideWorldBounds=false;
  cpu.setCollideWorldBounds(true);
  player.setImmovable(true);
  cpu.setImmovable(true);

  this.physics.add.collider(puck,player,onHit,null,this);
  this.physics.add.collider(puck,cpu,onHit,null,this);

  this.input.on('pointerdown',p=>{
    if(p.y>h*0.5){touchTarget.active=true;touchTarget.x=p.x;touchTarget.y=p.y;}
  });
  this.input.on('pointermove',p=>{
    if(touchTarget.active && p.y>h*0.5){touchTarget.x=p.x;touchTarget.y=p.y;}
  });
  this.input.on('pointerup',()=>touchTarget.active=false);

  scoreText=this.add.text(cx,40,'0 - 0',{
    fontFamily:'Orbitron',fontSize:'48px',color:'#ffe175',
    stroke:'#2fbf6b',strokeThickness:3
  }).setOrigin(0.5,0);

  resetPuck.call(this);
}

/* ---------------- COLLISION ---------------- */
function onHit(puck,paddle){
  const now=performance.now();
  if(now-lastHit<60)return; // short cooldown to prevent multi-hit drag
  lastHit=now;

  const dx=puck.x-paddle.x, dy=puck.y-paddle.y;
  const dist=Math.sqrt(dx*dx+dy*dy)||1;
  const nx=dx/dist, ny=dy/dist;

  const vx=paddle.x-prevPlayer.x;
  const vy=paddle.y-prevPlayer.y;
  const paddleSpeed=Math.sqrt(vx*vx+vy*vy);

  // ⚡ Enhanced impulse system
  const base=350;
  const speedBoost=paddleSpeed*180;
  const randomKick=Phaser.Math.Between(0,80);
  const force=Phaser.Math.Clamp(base+speedBoost+randomKick,400,1600);

  puck.body.velocity.x = nx * force;
  puck.body.velocity.y = ny * force;
  puck.setAngularVelocity(Phaser.Math.Between(-200,200));

  // temporary low drag after hit = stronger glide
  puck.setDrag(0.985,0.985);
  setTimeout(()=>{puck.setDrag(0.99,0.99)},300);
}

/* ---------------- UPDATE ---------------- */
function update(){
  const w=this.scale.width,h=this.scale.height;
  prevPlayer.x=player.x;
  prevPlayer.y=player.y;

  if(touchTarget.active){
    const dx=touchTarget.x-player.x;
    const dy=touchTarget.y-player.y;
    const moveSpeed=0.5;
    player.x+=dx*moveSpeed;
    player.y+=dy*moveSpeed;
  }

  player.x=Phaser.Math.Clamp(player.x,100,w-100);
  player.y=Phaser.Math.Clamp(player.y,h*0.5+20,h-80);

  cpu.x+=(puck.x-cpu.x)*0.08;
  cpu.y+=(puck.y-cpu.y)*0.05;
  cpu.x=Phaser.Math.Clamp(cpu.x,100,w-100);
  cpu.y=Phaser.Math.Clamp(cpu.y,80,h*0.45);

  const goalHalfW=130;
  if(puck.y<topGoal.y && Math.abs(puck.x-w/2)<goalHalfW){
    scorePlayer++; resetPuck.call(this,'player');
    flashGoal(topGoal,0xff0000);
  }
  if(puck.y>bottomGoal.y && Math.abs(puck.x-w/2)<goalHalfW){
    scoreCPU++; resetPuck.call(this,'cpu');
    flashGoal(bottomGoal,0x00ff00);
  }
}

/* ---------------- FLASH EFFECT ---------------- */
function flashGoal(goal,color){
  goal.setFillStyle(color,0.9);
  setTimeout(()=>goal.setFillStyle(color,0.4),180);
}

/* ---------------- RESET ---------------- */
function resetPuck(scoredBy){
  const w=this.scale.width,h=this.scale.height;
  puck.setPosition(w/2,h/2);
  const angle=Phaser.Math.Between(20,160)*(Phaser.Math.Between(0,1)?1:-1);
  const speed=Phaser.Math.Between(600,750);
  const vx=Math.cos(angle*Math.PI/180)*speed;
  const vy=(scoredBy==='player'?-1:1)*Math.abs(Math.sin(angle*Math.PI/180)*speed);
  puck.setVelocity(vx,vy);
  scoreText.setText(`${scorePlayer} - ${scoreCPU}`);
}
</script>
</body>
</html>
