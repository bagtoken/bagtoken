<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>$BAG Air Hockey â€” Arcade P2E</title>
<script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
<style>
html,body{margin:0;padding:0;height:100%;background:#021107;overflow:hidden;}
canvas{display:block;margin:auto;}
</style>
</head>
<body>
<script>
const config={
  type:Phaser.AUTO,
  scale:{mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH,width:1024,height:1536},
  physics:{
    default:'arcade',
    arcade:{
      debug:false,
      fps:120,          // more physics checks per second
      timeScale:1,
      overlapBias:4,
      step:1/120
    }
  },
  backgroundColor:'#021107',
  scene:{preload,create,update}
};
let table,puck,player,cpu,scoreText,stickBase,stickKnob,stickPointer=null;
let scorePlayer=0,scoreCPU=0;
let stickVector=new Phaser.Math.Vector2(0,0);
const game=new Phaser.Game(config);

/* ---------------- PRELOAD ---------------- */
function preload(){
  this.load.image('table','/arcade/assets/img/airhockey_table-1024.webp');
  this.load.image('puck','/arcade/assets/img/puck-1024.webp');
  this.load.image('paddle_gold','/arcade/assets/img/paddle_gold-1024.webp');
  this.load.image('paddle_green','/arcade/assets/img/paddle_green-1024.webp');
}

/* ---------------- CREATE ---------------- */
function create(){
  const w=this.scale.width,h=this.scale.height,cx=w/2,cy=h/2;

  this.add.image(cx,cy,'table').setDisplaySize(w,h);
  this.physics.world.setBounds(90,80,w-180,h-160);

  puck=this.physics.add.image(cx,cy,'puck').setScale(0.07);
  puck.setCollideWorldBounds(true).setBounce(0.98).setDamping(true).setDrag(0.99,0.99).setMaxVelocity(600);

  player=this.physics.add.image(cx,h*0.9,'paddle_gold').setScale(0.1);
  cpu=this.physics.add.image(cx,h*0.1,'paddle_green').setScale(0.1);

  player.setCollideWorldBounds(true);
  cpu.setCollideWorldBounds(true);
  player.setImmovable(true);
  cpu.setImmovable(true);

  this.physics.add.collider(puck,player,onHit,null,this);
  this.physics.add.collider(puck,cpu,onHit,null,this);

  // --- Virtual thumb stick (bottom-right) ---
  const stickRadius=100;
  stickBase=this.add.circle(w-160,h-160,stickRadius,0x222222,0.5).setScrollFactor(0);
  stickKnob=this.add.circle(w-160,h-160,40,0xaaaaaa,0.8).setScrollFactor(0);

  stickKnob.setInteractive();
  this.input.on('pointerdown',p=>{
    if(Phaser.Math.Distance.Between(p.x,p.y,stickBase.x,stickBase.y)<stickRadius*1.2){
      stickPointer=p.id;
      moveStick(p);
    }
  });
  this.input.on('pointermove',p=>{
    if(stickPointer===p.id) moveStick(p);
  });
  this.input.on('pointerup',p=>{
    if(stickPointer===p.id){
      stickPointer=null;
      stickKnob.x=stickBase.x;
      stickKnob.y=stickBase.y;
      stickVector.set(0,0);
    }
  });

  // --- Score display ---
  scoreText=this.add.text(cx,40,'0 - 0',{
    fontFamily:'Orbitron',fontSize:'48px',color:'#ffe175',
    stroke:'#2fbf6b',strokeThickness:3
  }).setOrigin(0.5,0);

  resetPuck.call(this);
}

/* ---------------- STICK MOVEMENT ---------------- */
function moveStick(p){
  const dx=p.x-stickBase.x, dy=p.y-stickBase.y;
  const dist=Math.min(100,Math.sqrt(dx*dx+dy*dy));
  const angle=Math.atan2(dy,dx);
  stickKnob.x=stickBase.x+Math.cos(angle)*dist;
  stickKnob.y=stickBase.y+Math.sin(angle)*dist;
  stickVector.set(Math.cos(angle)*(dist/100),Math.sin(angle)*(dist/100));
}

/* ---------------- COLLISION ---------------- */
function onHit(puck,paddle){
  const dx=puck.x-paddle.x, dy=puck.y-paddle.y;
  const dist=Math.sqrt(dx*dx+dy*dy)||1;
  const nx=dx/dist, ny=dy/dist;
  const speed=paddle.body.velocity.length();
  const force=Phaser.Math.Clamp(speed*1.2,150,800);
  puck.body.velocity.x=nx*force;
  puck.body.velocity.y=ny*force;
}

/* ---------------- UPDATE ---------------- */
function update(){
  const w=this.scale.width,h=this.scale.height;

  // --- Player paddle from thumb stick ---
  const moveSpeed=8;
  player.x+=stickVector.x*moveSpeed;
  player.y+=stickVector.y*moveSpeed;
  player.x=Phaser.Math.Clamp(player.x,120,w-120);
  player.y=Phaser.Math.Clamp(player.y,h/2+120,h-120);

  // --- CPU AI ---
  cpu.x+=(puck.x-cpu.x)*0.06;
  if(puck.y<h/2) cpu.y+=(puck.y-cpu.y)*0.04;
  cpu.y=Phaser.Math.Clamp(cpu.y,120,h/2-120);

  // --- Goals ---
  const goalW=250;
  if(puck.y<100 && Math.abs(puck.x-w/2)<goalW/2){scorePlayer++;resetPuck.call(this,'player');}
  if(puck.y>h-100 && Math.abs(puck.x-w/2)<goalW/2){scoreCPU++;resetPuck.call(this,'cpu');}
}

/* ---------------- RESET PUCK ---------------- */
function resetPuck(scoredBy){
  const w=this.scale.width,h=this.scale.height;
  puck.setPosition(w/2,h/2);
  const angle=Phaser.Math.Between(25,155)*(Phaser.Math.Between(0,1)?1:-1);
  const speed=Phaser.Math.Between(300,400);
  const vx=Math.cos(angle*Math.PI/180)*speed;
  const vy=(scoredBy==='player'?-1:1)*Math.abs(Math.sin(angle*Math.PI/180)*speed);
  puck.setVelocity(vx,vy);
  scoreText.setText(`${scorePlayer} - ${scoreCPU}`);
}
</script>
</body>
</html>
