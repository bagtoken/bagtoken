<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>$BAG Air Hockey â€” Arcade P2E</title>
<script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
<style>
body{margin:0;background:#021107;overflow:hidden;}
canvas{display:block;margin:auto;}
</style>
</head>
<body>
<script>
const config={
  type:Phaser.AUTO,
  width:window.innerWidth,
  height:window.innerHeight,
  backgroundColor:"#021107",
  physics:{default:"arcade",arcade:{debug:false,fps:60}},
  scene:{preload,create,update}
};

let puck,player,cpuPaddle,scorePlayer=0,scoreCPU=0,scoreText;
let prevPlayerPos={x:0,y:0},playerVel={x:0,y:0};

const game=new Phaser.Game(config);

/* ---------- LOAD ---------- */
function preload(){
  const hiRes=window.innerWidth>1000?'1024':'960';
  this.load.image('table',`/arcade/assets/img/airhockey_table-${hiRes}.webp`);
  this.load.image('puck',`/arcade/assets/img/puck-${hiRes}.webp`);
  this.load.image('paddle_gold',`/arcade/assets/img/paddle_gold-${hiRes}.webp`);
  this.load.image('paddle_green',`/arcade/assets/img/paddle_green-${hiRes}.webp`);
}

/* ---------- CREATE ---------- */
function create(){
  const w=config.width,h=config.height;
  const cx=w/2,cy=h/2;
  this.add.image(cx,cy,'table').setDisplaySize(w,h);

  puck=this.physics.add.image(cx,cy,'puck').setScale(0.07);
  player=this.physics.add.image(cx,h*0.85,'paddle_gold').setScale(0.1);
  cpuPaddle=this.physics.add.image(cx,h*0.15,'paddle_green').setScale(0.1);

  puck.setCollideWorldBounds(true).setBounce(0.98).setCircle(puck.width/2).setDrag(20,20);
  player.setCollideWorldBounds(true).setImmovable(false);
  cpuPaddle.setCollideWorldBounds(true).setImmovable(false);

  this.physics.add.collider(puck,player,onPaddleHit,null,this);
  this.physics.add.collider(puck,cpuPaddle,onPaddleHit,null,this);

  // pointer control (bottom)
  this.input.on('pointermove',pointer=>{
    player.x=Phaser.Math.Clamp(pointer.x,60,w-60);
    player.y=Phaser.Math.Clamp(pointer.y,h/2+40,h-40);
  });

  scoreText=this.add.text(cx,20,`0 - 0`,{
    fontFamily:'Orbitron',fontSize:'32px',color:'#ffe175',
    stroke:'#2fbf6b',strokeThickness:3}).setOrigin(0.5,0);

  resetPuck();
}

/* ---------- PHYSICS REACTION ---------- */
function onPaddleHit(puck,paddle){
  // Calculate relative velocity between paddle and puck
  const relVelX = paddle.body.velocity.x - puck.body.velocity.x;
  const relVelY = paddle.body.velocity.y - puck.body.velocity.y;
  const relSpeed = Math.sqrt(relVelX*relVelX + relVelY*relVelY);

  // Determine direction from paddle center to puck center
  const dx = puck.x - paddle.x;
  const dy = puck.y - paddle.y;
  const len = Math.sqrt(dx*dx + dy*dy) || 1;
  const nx = dx / len, ny = dy / len;

  // Apply impulse based on relative speed (sweet spot boost)
  const force = Phaser.Math.Clamp(relSpeed * 0.4, 0, 400);
  const vx = nx * force;
  const vy = ny * force;

  puck.body.velocity.x += vx;
  puck.body.velocity.y += vy;

  // Add slight rotation for natural rebound
  puck.setAngularVelocity(Phaser.Math.Between(-50,50));
}

/* ---------- UPDATE ---------- */
function update(){
  const w=config.width,h=config.height;

  // Track player's velocity for impact calc
  playerVel.x = player.x - prevPlayerPos.x;
  playerVel.y = player.y - prevPlayerPos.y;
  prevPlayerPos.x = player.x;
  prevPlayerPos.y = player.y;

  // CPU AI (top)
  const targetX=puck.x;
  cpuPaddle.x += (targetX - cpuPaddle.x) * 0.08;
  cpuPaddle.y += (puck.y<h/2?1:-1) * 1.5;
  cpuPaddle.y = Phaser.Math.Clamp(cpuPaddle.y,40,h/2-40);

  // Goal zones
  if(puck.y < h*0.02 && Math.abs(puck.x-w/2)<120){
    scorePlayer++; resetPuck('player');
  }
  if(puck.y > h*0.98 && Math.abs(puck.x-w/2)<120){
    scoreCPU++; resetPuck('cpu');
  }
}

/* ---------- RESET ---------- */
function resetPuck(scoredBy){
  const w=config.width,h=config.height;
  puck.setPosition(w/2,h/2);
  const angle=Phaser.Math.Between(20,160)*(Phaser.Math.Between(0,1)?1:-1);
  const speed=Phaser.Math.Between(260,340);
  const vx=Math.cos(angle*Math.PI/180)*speed;
  const vy=(scoredBy==='player'?-1:1)*Math.abs(Math.sin(angle*Math.PI/180)*speed);
  puck.setVelocity(vx,vy);
  scoreText.setText(`${scorePlayer} - ${scoreCPU}`);
}
</script>
</body>
</html>
