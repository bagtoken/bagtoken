<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>$BAG Air Hockey â€” Arcade P2E</title>
<script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
<style>
html,body{margin:0;padding:0;height:100%;background:#021107;overflow:hidden;}
canvas{display:block;margin:0 auto;}
</style>
</head>
<body>
<script>
const config = {
  type: Phaser.AUTO,
  scale: {
    mode: Phaser.Scale.FIT,
    autoCenter: Phaser.Scale.CENTER_BOTH,
    width: 1024,
    height: 1536
  },
  backgroundColor:'#021107',
  physics:{default:'arcade',arcade:{debug:false,fps:60}},
  scene:{preload,create,update}
};

let table,puck,player,cpu,scoreText;
let scorePlayer=0,scoreCPU=0;
let playerPointer={x:0,y:0};

const game=new Phaser.Game(config);

/* ---------- PRELOAD ---------- */
function preload(){
  this.load.image('table','/arcade/assets/img/airhockey_table-1024.webp');
  this.load.image('puck','/arcade/assets/img/puck-1024.webp');
  this.load.image('paddle_gold','/arcade/assets/img/paddle_gold-1024.webp');
  this.load.image('paddle_green','/arcade/assets/img/paddle_green-1024.webp');
}

/* ---------- CREATE ---------- */
function create(){
  const w=this.scale.width,h=this.scale.height;
  const cx=w/2,cy=h/2;

  table=this.add.image(cx,cy,'table').setDisplaySize(w,h);

  // create puck + paddles
  puck=this.physics.add.image(cx,cy,'puck').setScale(0.07);
  puck.body.setCircle(puck.width*0.035); // correct scaled radius
  puck.setCollideWorldBounds(true).setBounce(0.95).setDamping(true).setDrag(0.99,0.99);
  puck.setMaxVelocity(600);

  player=this.physics.add.image(cx,h*0.9,'paddle_gold').setScale(0.1);
  player.body.setCircle(player.width*0.05);
  player.setImmovable(true);

  cpu=this.physics.add.image(cx,h*0.1,'paddle_green').setScale(0.1);
  cpu.body.setCircle(cpu.width*0.05);
  cpu.setImmovable(true);

  // world bounds (slightly inside table)
  this.physics.world.setBounds(60,40,w-120,h-80,true,true,true,true);

  // colliders
  this.physics.add.collider(puck,player,onHit,null,this);
  this.physics.add.collider(puck,cpu,onHit,null,this);

  // pointer control
  this.input.on('pointermove',p=>{
    playerPointer.x=p.x; playerPointer.y=p.y;
  });

  // score display
  scoreText=this.add.text(cx,40,'0 - 0',{
    fontFamily:'Orbitron',
    fontSize:'48px',
    color:'#ffe175',
    stroke:'#2fbf6b',
    strokeThickness:3
  }).setOrigin(0.5,0);

  resetPuck.call(this);
}

/* ---------- COLLISION REACTION ---------- */
function onHit(puck,paddle){
  const dx=puck.x-paddle.x, dy=puck.y-paddle.y;
  const dist=Math.sqrt(dx*dx+dy*dy)||1;
  const nx=dx/dist, ny=dy/dist;

  // approximate paddle velocity from its last move delta
  const speed=paddle.lastMoveSpeed||300;
  const impulse=Phaser.Math.Clamp(speed*1.3,200,700);
  puck.body.velocity.x = nx*impulse;
  puck.body.velocity.y = ny*impulse;
}

/* ---------- UPDATE ---------- */
function update(){
  const w=this.scale.width,h=this.scale.height;

  // --- Player movement with interpolation (adds velocity) ---
  const targetX=Phaser.Math.Clamp(playerPointer.x,80,w-80);
  const targetY=Phaser.Math.Clamp(playerPointer.y,h/2+80,h-80);
  const dx=targetX-player.x, dy=targetY-player.y;
  player.lastMoveSpeed=Math.sqrt(dx*dx+dy*dy)*3; // used in impulse
  player.x+=dx*0.3;
  player.y+=dy*0.3;

  // --- CPU AI ---
  cpu.x+=(puck.x-cpu.x)*0.05;
  if(puck.y<h/2) cpu.y+=(puck.y-cpu.y)*0.04;
  cpu.y=Phaser.Math.Clamp(cpu.y,80,h/2-80);

  // --- Goal detection ---
  const goalW=250;
  if(puck.y<60 && Math.abs(puck.x-w/2)<goalW/2){scorePlayer++;resetPuck.call(this,'player');}
  if(puck.y>h-60 && Math.abs(puck.x-w/2)<goalW/2){scoreCPU++;resetPuck.call(this,'cpu');}
}

/* ---------- RESET PUCK ---------- */
function resetPuck(scoredBy){
  const w=this.scale.width,h=this.scale.height;
  puck.setPosition(w/2,h/2);
  const angle=Phaser.Math.Between(25,155)*(Phaser.Math.Between(0,1)?1:-1);
  const speed=Phaser.Math.Between(280,360);
  const vx=Math.cos(angle*Math.PI/180)*speed;
  const vy=(scoredBy==='player'?-1:1)*Math.abs(Math.sin(angle*Math.PI/180)*speed);
  puck.setVelocity(vx,vy);
  scoreText.setText(`${scorePlayer} - ${scoreCPU}`);
}
</script>
</body>
</html>
