<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>$BAG PLINKO — $BAG Casino</title>

<style>
  *{box-sizing:border-box}
  :root{
    --bg:#020703; --fg:#f5f7f4; --muted:#aeb7af;
    --panel:#0b1b13; --panel2:#0d2217; --line:#173c27;
    --green:#2fbf6b; --gold:#ffd700; --red:#e25b5b;
    --shadow:rgba(0,0,0,.4);
  }
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  a{color:inherit;text-decoration:none}

  /* very top back button row */
  .topbar{max-width:1100px;margin:0 auto;padding:12px 16px}
  .btn{
    background:linear-gradient(180deg,var(--panel),var(--panel2));
    border:1px solid #183c27;color:var(--fg);
    padding:10px 14px;border-radius:10px;cursor:pointer;
    box-shadow:0 6px 16px var(--shadow);font-weight:600;letter-spacing:.2px
  }
  .btn:active{transform:translateY(1px)}
  .btn.gold{background:linear-gradient(180deg,#6b5412,#3e2d09);border:1px solid #8a6a1a;color:#ffdc73}
  .btn.green{background:linear-gradient(180deg,#113a22,#0b2a18);border:1px solid #1e6a3f;color:#baf2cd}
  .btn.ghost{background:transparent;border:1px solid #244330;color:#cfe6d8}

  .wrap{max-width:1100px;margin:0 auto;padding:0 16px 16px}
  .top-banner{display:flex;justify-content:center;margin:6px 0 8px}
  .top-banner img{width:220px;height:auto;filter:drop-shadow(0 6px 12px rgba(0,0,0,.45))}

  /* header row: center demo, right connect/session */
  header{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:10px;margin:6px 0 14px}
  .h-center{justify-self:center}
  .h-right{justify-self:end;display:flex;align-items:center;gap:10px}

  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}

  .panel{
    background:radial-gradient(140% 100% at 0% 0%,rgba(27,64,45,.55),transparent 60%), var(--panel);
    border:1px solid var(--line); border-radius:14px; padding:14px; box-shadow:0 10px 30px var(--shadow)
  }

  .stage{position:relative;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .canvas-wrap{position:relative;width:100%;max-width:640px;aspect-ratio:8/11}
  canvas{position:absolute;inset:0;width:100%;height:100%}

  .hud{position:absolute;top:10px;left:10px;right:10px;display:flex;justify-content:space-between;flex-wrap:wrap;gap:6px;pointer-events:none}
  .pill{background:#0a1e15;border:1px solid #244330;border-radius:999px;padding:6px 10px;font-size:12px;color:#cfe6d8}

  .cele{position:absolute;inset:0;display:none;align-items:center;justify-content:center;font-size:42px;font-weight:900;color:#ffe28c;text-shadow:0 4px 14px rgba(0,0,0,.6)}
  .cele.show{display:flex;animation:pop .9s ease}
  @keyframes pop{0%{transform:scale(.7);opacity:0}50%{transform:scale(1.06);opacity:1}100%{transform:scale(1)}}

  label{font-size:12px;color:var(--muted)}
  input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #244330;background:#0a1e15;color:#f5f7f4}
  .row{display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap}
  .slots{display:flex;gap:6px;margin-top:6px}
  .slot{flex:1;text-align:center;border:1px dashed #2a4d38;border-radius:8px;padding:8px}
  .slot.jack{border-color:#8a6a1a;background:rgba(138,106,26,.08)}
  .note{color:#9fb4a7;font-size:12px}
</style>
</head>
<body>

  <!-- Back to Casino at the absolute top-left (above the banner) -->
  <div class="topbar">
    <a class="btn ghost" href="/casino.html">⬅️ Back to Casino</a>
  </div>

  <div class="wrap">
    <!-- Centered art banner (your path) -->
    <div class="top-banner"><img src="/assets/bag-plinko.png" alt="$BAG PLINKO"></div>

    <header>
      <div></div>
      <div class="h-center">
        <button id="btnAuto" class="btn green" title="Auto drops every 2s">Auto-Demo: Off</button>
      </div>
      <div class="h-right">
        <button id="btnConnect" class="btn gold">Connect Xaman</button>
        <button id="btnSession" class="btn green">Start Session</button>
      </div>
    </header>

    <div class="grid">
      <section class="panel stage">
        <div class="canvas-wrap">
          <canvas id="game"></canvas>
          <div class="hud">
            <span class="pill">Mode: <b id="modeLbl">Demo</b></span>
            <span class="pill">Balance: <b id="balLbl">100.00</b> <span id="ccyLbl">XRP</span></span>
            <span class="pill">Bet: <b id="betLbl">1</b></span>
            <span class="pill">Last: <b id="lastLbl">—</b></span>
          </div>
          <div id="cele" class="cele"></div>
        </div>
      </section>

      <aside class="panel">
        <div class="row">
          <div style="flex:1"><label>Stake</label><input id="stake" type="number" min="1" step="1" value="1"></div>
          <div style="width:140px"><label>Currency</label>
            <select id="currency"><option value="XRP">XRP</option><option value="BAG">$BAG</option></select>
          </div>
        </div>
        <div class="row">
          <button id="btnDrop" class="btn green" style="flex:1">Drop Coin</button>
          <button id="btnCashout" class="btn gold" style="width:150px">Cash Out</button>
        </div>

        <h3>Payouts</h3>
        <div class="slots">
          <div class="slot"><b>Scratch</b><br><span style="color:#aeb7af">Lose</span></div>
          <div class="slot"><b>1.2×</b><br><span style="color:#aeb7af">Instant Win</span></div>
          <div class="slot jack"><b>2×</b><br><span style="color:#aeb7af">Jackpot</span></div>
        </div>
        <p class="note">Minimum bet $1. Demo always works. Connected mode uses your server RNG and settles on-ledger.</p>
      </aside>
    </div>
  </div>

<script>
(() => {
  // ====== CONFIG (Option 3) ======
  const PAY_MAP = ['L', 1.2, 'L', 2, 'L', 1.2, 'L']; // left -> right
  const SLOT_COUNT = PAY_MAP.length;            // 7
  const PEG_ROWS = 12, PEG_COLS = 11;           // grid

  // tuned physics (anti-stick + finish line)
  const GRAVITY = 0.36, RESTITUTION = 0.78, FRICTION = 0.997;
  const PEG_R = 6, BALL_R = 9, WALL_PAD = 16;
  const DROP_Y = 60;

  // Sounds (files optional; fallback synth if missing)
  const SND = {
    peg:   '/assets/audio/peg.mp3',
    drop:  '/assets/audio/drop.mp3',
    win:   '/assets/audio/win.mp3',
    jack:  '/assets/audio/jackpot.mp3',
    lose:  '/assets/audio/lose.mp3'
  };
  let audioCtx=null; let unlocked=false;
  function unlockAudio(){ if(unlocked) return; try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); unlocked=true; }catch{} }

  // ====== STATE ======
  let mode='Demo', balance=100, stake=1, currency='XRP', lastTxt='—';
  let autoTimer=null, dropping=false;

  // ====== CANVAS ======
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const W=640, H=880; // logical resolution; no CSS scaling issues
  function size(){ canvas.width=W; canvas.height=H; }
  size();

  // ====== BOARD GEO ======
  const pegs=[];
  const leftWall=WALL_PAD, rightWall=W-WALL_PAD;
  const topBoard=110, bottomBoard=H-120;

  const pegSpacingX=(rightWall-leftWall-40)/(PEG_COLS-1);
  const pegSpacingY=(bottomBoard-topBoard-100)/(PEG_ROWS-1);

  for(let r=0;r<PEG_ROWS;r++){
    const off=(r%2===0)?0:pegSpacingX/2;
    for(let c=0;c<PEG_COLS;c++){
      let x=leftWall+20+c*pegSpacingX+off;
      if(x<=leftWall+PEG_R || x>=rightWall-PEG_R) continue;
      let y=topBoard+r*pegSpacingY;
      pegs.push({x,y,r:PEG_R});
    }
  }

  const slotTop=bottomBoard+10;
  const slotWidth=(rightWall-leftWall)/SLOT_COUNT;
  const slotX=i=>leftWall+i*slotWidth;
  const slotCenters=Array.from({length:SLOT_COUNT},(_,i)=>slotX(i)+slotWidth/2);

  // ====== BALL ======
  let ball=null;
  function newBall(){
    const x=W/2, y=DROP_Y, vx=(Math.random()-.5)*0.25, vy=0;
    ball={x,y,vx,vy,r:BALL_R,alive:true,frames:0};
  }

  // ====== UI ======
  const $=id=>document.getElementById(id);
  const modeLbl=$('modeLbl'), balLbl=$('balLbl'), ccyLbl=$('ccyLbl'), betLbl=$('betLbl'), lastLbl=$('lastLbl');
  function hud(){ balLbl.textContent=balance.toFixed(2); ccyLbl.textContent=currency; betLbl.textContent=String(stake); lastLbl.textContent=lastTxt; }
  $('currency').onchange=e=>{currency=e.target.value; hud();};
  $('stake').oninput=e=>{stake=Math.max(1,Math.floor(+e.target.value||1)); e.target.value=stake; hud();};

  // Gesture to unlock audio on first interaction
  document.addEventListener('pointerdown', unlockAudio, {once:true});

  $('btnDrop').onclick=()=>{ unlockAudio(); drop(); };
  $('btnCashout').onclick=()=>toast('Cash out wired later');
  $('btnConnect').onclick=()=>toast('Xaman wired later');
  $('btnSession').onclick=()=>{mode='Connected'; modeLbl.textContent=mode; toast('Session started (demo mirror)');};
  $('btnAuto').onclick=()=>{
    unlockAudio();
    if(autoTimer){clearInterval(autoTimer); autoTimer=null; $('btnAuto').textContent='Auto-Demo: Off'; return;}
    $('btnAuto').textContent='Auto-Demo: On'; drop(); autoTimer=setInterval(drop,2000);
  };

  function drop(){
    if(dropping) return;
    if(balance<stake){ toast('Insufficient demo funds'); return; }
    balance -= stake; lastTxt='—'; hud();
    newBall(); dropping=true; play('drop');
  }

  // ====== GAME LOOP (with safety watchdog) ======
  let rafId=null, lastFrameTs=performance.now();
  function loop(ts){
    if(ts - lastFrameTs > 2000){ // watchdog: restart draw if ever stalls
      // no-op; just keeps running
    }
    lastFrameTs = ts;

    drawBoard();
    if(ball && ball.alive){
      stepBall();
      drawBall(ball.x, ball.y);
    }
    rafId = requestAnimationFrame(loop);
  }
  rafId = requestAnimationFrame(loop);

  function stepBall(){
    ball.frames++;

    // integrate
    ball.vy += GRAVITY;
    ball.x += ball.vx; ball.y += ball.vy;
    ball.vx *= FRICTION; ball.vy *= FRICTION;

    // walls
    if(ball.x - BALL_R < leftWall){ ball.x = leftWall + BALL_R; ball.vx = Math.abs(ball.vx)*RESTITUTION; }
    if(ball.x + BALL_R > rightWall){ ball.x = rightWall - BALL_R; ball.vx = -Math.abs(ball.vx)*RESTITUTION; }
    if(ball.y - BALL_R < 0){ ball.y = BALL_R; ball.vy = 0; }

    // pegs
    for(const p of pegs){
      const dx=ball.x-p.x, dy=ball.y-p.y;
      const dist=Math.hypot(dx,dy) || 0.0001;
      const minD=BALL_R + p.r;
      if(dist < minD){
        const nx = dx / dist, ny = dy / dist;
        const overlap = (minD - dist) + 0.25;
        ball.x += nx * overlap; ball.y += ny * overlap;
        const vDotN = ball.vx*nx + ball.vy*ny;
        ball.vx = (ball.vx - 2*vDotN*nx) * RESTITUTION;
        ball.vy = (ball.vy - 2*vDotN*ny) * RESTITUTION;
        play('peg');
        // anti-stick jitter
        const speed = Math.hypot(ball.vx, ball.vy);
        if(speed < 0.22){ ball.vx += (Math.random()-.5)*0.65; ball.vy += 0.45; }
      }
    }

    // finish line: ensure it always resolves
    if(ball.y + BALL_R >= bottomBoard){
      // weak floor damping & nudge to ensure crossing dividers
      ball.vy = Math.max(ball.vy*0.96, 0.12);
      if(ball.y >= slotTop + 46 || ball.frames > 1800){
        resolveNow();
      }
    }
  }

  function resolveNow(){
    const idx = Math.min(SLOT_COUNT-1, Math.max(0, Math.floor((ball.x-leftWall)/slotWidth)));
    resolveDrop(idx);
    ball.alive=false; dropping=false; ball=null; // full reset for next play
  }

  // ====== RENDER ======
  function drawBoard(){
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle='#0b1b13'; ctx.fillRect(0,0,W,H);

    // frame box
    ctx.strokeStyle='#1c3b27'; ctx.lineWidth=4;
    ctx.strokeRect(leftWall-8, topBoard-40, rightWall-leftWall+16, bottomBoard-topBoard+60);

    // pegs
    ctx.fillStyle='#704d1d';
    for(const p of pegs){ ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill(); }

    // floor & dividers
    ctx.strokeStyle='#2a4d38'; ctx.lineWidth=3;
    ctx.beginPath(); ctx.moveTo(leftWall, bottomBoard); ctx.lineTo(rightWall, bottomBoard); ctx.stroke();
    for(let i=1;i<SLOT_COUNT;i++){
      const x = slotX(i);
      ctx.beginPath(); ctx.moveTo(x, bottomBoard); ctx.lineTo(x, bottomBoard+50); ctx.stroke();
    }

    // labels
    ctx.font='14px system-ui, -apple-system, Segoe UI, Roboto, Arial'; ctx.textAlign='center';
    for(let i=0;i<SLOT_COUNT;i++){
      const rule = PAY_MAP[i];
      const txt = rule==='L' ? 'Scratch' : (rule===2 ? '2×' : '1.2×');
      ctx.fillStyle = rule==='L' ? '#e25b5b' : (rule===2 ? '#ffd700' : '#baf2cd');
      ctx.fillText(txt, slotCenters[i], bottomBoard+72);
    }
  }

  function drawBall(x,y){
    const r=BALL_R;
    const g=ctx.createRadialGradient(x-4,y-4,2,x,y,r);
    g.addColorStop(0,'#ffd36d'); g.addColorStop(.6,'#c8911e'); g.addColorStop(1,'#8b5e13');
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
  }

  // ====== RESOLVE / CELEBRATE ======
  const cele=document.getElementById('cele');
  function resolveDrop(slot){
    const rule = PAY_MAP[slot] ?? 'L';
    if(rule==='L'){ lastTxt='Scratch'; showCele('SCRATCH'); play('lose'); hud(); return; }
    const mult = Number(rule);
    const payout = Math.floor(stake * mult * 100)/100;
    balance += payout; hud();
    if(mult===2){ lastTxt='Jackpot 2×'; showCele('JACKPOT 2×'); play('jack'); }
    else { lastTxt='Win 1.2×'; showCele('WIN 1.2×'); play('win'); }
  }
  function showCele(text){
    cele.textContent=text; cele.classList.remove('show'); void cele.offsetWidth; cele.classList.add('show');
    setTimeout(()=>cele.classList.remove('show'),1100);
  }

  // ====== SOUND ======
  async function play(kind){
    try{
      if(!audioCtx) return;                 // no audio on lock
      const url = SND[kind];
      if(url){
        const res = await fetch(url);
        if(res.ok){
          const buf = await res.arrayBuffer();
          const audio = await audioCtx.decodeAudioData(buf);
          const src = audioCtx.createBufferSource(); src.buffer=audio;
          src.connect(audioCtx.destination); src.start();
          return;
        }
      }
    }catch{}
    // Fallback synth
    try{
      if(!audioCtx) return;
      const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
      o.connect(g); g.connect(audioCtx.destination);
      const tones = {peg:520, drop:220, win:880, jack:1020, lose:180};
      o.frequency.value = tones[kind] || 400; g.gain.value = .08;
      o.start(); setTimeout(()=>o.stop(), kind==='jack'?340:140);
    }catch{}
  }

  // ====== HELPERS ======
  function toast(msg){
    const t=document.createElement('div'); t.textContent=msg;
    Object.assign(t.style,{position:'fixed',bottom:'20px',left:'50%',transform:'translateX(-50%)',
      background:'#0a1e15',color:'#fff',border:'1px solid #244330',padding:'10px 14px',borderRadius:'10px',zIndex:9999});
    document.body.appendChild(t); setTimeout(()=>t.remove(),1500);
  }

  // boot
  hud();
})();
</script>
</body>
</html>
