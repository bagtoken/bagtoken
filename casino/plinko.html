<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>$BAG PLINKO — $BAG Casino</title>

<link rel="preconnect" href="https://api.coingecko.com" crossorigin>
<script src="https://xaman.app/assets/cdn/xumm.min.js"></script>

<style>
  *{box-sizing:border-box}
  :root{
    --gold:#ffd700;--bg:#020703;--panel:#0b1b13;--panel2:#0d2217;
    --muted:#aeb7af;--fg:#f5f7f4;--green:#2fbf6b;--red:#e25b5b;
    --shadow:rgba(0,0,0,.35);
  }
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  .top-banner{display:flex;justify-content:center;margin-top:16px;margin-bottom:12px}
  .top-banner img{width:220px;max-width:80%;height:auto;filter:drop-shadow(0 6px 12px rgba(0,0,0,.45))}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  .left,.right{display:flex;gap:10px;align-items:center}
  .btn{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid #183c27;
    color:var(--fg);padding:10px 14px;border-radius:10px;cursor:pointer;
    box-shadow:0 6px 16px var(--shadow);font-weight:600;letter-spacing:.2px}
  .btn:active{transform:translateY(1px)}
  .btn.gold{background:linear-gradient(180deg,#6b5412,#3e2d09);border-color:#8a6a1a;color:#ffdc73}
  .btn.green{background:linear-gradient(180deg,#113a22,#0b2a18);border-color:#1e6a3f;color:#baf2cd}
  .btn.ghost{background:transparent;border:1px solid #244330;color:#cfe6d8}
  .grid{display:grid;grid-template-columns:1.3fr .7fr;gap:18px}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}
  .panel{background:radial-gradient(140% 100% at 0% 0%,rgba(27,64,45,.55),transparent 60%),var(--panel);
    border:1px solid #173c27;border-radius:14px;padding:16px;box-shadow:0 10px 30px var(--shadow)}
  .stage{position:relative;min-height:560px;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .cele{position:absolute;inset:0;display:none;align-items:center;justify-content:center;font-size:44px;font-weight:900;
    color:#ffe28c;text-shadow:0 4px 14px rgba(0,0,0,.6)}
  .cele.show{display:flex;animation:pop .9s ease}
  @keyframes pop{0%{transform:scale(.7);opacity:0}50%{transform:scale(1.06);opacity:1}100%{transform:scale(1);opacity:1}}
  label{font-size:12px;color:var(--muted)}
  input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #244330;background:#0a1e15;color:var(--fg)}
  .slots{display:flex;gap:6px;margin-top:6px}
  .slot{flex:1;text-align:center;border:1px dashed #2a4d38;border-radius:8px;padding:8px}
  .slot.jack{border-color:#8a6a1a;background:rgba(138,106,26,.08)}
  .note{color:#9fb4a7;font-size:12px}
  .muted{color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <div class="top-banner">
      <img src="/assets/img/bag-plinko.png" alt="$BAG PLINKO"/>
    </div>

    <header>
      <div class="left">
        <a class="btn ghost" href="/casino.html">⬅️ Back to Casino</a>
      </div>
      <div class="right">
        <button id="btnConnect" class="btn gold">Connect Xaman</button>
        <button id="btnSession" class="btn green">Start Session</button>
      </div>
    </header>

    <div class="grid">
      <section class="panel stage">
        <canvas id="canvas" width="640" height="820"></canvas>
        <div id="cele" class="cele"></div>
      </section>

      <aside class="panel">
        <div style="margin-bottom:12px">
          <label>Stake</label>
          <input id="stake" type="number" min="1" step="1" value="1">
        </div>
        <div style="margin-bottom:12px">
          <label>Currency</label>
          <select id="currency"><option>XRP</option><option>$BAG</option></select>
        </div>
        <button id="btnDrop" class="btn green" style="width:100%;margin-bottom:8px">Drop Coin</button>
        <button id="btnCashout" class="btn gold" style="width:100%;margin-bottom:16px">Cash Out</button>

        <h3>How it plays</h3>
        <ul>
          <li>Pick stake & currency then hit Drop Coin</li>
          <li>Chip bounces through pegs into a slot</li>
          <li>Demo always works — Connected mode settles on-ledger</li>
        </ul>
        <h3>Payouts</h3>
        <div class="slots">
          <div class="slot"><b>Scratch</b><br><span class="muted">Lose</span></div>
          <div class="slot"><b>1.2×</b><br><span class="muted">Instant Win</span></div>
          <div class="slot jack"><b>2×</b><br><span class="muted">Jackpot</span></div>
        </div>
        <p class="note">Minimum bet $1. Demo mode balance 100 XRP/$BAG.</p>
      </aside>
    </div>
  </div>

<script>
(() => {
  const BOARD_W=640,BOARD_H=820,ROWS=8,SLOTS=7;
  const PAY_MAP=['L',1.2,'L',2,'L',1.2,'L'];
  let balance=100,stake=1,currency='XRP';

  const cv=document.getElementById('canvas'),cx=cv.getContext('2d');
  const cele=document.getElementById('cele');

  document.getElementById('currency').onchange=e=>currency=e.target.value;
  document.getElementById('stake').oninput=e=>{
    stake=Math.max(1,Math.floor(+e.target.value||1));e.target.value=stake;
  };

  document.getElementById('btnDrop').onclick=()=>{
    if(balance<stake){toast('Insufficient demo funds');return;}
    balance-=stake;
    const slot=simulate(cryptoSeed());
    animate(slot,()=>{const r=resolve(slot);if(r.win)balance+=r.delta;celebrate(r);});
  };

  function simulate(seed){
    const rng=mulberry32(seed);let pos=Math.floor(SLOTS/2);
    for(let i=0;i<ROWS;i++)pos=Math.max(0,Math.min(SLOTS-1,pos+(rng()<.5?-1:1)));
    return pos;
  }
  function resolve(slot){
    const rule=PAY_MAP[slot];if(rule==='L')return{win:!1,delta:0,jack:!1};
    const mult=Number(rule),gain=Math.floor(stake*mult*100)/100;
    return{win:!0,delta:gain,jack:mult===2};
  }
  function animate(slot,done){
    cx.clearRect(0,0,BOARD_W,BOARD_H);drawLabels();
    const path=build(slot),chip={x:path[0].x,y:path[0].y,i:0};
    const step=()=>{
      const n=path[chip.i+1];if(!n){done();return;}
      const dx=n.x-chip.x,dy=n.y-chip.y,dist=Math.hypot(dx,dy);
      const spd=8;if(dist<=spd){chip.x=n.x;chip.y=n.y;chip.i++;}
      else{chip.x+=spd*dx/dist;chip.y+=spd*dy/dist;}
      cx.clearRect(0,0,BOARD_W,BOARD_H);drawLabels();drawChip(chip.x,chip.y);
      requestAnimationFrame(step);
    };requestAnimationFrame(step);
  }
  function build(slot){
    const colW=BOARD_W/(SLOTS+1),p=[{x:BOARD_W/2,y:140}];let cur=Math.floor(SLOTS/2);
    for(let r=0;r<ROWS;r++){
      const dir=slot>cur?1:slot<cur?-1:(Math.random()<.5?-1:1);
      cur=Math.max(0,Math.min(SLOTS-1,cur+dir));
      p.push({x:colW*(cur+1),y:180+r*60});
      p.push({x:colW*(cur+1),y:180+r*60+40});
    }
    p.push({x:colW*(slot+1),y:BOARD_H-70});return p;
  }
  function drawChip(x,y){
    cx.beginPath();cx.arc(x,y,10,0,2*Math.PI);
    const g=cx.createRadialGradient(x-4,y-4,2,x,y,10);
    g.addColorStop(0,'#ffd36d');g.addColorStop(.6,'#c8911e');g.addColorStop(1,'#8b5e13');
    cx.fillStyle=g;cx.fill();
  }
  function drawLabels(){
    const colW=BOARD_W/(PAY_MAP.length+1);cx.font='12px system-ui';cx.textAlign='center';
    PAY_MAP.forEach((r,i)=>{
      const x=colW*(i+1),y=BOARD_H-28;
      const t=r==='L'?'Scratch':(r===2?'2×':'1.2×');
      cx.fillStyle=r==='L'?'#e25b5b':(r===2?'#ffd700':'#baf2cd');
      cx.fillText(t,x,y);
    });
  }
  function celebrate(r){
    cele.textContent=r.jack?'JACKPOT 2×':(r.win?'WIN 1.2×':'SCRATCH');
    cele.classList.remove('show');void cele.offsetWidth;cele.classList.add('show');
    setTimeout(()=>cele.classList.remove('show'),1100);
  }
  function cryptoSeed(){const a=new Uint32Array(1);crypto.getRandomValues(a);return a[0];}
  function mulberry32(a){return()=>{let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);
    t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}}
  function toast(m){const t=document.createElement('div');t.textContent=m;
    Object.assign(t.style,{position:'fixed',bottom:'20px',left:'50%',transform:'translateX(-50%)',
    background:'#0a1e15',color:'#fff',border:'1px solid #244330',
    padding:'10px 14px',borderRadius:'10px',zIndex:9999});document.body.append(t);
    setTimeout(()=>t.remove(),1500);}
  drawLabels();
})();
</script>
</body>
</html>
