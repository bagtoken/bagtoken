<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>$BAG Plinko</title>

<link rel="preconnect" href="https://api.coingecko.com" crossorigin>
<script src="https://xaman.app/assets/cdn/xumm.min.js"></script>

<style>
  *{box-sizing:border-box}
  :root{
    --gold:#ffd700;--bg:#020703;--panel:#0b1b13;--panel2:#0d2217;--muted:#aeb7af;--fg:#f5f7f4;
    --green:#2fbf6b;--green2:#34c759;--line:#173524;--shadow:rgba(0,0,0,.35);
    --red:#e25b5b;
  }
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.55}
  img{display:block;max-width:100%;height:auto}
  button,input{font-size:16px}

  /* üîô Back to Casino button ‚Äî unchanged */
  .back-casino {
    position: fixed; top: 18px; left: 18px; z-index: 1000;
    background: linear-gradient(180deg,#ffe175 0%, #f5c94c 100%);
    color: #08130d; text-decoration: none; font-weight: 800;
    padding: 8px 14px; border-radius: 10px; box-shadow: 0 4px 0 #b08a19; transition: all .15s ease;
  }
  .back-casino:hover { filter: brightness(1.05); box-shadow: 0 4px 0 #b08a19, 0 14px 28px rgba(255,225,117,.22); }
  .back-casino:active { transform: translateY(1px); box-shadow: 0 3px 0 #9a7315; }
  @media (max-width: 640px){ .back-casino{ font-size:.9rem; padding:7px 12px; } }

  /* ===== Layout ‚Äî unchanged ===== */
  .game-header{text-align:center;padding:36px 10px 14px}
  .game-header img.hero-img{margin-bottom:10px;filter:drop-shadow(0 10px 24px rgba(46,191,107,.18))}
  .game-header h2{font-size:clamp(1.6rem,5vw,2.2rem);margin:6px 0 0}
  @media (min-width: 900px){
    .game-header img.hero-img{ width: 34vw; max-width: 420px; margin-left: auto; margin-right: auto; }
  }
  .game-teaser{padding:10px 16px 60px;background:
    radial-gradient(1200px 600px at 10% -10%, #0e2c1d 0%, transparent 60%),
    radial-gradient(900px 500px at 110% 20%, #0b2318 0%, transparent 55%),#060806;
    border-top:1px solid #131313;border-bottom:1px solid #131313}
  .game-wrap{max-width:1080px;margin:0 auto;display:grid;grid-template-columns:1.12fr .88fr;gap:22px}
  @media (max-width:900px){.game-wrap{grid-template-columns:1fr}}

  .panel{background:linear-gradient(180deg,var(--panel) 0%,var(--panel2) 100%);border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 24px var(--shadow)}
  .mock{padding:16px}
  .section-title{font-weight:800;font-size:1.2rem;margin:0 0 12px}

  .stack{display:grid;gap:10px}
  .choice{display:flex;gap:10px;flex-wrap:wrap}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid #2b6a48;background:#0e2a1c;color:#e9efe9;font-weight:800}
  .chip input{accent-color:#2fbf6b}
  .mono{font-variant-numeric:tabular-nums}
  .micro{font-size:.85rem;color:#a8b5ab}
  .muted{color:#cfd6cf}
  .divider{height:1px;background:#123221;margin:10px 0}
  .callout{margin-top:12px;padding:12px;border:1px dashed #29543d;border-radius:12px;background:#0c2418;color:#e4efe7}

  .btn-roll{
    width:100%;margin-top:12px;padding:16px 22px;font-size:1.15rem;font-weight:900;text-transform:uppercase;
    letter-spacing:.5px;border:0;border-radius:14px;color:#08130d;background:linear-gradient(180deg,#ffe175 0%, #f5c94c 100%);
    box-shadow:0 6px 0 #b08a19, 0 16px 32px rgba(255,225,117,.18), inset 0 1px 0 rgba(255,255,255,.35);
    transition:transform .06s ease, box-shadow .2s ease, filter .2s ease; cursor:pointer;
  }
  .btn-roll:hover{filter:brightness(1.05);box-shadow:0 6px 0 #b08a19, 0 22px 40px rgba(255,225,117,.26), inset 0 1px 0 rgba(255,255,255,.4)}
  .btn-roll:active{transform:translateY(2px);box-shadow:0 4px 0 #9a7315, 0 12px 24px rgba(255,225,117,.2), inset 0 1px 0 rgba(255,255,255,.3)}
  .btn-roll:disabled{opacity:.65;cursor:not-allowed;transform:none;box-shadow:0 6px 0 #6e6e6e, 0 10px 20px rgba(0,0,0,.2)!important}

  .result{margin-top:12px;padding:12px;border:1px solid #1b4a2f;border-radius:12px;background:#0b2217;display:flex;align-items:center;gap:10px}
  .result .n{font-weight:900;font-size:1.05rem}

  /* ===== Plinko visuals ‚Äî unchanged shell ===== */
  .stage{position:relative;display:flex;align-items:center;justify-content:center;overflow:hidden;margin-top:10px}
  .canvas-wrap{position:relative;width:100%;max-width:640px;aspect-ratio:8/11}
  canvas{position:absolute;inset:0;width:100%;height:100%}
  .hud{position:absolute;top:10px;left:10px;right:10px;display:flex;justify-content:space-between;flex-wrap:wrap;gap:6px;pointer-events:none}
  .pill{background:#0a1e15;border:1px solid #244330;border-radius:999px;padding:6px 10px;font-size:12px;color:#cfe6d8}
  .cele{position:absolute;inset:0;display:none;align-items:center;justify-content:center;font-size:42px;font-weight:900;color:#ffe28c;text-shadow:0 4px 14px rgba(0,0,0,.6)}
  .cele.show{display:flex;animation:pop .9s ease}
  @keyframes pop{0%{transform:scale(.7);opacity:0}50%{transform:scale(1.06);opacity:1}100%{transform:scale(1)}}
</style>
</head>
<body>

<a href="/casino/" class="back-casino">‚¨Ö Back to Casino</a>

<section class="game-header">
  <img src="/assets/bag-plinko.png" alt="$BAG Plinko" class="hero-img">
  <h2>ü™ô $BAG Plinko</h2>
  <p class="micro" style="margin-top:4px;opacity:.9;">
    üí∞ <strong>All payouts are in $BAG.</strong> $XRP bets convert automatically at the live rate.
  </p>
</section>

<section class="game-teaser" aria-labelledby="game-teaser-title">
  <div class="game-wrap">

    <!-- LEFT: Connect + Stake + Board (unchanged UI) -->
    <div class="panel mock" id="bagPlinko">
      <div id="demo-badge" style="display:none;position:relative;margin:6px 0 10px 0;font:600 12px/1 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;letter-spacing:.3px;">
        <span style="padding:6px 10px;border:1px solid #aaa;border-radius:6px;opacity:.9;">PRACTICE MODE ‚Äî No real bets or payouts</span>
      </div>

      <div id="connectRow" style="display:flex;justify-content:space-between;align-items:center;margin:-2px 0 10px 0;">
        <div id="connectStatus" class="micro" style="opacity:.9">Wallet: <span style="color:#e8a85c">not connected</span></div>
        <button id="connectBtn"
          style="padding:10px 14px;font-weight:800;border:0;border-radius:12px;color:#08130d;background:linear-gradient(180deg,#ffe175 0%, #f5c94c 100%);box-shadow:0 4px 0 #b08a19;cursor:pointer;">
          Connect Xaman
        </button>
      </div>

      <div id="sessionRow" style="display:flex;justify-content:space-between;align-items:center;margin:6px 0 10px 0;">
        <div id="sessionStatus" class="micro" style="opacity:.9">Session: <span style="color:#e8a85c">not started</span></div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="startSessionBtn" style="padding:8px 12px;font-weight:800;border:0;border-radius:10px;color:#08130d;background:linear-gradient(180deg,#ffe175 0%, #f5c94c 100%);box-shadow:0 3px 0 #b08a19;cursor:pointer;">Start Session</button>
          <button id="topUpBtn" style="padding:8px 12px;font-weight:800;border:0;border-radius:10px;color:#08130d;background:linear-gradient(180deg,#ffe175 0%, #f5c94c 100%);box-shadow:0 3px 0 #b08a19;cursor:pointer;display:none;">Top Up</button>
          <button id="endSessionBtn" style="padding:8px 12px;font-weight:800;border:0;border-radius:10px;background:#15261c;color:#dfe9e2;border:1px solid #2b6a48;cursor:pointer;display:none;">End</button>
        </div>
      </div>

      <div class="section-title">Stake & Prices</div>

      <div class="stake-box">
        <div class="stack">

          <div>
            <div style="display:flex;align-items:center;gap:6px">
              <input id="usdBet" class="mono" type="tel" inputmode="decimal" pattern="[0-9.]*"
                min="0" max="2000" step="0.01" placeholder="0.00"
                style="width:140px;background:#0b2217;border:1px solid #1b4a2f;border-radius:10px;color:#f3f5f0;padding:10px">
              <span class="micro" aria-hidden="true">USD</span>
            </div>
          </div>

          <div>
            <div class="micro">Bet currency</div>
            <div class="choice" id="curToggle">
              <label class="chip"><input type="radio" name="betCur" value="XRP" checked> XRP</label>
              <label class="chip"><input type="radio" name="betCur" value="BAG"> BAG</label>
            </div>
          </div>

          <div>
            <div class="micro">Bet amount</div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
              <div>
                <input id="demoBet" class="mono" type="tel" inputmode="numeric" pattern="[0-9]*" min="0" step="1" value="1"
                  style="width:140px;background:#0b2217;border:1px solid #1b4a2f;border-radius:10px;color:#f3f5f0;padding:10px">
                <span class="unit">XRP</span>
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="micro">Live prices</div>
          <div class="muted mono" id="liveLine">
            <span id="liveDot" class="warn">‚óè</span>
            <span> BAG $<span id="liveBAG">‚Äî</span> ¬∑ XRP $<span id="liveXRP">‚Äî</span> <span id="liveNote"></span></span>
            <div class="micro" id="liveConv" style="margin-top:4px;opacity:.9;">1 BAG ‚âà ‚Äî XRP ¬∑ 1 XRP ‚âà ‚Äî BAG</div>
            <div id="bagDiag" class="micro" style="opacity:.55;margin-top:4px;"></div>
          </div>

          <div class="divider"></div>

          <div class="micro">Game state</div>
          <div class="muted" id="stateText">Ready ‚Äî tap Drop to start</div>

          <div class="callout mono" id="payoutBox">
            <div><strong>Payouts:</strong> Scratch (lose) ¬∑ 1.2√ó (win) ¬∑ 2.0√ó (jackpot)</div>
            <div class="micro" style="margin-top:6px;opacity:.85;">Min $1 ¬∑ Max $2,000 (converted to $BAG on payout)</div>
          </div>

          <button id="dropBtn" class="btn-roll">Drop Coin</button>

          <div class="micro" style="text-align:center;opacity:.7;margin-top:6px">
            If you don‚Äôt hear sound: tap Drop once, turn off Silent mode, and raise volume.
          </div>

          <!-- Board -->
          <div class="stage">
            <div class="canvas-wrap">
              <canvas id="game"></canvas>
              <div class="hud">
                <span class="pill">Mode: <b id="modeLbl">Demo</b></span>
                <span class="pill">Balance: <b id="balLbl">100.00</b> <span id="ccyLbl">XRP</span></span>
                <span class="pill">Bet: <b id="betLbl">1</b></span>
                <span class="pill">Last: <b id="lastLbl">‚Äî</b></span>
              </div>
              <div id="cele" class="cele"></div>
            </div>
          </div>

          <div class="result">
            <div class="n">Result:</div>
            <div id="resText" class="t">‚Äî</div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Rules (unchanged) -->
    <div class="panel" style="padding:16px">
      <h3 style="margin:0 0 8px;font-size:1.2rem;">How it plays</h3>
      <ul style="margin:0;padding-left:18px;color:#cfd6cf">
        <li>Tap <b>Drop Coin</b> to release a token at the top.</li>
        <li>It bounces down pegs into a slot: <b>Scratch</b> (lose), <b>1.2√ó</b> (win), or <b>2√ó</b> (jackpot).</li>
        <li>All payouts settle in <b>$BAG</b> (XRP bets auto-convert).</li>
      </ul>

      <h4 style="margin:12px 0 6px;">Payouts:</h4>
      <ul style="margin:0;padding-left:18px;color:#cfd6cf">
        <li><b>Scratch:</b> 0√ó (lose).</li>
        <li><b>Win:</b> 1.2√ó payout.</li>
        <li><b>Jackpot:</b> 2.0√ó payout.</li>
      </ul>

      <p class="micro" style="margin-top:10px">No wallet connection yet. Visual demo only while development continues.</p>
    </div>

  </div>
</section>

<!-- AUDIO ENGINE (unchanged behavior) -->
<script>
(function(){
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let AC = null, MASTER = null, lastInteractTs = 0, watchdogTimer = null;

  function makeAC(){
    if(!AudioCtx) return null;
    const ac=new AudioCtx();
    const master=ac.createGain();
    master.gain.value=0.28;
    master.connect(ac.destination);
    AC=ac; MASTER=master;
    ac.onstatechange=function(){ if(ac.state==='suspended') tryResume(); };
    return ac;
  }
  function getAC(){ if(AC && AC.state!=='closed') return AC; return makeAC(); }
  function silentTick(ac){
    const o=ac.createOscillator(); const g=ac.createGain();
    g.gain.value=0.00001; o.connect(g).connect(MASTER); o.start(); o.stop(ac.currentTime+0.01);
  }
  async function tryResume(){
    const ac=getAC(); if(!ac) return;
    if(ac.state==='suspended'){ try{await ac.resume();}catch(e){} }
    if(ac.state==='running'){ silentTick(ac); }
  }
  function markInteract(){ lastInteractTs=Date.now(); tryResume(); }
  async function ensureInteractive(){ const ac=getAC(); if(!ac) return null; if(ac.state!=='running'){ await tryResume(); } return ac; }

  function makeNoise(ac,dur=0.08){
    const len=Math.max(1,Math.floor(dur*ac.sampleRate));
    const buf=ac.createBuffer(1,len,ac.sampleRate);
    const data=buf.getChannelData(0);
    for(let i=0;i<len;i++) data[i]=(Math.random()*2-1)*0.9;
    const src=ac.createBufferSource(); src.buffer=buf;
    const bp=ac.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=1200; bp.Q.value=2.0;
    const g=ac.createGain(); g.gain.value=0;
    src.connect(bp).connect(g);
    return {src,g};
  }
  async function nudge(){
    const ac=getAC(); if(!ac) return;
    if(ac.state!=='running'){ await tryResume(); return; }
    const now=ac.currentTime;
    const comp=ac.createDynamicsCompressor();
    comp.threshold.value=-26; comp.knee.value=16; comp.ratio.value=3.5; comp.attack.value=0.003; comp.release.value=0.08;
    comp.connect(MASTER);

    const {src:nSrc,g:nGain}=makeNoise(ac,0.06);
    nGain.connect(comp);
    nGain.gain.setValueAtTime(0.0001,now);
    nGain.gain.linearRampToValueAtTime(0.12,now+0.008);
    nGain.gain.exponentialRampToValueAtTime(0.0001,now+0.08);
    nSrc.start(now); nSrc.stop(now+0.09);

    const o=ac.createOscillator(); const g=ac.createGain();
    o.type='sine'; o.frequency.setValueAtTime(420,now); o.frequency.exponentialRampToValueAtTime(200,now+0.18);
    g.gain.setValueAtTime(0.0001,now);
    g.gain.linearRampToValueAtTime(0.10,now+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001,now+0.22);
    o.connect(g).connect(comp);
    o.start(now); o.stop(now+0.24);
  }

  const INTERACT_EVENTS=['pointerdown','mousedown','touchstart','keydown','click'];
  INTERACT_EVENTS.forEach(ev=>addEventListener(ev,markInteract,{passive:true,capture:true}));
  addEventListener('visibilitychange',()=>{ if(!document.hidden) tryResume(); });
  addEventListener('pageshow',()=>{ tryResume(); });
  addEventListener('focus',()=>{ tryResume(); });

  if(!watchdogTimer){
    watchdogTimer=setInterval(()=>{ const ac=AC; if(!ac) return; const active=Date.now()-lastInteractTs<30_000; if(active && ac.state==='suspended') tryResume(); },1500);
  }

  addEventListener('pointerdown', async function once(){
    removeEventListener('pointerdown', once, {capture:false});
    try{ await ensureInteractive(); await nudge(); }catch{}
  }, {once:true});

  window.__bagAudio={ensureInteractive,nudge};
})();
</script>

<!-- (Wallet / Session / Prices blocks unchanged from your version) -->
<script>
/* your Xaman + session + prices code here, unchanged */
</script>

<!-- Your bag:pricesUpdated UI hook (as requested) -->
<script>
window.addEventListener('bag:pricesUpdated', ()=>{
  const usd = (typeof stakeUsdEquivalent==='function') ? stakeUsdEquivalent() : 0;
  const usdInput = document.getElementById('usdBet');
  if (usdInput) usdInput.value = usd>0 ? usd.toFixed(2) : '';
  const stateText = document.getElementById('stateText');
  if (stateText && window.__PRICES__) {
    stateText.textContent = (window.__PRICES__.source === 'live-amm') ? 'Live pricing ready' :
                            (window.__PRICES__.bagUsd>0 ? 'Using cached pricing' : 'Waiting for pricing‚Ä¶');
  }
});
</script>

<!-- PLINKO GAME LOGIC (reverted board; deep fix so coin never disappears) -->
<script>
(function(){
  // Pay map
  const PAY_MAP = ['L', 1.2, 'L', 2, 'L', 1.2, 'L'];
  const SLOTS = PAY_MAP.length;

  // Physics (exact values you liked)
  const GRAVITY = 0.36, RESTITUTION = 0.78, FRICTION = 0.997;
  const PEG_R = 6, BALL_R = 9, WALL_PAD = 16;

  // Canvas ‚Äî fixed logical size (keeps proportions identical)
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const W=640, H=880; canvas.width=W; canvas.height=H;

  // Board geometry (same as before)
  const leftWall=WALL_PAD, rightWall=W-WALL_PAD;
  const topBoard=110, bottomBoard=H-120;

  const PEG_ROWS = 12, PEG_COLS = 11;
  const pegSpacingX=(rightWall-leftWall-40)/(PEG_COLS-1);
  const pegSpacingY=(bottomBoard-topBoard-100)/(PEG_ROWS-1);

  const pegs=[];
  for(let r=0;r<PEG_ROWS;r++){
    const off=(r%2===0)?0:pegSpacingX/2;
    for(let c=0;c<PEG_COLS;c++){
      let x=leftWall+20+c*pegSpacingX+off;
      if(x<=leftWall+PEG_R || x>=rightWall-PEG_R) continue;
      let y=topBoard+r*pegSpacingY;
      pegs.push({x,y,r:PEG_R});
    }
  }

  // Slots
  const slotWidth=(rightWall-leftWall)/SLOTS;
  const slotX=i=>leftWall+i*slotWidth;

  // UI refs
  const $=id=>document.getElementById(id);
  const modeLbl=$('modeLbl'), balLbl=$('balLbl'), ccyLbl=$('ccyLbl'), betLbl=$('betLbl'), lastLbl=$('lastLbl');
  const resText=$('resText'), dropBtn=$('dropBtn'), curToggle=$('curToggle');
  const unitSpan=document.querySelector('#bagPlinko .unit');
  const betInput=$('demoBet'), usdInput=$('usdBet'), cele=$('cele'), stateText=$('stateText');

  // State
  let mode='Demo', balance=100, stake=1, currency='XRP', lastTxt='‚Äî';
  let dropping=false, ball=null, dropStartedAt=0, lastPegTs=0, safetyTimer=null;

  // Deep fix: a single, immortal RAF loop + bulletproof per-round reset
  let rafStarted=false;
  function resetRoundState(){
    clearTimeout(safetyTimer); safetyTimer=null;
    ball=null;
    dropping=false;
    dropBtn.disabled=false;
    lastPegTs=0;
    cele?.classList.remove('show');
  }

  function hud(){ balLbl.textContent=Number(balance).toFixed(2); ccyLbl.textContent=currency; betLbl.textContent=String(stake); lastLbl.textContent=lastTxt; }

  function sanitizeBet(){
    const raw = (betInput.value||'').replace(/[^\d]/g,'');
    betInput.value = raw || '1';
    stake = Math.max(1, parseInt(betInput.value,10)||1);
    betLbl.textContent = String(stake);
  }
  betInput.addEventListener('input', sanitizeBet);
  betInput.addEventListener('blur', sanitizeBet);

  function currentCurrency(){ const el = curToggle.querySelector('input[name="betCur"]:checked'); return el ? el.value : 'XRP'; }
  function stakeUsdEquivalent(){
    const qty = Math.max(0, parseFloat(betInput.value||0));
    const P=window.__PRICES__||{};
    if (currentCurrency()==='BAG') return P.bagUsd>0 ? qty * P.bagUsd : 0;
    return P.xrpUsd>0 ? qty * P.xrpUsd : 0;
  }
  window.stakeUsdEquivalent = stakeUsdEquivalent;

  usdInput.addEventListener('blur', ()=>{
    const u = parseFloat(usdInput.value||'0'); const P=window.__PRICES__||{};
    if (!(u>0)) return;
    if (currentCurrency()==='XRP' && P.xrpUsd>0){ betInput.value = Math.max(1, Math.floor(u / P.xrpUsd)).toString(); }
    else if (currentCurrency()==='BAG' && P.bagUsd>0){ betInput.value = Math.max(1, Math.floor(u / P.bagUsd)).toString(); }
    sanitizeBet();
  });
  window.addEventListener('bag:pricesUpdated', ()=>{
    const usd = stakeUsdEquivalent();
    if (usdInput) usdInput.value = usd>0 ? usd.toFixed(2) : '';
  });

  curToggle.addEventListener('change', ()=>{
    currency = currentCurrency(); ccyLbl.textContent = currency; unitSpan.textContent = currency;
    const usd = stakeUsdEquivalent(); usdInput.value = usd>0 ? usd.toFixed(2) : '';
  });

  function pegKnock(){ try{ window.__bagAudio?.nudge?.(); }catch{} }

  dropBtn.addEventListener('click', async ()=>{
    // wake audio every click
    try { await window.__bagAudio?.ensureInteractive?.(); window.__bagAudio?.nudge?.(); } catch {}

    // always fully reset any stale state BEFORE starting next round
    resetRoundState();

    const usd = stakeUsdEquivalent();
    const passesMin = usd > 0 ? usd >= 1 : (Number(stake) >= 1);
    if (!passesMin){ resText.textContent = 'Min $1'; return; }

    dropBtn.disabled = true;
    balance = Math.max(0, balance - stake);
    lastTxt = '‚Äî';
    resText.textContent = '‚Äî';
    stateText.textContent = 'Dropping‚Ä¶';
    hud();

    startDrop();
    startLoop(); // ensure RAF is running forever (idempotent)
  });

  function startDrop(){
    dropping=true;
    ball = {x:W/2, y:60, vx:(Math.random()-.5)*0.35, vy:0, r:BALL_R, alive:true, frames:0};
    lastPegTs = 0;
    dropStartedAt = performance.now();

    clearTimeout(safetyTimer);
    safetyTimer = setTimeout(()=>{ if(dropping){ resolveByIndex(boundarySlotIndex((ball&&ball.x)||W/2)); } }, 9000);
  }

  function startLoop(){
    if (rafStarted) return;
    rafStarted = true;
    (function loop(ts){
      drawBoard();
      if(ball && ball.alive){
        stepBall(ts);
        drawBall(ball.x, ball.y);
        if(ball.y > H + 200 || ts - dropStartedAt > 12000){
          resolveByIndex(boundarySlotIndex(ball.x));
        }
      }
      // guard: if physics ended but flags stuck, free button
      if (!ball && dropping) { dropping = false; dropBtn.disabled = false; }
      requestAnimationFrame(loop);
    })(performance.now());
  }

  // extra guards across tab visibility
  addEventListener('visibilitychange', ()=>{ if (!document.hidden) { /* nothing extra; loop is immortal */ } });
  setInterval(()=>{ if(dropping && (!ball || !ball.alive)){ resetRoundState(); } }, 1000);

  function stepBall(ts){
    ball.frames++;
    ball.vy += GRAVITY;
    ball.x += ball.vx; ball.y += ball.vy;
    ball.vx *= FRICTION; ball.vy *= FRICTION;

    // walls
    if(ball.x - BALL_R < leftWall){ ball.x = leftWall + BALL_R; ball.vx = Math.abs(ball.vx)*RESTITUTION; pegKnock(); }
    if(ball.x + BALL_R > rightWall){ ball.x = rightWall - BALL_R; ball.vx = -Math.abs(ball.vx)*RESTITUTION; pegKnock(); }
    if(ball.y - BALL_R < 0){ ball.y = BALL_R; ball.vy = 0; }

    // pegs
    for(const p of pegs){
      const dx=ball.x-p.x, dy=ball.y-p.y;
      const dist=Math.hypot(dx,dy) || 0.0001;
      const minD=BALL_R + p.r;
      if(dist < minD){
        const nx = dx / dist, ny = dy / dist;
        const overlap = (minD - dist) + 0.25;
        ball.x += nx * overlap; ball.y += ny * overlap;
        const vDotN = ball.vx*nx + ball.vy*ny;
        ball.vx = (ball.vx - 2*vDotN*nx) * RESTITUTION;
        ball.vy = (ball.vy - 2*vDotN*ny) * RESTITUTION;
        const nowMs = performance.now();
        if (nowMs - lastPegTs > 50){ lastPegTs = nowMs; pegKnock(); }
        const speed = Math.hypot(ball.vx, ball.vy);
        if(speed < 0.22){ ball.vx += (Math.random()-.5)*0.65; ball.vy += 0.45; }
      }
    }

    // Landing
    const slowEnough = Math.abs(ball.vy) < 0.22;
    if (ball.y >= bottomBoard + 56 && (slowEnough || ball.y >= bottomBoard + 86)){
      resolveByIndex(boundarySlotIndex(ball.x));
    }
  }

  function boundarySlotIndex(x){
    const clamped = Math.min(rightWall-1, Math.max(leftWall+1, x));
    const idx = Math.floor((clamped - leftWall) / slotWidth);
    return Math.max(0, Math.min(SLOTS-1, idx));
  }

  function resolveByIndex(idx){
    // fully reset if somehow already cleared
    if (!ball){ resetRoundState(); return; }
    ball.alive = false;
    ball = null;
    clearTimeout(safetyTimer); safetyTimer=null;

    dropping = false;
    dropBtn.disabled = false;

    const rule = PAY_MAP[idx] ?? 'L';
    cele?.classList.remove('show');

    if (rule === 'L'){
      lastTxt = 'Scratch';
      resText.textContent = 'Scratch (lose)';
      stateText.textContent = 'Resolved';
      try{ __bagAudio?.nudge?.(); }catch{}
    } else {
      const mult = Number(rule);
      const payout = Math.floor(stake * mult * 100)/100;
      balance += payout; hud();
      if (mult === 2){
        lastTxt = 'Jackpot 2√ó';
        resText.textContent = 'üéâ Jackpot 2√ó';
        cele.style.color = '#ffd700';
      } else {
        lastTxt = 'Win 1.2√ó';
        resText.textContent = 'Win 1.2√ó';
        cele.style.color = '#baf2cd';
      }
      try{ window.__bagSession?.credit?.(payout); }catch{}
      cele.textContent = resText.textContent;
      cele.classList.add('show');
      setTimeout(()=> cele.classList.remove('show'), 1200);
      stateText.textContent = 'Resolved';
    }
    hud();
  }

  // Board render (unchanged look)
  function drawBoard(){
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle='#0b1b13'; ctx.fillRect(0,0,W,H);

    ctx.strokeStyle='#1c3b27'; ctx.lineWidth=4;
    ctx.strokeRect(leftWall-8, topBoard-40, rightWall-leftWall+16, bottomBoard-topBoard+60);

    ctx.fillStyle='#704d1d';
    for(const p of pegs){ ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill(); }

    ctx.strokeStyle='#2a4d38'; ctx.lineWidth=3;
    ctx.beginPath(); ctx.moveTo(leftWall, bottomBoard); ctx.lineTo(rightWall, bottomBoard); ctx.stroke();
    for(let i=1;i<SLOTS;i++){
      const x = slotX(i);
      ctx.beginPath(); ctx.moveTo(x, bottomBoard); ctx.lineTo(x, bottomBoard+50); ctx.stroke();
    }

    const centers=Array.from({length:SLOTS},(_,i)=>slotX(i)+slotWidth/2);
    ctx.font='14px system-ui, -apple-system, Segoe UI, Roboto, Arial'; ctx.textAlign='center';
    for(let i=0;i<SLOTS;i++){
      const rule = PAY_MAP[i];
      const txt = rule==='L' ? 'Scratch' : (rule===2 ? '2√ó' : '1.2√ó');
      ctx.fillStyle = rule==='L' ? '#e25b5b' : (rule===2 ? '#ffd700' : '#baf2cd');
      ctx.fillText(txt, centers[i], bottomBoard+72);
    }
  }

  function drawBall(x,y){
    const r=BALL_R;
    const g=ctx.createRadialGradient(x-4,y-4,2,x,y,r);
    g.addColorStop(0,'#ffd36d'); g.addColorStop(.6,'#c8911e'); g.addColorStop(1,'#8b5e13');
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
    ctx.lineWidth=1.2; ctx.strokeStyle='rgba(0,0,0,.35)'; ctx.stroke();
  }

  // initial UI + start the immortal loop so board is visible before first drop
  ccyLbl.textContent = currency; unitSpan.textContent = currency;
  hud();
  (function boot(){ startLoop(); })();
})();
</script>

<!-- Service worker guard + footer (unchanged) -->
<script>
if ('serviceWorker' in navigator) { navigator.serviceWorker.register('/service-worker.js').catch(()=>{}); }
window.addEventListener('gesturestart', e=>e.preventDefault(), {passive:false});
</script>

<footer class="footer" style="text-align:center; padding:12px 0; line-height:1.6;">
  ¬© 2025 $BAG Protocol | getthebag.io | Powered by $XRP
  <br>
  <a href="https://x.com/getthebag_io" target="_blank" rel="noopener" style="color:#e0c66f;text-decoration:none;font-weight:700;">ùïè @getthebag_io</a> |
  <a href="https://t.me/getthebag_io" target="_blank" rel="noopener" style="color:#e0c66f;text-decoration:none;font-weight:700;">Telegram @getthebag_io</a>
</footer>

</body>
</html>
