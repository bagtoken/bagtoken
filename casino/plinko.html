<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>$BAG Plinko</title>

<link rel="preconnect" href="https://api.coingecko.com" crossorigin>
<script src="https://xaman.app/assets/cdn/xumm.min.js"></script>

<style>
  *{box-sizing:border-box}
  :root{
    --gold:#ffd700;--bg:#020703;--panel:#0b1b13;--panel2:#0d2217;--muted:#aeb7af;--fg:#f5f7f4;
    --green:#2fbf6b;--green2:#34c759;--line:#173524;--shadow:rgba(0,0,0,.35);
    --red:#e25b5b;
  }
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.55}
  img{display:block;max-width:100%;height:auto}
  button,input{font-size:16px}

  .back-casino {
    position: fixed; top: 18px; left: 18px; z-index: 1000;
    background: linear-gradient(180deg,#ffe175 0%, #f5c94c 100%);
    color: #08130d; text-decoration: none; font-weight: 800;
    padding: 8px 14px; border-radius: 10px; box-shadow: 0 4px 0 #b08a19; transition: all .15s ease;
  }
  .back-casino:hover { filter: brightness(1.05); box-shadow: 0 4px 0 #b08a19, 0 14px 28px rgba(255,225,117,.22); }
  .back-casino:active { transform: translateY(1px); box-shadow: 0 3px 0 #9a7315; }
  @media (max-width: 640px){ .back-casino{ font-size:.9rem; padding:7px 12px; } }

  .game-header{text-align:center;padding:36px 10px 14px}
  .game-header img.hero-img{margin-bottom:10px;filter:drop-shadow(0 10px 24px rgba(46,191,107,.18))}
  .game-header h2{font-size:clamp(1.6rem,5vw,2.2rem);margin:6px 0 0}
  @media (min-width: 900px){
    .game-header img.hero-img{ width: 34vw; max-width: 420px; margin-left: auto; margin-right: auto; }
  }
  .game-teaser{padding:10px 16px 60px;background:
    radial-gradient(1200px 600px at 10% -10%, #0e2c1d 0%, transparent 60%),
    radial-gradient(900px 500px at 110% 20%, #0b2318 0%, transparent 55%),#060806;
    border-top:1px solid #131313;border-bottom:1px solid #131313}
  .game-wrap{max-width:1080px;margin:0 auto;display:grid;grid-template-columns:1.12fr .88fr;gap:22px}
  @media (max-width:900px){.game-wrap{grid-template-columns:1fr}}

  .panel{background:linear-gradient(180deg,var(--panel) 0%,var(--panel2) 100%);border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 24px var(--shadow)}
  .mock{padding:16px}
  .section-title{font-weight:800;font-size:1.2rem;margin:0 0 12px}

  .stack{display:grid;gap:10px}
  .choice{display:flex;gap:10px;flex-wrap:wrap}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid #2b6a48;background:#0e2a1c;color:#e9efe9;font-weight:800}
  .chip input{accent-color:#2fbf6b}
  .mono{font-variant-numeric:tabular-nums}
  .micro{font-size:.85rem;color:#a8b5ab}
  .muted{color:#cfd6cf}
  .divider{height:1px;background:#123221;margin:10px 0}
  .callout{margin-top:12px;padding:12px;border:1px dashed #29543d;border-radius:12px;background:#0c2418;color:#e4efe7}

  .btn-roll{
    width:100%;margin-top:12px;padding:16px 22px;font-size:1.15rem;font-weight:900;text-transform:uppercase;
    letter-spacing:.5px;border:0;border-radius:14px;color:#08130d;background:linear-gradient(180deg,#ffe175 0%, #f5c94c 100%);
    box-shadow:0 6px 0 #b08a19, 0 16px 32px rgba(255,225,117,.18), inset 0 1px 0 rgba(255,255,255,.35);
    transition:transform .06s ease, box-shadow .2s ease, filter .2s ease; cursor:pointer;
  }
  .btn-roll:hover{filter:brightness(1.05);box-shadow:0 6px 0 #b08a19, 0 22px 40px rgba(255,225,117,.26), inset 0 1px 0 rgba(255,255,255,.4)}
  .btn-roll:active{transform:translateY(2px);box-shadow:0 4px 0 #9a7315, 0 12px 24px rgba(255,225,117,.2), inset 0 1px 0 rgba(255,255,255,.3)}
  .btn-roll:disabled{opacity:.65;cursor:not-allowed;transform:none;box-shadow:0 6px 0 #6e6e6e, 0 10px 20px rgba(0,0,0,.2)!important}

  .result{margin-top:12px;padding:12px;border:1px solid #1b4a2f;border-radius:12px;background:#0b2217;display:flex;align-items:center;gap:10px}
  .result .n{font-weight:900;font-size:1.05rem}

  /* ===== Plinko visuals ===== */
  .stage{position:relative;display:flex;align-items:center;justify-content:center;overflow:hidden;margin-top:10px}
  .canvas-wrap{
    position:relative;width:100%;max-width:720px;
    aspect-ratio:3/4;
    border-radius:14px;
    box-shadow:0 10px 30px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.04);
    background: radial-gradient(120% 120% at 50% 0%, #0b2016 0%, #07120d 60%, #060a08 100%);
  }
  canvas{position:absolute;inset:0;width:100%;height:100%}

  .hud{ display:none }
  .pill{background:#0a1e15;border:1px solid #244330;border-radius:999px;padding:6px 10px;font-size:12px;color:#cfe6d8}

  /* New off-board HUD bar + tip */
  .hudbar{
    display:flex; gap:6px; flex-wrap:wrap; align-items:center;
    margin:6px 0 10px; pointer-events:auto;
  }
  .aim-tip{ margin:-2px 0 8px; opacity:.9 }

  .cele{position:absolute;inset:0;display:none;align-items:center;justify-content:center;font-size:42px;font-weight:900;color:#ffe28c;text-shadow:0 4px 14px rgba(0,0,0,.6)}
  .cele.show{display:flex;animation:pop .9s ease}
  @keyframes pop{0%{transform:scale(.7);opacity:0}50%{transform:scale(1.06);opacity:1}100%{transform:scale(1)}}
</style>

<script src="/js/bag-session.js"></script>
</head>
<body>

<a href="/casino/" class="back-casino" aria-label="Back to Casino">‚¨Ö Back to Casino</a>

<section class="game-header">
  <img src="/assets/bag-plinko.png" alt="$BAG Plinko" class="hero-img" loading="lazy" decoding="async">
  <h2>ü™ô $BAG Plinko</h2>
  <p class="micro" style="margin-top:4px;opacity:.9;">
    üí∞ <strong>All payouts are in $BAG.</strong> $XRP bets convert automatically at the live rate.
  </p>
</section>

<section class="game-teaser" aria-labelledby="game-teaser-title">
  <div class="game-wrap">

    <!-- LEFT PANEL -->
    <div class="panel mock" id="bagPlinko">
      <div id="demo-badge" style="display:none;position:relative;margin:6px 0 10px 0;font:600 12px/1 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;letter-spacing:.3px;">
        <span style="padding:6px 10px;border:1px solid #aaa;border-radius:6px;opacity:.9;">PRACTICE MODE ‚Äî No real bets or payouts</span>
      </div>

      <div id="connectRow" style="display:flex;justify-content:space-between;align-items:center;margin:-2px 0 10px 0;">
        <div id="connectStatus" class="micro" style="opacity:.9">Wallet: <span style="color:#e8a85c">not connected</span></div>
        <button id="connectBtn"
          style="padding:10px 14px;font-weight:800;border:0;border-radius:12px;color:#08130d;background:linear-gradient(180deg,#ffe175 0%, #f5c94c 100%);box-shadow:0 4px 0 #b08a19;cursor:pointer;">
          Connect Xaman
        </button>
      </div>

      <div id="sessionRow" style="display:flex;justify-content:space-between;align-items:center;margin:6px 0 10px 0;">
        <div id="sessionStatus" class="micro" style="opacity:.9">Session: <span style="color:#e8a85c">not started</span></div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="startSessionBtn" style="padding:8px 12px;font-weight:800;border:0;border-radius:10px;color:#08130d;background:linear-gradient(180deg,#ffe175 0%, #f5c94c 100%);box-shadow:0 3px 0 #b08a19;cursor:pointer;">Start Session</button>
          <button id="topUpBtn" style="padding:8px 12px;font-weight:800;border:0;border-radius:10px;color:#08130d;background:linear-gradient(180deg,#ffe175 0%, #f5c94c 100%);box-shadow:0 3px 0 #b08a19;cursor:pointer;display:none;">Top Up</button>
          <button id="endSessionBtn" style="padding:8px 12px;font-weight:800;border:0;border-radius:10px;background:#15261c;color:#dfe9e2;border:1px solid #2b6a48;cursor:pointer;display:none;">End</button>
        </div>
      </div>

      <div class="section-title">Stake & Prices</div>

      <div class="stack">
        <div>
          <div style="display:flex;align-items:center;gap:6px">
            <input id="usdBet" class="mono" type="tel" inputmode="decimal" pattern="[0-9.]*"
              min="0" max="2000" step="0.01" placeholder="0.00" aria-label="Stake in USD"
              style="width:140px;background:#0b2217;border:1px solid #1b4a2f;border-radius:10px;color:#f3f5f0;padding:10px">
            <span class="micro" aria-hidden="true">USD</span>
          </div>
        </div>

        <div>
          <div class="micro">Bet currency</div>
          <div class="choice" id="curToggle" role="radiogroup" aria-label="Bet currency">
            <label class="chip"><input type="radio" name="betCur" value="XRP" checked> XRP</label>
            <label class="chip"><input type="radio" name="betCur" value="BAG"> BAG</label>
          </div>
        </div>

        <div>
          <div class="micro">Bet amount</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
            <div>
              <input id="demoBet" class="mono" type="tel" inputmode="decimal" pattern="[0-9.]*"
                min="0" step="any" value="1" aria-label="Stake units"
                style="width:140px;background:#0b2217;border:1px solid #1b4a2f;border-radius:10px;color:#f3f5f0;padding:10px">
              <span class="unit">XRP</span>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="micro">Live prices</div>
        <div class="muted mono" id="liveLine" aria-live="polite">
          <span id="liveDot" class="warn">‚óè</span>
          <span> BAG $<span id="liveBAG">‚Äî</span> ¬∑ XRP $<span id="liveXRP">‚Äî</span> <span id="liveNote"></span></span>
          <div class="micro" id="liveConv" style="margin-top:4px;opacity:.9;">1 BAG ‚âà ‚Äî XRP ¬∑ 1 XRP ‚âà ‚Äî BAG</div>
          <div id="bagDiag" class="micro" style="opacity:.55;margin-top:4px;"></div>
        </div>

        <div class="divider"></div>

        <div class="micro">Game state</div>
        <div class="muted" id="stateText">Ready ‚Äî tap Drop to start</div>

        <div class="callout mono" id="payoutBox">
          <div style="font-weight:700;margin-bottom:6px">Payouts</div>
          <div class="payout-grid" style="display:grid;gap:4px">
            <div class="row" style="display:flex;justify-content:space-between">
              <div class="lab"><strong>Scratch</strong> (0.00√ó):</div>
              <div class="val" id="payScratch">‚Äî</div>
            </div>
            <div class="row" style="display:flex;justify-content:space-between">
              <div class="lab"><strong>Win</strong> (1.25√ó):</div>
              <div class="val" id="payWin">‚Äî <span class="micro" id="payWinGain" style="opacity:.9"></span></div>
            </div>
            <div class="row" style="display:flex;justify-content:space-between">
              <div class="lab"><strong>Jackpot</strong> (2.00√ó):</div>
              <div class="val" id="payJackpot">‚Äî <span class="micro" id="payJackpotGain" style="opacity:.9"></span></div>
            </div>
          </div>
          <div class="micro" style="margin-top:6px;opacity:.85;">Min $1 ¬∑ Max $2,000. Bets shown in selected currency; $BAG amount and USD shown per live price.</div>
        </div>

        <!-- HUD bar (live balance tweak ONLY) -->
        <div class="hudbar">
          <span class="pill">Mode: <b id="modeLbl">Demo</b></span>
          <span class="pill">Balance: <b id="balLbl">1000</b> <span id="balCcyLbl">BAG</span> <span id="balUsdLbl" class="micro" style="margin-left:6px;opacity:.85"></span></span>
          <span class="pill">Bet: <b id="betLbl">1</b> <span id="betCcyLbl">XRP</span></span>
          <span class="pill">Last: <b id="lastLbl">‚Äî</b></span>
        </div>

        <p class="micro aim-tip">üëá Tap anywhere on the board to choose where the coin drops. Use ‚Üê/‚Üí to adjust; press Space or tap <b>Drop</b> to release.</p>

        <!-- Board -->
        <div class="stage">
          <div class="canvas-wrap">
            <canvas id="game" aria-label="Plinko board"></canvas>
            <div class="hud">
              <span class="pill">Mode: <b>Demo</b></span>
              <span class="pill">Balance: <b>100.00</b> <span>XRP</span></span>
              <span class="pill">Bet: <b>1</b></span>
              <span class="pill">Last: <b>‚Äî</b></span>
            </div>
            <div id="cele" class="cele" aria-live="polite"></div>
          </div>
        </div>

        <div class="result" style="margin-top:12px">
          <div class="n">Result:</div>
          <div id="resText" class="t">‚Äî</div>
        </div>

        <div style="margin-top:18px;text-align:center">
          <button id="dropBtn" class="btn-roll" style="width:min(360px,90%)">Drop Coin</button>
        </div>

        <div class="micro" style="text-align:center;opacity:.7;margin-top:6px">
          üîä If you don‚Äôt hear sound: tap DROP once, turn off Silent mode, and raise volume.
        </div>
      </div>

      <!-- RIGHT: Rules -->
      <div class="panel" style="padding:16px">
        <h3 style="margin:0 0 8px;font-size:1.2rem;">How it plays</h3>
        <ul style="margin:0;padding-left:18px;color:#cfd6cf">
          <li>Tap <b>Drop Coin</b> to release a token at the top.</li>
          <li>It bounces down pegs into a slot: <b>Scratch</b> (lose), <b>1.25√ó</b> (win), or <b>2√ó</b> (jackpot).</li>
          <li>All payouts settle in <b>$BAG</b> (XRP bets auto-convert).</li>
        </ul>

        <h4 style="margin:12px 0 6px;">Payouts:</h4>
        <ul style="margin:0;padding-left:18px;color:#cfd6cf">
          <li><b>Scratch:</b> 0√ó (lose).</li>
          <li><b>Win:</b> 1.25√ó payout.</li>
          <li><b>Jackpot:</b> 2.0√ó payout.</li>
        </ul>

        <p class="micro" style="margin-top:10px">No wallet connection yet. Visual demo only while development continues.</p>
      </div>
    </div>
  </div>
</section>

<!-- === AUDIO ENGINE (unchanged) === -->
<script>
/* ‚Ä¶ (exact same audio block from your baseline) ‚Ä¶ */
</script>

<!-- === WALLET CONNECT (unchanged) === -->
<script>
/* ‚Ä¶ (exact same wallet connect block from your baseline) ‚Ä¶ */
</script>

<!-- === TAB SESSION (unchanged) === -->
<script>
/* ‚Ä¶ (exact same tab session block from your baseline) ‚Ä¶ */
</script>

<!-- === PRICES (unchanged) === -->
<script>
/* ‚Ä¶ (exact same prices block from your baseline) ‚Ä¶ */
</script>

<!-- === PRICES/STAKE SYNC (with HUD live-balance tweak ONLY) === -->
<script>
(function(){
  const MIN_USD = 1;
  const MAX_USD = 2000;

  const $ = (s)=>document.querySelector(s);
  const usdInput   = $('#usdBet');
  const betInput   = $('#demoBet');
  const unitSpan   = document.querySelector('.unit');
  const curWrap    = $('#curToggle');

  // NEW: HUD bits for live balance
  const modeLbl = document.getElementById('modeLbl');
  const balLbl  = document.getElementById('balLbl');
  const balCcy  = document.getElementById('balCcyLbl');
  const balUsd  = document.getElementById('balUsdLbl');
  const betLbl  = document.getElementById('betLbl');
  const betCcy  = document.getElementById('betCcyLbl');

  const stateText  = $('#stateText');

  let syncing = false;

  function selectedCur(){
    return curWrap?.querySelector('input[name="betCur"]:checked')?.value || 'XRP';
  }
  function priceFor(cur){
    const P = window.__PRICES__ || {};
    return cur==='BAG' ? (P.bagUsd||0) : (P.xrpUsd||0);
  }
  function clampUsd(v){
    if (!Number.isFinite(v)) return 0;
    return Math.min(MAX_USD, Math.max(0, v));
  }
  function refreshBetHud(){
    if (betLbl) betLbl.textContent = (parseInt(betInput?.value||'0',10)||0);
    if (betCcy) betCcy.textContent = selectedCur();
    if (unitSpan) unitSpan.textContent = selectedCur();
  }

  // NEW: Live balance HUD updater (session or demo)
  function refreshLiveBalanceHud(){
    const demo = window.__BAG_FORCE_DEMO === true;
    const s    = window.__bagSession?.get?.();
    const bag  = demo ? (Number(localStorage.getItem('__bag_demo_bag_v1'))||1000) : (s?.bag||0);
    const P    = window.__PRICES__ || {};
    const usd  = (P.bagUsd>0 ? bag * P.bagUsd : 0);
    const fmt = (n,max=6)=>Number.isFinite(n)? n.toLocaleString(undefined,{maximumFractionDigits:max}) : '‚Äî';
    const fmtUsd = (n)=>'$'+(Number(n)||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});

    if (modeLbl) modeLbl.textContent = demo ? 'Demo' : 'Live';
    if (balLbl)  balLbl.textContent  = fmt(bag, bag>=1?4:8);
    if (balCcy)  balCcy.textContent  = 'BAG';
    if (balUsd)  balUsd.textContent  = usd ? `(${fmtUsd(usd)})` : '';
  }

  function updateUsdFromBet(){
    if (!usdInput || !betInput) return;
    if (syncing) return;
    const cur = selectedCur();
    const px  = priceFor(cur);
    const qty = Math.max(0, parseFloat(betInput.value||'0'));
    const usd = px>0 ? qty*px : 0;
    syncing = true;
    usdInput.value = usd>0 ? usd.toFixed(2) : '';
    syncing = false;
  }

  function updateBetFromUsd(){
    if (!usdInput || !betInput) return;
    if (syncing) return;
    const cur = selectedCur();
    const px  = priceFor(cur);
    let usd   = clampUsd(parseFloat(usdInput.value||'0'));
    if (!Number.isFinite(usd) || usd<=0 || px<=0){
      syncing = true; betInput.value = betInput.value; syncing = false;
      return;
    }
    const units = Math.floor(usd / px);
    syncing = true;
    betInput.value = String(Math.max(0, units));
    syncing = false;
  }

  // Public helper kept for existing code paths
  function stakeUsdEquivalent(){
    const qty = Math.max(0, parseFloat(betInput?.value||0));
    const cur = selectedCur();
    const px  = priceFor(cur);
    return px>0 ? qty*px : 0;
  }
  window.stakeUsdEquivalent = window.stakeUsdEquivalent || stakeUsdEquivalent;

  usdInput?.addEventListener('input', ()=>{ updateBetFromUsd(); refreshBetHud(); refreshLiveBalanceHud(); });
  betInput?.addEventListener('input', ()=>{ updateUsdFromBet(); refreshBetHud(); refreshLiveBalanceHud(); });
  curWrap?.addEventListener('change', ()=>{ updateUsdFromBet(); refreshBetHud(); refreshLiveBalanceHud(); });

  // React to price availability/changes
  window.addEventListener('bag:pricesUpdated', ()=>{
    const P = window.__PRICES__;
    if (stateText && P) {
      stateText.textContent = (P.source === 'live-amm') ? 'Live pricing ready' :
                              (P.bagUsd>0 ? 'Using cached pricing' : 'Waiting for pricing‚Ä¶');
    }
    updateUsdFromBet();
    refreshBetHud();
    refreshLiveBalanceHud();
  });

  // Initial paint
  refreshBetHud();
  refreshLiveBalanceHud();
  updateUsdFromBet();
})();
</script>

<!-- === PAYOUT PREVIEW (unchanged math / only reads stake + prices) === -->
<script>
/* ‚Ä¶ (exact same payout preview block from your baseline) ‚Ä¶ */
</script>

<!-- === PLINKO GAME LOGIC (unchanged physics/odds/visuals; only HUD calls stay) === -->
<script>
/* ‚Ä¶ (exact same game logic block from your baseline) ‚Ä¶ */
</script>

<!-- === Practice Mode Wrapper (unchanged except it already exposes demo balance) === -->
<script>
/* ‚Ä¶ (exact same practice mode wrapper from your baseline) ‚Ä¶ */
</script>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/service-worker.js').catch(()=>{});
}
</script>

<footer class="footer" style="text-align:center; padding:12px 0; line-height:1.6;">
  ¬© 2025 $BAG Protocol | getthebag.io | Powered by $XRP
  <br>
  <a href="https://x.com/getthebag_io" target="_blank" rel="noopener" style="color:#e0c66f;text-decoration:none;font-weight:700;">ùïè @getthebag_io</a> |
  <a href="https://t.me/getthebag_io" target="_blank" rel="noopener" style="color:#e0c66f;text-decoration:none;font-weight:700;">Telegram @getthebag_io</a>
</footer>

</body>
</html>
