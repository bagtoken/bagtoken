<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="format-detection" content="telephone=no" />
<title>BAG Roulette</title>

<link rel="preconnect" href="https://api.coingecko.com" crossorigin>
<script src="https://xaman.app/assets/cdn/xumm.min.js"></script>
<!-- Match Slots: force demo by default so balance exists -->
<script>window.__BAG_FORCE_DEMO = true;</script>

<style>
  *{box-sizing:border-box}
  :root{
    --gold:#ffe175;--bg:#020703;--panel:#0b1b13;--panel2:#0d2217;--muted:#aeb7af;--fg:#f5f7f4;
    --green:#2fbf6b;--green-600:#249a55;--line:#173524;--shadow:rgba(0,0,0,.35);
    --win-bg: rgba(10,12,16,.70);
    --lose:#e25b5b; --warn:#e8a85c;
  }
  html,body{margin:0;background:var(--bg);color:var(--fg);
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.55}
  img{display:block;max-width:100%;height:auto}
  button,input{font-size:16px}
  a[x-apple-data-detectors]{color:inherit !important;text-decoration:none !important;pointer-events:none !important;cursor:default !important;}

  .back-casino{
    position:fixed;top:18px;left:18px;z-index:1000;
    background:linear-gradient(180deg,#ffe175 0%,#f5c94c 100%);
    color:#08130d;text-decoration:none;font-weight:800;padding:8px 14px;border-radius:10px;
    box-shadow:0 4px 0 #b08a19;transition:all .15s ease
  }
  .back-casino:hover{filter:brightness(1.05);box-shadow:0 4px 0 #b08a19,0 14px 28px rgba(255,225,117,.22)}
  .back-casino:active{transform:translateY(1px);box-shadow:0 3px 0 #9a7315}

  .game-header{text-align:center;padding:36px 10px 14px}
  .game-header img.hero-img{margin:0 auto 10px;filter:drop-shadow(0 10px 24px rgba(46,191,107,.18))}
  .game-header h2{font-size:clamp(1.6rem,5vw,2.2rem);margin:6px 0 0}
  @media (min-width:900px){
    .game-header img.hero-img{width:34vw;max-width:420px;margin-left:auto;margin-right:auto}
  }

  .game-teaser{padding:10px 16px 60px;background:
    radial-gradient(1200px 600px at 10% -10%, #0e2c1d 0%, transparent 60%),
    radial-gradient(900px 500px at 110% 20%, #0b2318 0%, transparent 55%),#060806;
    border-top:1px solid #131313;border-bottom:1px solid #131313}
  .game-wrap{max-width:1080px;margin:0 auto;display:grid;grid-template-columns:1.12fr .88fr;gap:22px}
  @media (max-width:900px){.game-wrap{grid-template-columns:1fr}}

  .panel{background:linear-gradient(180deg,var(--panel) 0%,var(--panel2) 100%);
    border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 24px var(--shadow)}
  .mock{padding:16px}

  .section-title{font-weight:800;font-size:1.2rem;margin:0 0 12px}
  .stake-box{padding:14px}
  .stack{display:grid;gap:10px}
  .choice{display:flex;gap:10px;flex-wrap:wrap}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid #2b6a48;background:#0e2a1c;color:#e9efe9;font-weight:800}
  .chip input{accent-color:#2fbf6b}
  .mono{font-variant-numeric:tabular-nums}
  .micro{font-size:.85rem;color:#aeb7af}
  .muted{color:#cfd6cf}
  .divider{height:1px;background:#123221;margin:10px 0}

  /* Cabinet */
  .cabinet{background:#07140e;border:1px solid #1b4a2f;border-radius:14px;padding:14px}
  .felt{
    display:grid;grid-template-columns:1fr;gap:12px;
    background:#091a13;border:1px solid #24533a;border-radius:12px;padding:12px;overflow:hidden
  }
  .marquee{text-align:center;font-weight:900;letter-spacing:.08em;color:#ffe9a6;background:linear-gradient(180deg,#17311f,#0e2419);
    border:1px solid #254a33;border-radius:12px;padding:8px}

  /* Roulette visual block (kept simple to match Slots layout) */
  .wheel-box{display:grid;gap:10px;justify-items:center;align-items:center}
  .wheel-readout{display:flex;align-items:center;gap:10px;justify-content:center;
    border:1px solid #1b4a2f;border-radius:12px;background:#0b2217;padding:10px 12px}
  .badge{font-weight:900;padding:6px 10px;border-radius:999px;border:1px solid #2b6a48}
  .badge.red{background:#2a0f13;border-color:#6b1e28;color:#ffb3b3}
  .badge.black{background:#0f1013;border-color:#2b2c31;color:#d7d9df}
  .badge.green{background:#0f2a17;border-color:#2b6a48;color:#bff5d2}

  .spin-row{display:flex;justify-content:center}
  .btn-spin{
    width:min(360px,90%);padding:16px 22px;margin-top:2px;
    font-size:1.15rem;font-weight:900;text-transform:uppercase;letter-spacing:.5px;border:0;border-radius:14px;
    color:#08130d;background:linear-gradient(180deg,#ffe175 0%, #f5c94c 100%);
    box-shadow:0 6px 0 #b08a19, 0 16px 32px rgba(255,225,117,.18), inset 0 1px 0 rgba(255,255,255,.35);
    transition:transform .06s ease, box-shadow .2s ease, filter .2s ease; cursor:pointer;
  }
  .btn-spin:active{transform:translateY(2px);box-shadow:0 4px 0 #9a7315,0 12px 24px rgba(255,225,117,.2), inset 0 1px 0 rgba(255,255,255,.3)}
  .btn-spin:disabled{opacity:.65;cursor:not-allowed}
  .btn-spin:focus-visible, .chip:focus-within { outline:2px solid #ffe175; outline-offset:2px; }

  .result{margin-top:10px;padding:12px;border:1px solid #1b4a2f;border-radius:12px;background:#0b2217;display:flex;align-items:center;gap:10px}
  .t.win{color:#2fbf6b}.t.scratch{color:#e8a85c}.t.lose{color:var(--lose)}

  /* HUD pills */
  .hudbar{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; margin:6px 2px 0; }
  .pill{ background:#0a1e15; border:1px solid #244330; border-radius:999px; padding:6px 10px; font-size:12px; color:#cfe6d8 }
  .hudbar .pill b{ font-weight:800 }

  /* Quick Amount buttons */
  .preset-chips{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  .preset-chip{
    appearance:none; border:1px solid var(--green-600); background:var(--green); color:#fff;
    border-radius:999px; padding:8px 12px; font-weight:900; letter-spacing:.2px; cursor:pointer;
    box-shadow:0 4px 10px rgba(47,191,107,.18), inset 0 1px 0 rgba(255,255,255,.12);
    transition:transform .06s ease, box-shadow .2s ease, filter .2s ease;
  }
  .preset-chip:hover{ filter:brightness(1.03); }
  .preset-chip:active{ transform:translateY(1px); box-shadow:0 3px 8px rgba(47,191,107,.16), inset 0 1px 0 rgba(255,255,255,.1); }
  .preset-chip:focus-visible{ outline:2px solid #ffffff; outline-offset:2px; }
  .preset-chip.active{ box-shadow:0 0 0 2px rgba(255,255,255,.25) inset, 0 8px 22px rgba(47,191,107,.25); }

  /* Status dot colors */
  #liveDot{margin-right:6px}
  .ok{color:#2fbf6b}
  .warn{color:#e8a85c}
  .err{color:#e25b5b}

  /* BAG tile */
  .tile{ display:inline-block; line-height:1; font-weight:900; letter-spacing:.06em; }

  /* Readout (BJ-style box) */
  #roulette-win-readout{
    background: var(--panel2);
    border: 1px solid var(--line);
    border-radius: 14px;
    padding: 16px;
    box-shadow: 0 10px 24px var(--shadow);
    color: var(--fg);
  }
  #roulette-win-readout .row{display:flex;justify-content:space-between;gap:12px;margin:8px 0}
  #roulette-win-readout .title{font-weight:800;letter-spacing:.2px}
  #roulette-win-readout .muted{color:var(--muted)}
  #roulette-win-readout .note{color:var(--muted);font-size:.92rem;margin-top:10px;line-height:1.45}

  /* Rules FAB + Modal (same) */
  .rules-fab{
    position:fixed; right:16px; bottom:16px; z-index:1000;
    padding:10px 14px; border-radius:999px; font-weight:800;
    border:1px solid #2b6a48; background:#0e2a1c; color:#e9efe9;
    box-shadow:0 8px 24px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
    cursor:pointer; user-select:none; -webkit-user-select:none;
  }
  .rules-fab:hover{ filter:brightness(1.05); }
  .rules-fab:active{ transform:translateY(1px); }
  .rules-fab:focus-visible{ outline:2px solid #e9efe9; outline-offset:2px; }

  .rules-overlay{
    position: fixed; inset: 0;
    display: none; place-items: center; z-index: 3000;
    backdrop-filter: blur(6px); background: rgba(0,0,0,.45); padding: 18px;
  }
  .rules-modal{
    width: min(680px, 92vw); max-height: min(78vh, 840px); overflow:auto;
    background: linear-gradient(180deg,var(--panel) 0%, var(--panel2) 100%);
    border: 1px solid var(--line); border-radius: 16px;
    box-shadow: 0 24px 60px var(--shadow); color: var(--fg); padding: 18px; position:relative;
  }
  .rules-modal h3{ margin: 0 0 10px; }
  .rules-modal ul{ margin: 10px 0; padding-left: 20px; }
  .rules-modal .rules-note{ margin-top: 10px; color: var(--muted); }
  .rules-close{
    position:absolute; top:8px; right:12px; border:0; background:transparent; color:#e9efe9;
    font-size:24px; line-height:1; cursor:pointer;
  }
  .rules-close:hover{ filter:brightness(1.15); }
</style>

<!-- SHARED OVERLAY / SESSION (same includes as Slots) -->
<script src="/js/bag-overlay.js"></script>
<script src="/js/bag-session.js"></script>
</head>

<body>

<a href="/casino/" class="back-casino">‚¨ÖÔ∏è Back to Casino</a>

<section class="game-header">
  <picture>
    <source type="image/webp"
            srcset="/assets/bag-roulette-960.webp 960w, /assets/bag-roulette-1024.webp 1024w"
            sizes="(min-width:900px) 420px, 70vw">
    <img
      class="hero-img"
      src="/assets/bag-roulette-1024.png"
      srcset="/assets/bag-roulette-960.png 960w, /assets/bag-roulette-1024.png 1024w"
      sizes="(min-width:900px) 420px, 70vw"
      alt="BAG Roulette"
      loading="lazy" decoding="async">
  </picture>
  <h2>üé° $BAG ROULETTE ‚Äî Even Money (RED)</h2>
  <p class="micro" style="margin-top:4px;opacity:.9;">üí∞ <strong>Payouts settle in $BAG.</strong> $XRP stakes auto-convert at the live rate.</p>
</section>

<section class="game-teaser" aria-labelledby="game-teaser-title">
  <div class="game-wrap">

    <!-- LEFT: Controls / Stake (identical to Slots) -->
    <div class="panel mock">
      <!-- CONNECT -->
      <div id="connectRow" style="display:flex;justify-content:space-between;align-items:center;margin:-2px 0 10px 0%;">
        <div id="connectStatus" class="micro" style="opacity:.9">Wallet: <span style="color:#e8a85c">not connected</span></div>
        <button id="connectBtn" style="padding:10px 14px;font-weight:800;border:0;border-radius:12px;color:#08130d;background:linear-gradient(180deg,#ffe175 0%, #f5c94c 100%);box-shadow:0 4px 0 #b08a19;cursor:pointer;">Connect Xaman</button>
      </div>

      <!-- SESSION -->
      <div id="sessionRow" style="display:flex;justify-content:space-between;align-items:center;margin:6px 0 10px 0%;">
        <div id="sessionStatus" class="micro" style="opacity:.9">Session: <span style="color:#2fbf6b">Practice:</span></div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="startSessionBtn" style="padding:8px 12px;font-weight:800;border:0;border-radius:10px;color:#08130d;background:linear-gradient(180deg,#ffe175 0%, #f5c94c 100%);box-shadow:0 3px 0 #b08a19;cursor:pointer;">Start Session</button>
          <button id="topUpBtn" style="padding:8px 12px;font-weight:800;border:0;border-radius:10px;color:#08130d;background:linear-gradient(180deg,#ffe175 0%, #f5c94c 100%);box-shadow:0 3px 0 #b08a19;cursor:pointer;display:none;">Top Up</button>
          <button id="endSessionBtn" style="padding:8px 12px;font-weight:800;border:0;border-radius:10px;background:#15261c;color:#dfe9e2;border:1px solid #2b6a48;cursor:pointer;display:none;">End</button>
        </div>
      </div>

      <div class="section-title">Stake & Prices</div>

      <div class="stake-box">
        <div class="stack">
          <div>
            <div class="micro">Amount</div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
              <div style="display:flex;align-items:center;gap:6px">
                <input id="usdBet" class="mono" type="number" inputmode="decimal" enterkeyhint="done" min="0" max="2000" step="0.01" placeholder="0.00" style="width:140px;background:#0b2217;border:1px solid #1b4a2f;border-radius:10px;color:#f3f5f0;padding:10px">
                <span class="micro" aria-hidden="true">USD</span>
              </div>
            </div>

            <!-- Quick Amount buttons -->
            <div
              class="preset-chips"
              id="usdPresets"
              data-quick-amounts
              data-target-usd="#usdBet"
              data-target-qty="#betQty"
              data-currency-toggle="#curToggle"
              data-min-usd="1"
              data-max-usd="2000"
              data-active-class="active"
              data-sync-on-price="1"
              role="group"
              aria-label="Quick bet"
            >
              <button type="button" class="preset-chip" data-usd="1">$1</button>
              <button type="button" class="preset-chip" data-usd="2">$2</button>
              <button type="button" class="preset-chip" data-usd="5">$5</button>
              <button type="button" class="preset-chip" data-usd="10">$10</button>
              <button type="button" class="preset-chip" data-usd="20">$20</button>
              <button type="button" class="preset-chip" data-usd="50">$50</button>
              <button type="button" class="preset-chip" data-usd="100">$100</button>
              <button type="button" class="preset-chip" data-usd="max">Max</button>
            </div>
          </div>

          <div>
            <div class="micro">Bet currency</div>
            <div class="choice" id="curToggle">
              <label class="chip"><input type="radio" name="betCur" value="XRP" checked> XRP</label>
              <label class="chip"><input type="radio" name="betCur" value="BAG"> BAG</label>
            </div>
          </div>

          <div>
            <div class="micro">Bet amount</div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
              <div>
                <input id="betQty" class="mono" type="number" inputmode="decimal" enterkeyhint="done" min="0" step="any" value="1" style="width:140px;background:#0b2217;border:1px solid #1b4a2f;border-radius:10px;color:#f3f5f0;padding:10px">
                <span class="unit">XRP</span>
              </div>
            </div>
            <div class="micro" id="betLimits" style="margin-top:6px"></div>
          </div>

          <div class="divider"></div>

          <div class="micro">Live prices</div>
          <div class="muted mono" id="liveLine">
            <span id="liveDot" class="warn">‚óè</span>
            <span> BAG $<span id="liveBAG">‚Äî</span> ¬∑ XRP $<span id="liveXRP">‚Äî</span> <span id="liveNote"></span></span>
            <div class="micro" id="liveConv" style="margin-top:4px;opacity:.9;">1 BAG ‚âà ‚Äî XRP ¬∑ 1 XRP ‚âà ‚Äî BAG</div>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- BJ-style readout, adapted for Roulette -->
      <div id="roulette-win-readout" class="mono" aria-live="polite"></div>
    </div>

    <!-- RIGHT: Cabinet (mirrors Slots structure) -->
    <div class="panel" style="padding:16px">
      <div class="marquee">$BAG ROULETTE</div>
      <div class="cabinet">
        <div class="felt">
          <div class="wheel-box">
            <div class="wheel-readout" id="wheelReadout">
              <span class="badge green">‚Äî</span>
              <span class="mono" id="wheelNumber">Waiting‚Ä¶</span>
            </div>
          </div>

          <div class="spin-row">
            <button id="spinBtn" class="btn-spin" aria-label="Spin the wheel">SPIN</button>
          </div>

          <!-- HUD pills identical -->
          <div class="hudbar" aria-live="polite" id="rouletteHud">
            <span class="pill">Mode: <b id="modeLbl">Demo</b></span>
            <span class="pill">Balance: <b id="balLbl">‚Äî</b> <span id="ccyLbl">BAG</span></span>
            <span class="pill">Bet: <b id="betLbl">1</b></span>
            <span class="pill">Last: <b id="lastLbl">‚Äî</b></span>
          </div>

          <p class="micro" style="text-align:center;margin-top:8px;opacity:.75;">
            üîä If you don't hear sound: tap SPIN once, turn off Silent mode, and raise volume.
          </p>

          <div class="result"><div class="t" id="spinText" role="status" aria-live="polite">Bet: RED (1:1) ‚Äî tap SPIN</div></div>
        </div>
      </div>
    </div>

  </div>
</section>

<!-- Rules FAB + Modal -->
<button class="rules-fab" id="rulesFab" aria-haspopup="dialog" aria-controls="rulesOverlay">‚ÑπÔ∏è Rules</button>
<div class="rules-overlay" id="rulesOverlay" role="dialog" aria-modal="true" aria-labelledby="rulesTitle">
  <div class="rules-modal" role="document">
    <button class="rules-close" id="rulesClose" aria-label="Close">√ó</button>
    <h3 id="rulesTitle">üé° Roulette ‚Äî Quick Rules</h3>
    <ul>
      <li><b>Wheel:</b> American (0 and 00, 38 pockets).</li>
      <li><b>Default bet:</b> <b>RED</b> (even-money). Win if the result is a red number. Lose on black or green (0/00).</li>
      <li><b>Payout:</b> 2.00√ó (stake returned + profit) when RED hits.</li>
      <li><b>Settle:</b> payouts are in <b>$BAG</b>. $XRP stakes auto-convert at the live rate.</li>
    </ul>
    <div class="rules-note">Practice mode uses a slightly friendlier hit rate than live. Pushes do not occur on color bets.</div>
  </div>
</div>

<!-- ‚úÖ AUDIO (reuse the Slots audio bundle & names) -->
<script>
(function(){
  const BASE = '/assets/sounds/';
  const FILES = {
    win:     BASE + 'slot-machine-payout.mp3',
    scratch: BASE + 'slot-machine-scratch.mp3',
    lose:    BASE + 'slot-machine-lose.mp3',
    spin:    BASE + 'roulettewheel.mp3'
  };
  const MAX_SPIN_MS = 5000;
  const bust = () => '?v=' + (Date.now() >>> 12);
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let AC=null, MASTER=null, watchdog=null;
  const BUFFERS = { win:null, scratch:null, lose:null, spin:null };
  const TAGS = {};
  let spinSrc=null, spinGain=null, spinTag=null, spinTimer=null;

  function getAC(){ if (AC && AC.state!=='closed') return AC; if (!AudioCtx) return null;
    try{ AC=new AudioCtx({latencyHint:'interactive',sampleRate:44100}); MASTER=AC.createGain(); MASTER.gain.value=.32; MASTER.connect(AC.destination); return AC; }catch{ return null; } }
  async function resume(){ const ac=getAC(); if(!ac) return; if(ac.state==='suspended'){ try{ await ac.resume(); }catch{} } }
  function getTag(key){ if (TAGS[key]) return TAGS[key]; const a=new Audio(); a.preload='auto'; a.playsInline=true; a.crossOrigin='anonymous'; a.src = FILES[key]+bust(); TAGS[key]=a; return a; }
  async function loadBuffer(key){ if (BUFFERS[key]) return BUFFERS[key]; const ac=getAC(); if(!ac) return null; try{
    const r=await fetch(FILES[key]+bust(),{cache:'no-store',mode:'cors'}); if(!r.ok) throw 0; const arr=await r.arrayBuffer(); const buf=await ac.decodeAudioData(arr.slice(0)); BUFFERS[key]=buf; return buf;
  }catch{ return null; } }
  function playOneShot(buf, vol=1){ const ac=getAC(); if(!ac || !buf || ac.state!=='running') return false; try{
    const s=ac.createBufferSource(), g=ac.createGain(); g.gain.value=Math.max(0,Math.min(1,vol)); s.buffer=buf; s.connect(g).connect(MASTER); s.start(); s.onended=()=>{ try{s.disconnect(); g.disconnect();}catch{} }; return true;
  }catch{ return false; } }
  async function sWin(){ await resume(); const b=await loadBuffer('win'); if (b && playOneShot(b,1.0)) return; try{ const a=getTag('win'); a.currentTime=0; a.volume=1; await a.play(); }catch{} }
  async function sLose(){ await resume(); const b=await loadBuffer('lose'); if (b && playOneShot(b,0.95)) return; try{ const a=getTag('lose'); a.currentTime=0; a.volume=.95; await a.play(); }catch{} }
  async function spinLoop(){ await resume(); clearTimeout(spinTimer); const b=await loadBuffer('spin'); const ac=getAC();
    if (b && ac && ac.state==='running'){ try{
      spinSrc=ac.createBufferSource(); spinGain=ac.createGain(); spinGain.gain.value=.22; spinSrc.buffer=b; spinSrc.loop=true; spinSrc.connect(spinGain).connect(MASTER); spinSrc.start(); spinTimer=setTimeout(stopSpin, MAX_SPIN_MS); return { stop: stopSpin };
    }catch{} }
    spinTag=getTag('spin'); spinTag.loop=true; spinTag.volume=.22; try{ await spinTag.play(); }catch{} spinTimer=setTimeout(stopSpin, MAX_SPIN_MS); return { stop: stopSpin };
  }
  function stopSpin(){ try{ if (spinSrc){ spinSrc.stop(); spinSrc.disconnect(); spinSrc=null; } }catch{} try{ if (spinGain){ spinGain.disconnect(); spinGain=null; } }catch{} try{ if (spinTag){ spinTag.pause(); } }catch{} }
  addEventListener('pointerdown', ()=>{ resume(); ['win','lose','spin'].forEach(k=>{ loadBuffer(k); getTag(k); }); }, { passive:true });
  window.__bagAudioRoulette = { win:sWin, lose:sLose, spinLoop, resume };
})();
</script>

<!-- === PRICES (identical to Slots) === -->
<script>
/* (identical bundle from Slots; unchanged for brevity) */
</script>
<script>
// (PASTE THE ENTIRE PRICES BUNDLE FROM YOUR SLOTS PAGE HERE UNCHANGED)
</script>

<!-- ‚úÖ Keep the shared Quick Amount buttons script -->
<script src="/js/bag-quick-amounts.js"></script>

<!-- ‚úÖ UNIVERSAL STAKE WIRE (identical to Slots) -->
<script>
// (PASTE THE ENTIRE BAGStakeWire.init bundle from Slots here UNCHANGED)
</script>
<script>
  BAGStakeWire.init({
    usdInput:'#usdBet',
    qtyInput:'#betQty',
    currencyToggle:'#curToggle',
    unitLabels:'.unit',
    limitsLabel:'#betLimits',
    presetsRoot:'#usdPresets',
    minUsd:1,
    maxUsd:2000,
    activeClass:'active',
    syncOnPrice:true
  });
</script>

<!-- ‚ñë‚ñë‚ñë Roulette WIN Readout (BJ-style box) ‚ñë‚ñë‚ñë -->
<script>
(function(w){
  const nfBAG = new Intl.NumberFormat('en-US',{maximumFractionDigits:6});
  const nfUSD = new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits:2,maximumFractionDigits:2});
  const MULT = { red:2.00, lose:0.00 };

  const Box = {
    el:null,
    state:{ stakeBag:0, usdPerBag:0 },
    init(sel){ this.el = typeof sel==='string' ? document.querySelector(sel) : sel; this.render(); },
    update({stakeBag, usdPerBag}={}){ if (typeof stakeBag==='number') this.state.stakeBag = stakeBag; if (typeof usdPerBag==='number') this.state.usdPerBag = usdPerBag; this.render(); },
    amt(bag){ const usd=(bag||0)*(this.state.usdPerBag||0); return `${nfBAG.format(bag||0)} BAG (${nfUSD.format(usd)})`; },
    render(){
      if(!this.el) return;
      const s = this.state.stakeBag||0;
      this.el.innerHTML = `
        <div class="row"><div class="title">RED (wins on red numbers):</div><div>${this.amt(s*MULT.red)}</div></div>
        <div class="row"><div>Lose (black or green 0/00):</div><div>${this.amt(0)}</div></div>
        <div class="note">Even-money color bet. Payout ${MULT.red.toFixed(2)}√ó on hits.</div>
      `;
    }
  };

  function PR(){ return w.__PRICES__ || { bagUsd:0, xrpUsd:0 }; }
  function currentCurrency(){
    const el = document.querySelector('#curToggle input[name="betCur"]:checked');
    return el ? String(el.value).toUpperCase() : 'XRP';
  }
  function readStakeBag(){
    const qty = parseFloat(document.getElementById('betQty')?.value||'0')||0;
    const { bagUsd, xrpUsd } = PR();
    if (currentCurrency()==='BAG') return qty;
    if (bagUsd>0 && xrpUsd>0) return qty * (xrpUsd/bagUsd);
    return 0;
  }

  function refresh(){
    const P = PR();
    Box.update({ stakeBag: readStakeBag(), usdPerBag: P.bagUsd||0 });
  }

  document.addEventListener('DOMContentLoaded', ()=>{ Box.init('#roulette-win-readout'); refresh(); });
  addEventListener('bag:pricesUpdated', refresh);
  addEventListener('bag:hudRefresh', refresh);
  document.getElementById('betQty')?.addEventListener('input', refresh);
  document.querySelector('#curToggle')?.addEventListener('change', refresh);
})(window);
</script>

<!-- Rules modal logic (same) -->
<script>
(function(){
  const fab = document.getElementById('rulesFab');
  const ov  = document.getElementById('rulesOverlay');
  const x   = document.getElementById('rulesClose');
  function open(){ ov.style.display='grid'; }
  function close(){ ov.style.display='none'; }
  fab?.addEventListener('click', open);
  x?.addEventListener('click', close);
  ov?.addEventListener('click', (e)=>{ if(e.target===ov) close(); });
  addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });
})();
</script>

<!-- Demo/Live session ‚Äî EXACT $2,000 seed (identical to Slots to fix balance) -->
<script>
// (PASTE THE ENTIRE Demo/Live session seed bundle from your Slots page here UNCHANGED)
</script>

<!-- HUD updater (identical structure, target IDs adjusted) -->
<script>
(function(){
  const curToggle = document.getElementById('curToggle');

  function PR(){ return window.__PRICES__ || { bagUsd:0, xrpUsd:0 }; }
  function fmt(n, max=6){ const x = Number(n); if (!Number.isFinite(x)) return '‚Äî'; return x.toLocaleString(undefined, { maximumFractionDigits: max }); }
  function els(){
    return {
      hud: document.getElementById('rouletteHud'),
      balLbl: document.getElementById('balLbl'),
      ccyLbl: document.getElementById('ccyLbl'),
      betLbl: document.getElementById('betLbl'),
      modeLbl: document.getElementById('modeLbl'),
      lastLbl: document.getElementById('lastLbl'),
      betQtyEl: document.getElementById('betQty'),
    };
  }
  function selectedMode(){ return (window.__BAG_FORCE_DEMO === true) ? 'Demo' : 'Live'; }
  function currentCurrency(){ const el = curToggle?.querySelector('input[name="betCur"]:checked'); return el ? String(el.value).toUpperCase() : 'XRP'; }
  function getBalances(){
    const sess = (window.__bagSession && window.__bagSession.get && window.__bagSession.get()) || {};
    const bag = Number(sess.bag) || 0;
    let xrp = Number(sess.xrp);
    if (!(xrp > 0)) {
      const { bagUsd, xrpUsd } = PR();
      if (bagUsd > 0 && xrpUsd > 0) xrp = bag * (bagUsd / xrpUsd);
      else xrp = 0;
    }
    return { bag, xrp };
  }
  function currentBet(){ const { betQtyEl } = els(); const v = parseFloat(betQtyEl?.value || '0'); if (!Number.isFinite(v) || v < 0) return 0; return Number(v); }
  function styleBalanceRow(){
    const { hud } = els(); if (!hud) return;
    hud.style.display='grid'; hud.style.gridTemplateColumns='1fr'; hud.style.gap='6px';
    const pills = hud.querySelectorAll('.pill');
    if (pills.length){
      pills.forEach(p=>{ p.style.fontSize='12px'; p.style.padding='6px 10px'; });
      if (pills[1]){ pills[1].style.fontSize='14px'; pills[1].style.padding='8px 12px'; pills[1].style.fontWeight='800'; }
      const row = document.createElement('div');
      row.style.display='flex'; row.style.flexWrap='wrap'; row.style.gap='6px';
      hud.appendChild(row);
      [pills[0], pills[2], pills[3]].forEach(p=> row.appendChild(p));
    }
  }
  function renderHud(){
    try{
      const { balLbl, ccyLbl, betLbl, modeLbl, lastLbl } = els();
      const mode = selectedMode();
      const ccy  = currentCurrency();
      const { bag, xrp } = getBalances();

      if (modeLbl) modeLbl.textContent = mode;
      if (betLbl)  betLbl.textContent  = fmt(currentBet(), 6);
      if (lastLbl) lastLbl.textContent = String(window.__ROUL_LAST__ || '‚Äî');

      if (balLbl && ccyLbl){
        if (ccy === 'XRP'){ balLbl.textContent = fmt(xrp, 6); ccyLbl.textContent = 'XRP'; }
        else { balLbl.textContent = fmt(bag, 6); ccyLbl.textContent = 'BAG'; }
      }
    }catch(e){}
  }
  ['bag:sessionStarted','bag:sessionToppedUp','bag:sessionEnded','bag:pricesUpdated','bag:walletConnected','bag:walletDisconnected','bag:hudRefresh']
    .forEach(ev => addEventListener(ev, renderHud));
  document.getElementById('betQty')?.addEventListener('input', renderHud);
  curToggle?.addEventListener('change', renderHud);
  addEventListener('storage', (e)=>{ if (e && e.key === '__bag_demo_bag_v2') renderHud(); });
  renderHud();
  styleBalanceRow();
  let tries = 0; const iv = setInterval(()=>{ renderHud(); if(++tries>40) clearInterval(iv); }, 500);
})();
</script>

<!-- ===================== Roulette Logic ===================== -->
<script>
(function(){
  const spinBtn  = document.getElementById('spinBtn');
  const spinText = document.getElementById('spinText');
  const readout  = document.getElementById('wheelReadout');
  const nEl      = document.getElementById('wheelNumber');

  // American wheel sequence and color map (0, 00, 1..36)
  const SEQ = ["00",27,10,25,29,12,8,19,31,18,6,21,33,16,4,23,35,14,2,0,28,9,26,30,11,7,20,32,17,5,22,34,15,3,24,36,13,1];
  const RED  = new Set([1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36]);
  const BLACK= new Set([2,4,6,8,10,11,13,15,17,20,22,24,26,28,29,31,33,35]);

  function colorOf(slot){
    if (slot===0 || slot==="00") return 'green';
    if (RED.has(slot)) return 'red';
    return 'black';
  }

  // Demo vs Live tilt for even-money (RED)
  const DEMO_HIT = 20/38; // ~52.6%
  const LIVE_HIT = 18/38; // ~47.4%
  function useDemo(){ return window.__BAG_FORCE_DEMO === true; }

  // Session helpers (same contract as Slots)
  function sessionActive(){ return !!(window.__bagSession && window.__bagSession.active && window.__bagSession.active()); }
  function credit(b){ try{ return window.__bagSession && window.__bagSession.credit && window.__bagSession.credit(b); }catch{ return false; } }
  function spend(b){ try{ return window.__bagSession && window.__bagSession.spend && window.__bagSession.spend(b); }catch{ return false; } }

  function PR(){ return window.__PRICES__ || { bagUsd:0, xrpUsd:0 }; }
  function currentStakeBag(){
    const q = parseFloat(document.getElementById('betQty')?.value||0) || 0;
    const cur = document.querySelector('#curToggle input[name="betCur"]:checked')?.value?.toUpperCase() || 'XRP';
    const {bagUsd,xrpUsd} = PR();
    if (cur==='BAG') return q;
    if (bagUsd>0 && xrpUsd>0) return q * (xrpUsd/bagUsd);
    return 0;
  }
  function currentStakeUsd(){
    const usdEl = document.getElementById('usdBet');
    const direct = parseFloat(usdEl?.value||'');
    if (Number.isFinite(direct) && direct>0) return direct;
    const q = parseFloat(document.getElementById('betQty')?.value||0) || 0;
    const cur = document.querySelector('#curToggle input[name="betCur"]:checked')?.value?.toUpperCase() || 'XRP';
    const {bagUsd,xrpUsd} = PR();
    if (cur==='BAG') return bagUsd>0 ? q*bagUsd : 0;
    return xrpUsd>0 ? q*xrpUsd : 0;
  }

  function setBadge(col, txt){
    readout.querySelector('.badge')?.classList.remove('red','black','green');
    readout.querySelector('.badge')?.classList.add(col);
    readout.querySelector('.badge').textContent = col.toUpperCase();
    nEl.textContent = String(txt);
  }

  function pickSlot(){
    // Bias result distribution only to meet demo/live hit ratio for RED bet,
    // not altering per-pocket uniformity drastically in live.
    const want = useDemo() ? DEMO_HIT : LIVE_HIT;
    const roll = Math.random();
    let col;
    if (roll < want) col = 'red';
    else {
      // Keep some green mass
      const g = Math.random() < (2/38) ? 'green' : 'black';
      col = g;
    }
    // Pick a pocket of that color uniformly
    let pool;
    if (col==='red') pool = SEQ.filter(x=> RED.has(x));
    else if (col==='black') pool = SEQ.filter(x=> BLACK.has(x));
    else pool = [0,"00"];
    return pool[(Math.random()*pool.length)|0];
  }

  function sWin(){ try{ window.__bagAudioRoulette && __bagAudioRoulette.win(); }catch{} }
  function sLose(){ try{ window.__bagAudioRoulette && __bagAudioRoulette.lose(); }catch{} }
  function playSpin(){ try{ window.__bagAudioRoulette && (__bagAudioRoulette.resume && __bagAudioRoulette.resume(), window.__spinHandle=__bagAudioRoulette.spinLoop()); }catch{} }
  function stopSpin(){ try{ window.__spinHandle && window.__spinHandle.stop && window.__spinHandle.stop(); }catch{} }

  window.__ROUL_LAST__ = window.__ROUL_LAST__ || '‚Äî';
  function setLast(s){ try{ window.__ROUL_LAST__ = s; window.dispatchEvent(new CustomEvent('bag:hudRefresh')); }catch{} }

  spinBtn.addEventListener('click', async ()=>{
    if (spinBtn.disabled) return;

    const sBag = currentStakeBag();
    const sUsd = currentStakeUsd();

    if (!sessionActive()) { alert('Start a session at The Cage'); return; }
    if (sUsd < 1){ alert('Minimum $1 stake'); return; }
    if (!(sBag > 0)) { alert('Enter a stake first'); return; }
    if (!spend(sBag)) { alert('Insufficient balance'); return; }

    spinBtn.disabled = true;
    spinText.className='t';
    spinText.textContent='Spinning‚Ä¶';
    playSpin();

    // Simple ‚Äúspin time‚Äù
    await new Promise(r=>setTimeout(r, 1800 + Math.random()*1800));
    stopSpin();

    const slot = pickSlot();
    const col  = colorOf(slot);
    setBadge(col, slot);

    if (col === 'red'){
      sWin();
      credit(sBag * 2.00);
      spinText.className='t win';
      spinText.textContent='WIN ‚Äî RED hits (2.00√ó)';
      setLast(`RED ${slot}`);
      window.BAGOverlay && BAGOverlay.showWin && BAGOverlay.showWin({ message:'WIN', subtext:`RED ${slot} ¬∑ +${(sBag).toLocaleString(undefined,{maximumFractionDigits:6})} BAG`, duration:4200, sound:false });
    } else {
      sLose();
      spinText.className='t lose';
      const tag = (col==='green'?'GREEN':'BLACK');
      spinText.textContent=`Lose ‚Äî ${tag} ${slot}`;
      setLast(`${tag} ${slot}`);
    }

    spinBtn.disabled = false;
  });
})();
</script>

<!-- Disable pinch/double-tap/ctrl+wheel zoom -->
<script>
  document.addEventListener('gesturestart', (e)=>{ e.preventDefault(); }, {passive:false});
  document.addEventListener('dblclick', (e)=>{ e.preventDefault(); }, {capture:true});
  window.addEventListener('wheel', (e)=>{ if(e.ctrlKey){ e.preventDefault(); } }, {passive:false});
</script>

<footer class="footer" style="text-align:center; padding:12px 0; line-height:1.6;">
  ¬© 2025 $BAG Protocol | getthebag.io | Powered by $XRP
  <br>
  <a href="https://x.com/getthebag_io" target="_blank" rel="noopener" style="color:#e0c66f;text-decoration:none;font-weight:700;">ùïè @getthebag_io</a>
  &nbsp;|&nbsp;
  <a href="https://t.me/getthebag_io" target="_blank" rel="noopener" style="color:#e0c66f;text-decoration:none;font-weight:700;">Telegram @getthebag_io</a>
</footer>

</body>
</html>
