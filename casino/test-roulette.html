      t.classList.add('selected');
      straight = t.dataset.val || '';
      const v = straight==='00' ? null : Number(straight);
      D   = (!v||v===0)? '' : (v<=12?'D1' : v<=24?'D2':'D3');
      COL = (!v||v===0)? '' : (v%3===1?'C1' : v%3===2?'C2':'C3');
      syncHidden(); return;
    }
    if (t.closest('#colBets')){
      allCols().forEach(x=>x.classList.remove('selected'));
      t.classList.add('selected'); COL = String(t.dataset.val||''); syncHidden(); return;
    }
    if (t.closest('#outsideBets')){
      const type = t.dataset.type, val = t.dataset.val;
      if (type==='RB'){ allOutside().forEach(x=>{ if(x.dataset.type==='RB') x.classList.remove('selected'); }); t.classList.add('selected'); RB = val; }
      else if (type==='EO'){ allOutside().forEach(x=>{ if(x.dataset.type==='EO') x.classList.remove('selected'); }); t.classList.add('selected'); EO = val; }
      else if (type==='HL'){ allOutside().forEach(x=>{ if(x.dataset.type==='HL') x.classList.remove('selected'); }); t.classList.add('selected'); HL = val; }
      syncHidden(); return;
    }
  });
})();
</script>

<!-- Wheel + RNG -->
<script>
(function(){
  // Authentic American wheel order
  const WHEEL = ["00",27,10,25,29,12,8,19,31,18,6,21,33,16,4,23,35,14,2,0,28,9,26,30,11,7,20,32,17,5,22,34,15,3,24,36,13,1];
  const COLOR = {}; ["00",0].forEach(n=>COLOR[n]="green");
  [1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36].forEach(n=>COLOR[n]="red");
  [2,4,6,8,10,11,13,15,17,20,22,24,26,28,29,31,33,35].forEach(n=>COLOR[n]="black");

  const COLUMN = {};
  [1,4,7,10,13,16,19,22,25,28,31,34].forEach(n=>COLUMN[n]="C1");
  [2,5,8,11,14,17,20,23,26,29,32,35].forEach(n=>COLUMN[n]="C2");
  [3,6,9,12,15,18,21,24,27,30,33,36].forEach(n=>COLUMN[n]="C3");

  const ring = document.getElementById('ring');
  const ball = document.getElementById('ball');
  const spinBtn = document.getElementById('spinBtn');
  const spinText = document.getElementById('spinText');
  const ticksBox = document.getElementById('ticks');

  const DEG = 360 / WHEEL.length;

  // Build pockets and tick marks
  WHEEL.forEach((val, i)=>{
    const el=document.createElement('div');
    el.className = 'pocket ' + (COLOR[val]||'black');
    el.style.transform = 'rotate('+ (i*DEG) +'deg) translate(-2%, -50%)';
    el.textContent = String(val);
    ring.appendChild(el);

    const tk=document.createElement('div'); tk.className='tick';
    tk.style.transform = 'rotate('+(i*DEG)+'deg)'; ticksBox.appendChild(tk);
  });

  // Maintain our own angles instead of reading matrices
  let ringAngle = 0;
  let ballAngle = 0;
  function ballRadiusPx(){
    const w = ring.clientWidth || 300;
    return Math.max(60, Math.round(w * 0.34));
  }
  function applyTransforms(radius){
    ring.style.transform = 'rotate('+ringAngle+'deg)';
    ball.style.transform = 'rotate('+ballAngle+'deg) translate('+radius+'px)';
  }
  function resetTransitions(){
    ring.style.transition = 'none';
    ball.style.transition = 'none';
  }
  function setTransitions(ms){
    const ease = 'cubic-bezier(.2,.9,.2,1)';
    ring.style.transition = 'transform '+ms+'ms '+ease;
    ball.style.transition = 'transform '+ms+'ms '+ease;
  }

  // Home placement
  function placeHome(){
    resetTransitions();
    applyTransforms(ballRadiusPx());
  }
  placeHome();
  addEventListener('resize', ()=>applyTransforms(ballRadiusPx()));

  function randIndex(){
    const a=new Uint32Array(1);
    crypto.getRandomValues(a);
    return Math.floor((a[0] / 0x100000000) * WHEEL.length);
  }

  function stakeBag(){
    const p = window.__PRICES__ || {};
    const c = (document.querySelector('#curToggle input[name="betCur"]:checked')?.value || 'XRP').toUpperCase();
    const qty = Math.max(0, parseFloat(document.getElementById('betQty')?.value||'0'));
    if (c==='BAG') return qty;
    if (p.bagUsd>0 && p.xrpUsd>0){
      const bagPerXrp = p.xrpUsd / p.bagUsd;
      return qty * bagPerXrp;
    }
    return 0;
  }
  function stakeUsd(){
    const p = window.__PRICES__ || {};
    const qty = Math.max(0, parseFloat(document.getElementById('betQty')?.value||'0'));
    const c = (document.querySelector('#curToggle input[name="betCur"]:checked')?.value || 'XRP').toUpperCase();
    const px = (c==='BAG') ? (p.bagUsd||0) : (p.xrpUsd||0);
    return px>0 ? qty*px : 0;
  }

  function selectedBetsCount(){
    const b = {
      straight:(document.getElementById('betStraight').value||'').trim(),
      rb:document.getElementById('betRB').value,
      eo:document.getElementById('betEO').value,
      hl:document.getElementById('betHL').value,
      dozen:document.getElementById('betDozen').value,
      col:document.getElementById('betCol').value
    };
    let c=0; if(b.straight) c++; if(b.rb) c++; if(b.eo) c++; if(b.hl) c++; if(b.dozen) c++; if(b.col) c++;
    return Math.max(1,c);
  }

  function computePayout(hit, stake){
    const b = {
      straight:(document.getElementById('betStraight').value||'').trim().toUpperCase(),
      rb:document.getElementById('betRB').value,
      eo:document.getElementById('betEO').value,
      hl:document.getElementById('betHL').value,
      dozen:document.getElementById('betDozen').value,
      col:document.getElementById('betCol').value
    };
    let win = 0, notes = [];
    if (b.straight){
      const v = b.straight;
      const valid = (v==="00") || (!isNaN(+v) && +v>=0 && +v<=36);
      if(valid && String(hit)===v){ win += 35*stake; notes.push('Straight 35:1'); }
    }
    const colorHit = COLOR[hit];
    if (b.rb && colorHit && colorHit.toUpperCase()===b.rb){ win += 1*stake; notes.push('RB 1:1'); }
    if (b.eo && typeof hit==="number" && hit!==0){
      if((b.eo==="EVEN" && hit%2===0) || (b.eo==="ODD" && hit%2===1)){ win += 1*stake; notes.push('EO 1:1'); }
    }
    if (b.hl && typeof hit==="number" && hit!==0){
      if((b.hl==="LOW" && hit>=1 && hit<=18) || (b.hl==="HIGH" && hit>=19 && hit<=36)){ win += 1*stake; notes.push('HL 1:1'); }
    }
    if (b.dozen && typeof hit==="number" && hit!==0){
      if((b.dozen==="D1" && hit>=1 && hit<=12) || (b.dozen==="D2" && hit>=13 && hit<=24) || (b.dozen==="D3" && hit>=25 && hit<=36)){
        win += 2*stake; notes.push('Dozen 2:1');
      }
    }
    if (b.col && COLUMN[hit]===b.col){ win += 2*stake; notes.push('Column 2:1'); }
    return {win, notes};
  }

  let spinning=false;

  spinBtn.addEventListener('click', async ()=>{
    if (spinning) return;
    const sBag = stakeBag(), sUsd = stakeUsd();
    if (sUsd < 1 && !window.__BAG_FORCE_DEMO){ alert('Minimum $1 stake'); return; }
    if (!window.__BAG_FORCE_DEMO){ if (!(window.__bagSession && window.__bagSession.spend && window.__bagSession.spend(sBag))) return; }

    spinning = true;
    spinBtn.disabled = true; spinText.className='t'; spinText.textContent='Spinning…';

    try{ if (window.__bagAudio && __bagAudio.resume) await __bagAudio.resume(); }catch{}
    try{ window.__bagAudio?.startSpinLoop?.(); }catch{}

    // Pick result
    const idx = randIndex();
    const hit = WHEEL[idx];

    // Target angles
    const revs = 16;                 // full spins of the wheel
    const dur  = 9000;               // ms
    const pocketDeg = 360 / WHEEL.length;
    const targetRing = ringAngle + 360*revs + (360 - idx*pocketDeg);
    const targetBall = ballAngle - (360*revs + 540 + (360 - idx*pocketDeg)); // opposite direction + extra to feel right

    // Animate with shrinking radius bounce
    const baseR = ballRadiusPx();
    setTransitions(dur);
    ringAngle = targetRing;
    ballAngle = targetBall;
    applyTransforms(baseR);

    const t0 = performance.now();
    let raf;
    function bounce(){
      const t = performance.now() - t0;
      const p = Math.min(1, t / dur);
      const amp = (1 - p) * 12;
      const freq = 10 + 8*(1-p);
      const r = baseR + Math.sin(t/1000*freq*2*Math.PI) * amp;
      // keep transforms while radius changes
      resetTransitions();
      applyTransforms(r);
      setTransitions(Math.max(0, dur - t));
      if (p < 1) { raf = requestAnimationFrame(bounce); }
    }
    raf = requestAnimationFrame(bounce);

    setTimeout(()=>{
      cancelAnimationFrame(raf);
      resetTransitions();
      applyTransforms(baseR);
      try{ window.__bagAudio?.stopSpinLoop?.(); }catch{}

      const {win, notes} = computePayout(hit, sBag);
      const net = win - sBag * selectedBetsCount();
      document.getElementById('lastLbl').textContent = String(hit);

      if (net > 0){
        try{ window.__bagAudio && window.__bagAudio.chime(); }catch{}
        window.__bagSession?.credit?.(win);
        spinText.className='t win';
        spinText.textContent = 'WIN on ' + String(hit) + ' · +' + win.toLocaleString(undefined,{maximumFractionDigits:6}) + ' BAG';
      } else if (net === 0){
        spinText.className='t scratch';
        spinText.textContent = 'PUSH on ' + String(hit) + ' · bets offset';
      } else {
        try{ window.__bagAudio && window.__bagAudio.thud(); }catch{}
        spinText.className='t lose';
        spinText.textContent = 'Lose on ' + String(hit) + ' — try again';
      }

      spinBtn.disabled = false; spinning = false;
    }, dur + 120);
  });
})();
</script>

<!-- HUD updater + Rules pill -->
<script>
(function(){
  function PR(){ return window.__PRICES__ || { bagUsd:0, xrpUsd:0 }; }
  function fmt(n, max=6){ const x=Number(n); if(!Number.isFinite(x)) return '—'; return x.toLocaleString(undefined,{maximumFractionDigits:max}); }
  function cur(){ const el=document.querySelector('#curToggle input[name="betCur"]:checked'); return el?String(el.value).toUpperCase():'XRP'; }
  function balances(){
    const sess = (window.__bagSession && window.__bagSession.get && window.__bagSession.get()) || {};
    const bag = Number(sess.bag)||0;
    let xrp = Number(sess.xrp);
    if (!(xrp > 0)) {
      const { bagUsd, xrpUsd } = PR();
      xrp = (bagUsd>0 && xrpUsd>0) ? bag * (bagUsd/xrpUsd) : 0;
    }
    return {bag,xrp};
  }
  function render(){
    const balLbl=document.getElementById('balLbl'), ccyLbl=document.getElementById('ccyLbl'), betLbl=document.getElementById('betLbl'), modeLbl=document.getElementById('modeLbl');
    const {bag,xrp} = balances(); const c=cur();
    if (modeLbl) modeLbl.textContent = (window.__BAG_FORCE_DEMO ? 'DEMO' : 'LIVE');
    if (ccyLbl) ccyLbl.textContent = c;
    if (balLbl) balLbl.textContent = fmt(c==='XRP'?xrp:bag);
    if (betLbl){ const v=parseFloat(document.getElementById('betQty')?.value||'0'); betLbl.textContent = (c==='BAG'?Math.floor(v):Math.floor(v*1e6)/1e6); }
  }
  ['input','change'].forEach(ev=>{
    document.getElementById('betQty')?.addEventListener(ev, render);
    document.getElementById('curToggle')?.addEventListener(ev, render);
  });
  addEventListener('bag:pricesUpdated', render);
  addEventListener('bag:sessionToppedUp', render);
  addEventListener('bag:sessionSpent', render);
  render();

  // Rules pill wiring
  const pill = document.getElementById('rulesPill');
  const modal = document.getElementById('rulesModal');
  const close = document.getElementById('rulesClose');
  function open(){ modal.style.display='block'; pill.setAttribute('aria-expanded','true'); }
  function hide(){ modal.style.display='none'; pill.setAttribute('aria-expanded','false'); }
  pill?.addEventListener('click', open);
  close?.addEventListener('click', hide);
  modal?.addEventListener('click', (e)=>{ if (e.target===modal) hide(); });
  addEventListener('keydown', (e)=>{ if (e.key==='Escape') hide(); });
})();
</script>

<script>
(function(){function setVW(){var vw=Math.min(window.innerWidth||0,document.documentElement.clientWidth||0);document.documentElement.style.setProperty('--vwpx',vw+'px');}setVW();addEventListener('resize',setVW);addEventListener('orientationchange',setVW);}());
</script>

<footer class="footer" style="text-align:center; padding:12px 0; line-height:1.6; width:100%; margin:0 auto;">
  © 2025 $BAG Protocol | getthebag.io | Powered by $XRP
  <br>
  <a href="https://x.com/getthebag_io" target="_blank" rel="noopener" style="color:#e0c66f;text-decoration:none;font-weight:700;">𝕏 @getthebag_io</a> |
  <a href="https://t.me/getthebag_io" target="_blank" rel="noopener" style="color:#e0c66f;text-decoration:none;font-weight:700;">Telegram @getthebag_io</a>
</footer>

</body>
</html>
