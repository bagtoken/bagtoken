// Spin (debits full cost up front, credits full win)
let spinning = false;
document.getElementById('spinBtn').addEventListener('click', async ()=>{
  if (spinning) return;

  // Read selections BEFORE spending
  const picksNow = {
    straight:(document.getElementById('betStraight').value||'').trim().toUpperCase(),
    rb:document.getElementById('betRB').value,
    eo:document.getElementById('betEO').value,
    hl:document.getElementById('betHL').value,
    dozen:document.getElementById('betDozen').value,
    col:document.getElementById('betCol').value
  };
  const selections = [
    picksNow.straight && 'S', picksNow.rb && 'RB', picksNow.eo && 'EO',
    picksNow.hl && 'HL', picksNow.dozen && 'D', picksNow.col && 'C'
  ].filter(Boolean).length || 1;

  // Base stake in BAG (from XRP/BAG selection)
  const sBagBase = (function stakeBag(){
    const p = window.__PRICES__ || {};
    const c = (document.querySelector('#curToggle input[name="betCur"]:checked')?.value || 'XRP').toUpperCase();
    const qty = Math.max(0, parseFloat(document.getElementById('betQty')?.value||'0'));
    if (c==='BAG') return qty;
    if (p.bagUsd>0 && p.xrpUsd>0){ return qty * (p.xrpUsd/p.bagUsd); }
    return qty * (0.50/0.02); // safe demo fallback
  })();

  const totalCost = sBagBase * selections;
  if (!(totalCost > 0)) {
    const t=document.getElementById('spinText'); t.className='t scratch'; t.textContent='Enter a stake first';
    return;
  }

  // Try to debit the full cost up front
  if (!(window.__bagSession && window.__bagSession.spend && window.__bagSession.spend(totalCost))) {
    const t=document.getElementById('spinText'); t.className='t scratch'; t.textContent='Insufficient Practice balance';
    return;
  }

  spinning = true;
  const btn = document.getElementById('spinBtn');
  const spinText = document.getElementById('spinText');
  btn.disabled = true; spinText.className='t'; spinText.textContent='Spinning…';
  try{ window.__bagAudio?.resume?.(); window.__bagAudio?.startSpinLoop?.(); }catch{}

  // RNG → pocket
  function randSeed(){ const a=new Uint32Array(1); crypto.getRandomValues(a); return a[0]; }
  const seed = randSeed();
  const idx = Math.floor((seed / 0x100000000) * WHEEL.length);
  const hit = WHEEL[idx];

  // Motion
  const DURATION_MS = 9000;
  const ringRevs = 16, ballRevs = 24;
  const DEG = 360 / WHEEL.length;
  const pocketCenterTop = idx*DEG + DEG/2;
  const ANGLE_OFFSET = 90, MARKER_DEG = 0;
  const desiredAbs = 0 + ANGLE_OFFSET - pocketCenterTop;
  const rpx = (function ballRadiusPx(){ const svg=document.getElementById('ringSvg'); return Math.max(60, Math.round((svg.getBoundingClientRect().width || 300) * 0.345)); })();

  const ringG = document.getElementById('ringG');
  const ball  = document.getElementById('ball');

  const ringTarget = 360*ringRevs + desiredAbs;
  const ballTarget = MARKER_DEG - 360*ballRevs;

  ringG.style.transition = `transform ${DURATION_MS}ms cubic-bezier(.2,.9,.2,1)`;
  ball.style.transition  = `transform ${DURATION_MS}ms cubic-bezier(.2,.9,.2,1)`;
  requestAnimationFrame(()=>{
    ringG.style.transform = `rotate(${ringTarget}deg)`;
    ball.style.transform  = `rotate(${ballTarget}deg) translate(${rpx}px)`;
  });

  setTimeout(()=>{
    try{ window.__bagAudio?.stopSpinLoop?.(); }catch{}

    // Compute WIN for the selections we debited
    function computePayout(hit, picks, stake){
      let win=0;
      if (picks.straight){ const v=picks.straight; const valid=(v==="00")||(!isNaN(+v)&&+v>=0&&+v<=36); if(valid && String(hit)===v){ win+=35*stake; } }
      const colorH = COLOR[hit];
      if (picks.rb && colorH && colorH.toUpperCase()===picks.rb){ win += 1*stake; }
      if (picks.eo && typeof hit==="number" && hit!==0){
        if((picks.eo==="EVEN" && hit%2===0) || (picks.eo==="ODD" && hit%2===1)){ win += 1*stake; }
      }
      if (picks.hl && typeof hit==="number" && hit!==0){
        if((picks.hl==="LOW" && hit>=1 && hit<=18) || (picks.hl==="HIGH" && hit>=19 && hit<=36)){ win += 1*stake; }
      }
      if (picks.dozen && typeof hit==="number" && hit!==0){
        if((picks.dozen==="D1" && hit>=1 && hit<=12) || (picks.dozen==="D2" && hit>=13 && hit<=24) || (picks.dozen==="D3" && hit>=25 && hit<=36)){ win += 2*stake; }
      }
      if (picks.col && typeof hit==="number" && COLUMN[hit]===picks.col){ win += 2*stake; }
      return win;
    }

    const winBag = computePayout(hit, picksNow, sBagBase);
    const netBag = winBag - totalCost;
    document.getElementById('lastLbl').textContent = String(hit);

    const bagUsd = (window.__PRICES__||{}).bagUsd || 0.02;
    const netUsd = netBag * bagUsd;

    // Credit wins (we already debited total cost)
    if (winBag > 0){ window.__bagSession?.credit?.(winBag); try{ window.__bagAudio?.chime?.(); }catch{} }

    // UI
    if (netBag > 0){
      spinText.className='t win';
      spinText.textContent = `WIN on ${String(hit)} · +${netBag.toLocaleString(undefined,{maximumFractionDigits:6})} BAG net`;
    } else if (netBag === 0){
      spinText.className='t scratch';
      spinText.textContent = `PUSH on ${String(hit)} · bets offset`;
    } else {
      try{ window.__bagAudio?.thud?.(); }catch{}
      spinText.className='t lose';
      spinText.textContent = `Lose on ${String(hit)} — net ${netBag.toLocaleString(undefined,{maximumFractionDigits:6})} BAG`;
    }

    // Overlay
    (function(){
      const overlay = document.getElementById('winOverlay');
      const winTitle= document.getElementById('winTitle');
      const winAmt  = document.getElementById('winAmt');
      const winUsd  = document.getElementById('winUsd');
      const winBreak= document.getElementById('winBreak');

      const parts=[];
      if (picksNow.straight) parts.push('Straight');
      if (picksNow.rb) parts.push(picksNow.rb);
      if (picksNow.eo) parts.push(picksNow.eo);
      if (picksNow.hl) parts.push(picksNow.hl==='LOW'?'1–18':'19–36');
      if (picksNow.dozen) parts.push(picksNow.dozen);
      if (picksNow.col) parts.push(picksNow.col);

      winTitle.textContent = `Result ${String(hit)}`;
      winAmt.textContent   = `${netBag>=0?'+':''}${netBag.toLocaleString(undefined,{maximumFractionDigits:6})} BAG net`;
      winUsd.textContent   = `${netUsd>=0?'+':''}$${Math.abs(netUsd).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}`;
      winBreak.textContent = `Cost ${totalCost.toLocaleString(undefined,{maximumFractionDigits:6})} · Win ${winBag.toLocaleString(undefined,{maximumFractionDigits:6})} · ${parts.join(' · ')}`;
      overlay.style.display='flex';
    })();

    // Snap to precise final and bounce
    function norm(d){ return ((d % 360) + 360) % 360; }
    const finalRing = norm(ringTarget);
    ringG.style.transition = 'none';
    ball.style.transition = 'none';
    ringG.style.transform = `rotate(${finalRing}deg)`;
    ball.style.transform  = `rotate(${MARKER_DEG}deg) translate(${rpx}px)`;
    ball.style.setProperty('--finalBall', `rotate(${MARKER_DEG}deg) translate(${rpx}px)`);
    ball.style.setProperty('--finalBallDeg', `${MARKER_DEG}deg`);
    ball.style.setProperty('--finalBallR', `${rpx}px`);
    ball.classList.remove('bounce'); void ball.offsetWidth; ball.classList.add('bounce');

    spinning = false; btn.disabled = false;
    window.dispatchEvent(new CustomEvent('bag:sessionSpent'));
  }, DURATION_MS + 60);
});
