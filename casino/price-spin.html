<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="format-detection" content="telephone=no" />
<title>$BAG Price Spin ‚Äî The Big Wheel</title>

<link rel="preconnect" href="https://api.coingecko.com" crossorigin>
<script src="https://xaman.app/assets/cdn/xumm.min.js"></script>
<script>window.__BAG_FORCE_DEMO = false;</script>

<style>
  *{box-sizing:border-box}
  :root{
    --gold:#ffe175;--bg:#020703;--panel:#0b1b13;--panel2:#0d2217;--muted:#aeb7af;--fg:#f5f7f4;
    --green:#2fbf6b;--green-600:#249a55;--line:#173524;--shadow:rgba(0,0,0,.35);
    --lose:#e25b5b;
  }
  html,body{margin:0;background:var(--bg);color:var(--fg);
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.55}
  img{display:block;max-width:100%;height:auto}
  button,input{font-size:16px}

  a[x-apple-data-detectors]{ color:inherit!important; text-decoration:none!important; pointer-events:none!important; cursor:default!important; }

  .back-casino{
    position:fixed;top:18px;left:18px;z-index:1000;
    background:linear-gradient(180deg,#ffe175 0%,#f5c94c 100%);
    color:#08130d;text-decoration:none;font-weight:800;padding:8px 14px;border-radius:10px;
    box-shadow:0 4px 0 #b08a19;transition:all .15s ease
  }
  .back-casino:hover{filter:brightness(1.05);box-shadow:0 4px 0 #b08a19,0 14px 28px rgba(255,225,117,.22)}
  .back-casino:active{transform:translateY(1px);box-shadow:0 3px 0 #9a7315}

  .game-header{text-align:center;padding:36px 10px 14px}
  .game-header img.hero-img{margin:0 auto 10px;filter:drop-shadow(0 10px 24px rgba(46,191,107,.18))}
  .game-header h2{font-size:clamp(1.6rem,5vw,2.2rem);margin:6px 0 0}
  @media (min-width:900px){
    .game-header img.hero-img{width:34vw;max-width:420px;margin-left:auto;margin-right:auto}
  }

  .game-teaser{padding:10px 16px 60px;background:
    radial-gradient(1200px 600px at 10% -10%, #0e2c1d 0%, transparent 60%),
    radial-gradient(900px 500px at 110% 20%, #0b2318 0%, transparent 55%),#060806;
    border-top:1px solid #131313;border-bottom:1px solid #131313}
  .game-wrap{max-width:1080px;margin:0 auto;display:grid;grid-template-columns:1.12fr .88fr;gap:22px}
  @media (max-width:900px){.game-wrap{grid-template-columns:1fr}}

  .panel{background:linear-gradient(180deg,var(--panel) 0%,var(--panel2) 100%);
    border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 24px var(--shadow)}
  .mock{padding:16px}

  .section-title{font-weight:800;font-size:1.2rem;margin:0 0 12px}
  .stake-box{padding:14px}
  .stack{display:grid;gap:10px}
  .choice{display:flex;gap:10px;flex-wrap:wrap}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid #2b6a48;background:#0e2a1c;color:#e9efe9;font-weight:800}
  .chip input{accent-color:#2fbf6b}
  .mono{font-variant-numeric:tabular-nums}
  .micro{font-size:.85rem;color:#a8b5ab}
  .muted{color:#cfd6cf}
  .divider{height:1px;background:#123221;margin:10px 0}
  .callout{margin-top:12px;padding:12px;border:1px dashed #29543d;border-radius:12px;background:#0c2418;color:#e4efe7}
  .payout-grid{display:grid;gap:4px}
  .payout-grid .row{display:flex;justify-content:space-between}
  .payout-grid .lab{color:#cfd6cf}
  .payout-grid .val{font-variant-numeric:tabular-nums}

  #liveDot{margin-right:6px}
  .ok{color:#2fbf6b}
  .warn{color:#e8a85c}
  .err{color:var(--lose)}

  .table{background:#07140e;border:1px solid #1b4a2f;border-radius:14px;padding:14px}
  .felt{
    display:grid;grid-template-columns:1fr;gap:12px;
    background:#091a13;border:1px solid #24533a;border-radius:12px;padding:12px;overflow:hidden
  }
  .marquee{ text-align:center;font-weight:900;letter-spacing:.08em;
    color:#ffe9a6;background:linear-gradient(180deg,#17311f,#0e2419);
    border:1px solid #254a33;border-radius:12px;padding:8px }

  /* BIG WHEEL (front-facing) */
  .stage2d{ height:520px; position:relative; border-radius:10px; overflow:hidden; display:grid; place-items:center; }
  .wheel-wrap{ position:relative; width:min(560px, 92vw); aspect-ratio:1 / 1; }
  canvas#wheel{ width:100%; height:100%; display:block; touch-action:pan-y; }
  .flapper{
    position:absolute; top:4px; left:50%; transform:translateX(-50%);
    width:0;height:0;border-left:16px solid transparent;border-right:16px solid transparent;border-bottom:28px solid #ffd34d;
    filter:drop-shadow(0 4px 8px rgba(0,0,0,.5)); pointer-events:none;
  }
  .flapper-stem{
    position:absolute; top:-8px; left:50%; transform:translateX(-50%);
    width:10px;height:26px;background:#4b3b1a;border-radius:6px 6px 2px 2px; box-shadow:0 2px 6px rgba(0,0,0,.5) inset;
  }
  .roll-row{display:flex;justify-content:center;gap:10px;flex-wrap:wrap}
  .btn-roll{
    width:min(360px,90%);padding:16px 22px;margin-top:2px;
    font-size:1.15rem;font-weight:900;text-transform:uppercase;letter-spacing:.5px;border:0;border-radius:14px;
    color:#08130d;background:linear-gradient(180deg,#ffe175 0%, #f5c94c 100%);
    box-shadow:0 6px 0 #b08a19, 0 16px 32px rgba(255,225,117,.18), inset 0 1px 0 rgba(255,255,255,.35);
    transition:transform .06s ease, box-shadow .2s ease, filter .2s ease; cursor:pointer;
  }
  .btn-roll:active{transform:translateY(2px);box-shadow:0 4px 0 #9a7315,0 12px 24px rgba(255,225,117,.2), inset 0 1px 0 rgba(255,255,255,.3)}
  .btn-roll:disabled{opacity:.65;cursor:not-allowed}
  .t.win{color:#2fbf6b}.t.lose{color:var(--lose)}
  .pill{ background:#0a1e15; border:1px solid #244330; border-radius:999px; padding:6px 10px; font-size:12px; color:#cfe6d8 }
  .hudbar{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; margin:6px 2px 0; }
</style>

<!-- SHARED OVERLAY / SESSION -->
<script src="/js/bag-overlay.js"></script>
<script src="/js/bag-session.js"></script>
</head>

<body>

<a href="/casino/" class="back-casino">‚¨ÖÔ∏è Back to Casino</a>

<section class="game-header">
  <picture>
    <source type="image/webp"
            srcset="/assets/bag-pricewheel-960.webp 960w, /assets/bag-pricewheel-1024.webp 1024w"
            sizes="(min-width:900px) 420px, 70vw">
    <img
      class="hero-img"
      src="/assets/bag-pricewheel-1024.png"
      srcset="/assets/bag-pricewheel-960.png 960w, /assets/bag-pricewheel-1024.png 1024w"
      sizes="(min-width:900px) 420px, 70vw"
      alt="$BAG Price Spin ‚Äî The Big Wheel"
      loading="lazy" decoding="async">
  </picture>
  <h2>üé° $BAG PRICE SPIN ‚Äî The Big Wheel</h2>
  <p class="micro" style="margin-top:4px;opacity:.9;">üí∞ <strong>All payouts are in $BAG.</strong> $XRP bets convert automatically at the live rate.</p>
</section>

<section class="game-teaser">
  <div class="game-wrap">

    <!-- LEFT -->
    <div class="panel mock" id="bagWheel">
      <!-- CONNECT / SESSION / STAKE (UNCHANGED FROM YOUR TEMPLATE) -->
      <div id="connectRow" style="display:flex;justify-content:space-between;align-items:center;margin:-2px 0 10px 0%;">
        <div id="connectStatus" class="micro" style="opacity:.9">Wallet: <span style="color:#e8a85c">not connected</span></div>
        <button id="connectBtn" style="padding:10px 14px;font-weight:800;border:0;border-radius:12px;color:#08130d;background:linear-gradient(180deg,#ffe175 0%, #f5c94c 100%);box-shadow:0 4px 0 #b08a19;cursor:pointer;">Connect Xaman</button>
      </div>

      <div id="sessionRow" style="display:flex;justify-content:space-between;align-items:center;margin:6px 0 10px 0%;">
        <div id="sessionStatus" class="micro" style="opacity:.9">Session: <span style="color:#2fbf6b">Practice:</span></div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="startSessionBtn" style="padding:8px 12px;font-weight:800;border:0;border-radius:10px;color:#08130d;background:linear-gradient(180deg,#ffe175 0%, #f5c94c 100%);box-shadow:0 3px 0 #b08a19;cursor:pointer;">Start Session</button>
          <button id="topUpBtn" style="padding:8px 12px;font-weight:800;border:0;border-radius:10px;color:#08130d;background:linear-gradient(180deg,#ffe175 0%, #f5c94c 100%);box-shadow:0 3px 0 #b08a19;cursor:pointer;display:none;">Top Up</button>
          <button id="endSessionBtn" style="padding:8px 12px;font-weight:800;border:0;border-radius:10px;background:#15261c;color:#dfe9e2;border:1px solid #2b6a48;cursor:pointer;display:none;">End</button>
        </div>
      </div>

      <div class="section-title">Stake & Prices</div>
      <!-- Stake UI (same as Dice) -->
      <div class="stake-box">
        <div class="stack">
          <div>
            <div class="micro">Amount</div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
              <div style="display:flex;align-items:center;gap:6px">
                <input id="usdBet" class="mono" type="number" inputmode="decimal" enterkeyhint="done" min="0" max="2000" step="0.01" placeholder="0.00" style="width:140px;background:#0b2217;border:1px solid #1b4a2f;border-radius:10px;color:#f3f5f0;padding:10px">
                <span class="micro" aria-hidden="true">USD</span>
              </div>
            </div>
            <div class="preset-chips"
              id="usdPresets"
              data-quick-amounts
              data-target-usd="#usdBet"
              data-target-qty="#betQty"
              data-currency-toggle="#curToggle"
              data-min-usd="1"
              data-max-usd="2000"
              data-active-class="active"
              data-sync-on-price="1"
              role="group"
              aria-label="Quick bet">
              <button type="button" class="preset-chip" data-usd="1">$1</button>
              <button type="button" class="preset-chip" data-usd="2">$2</button>
              <button type="button" class="preset-chip" data-usd="5">$5</button>
              <button type="button" class="preset-chip" data-usd="10">$10</button>
              <button type="button" class="preset-chip" data-usd="20">$20</button>
              <button type="button" class="preset-chip" data-usd="50">$50</button>
              <button type="button" class="preset-chip" data-usd="100">$100</button>
              <button type="button" class="preset-chip" data-usd="max">Max</button>
            </div>
          </div>

          <div>
            <div class="micro">Bet currency</div>
            <div class="choice" id="curToggle">
              <label class="chip"><input type="radio" name="betCur" value="XRP" checked> XRP</label>
              <label class="chip"><input type="radio" name="betCur" value="BAG"> BAG</label>
            </div>
          </div>

          <div>
            <div class="micro">Bet amount</div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
              <div>
                <input id="betQty" class="mono" type="number" inputmode="decimal" enterkeyhint="done" min="0" step="any" value="1" style="width:140px;background:#0b2217;border:1px solid #1b4a2f;border-radius:10px;color:#f3f5f0;padding:10px">
                <span class="unit">XRP</span>
              </div>
            </div>
            <div class="micro" id="betLimits" style="margin-top:6px"></div>
          </div>

          <div class="divider"></div>

          <div class="micro">Live prices</div>
          <div class="muted mono" id="liveLine">
            <span id="liveDot" class="warn">‚óè</span>
            <span> BAG $<span id="liveBAG">‚Äî</span> ¬∑ XRP $<span id="liveXRP">‚Äî</span> <span id="liveNote"></span></span>
            <div class="micro" id="liveConv" style="margin-top:4px;opacity:.9;">1 BAG ‚âà ‚Äî XRP ¬∑ 1 XRP ‚âà ‚Äî BAG</div>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Payouts preview -->
      <div class="callout mono" id="payoutBox">
        <div class="payout-grid">
          <div class="row"><div class="lab"><strong>Exact 1.00</strong> (‚â§2 spins):</div><div class="val" id="payExact">‚Äî</div></div>
          <div class="row"><div class="lab"><strong>Near 1.00</strong> (0.95‚Äì0.99):</div><div class="val" id="payNear">‚Äî</div></div>
          <div class="row"><div class="lab"><strong>Bonus Spin</strong> (only if exact 1.00):</div><div class="val">0.05‚Üí5√ó ¬∑ 0.15‚Üí15√ó ¬∑ 1.00‚Üí25√ó</div></div>
          <div class="row"><div class="lab"><strong>Bust</strong> (&gt;1.00):</div><div class="val">0 BAG ($0.00)</div></div>
        </div>
        <div class="micro" style="margin-top:6px;opacity:.85;">
          Spin up to <b>two</b> times to hit <b>1.00</b> without going over. Exact 1.00 pays <b>5√ó</b> and triggers a <b>bonus spin</b>.
          Totals in <b>[0.95, 0.99]</b> pay <b>1√ó</b>. Otherwise <b>0√ó</b>.
        </div>
      </div>

      <!-- WHEEL -->
      <div class="dice-wrap">
        <div class="marquee">$BAG PRICE SPIN</div>
        <div class="table">
          <div class="felt">
            <div class="stage2d" aria-label="Wheel area">
              <div class="wheel-wrap">
                <div class="flapper-stem" aria-hidden="true"></div>
                <div class="flapper" aria-hidden="true"></div>
                <canvas id="wheel" width="900" height="900"></canvas>
              </div>
            </div>
            <div class="roll-row">
              <button id="spinBtn" class="btn-roll">SPIN</button>
              <button id="holdBtn" class="btn-roll" style="width:auto;padding:14px 18px;">HOLD</button>
              <button id="resetBtn" class="btn-roll" style="width:auto;padding:14px 18px;background:linear-gradient(180deg,#c3c7cc 0%, #aeb3b9 100%);box-shadow:0 6px 0 #7b8086,0 16px 32px rgba(190,198,206,.18), inset 0 1px 0 rgba(255,255,255,.35);color:#0b1016;">RESET</button>
            </div>

            <div class="hudbar" aria-live="polite" id="diceHud">
              <span class="pill">Mode: <b id="modeLbl">Demo</b></span>
              <span class="pill">Balance: <b id="balLbl">‚Äî</b> <span id="ccyLbl">BAG</span></span>
              <span class="pill">Bet: <b id="betLbl">1</b></span>
              <span class="pill">Last: <b id="lastLbl">‚Äî</b></span>
            </div>

            <p class="micro" style="text-align:center;margin-top:8px;opacity:.75;">
              üéõÔ∏è Swipe up/down on the wheel (or click-drag) to set spin strength. Tap SPIN to auto-spin. No jackpot anthem on this game by design.
            </p>
            <div class="result"><div class="t" id="rollText" role="status" aria-live="polite">Spin up to two times to reach 1.00 without going over.</div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: How it plays (same as before) -->
    <div class="panel" style="padding:16px">
      <h3 style="margin:0 0 8px;font-size:1.2rem;">How it plays (Showcase Showdown rules)</h3>
      <p style="color:#cfd6cf;margin:0 0 8px;">Hit <b>as close to 1.00</b> as possible in <b>two spins or fewer</b> without going over.</p>
      <h4 style="margin:12px 0 6px;">Wheel</h4>
      <ul style="margin:0;padding-left:18px;color:#cfd6cf">
        <li>20 equal slices: <b>0.05</b> to <b>1.00</b> in <b>0.05</b> steps. Front-facing vertical wheel with pegs and flapper.</li>
        <li>Swipe to spin; you may <b>HOLD</b> after the first spin.</li>
      </ul>
      <h4 style="margin:12px 0 6px;">Payouts</h4>
      <ul style="margin:0;padding-left:18px;color:#cfd6cf">
        <li><b>Exact 1.00</b> ‚Äî <b>5.00√ó</b> + <b>bonus spin</b></li>
        <li><b>0.95‚Äì0.99</b> ‚Äî <b>1.00√ó</b></li>
        <li><b>Over 1.00</b> ‚Äî <b>0√ó</b></li>
      </ul>
      <h4 style="margin:12px 0 6px;">Bonus spin (after exact 1.00)</h4>
      <ul style="margin:0;padding-left:18px;color:#cfd6cf">
        <li>Hit <b>0.05</b> = <b>+5√ó</b> ¬∑ <b>0.15</b> = <b>+15√ó</b> ¬∑ <b>1.00</b> = <b>+25√ó</b></li>
      </ul>
      <p class="micro" style="margin-top:10px">Practice mode enabled. All payouts settle in <b>$BAG</b>. $XRP stakes convert at live rate automatically.</p>
    </div>

  </div>
</section>

<!-- AUDIO: tick + cheer (no "here-come-the-money") -->
<script>
(function(){
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let AC=null, MASTER=null;
  function ac(){ if (AC && AC.state!=='closed') return AC;
    if (!AudioCtx) return null;
    AC = new AudioCtx({ latencyHint:'interactive', sampleRate:44100 });
    MASTER = AC.createGain(); MASTER.gain.value = .22; MASTER.connect(AC.destination);
    return AC;
  }
  async function resume(){ const a=ac(); if(!a) return; if(a.state==='suspended'){ try{ await a.resume(); }catch{} } }
  window.restartAudio = resume;
  addEventListener('pointerdown', resume, {passive:true});
  addEventListener('visibilitychange', ()=>{ if(!document.hidden) resume(); });

  const tick = new Audio('/assets/sounds/tick.mp3'); tick.preload='auto'; tick.crossOrigin='anonymous'; tick.setAttribute('playsinline',''); tick.volume=.75;
  const cheer = new Audio('/assets/sounds/crowd-cheer.mp3'); cheer.preload='auto'; cheer.crossOrigin='anonymous'; cheer.setAttribute('playsinline',''); cheer.volume=.8;

  window.__bagWheelAudio = {
    tick(){ try{ tick.currentTime=0; tick.play().catch(()=>{});}catch{} },
    cheer(){ try{ cheer.currentTime=0; cheer.play().catch(()=>{});}catch{} },
    resume
  };
})();
</script>

<!-- PRICES + QUICK AMOUNTS + STAKE WIRE (same as your Dice page) -->
<script src="/js/bag-quick-amounts.js"></script>
<script>
/* prices (unchanged) */
(function(){ /* ... unchanged from your Dice (omitted for brevity) ... */ })();
</script>
<script>
/* BAGStakeWire (unchanged) */
(function(){ /* ... unchanged from your Dice (omitted for brevity) ... */ })();
</script>
<script>
  BAGStakeWire.init({
    usdInput:'#usdBet',
    qtyInput:'#betQty',
    currencyToggle:'#curToggle',
    unitLabels:'.unit',
    limitsLabel:'#betLimits',
    presetsRoot:'#usdPresets',
    minUsd:1,
    maxUsd:2000,
    activeClass:'active',
    syncOnPrice:true
  });
</script>

<!-- BIG WHEEL GAME LOGIC: front-facing + swipe physics -->
<script>
(function(){
  const wheel = document.getElementById('wheel');
  const ctx = wheel.getContext('2d', { alpha:true, desynchronize:true });

  const spinBtn = document.getElementById('spinBtn');
  const holdBtn = document.getElementById('holdBtn');
  const resetBtn = document.getElementById('resetBtn');
  const rollText = document.getElementById('rollText');

  const betQtyEl = document.getElementById('betQty');
  const usdBetEl = document.getElementById('usdBet');
  const curToggle = document.getElementById('curToggle');

  const MIN_USD=1, MAX_USD=2000;

  const values = Array.from({length:20}, (_,i)=>((i+1)*0.05).toFixed(2));
  const TAU = Math.PI*2;
  const per = TAU/values.length;

  const PAYOUTS = { exactBase:5, nearMin:0.95, nearPay:1, bonus:{'0.05':5,'0.15':15,'1.00':25} };
  const DEMO_BIAS = 0.35;

  // Visual constants
  const W = wheel.width, H = wheel.height, CX=W/2, CY=H/2;
  const R_OUT = Math.min(W,H)/2 - 22;
  const R_PEG = R_OUT - 8;
  const R_NUM = R_OUT - 90;
  const R_HUB = 86;

  // Physics
  let angle = -Math.PI/2;                    // 12 o‚Äôclock
  let angVel = 0;                            // rad/s
  const FRICTION = 0.995;                    // decay per frame
  const MIN_VEL_TO_STOP = 0.002;             // stop threshold
  const PIXEL_TO_RAD = 0.012;                // swipe sensitivity
  const PEG_TICK_GAP = per*0.5;              // prevent over-ticking
  let lastPegTickAngle = null;

  const state = { spinning:false, spin1:null, spin2:null, total:0, done:false, lockedBag:0, lockedUsd:0 };

  function draw(){
    ctx.clearRect(0,0,W,H);
    ctx.save();
    ctx.translate(CX,CY);
    ctx.rotate(angle);

    // Rim depth
    const grd = ctx.createRadialGradient(0,0,R_OUT-60, 0,0,R_OUT+8);
    grd.addColorStop(0,'#1a3b2a'); grd.addColorStop(.6,'#123123'); grd.addColorStop(1,'#0a1e15');
    ctx.beginPath(); ctx.arc(0,0,R_OUT+8,0,TAU); ctx.fillStyle=grd; ctx.fill();

    // Slices with glossy band
    for (let i=0;i<values.length;i++){
      const a0=i*per, a1=a0+per;
      ctx.beginPath();
      ctx.moveTo(0,0); ctx.arc(0,0,R_OUT-18,a0,a1); ctx.closePath();
      ctx.fillStyle = (i%2)?'#0e3a28':'#134b34'; ctx.fill();
      ctx.lineWidth=2; ctx.strokeStyle='#1d5a3a'; ctx.stroke();

      // label plate
      const mid=a0+per/2;
      ctx.save();
      ctx.rotate(mid);
      ctx.translate(R_NUM,0);
      // badge
      ctx.fillStyle='#0b2318'; ctx.strokeStyle='#256244'; ctx.lineWidth=2;
      roundedRect(-38,-20,76,40,10);
      ctx.fill(); ctx.stroke();
      // number
      ctx.fillStyle='#f9fdf9'; ctx.font='700 36px Inter, Arial, sans-serif';
      ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText(values[i],0,2);
      ctx.restore();
    }

    // Gold pegs around rim
    for (let i=0;i<values.length;i++){
      const a=i*per;
      const x=Math.cos(a)*R_PEG, y=Math.sin(a)*R_PEG;
      ctx.beginPath();
      ctx.arc(x,y,6,0,TAU);
      ctx.fillStyle='#d5b55c';
      ctx.fill();
      ctx.strokeStyle='#8a7535'; ctx.lineWidth=1.5; ctx.stroke();
      // tiny highlight
      ctx.beginPath(); ctx.arc(x-2,y-2,2.2,0,TAU); ctx.fillStyle='rgba(255,255,255,.6)'; ctx.fill();
    }

    // Center hub (depth)
    const hub = ctx.createRadialGradient(0,0,10, 0,0,R_HUB);
    hub.addColorStop(0,'#1a2720'); hub.addColorStop(.8,'#0c1c14'); hub.addColorStop(1,'#09150f');
    ctx.beginPath(); ctx.arc(0,0,R_HUB,0,TAU); ctx.fillStyle=hub; ctx.fill();
    ctx.lineWidth=3; ctx.strokeStyle='#1a7a50'; ctx.stroke();

    // Logo text
    ctx.fillStyle='#ffd700'; ctx.font='800 28px Inter, Arial'; ctx.textAlign='center';
    ctx.fillText('$BAG',0,-6);
    ctx.fillStyle='#aeb7af'; ctx.font='600 14px Inter, Arial'; ctx.fillText('PRICE SPIN',0,14);

    ctx.restore();
  }
  function roundedRect(x,y,w,h,r){
    const rr=Math.min(r,Math.abs(w)/2,Math.abs(h)/2);
    ctx.beginPath();
    ctx.moveTo(x+rr,y);
    ctx.arcTo(x+w,y,x+w,y+h,rr);
    ctx.arcTo(x+w,y+h,x,y+h,rr);
    ctx.arcTo(x,y+h,x,y,rr);
    ctx.arcTo(x,y,x+w,y,rr);
    ctx.closePath();
  }
  draw();

  function currentIndexFromAngle(a){
    let t=a%TAU; if(t<0) t+=TAU;
    const idx = Math.floor((t + per/2)/per) % values.length;
    return (values.length - idx) % values.length;
  }
  function snapToNearest(){
    const idx=currentIndexFromAngle(angle);
    const centerFromTop=(values.length - idx) % values.length;
    return centerFromTop*per - per/2;
  }

  // Swipe handling
  let dragging=false, lastY=0, lastT=0, vSample=[];
  function onStart(e){
    if(state.spinning || state.done) return;
    dragging=true; vSample.length=0;
    lastY = getY(e); lastT=performance.now();
  }
  function onMove(e){
    if(!dragging) return;
    const y=getY(e), t=performance.now();
    const dy = y - lastY;
    angle += dy*PIXEL_TO_RAD; // pull down = increase angle ‚Üí spins ‚Äúdownward‚Äù
    draw();
    // collect velocity samples
    const dt = t - lastT;
    if (dt>0){
      const vel = (dy*PIXEL_TO_RAD)/(dt/1000);
      vSample.push({t,vel}); if(vSample.length>6) vSample.shift();
    }
    lastY=y; lastT=t;
    e.preventDefault();
  }
  function onEnd(){
    if(!dragging) return; dragging=false;
    // initial angular velocity from last samples
    const v = vSample.length ? vSample.reduce((a,b)=>a+b.vel,0)/vSample.length : 0;
    angVel = clamp(v*1.2, -8, 8); // cap crazy flicks
    if (Math.abs(angVel) < 1.2){ // require a real pull
      // small assist so a gentle pull still spins
      angVel = (angVel>=0?1.2:-1.2);
    }
    startSpinLoop();
  }
  function getY(e){ return (e.touches? e.touches[0].clientY : e.clientY); }
  function clamp(n,a,b){ return Math.min(b, Math.max(a,n)); }

  wheel.addEventListener('mousedown', onStart);
  window.addEventListener('mousemove', onMove);
  window.addEventListener('mouseup', onEnd);
  wheel.addEventListener('touchstart', onStart, {passive:false});
  wheel.addEventListener('touchmove', onMove, {passive:false});
  wheel.addEventListener('touchend', onEnd);

  // Auto-spin button for desktop
  spinBtn.addEventListener('click', ()=>{
    if(state.spinning || state.done) return;
    // give a nice show spin
    angVel = 6.0; startSpinLoop();
  });

  resetBtn.addEventListener('click', resetRound);
  holdBtn.addEventListener('click', holdAfterFirst);

  // Session + stake helpers
  const PR = ()=>window.__PRICES__||{bagUsd:0,xrpUsd:0};
  function currentCurrency(){
    const el = curToggle?.querySelector('input[name="betCur"]:checked');
    return el ? String(el.value).toUpperCase() : 'XRP';
  }
  function stakeBag(){
    const q = parseFloat(betQtyEl?.value||0) || 0;
    if (!q) return 0;
    const {bagUsd,xrpUsd} = PR();
    if (currentCurrency()==='BAG') return q;
    if (bagUsd>0 && xrpUsd>0) return q * (xrpUsd/bagUsd);
    return 0;
  }
  function stakeUsd(){
    const direct = parseFloat(usdBetEl?.value||'');
    if (Number.isFinite(direct) && direct>0) return direct;
    const q = parseFloat(betQtyEl?.value||0) || 0;
    const {bagUsd,xrpUsd} = PR();
    if (currentCurrency()==='BAG') return bagUsd>0 ? q*bagUsd : 0;
    return xrpUsd>0 ? q*xrpUsd : 0;
  }
  function fmtUsd(n){ return '$'+(Number(n)||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }

  // Round control
  async function maybeLockStake(){
    if (state.spin1!=null) return true; // already locked earlier
    const sUsd=stakeUsd(), sBag=stakeBag();
    if (!window.__bagSession || !__bagSession.active()){ alert('Start a session at The Cage'); return false; }
    if (sUsd < MIN_USD){ alert(`Minimum $${MIN_USD.toFixed(2)} stake`); return false; }
    if (sUsd > MAX_USD){ alert(`Maximum $${MAX_USD.toFixed(2)} stake`); return false; }
    if (!(sBag>0)){ alert('Enter a stake first'); return false; }
    if (!__bagSession.spend(sBag)){ alert('Insufficient balance'); return false; }
    state.lockedBag=sBag; state.lockedUsd=sUsd;
    return true;
  }

  // Spin loop with friction + peg ticks
  let raf=null;
  async function startSpinLoop(){
    if (state.done) return;
    const ok = await maybeLockStake(); if(!ok) { angVel=0; return; }

    state.spinning=true; spinBtn.disabled=true; holdBtn.disabled=true; resetBtn.disabled=true;
    rollText.className='t'; rollText.textContent = (state.spin1==null) ? 'Spinning 1‚Ä¶' : 'Spinning 2‚Ä¶';

    const tStart=performance.now();
    const tick = ()=>{
      angle += angVel*(1/60);
      // peg tick detect: when we cross a peg angle, click
      const pegIdx = currentIndexFromAngle(angle);
      const pegAngle = ((values.length - pegIdx)%values.length)*per;
      if (lastPegTickAngle==null || Math.abs(normalizeAngle(angle - lastPegTickAngle)) > PEG_TICK_GAP){
        // play tick roughly once per peg boundary passed
        window.__bagWheelAudio && __bagWheelAudio.tick();
        lastPegTickAngle = angle;
      }

      angVel *= FRICTION;
      if (Math.abs(angVel) < MIN_VEL_TO_STOP){
        // settle to nearest slice with a small ease
        const target = snapToNearest();
        const delta = normalizeAngle(target - angle);
        if (Math.abs(delta) > 0.0005) angle += delta*0.25;
        else {
          angle = target;
          draw();
          state.spinning=false;
          cancelAnimationFrame(raf); raf=null;
          onSettle();
          return;
        }
      }
      draw();
      raf = requestAnimationFrame(tick);
    };
    if (!raf) raf = requestAnimationFrame(tick);
  }

  function normalizeAngle(a){ a%=TAU; if(a> Math.PI) a-=TAU; if(a<-Math.PI) a+=TAU; return a; }

  function chooseIndexForAuto(){
    // for demo auto-spin bias close to 1.00
    let weights = values.map(()=>1);
    if (window.__BAG_FORCE_DEMO === true){
      const near = new Set(['0.95','1.00']);
      values.forEach((v,i)=>{ if (near.has(v)) weights[i]+= DEMO_BIAS*4; if(v==='0.50'||v==='0.55') weights[i]+=DEMO_BIAS*2; });
      if (state.spin1){ const s1=parseFloat(state.spin1); values.forEach((v,i)=>{ const d=Math.abs(1-(s1+parseFloat(v))); weights[i]+=(1-Math.min(d,1))*DEMO_BIAS*6; }); }
    }
    const sum=weights.reduce((a,b)=>a+b,0);
    let r=Math.random()*sum; for(let i=0;i<weights.length;i++){ r-=weights[i]; if(r<=0) return i; }
    return values.length-1;
  }

  function onSettle(){
    // read landed
    const idx=currentIndexFromAngle(angle);
    const landed = values[idx];

    if (!state.spin1){
      state.spin1 = landed;
      state.total = parseFloat(landed);
      rollText.textContent = `Spin 1: ${landed} ‚Äî ${state.total.toFixed(2)}. Spin again or HOLD.`;
      holdBtn.disabled=false; resetBtn.disabled=false; spinBtn.disabled=false;
      return;
    }

    state.spin2 = landed;
    state.total = parseFloat(state.spin1)+parseFloat(landed);

    if (state.total > 1.00){
      rollText.className='t lose';
      rollText.textContent = `BUST ‚Äî ${state.total.toFixed(2)} is over 1.00`;
      finishRound(0,'Bust');
      return;
    }
    if (state.total === 1.00){
      const base = PAYOUTS.exactBase;
      BAGOverlay.showWin({
        message:'WIN',
        subtext:`Exact 1.00 ‚Äî ${state.lockedBag.toLocaleString(undefined,{maximumFractionDigits:6})} ‚Üí ${(state.lockedBag*base).toLocaleString(undefined,{maximumFractionDigits:6})} BAG`,
        duration: 4200,
        sound:true
      });
      window.__bagWheelAudio && __bagWheelAudio.cheer();
      rollText.className='t win';
      rollText.textContent = `Exact 1.00 ‚Äî ${base.toFixed(2)}√ó. Bonus spin incoming‚Ä¶`;
      bonusSpin(base);
      return;
    }
    if (state.total >= PAYOUTS.nearMin){
      finishRound(PAYOUTS.nearPay,'Near 1.00');
    } else {
      finishRound(0,'Under 1.00');
    }
  }

  function holdAfterFirst(){
    if (state.spinning || state.done) return;
    if (state.spin1==null){ rollText.textContent='You must spin first.'; return; }
    if (state.total === 1.00){
      const base = PAYOUTS.exactBase;
      BAGOverlay.showWin({
        message:'WIN',
        subtext:`Exact 1.00 ‚Äî ${state.lockedBag.toLocaleString(undefined,{maximumFractionDigits:6})} ‚Üí ${(state.lockedBag*base).toLocaleString(undefined,{maximumFractionDigits:6})} BAG`,
        duration: 4200,
        sound:true
      });
      window.__bagWheelAudio && __bagWheelAudio.cheer();
      bonusSpin(base);
      return;
    }
    if (state.total >= PAYOUTS.nearMin) finishRound(PAYOUTS.nearPay,'Held near 1.00');
    else finishRound(0,'Held under 1.00');
  }

  function finishRound(mult,label){
    state.done=true;
    if (mult>0){
      const gain = state.lockedBag*(mult-1);
      try{ __bagSession.credit(state.lockedBag*mult); }catch{}
      BAGOverlay.showWin({
        message: mult>=5?'BIG WIN':'WIN',
        subtext:`+${gain.toLocaleString(undefined,{maximumFractionDigits:6})} BAG ¬∑ ${fmtUsd(state.lockedUsd)} ‚Üí ${fmtUsd(state.lockedUsd*mult)}`,
        duration: mult>=5?5600:4200,
        sound:true
      });
      window.__bagWheelAudio && __bagWheelAudio.cheer();
      rollText.className='t win';
      rollText.textContent = `${label} ‚Äî ${mult.toFixed(2)}√ó`;
    } else {
      rollText.className='t lose';
      rollText.textContent = `${label} ‚Äî 0√ó`;
    }
    spinBtn.disabled=true; holdBtn.disabled=true; resetBtn.disabled=false;
  }

  async function bonusSpin(basePaid){
    spinBtn.disabled=true; holdBtn.disabled=true; resetBtn.disabled=true;
    await new Promise(r=>setTimeout(r,500));
    rollText.textContent='Bonus spin‚Ä¶ (0.05/0.15/1.00 pay extra)';

    // Pure uniform result; if it lands on a bonus key, credit
    const targetIdx = Math.floor(Math.random()*values.length);
    // give it a quick show spin
    angVel = 5.5; // start
    // aim roughly toward target slice by adding an offset so it settles nicely
    const targetAngle = ((values.length - targetIdx)%values.length)*per - per/2;
    const settleLoop = ()=>{
      angle += angVel*(1/60);
      angVel *= FRICTION;
      if (Math.abs(angVel) < MIN_VEL_TO_STOP){
        const delta = normalizeAngle(targetAngle - angle);
        if (Math.abs(delta) > 0.002){ angle += delta*0.2; }
        else {
          draw();
          // evaluate
          const idx=currentIndexFromAngle(angle);
          const landed=values[idx];
          const extra = PAYOUTS.bonus[landed]||0;
          if (extra>0){
            try{ __bagSession.credit(state.lockedBag*extra); }catch{}
            BAGOverlay.showWin({
              message:'BONUS',
              subtext:`Hit ${landed} ‚Äî +${extra}√ó`,
              duration:4800,
              sound:true
            });
            window.__bagWheelAudio && __bagWheelAudio.cheer();
            rollText.className='t win';
            rollText.textContent = `Bonus hit ${landed} ‚Äî +${extra}√ó`;
          } else {
            rollText.className='t';
            rollText.textContent = `Bonus missed ‚Äî kept base ${basePaid.toFixed(2)}√ó`;
          }
          state.done=true; resetBtn.disabled=false;
          return;
        }
      }
      draw(); requestAnimationFrame(settleLoop);
    };
    requestAnimationFrame(settleLoop);
  }

  function resetRound(){
    cancelAnimationFrame(raf); raf=null;
    state.spinning=false; state.spin1=null; state.spin2=null; state.done=false; state.total=0;
    state.lockedBag=0; state.lockedUsd=0;
    angVel=0; angle=-Math.PI/2; draw();
    rollText.className='t'; rollText.textContent='Spin up to two times to reach 1.00 without going over.';
    spinBtn.disabled=false; holdBtn.disabled=true; resetBtn.disabled=false;
  }
})();
</script>

<!-- HUD updater + Session demo block (reuse your Dice logic) -->
<script>
/* You can reuse the exact HUD + demo session code from your Dice page here.
   If you want me to paste those blocks inline again, I can ‚Äî but this file
   stays drop-in compatible with your existing /js/bag-session.js setup. */
</script>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/service-worker.js').catch(()=>{});
}
</script>

<footer class="footer" style="text-align:center; padding:12px 0; line-height:1.6;">
  ¬© 2025 $BAG Protocol | getthebag.io | Powered by $XRP
  <br>
  <a href="https://x.com/getthebag_io" target="_blank" rel="noopener" style="color:#e0c66f;text-decoration:none;font-weight:700;"> ùïè @getthebag_io</a> |
  <a href="https://t.me/getthebag_io" target="_blank" rel="noopener" style="color:#e0c66f;text-decoration:none;font-weight:700;">Telegram @getthebag_io</a>
</footer>

</body>
</html>
