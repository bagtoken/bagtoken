<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>$BAG Casino</title>

<style>
  *{box-sizing:border-box}
  :root{
    --gold:#ffd700;--bg:#020703;--panel:#0b1b13;--panel2:#0d2217;
    --muted:#aeb7af;--fg:#f5f7f4;--green:#2fbf6b;
    --line:#173524;--shadow:rgba(0,0,0,.35);
  }
  html,body{margin:0;background:var(--bg);color:var(--fg);
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  img{display:block;max-width:100%;height:auto}

  /* Back */
  .backbar{position:sticky;top:0;z-index:999;background:linear-gradient(180deg,#0f1f17,#0e271c);
    border-bottom:1px solid #1b4a2f;box-shadow:0 4px 18px rgba(0,0,0,.35)}
  .backlink{display:inline-block;margin:10px 12px;padding:10px 14px;border-radius:12px;
    color:#08130d;text-decoration:none;font-weight:900;letter-spacing:.2px;
    background:linear-gradient(180deg,#ffe175 0%, #f5c94c 100%);
    box-shadow:0 3px 0 #b08a19;transition:transform .06s ease,box-shadow .2s ease,filter .2s ease}
  .backlink:hover{filter:brightness(1.05)}
  .backlink:active{transform:translateY(1px);box-shadow:0 2px 0 #9a7315}

  .wrap{max-width:1200px;margin:0 auto;padding:18px 16px 32px}
  .top{text-align:center;padding:18px 0 6px}
  .tag{color:var(--muted);font-weight:600;letter-spacing:.04em}
  .tag.gold{color:var(--gold);}
  .tag.gold strong{color:inherit;}

  /* Hero */
  .casino-hero{padding:10px 0 0}
  .casino-hero .poster{margin:0 auto 18px;border-radius:14px;box-shadow:0 8px 28px var(--shadow)}
  @media (min-width:900px){.casino-hero .poster{max-width:900px}}
  @media (max-width:899px){.casino-hero .poster{width:100%;max-width:none;border-radius:0;box-shadow:none}}

  /* Under Construction (centered) */
  .under-construction{
    max-width:900px;
    margin:0 auto 16px;
    text-align:center;
    color:#e9efe9;
    padding:12px 14px;
    border:1px dashed #2b6a48;
    border-radius:12px;
    background:linear-gradient(180deg,var(--panel) 0%, var(--panel2) 100%);
    box-shadow:0 6px 20px var(--shadow);
  }
  .under-construction p{margin:6px 0}

  /* Divider */
  .vault-break{text-align:center;color:var(--gold);font-weight:900;letter-spacing:.12em;
    margin:48px auto 32px;font-size:1rem;opacity:.85;position:relative}
  .vault-break::before,.vault-break::after{
    content:"";display:inline-block;vertical-align:middle;width:60px;height:2px;
    background:linear-gradient(90deg,transparent,var(--gold),transparent);
    margin:0 12px;opacity:.7
  }

  /* Grid */
  .grid{display:grid;gap:18px;margin-top:16px}
  @media (min-width:720px){.grid{grid-template-columns:repeat(3,1fr)}}
  @media (max-width:719px){.grid{grid-template-columns:1fr}}

  .card{position:relative;background:linear-gradient(180deg,var(--panel) 0%, var(--panel2) 100%);
    border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 24px var(--shadow);overflow:hidden}
  .card-img{aspect-ratio:16/9;width:100%;object-fit:cover;background:#0b0b0c}
  .card-body{padding:14px 14px 16px}
  .card h3{margin:0 0 6px;font-size:1.05rem}
  .meta{color:#cfd6cf;font-size:.92rem;margin:0 0 12px}
  .btn{display:inline-block;padding:10px 16px;font-weight:800;text-decoration:none;border-radius:12px;
    color:#08130d;background:linear-gradient(180deg,#ffe175 0%, #f5c94c 100%);
    box-shadow:0 4px 0 #b08a19;transition:transform .06s ease, filter .2s ease, box-shadow .2s ease}
  .btn:hover{filter:brightness(1.05);box-shadow:0 4px 0 #b08a19,0 14px 28px rgba(255,225,117,.22)}
  .btn:active{transform:translateY(1px);box-shadow:0 3px 0 #9a7315}

  /* ğŸ”Š Floating sound toggle (upper-right) */
  #soundToggle{
    position:fixed;top:10px;right:12px;z-index:2147483647;
    background:rgba(0,0,0,.35);backdrop-filter:saturate(120%) blur(4px);
    border:1px solid #2b6a48;border-radius:12px;padding:8px 10px;
    color:var(--gold);font-size:1.2rem;cursor:pointer;opacity:.9;
    transition:opacity .2s ease, transform .12s ease;
  }
  #soundToggle:hover{opacity:1;transform:scale(1.06)}
  #soundToggle:active{transform:scale(.98)}

  /* ğŸ§ Spotify toggle â€” close to ğŸ”Š but not touching */
  #spotifyToggle{
    position:fixed;top:10px;right:64px;z-index:2147483647;
    background:rgba(0,0,0,.35);backdrop-filter:saturate(120%) blur(4px);
    border:1px solid #2b6a48;border-radius:12px;padding:8px 10px;
    color:#ffd700;font-size:1.2rem;cursor:pointer;opacity:.9;
    transition:opacity .2s ease, transform .12s ease;
  }
  #spotifyToggle:hover{opacity:1;transform:scale(1.06)}
  #spotifyToggle:active{transform:scale(.98)}

  /* Tiny status toast (bottom-right) */
  .toast{
    position:fixed;right:12px;bottom:12px;background:rgba(0,0,0,.7);
    border:1px solid #2b6a48;border-radius:10px;padding:8px 10px;color:#e9efe9;
    font-size:.9rem;opacity:0;transform:translateY(6px);transition:all .18s ease;z-index:2147483647
  }
  .toast.show{opacity:1;transform:translateY(0)}
  .toast.ok{border-color:#2fbf6b}
  .toast.err{border-color:#b93a3a}
  
  .foot{color:#aab3ab;text-align:center;margin:26px 0 8px;font-size:.9rem}
  .foot a{color:#e0c66f;text-decoration:none;font-weight:700}

 /* THE CAGE (cashier) */
.cage{margin:0 0 24px}
.cage-panel{
  display:flex;gap:16px;align-items:center;justify-content:space-between;
  padding:14px 16px;border-radius:16px;
  background:linear-gradient(180deg,var(--panel) 0%, var(--panel2) 100%);
  border:1px solid var(--line);box-shadow:0 8px 24px var(--shadow)
}
.cage-title{font-weight:900;letter-spacing:.06em;color:var(--gold)}
.cage-meta{margin:4px 0 0;color:#cfd6cf;font-size:.95rem}
.cage-actions{display:flex;gap:10px;flex-wrap:wrap}
@media (max-width:720px){
  .cage-panel{flex-direction:column;align-items:flex-start}
}
</style>

<!-- Spotify Web Playback SDK -->
<script src="https://sdk.scdn.co/spotify-player.js"></script>
<script src="/js/bag-session.js" defer></script>
</head>
<body>

<nav class="backbar" role="navigation" aria-label="Back">
  <a class="backlink" href="/" aria-label="Back to $BAG">â¬… Back to $BAG</a>
</nav>

<!-- ğŸ”Š Floating speaker -->
<button id="soundToggle" title="Toggle casino ambiance" aria-pressed="false">ğŸ”‡</button>
<audio id="casinoAmbience" src="/assets/sounds/casino-ambiance.mp3" loop preload="auto"></audio>

<!-- ğŸ§ Headphones (Spotify) -->
<button id="spotifyToggle" title="Play $BAG Casino Spotify" aria-pressed="false">ğŸ§</button>

<!-- Tiny status toast -->
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<div class="wrap">
  <div class="top">
    <div style="font-size:1.6rem;font-weight:900;letter-spacing:.03em">ğŸ’¼ $BAG CASINO</div>
    <div class="tag">Utility on Chain. Culture on Brand.</div>
    <div class="tag gold" style="margin-top:6px">
      Bet in $XRP or <strong>$BAG</strong> on all games. $XRP bets auto-convert at the live rate; payouts are in <strong>$BAG</strong>.
    </div>
  </div>

  <section class="casino-hero" aria-label="$BAG Casino">
    <img src="/assets/bag-casino-poster.png" alt="$BAG Casino Poster" class="poster" decoding="async">
  </section>

  <!-- ğŸš§ Under Construction Banner (centered) -->
  <div class="under-construction" role="status" aria-live="polite">
    <p>ğŸš§ <strong>Pardon the Dust â€” Weâ€™re Building the BAG</strong></p>
    <p>The tables are being polished. The dice are loading.</p>
    <p>The vaultâ€™s wiring in progress â€” youâ€™re early to the floor.</p>
    <p>ğŸ° <strong>$BAG Casino coming online piece by piece.</strong></p>
  </div>

  <br>
  <div class="vault-break">ENTER THE FLOOR</div>

  <section class="cage" aria-label="The Cage (Cashier)">
    <div class="cage-panel">
      <div>
        <div class="cage-title">ğŸ¦ THE CAGE</div>
        <p class="cage-meta">
          Connect, deposit, and play across all games with one balance. Bet in <strong>$XRP</strong> or <strong>$BAG</strong>
          (XRP auto-converts; payouts in <strong>$BAG</strong>).
        </p>
      </div>
      <div class="cage-actions">
        <button class="btn" id="btnConnect">Connect Wallet</button>
        <button class="btn" id="btnStart">Start Session</button>
        <button class="btn" id="btnTopup">Top Up</button>
        <button class="btn" id="btnEnd" style="background:#15261c;color:#dfe9e2;border:1px solid #2b6a48;">End</button>
      </div>
    </div>
  </section>

  <script>
    const $ = s => document.querySelector(s);
    $('#btnConnect').onclick = async ()=>{ try{ await __bagSession.connect(); alert('Wallet connected'); }catch(e){ alert(e.message||'Connect failed'); } };
    $('#btnStart').onclick   = async ()=>{ try{ await __bagSession.start({ usdDeposit: 10 }); alert('Session started'); }catch(e){ alert(e.message||'Start failed'); } };
    $('#btnTopup').onclick   = async ()=>{ try{ await __bagSession.topUp({ usdDeposit: 10 }); alert('Topped up'); }catch(e){ alert(e.message||'Top-up failed'); } };
    $('#btnEnd').onclick     = ()=>{ __bagSession.end(); alert('Session ended'); };
    window.addEventListener('bag:sessionSynced', ()=>{/* optionally refresh UI */});
  </script>

  <section aria-label="Games" class="grid">
    <!-- ğŸ² DICE -->
    <article class="card">
      <img class="card-img" src="/assets/bag-dice.jpeg" alt="$BAG Dice" loading="lazy" decoding="async">
      <div class="card-body">
        <h3>ğŸ² $BAG Dice</h3>
        <p class="meta">Pass Line. Instant on-ledger payouts in $BAG.</p>
        <a class="btn" href="/casino/dice.html">Play Dice (ğŸš§DEMO AVAILABLEğŸš§)</a>
      </div>
    </article>

    <!-- ğŸ° SLOTS -->
    <article class="card">
      <img class="card-img" src="/assets/bag-slots.png" alt="$BAG Slots" loading="lazy" decoding="async">
      <div class="card-body">
        <h3>ğŸ° $BAG Slots</h3>
        <p class="meta">3Ã—3 classic. Manual spin. Multipliers & payouts.</p>
        <a class="btn" href="/casino/slots.html">Play Slots (ğŸš§DEMO AVAILABLEğŸš§)</a>
      </div>
    </article>

    <!-- ğŸ’¥ PLINKO -->
    <article class="card">
      <img class="card-img" src="/assets/bag-plinko.png" alt="$BAG Plinko" loading="lazy" decoding="async">
      <div class="card-body">
        <h3>ğŸ’¥ $BAG Plinko</h3>
        <p class="meta">Risk ladder. Choose your rows & odds.</p>
        <a class="btn" href="/casino/plinko.html" aria-disabled="true">Play Plinko (ğŸš§DEMO AVAILABLEğŸš§)</a>
      </div>
    </article>

    <!-- ğŸ¯ ROULETTE -->
    <article class="card">
      <img class="card-img" src="/assets/bag-roulette.png" alt="$BAG Roulette" loading="lazy" decoding="async">
      <div class="card-body">
        <h3>ğŸ¯ $BAG Roulette</h3>
        <p class="meta">American wheel. Bet red, black, or green â€” house edge never sleeps.</p>
        <a class="btn" href="/casino/">Play Roulette (ğŸš§COMING SOONğŸš§)</a>
      </div>
    </article>

    <!-- â™ ï¸ POKER -->
    <article class="card">
      <img class="card-img" src="/assets/bag-poker.jpeg" alt="$BAG Poker" loading="lazy" decoding="async">
      <div class="card-body">
        <h3>â™ ï¸ $BAG Poker</h3>
        <p class="meta">5-Card Draw. Read the table â€” and the chain.</p>
        <a class="btn" href="/casino/">Play Poker (ğŸš§COMING SOONğŸš§)</a>
      </div>
    </article>

    <!-- ğŸƒ BLACKJACK -->
    <article class="card">
      <img class="card-img" src="/assets/bag-blackjack.png" alt="$BAG Blackjack" loading="lazy" decoding="async">
      <div class="card-body">
        <h3>ğŸƒ $BAG Blackjack</h3>
        <p class="meta">21 protocol. Double down or burn your hand.</p>
        <a class="btn" href="/casino/">Play Blackjack (ğŸš§COMING SOONğŸš§)</a>
      </div>
    </article>
  </section>

<footer class="footer" style="text-align:center; padding:12px 0; line-height:1.6;">
  Â© 2025 $BAG Protocol | getthebag.io | Powered by $XRP
  <br>
  <a href="https://x.com/getthebag_io" target="_blank" rel="noopener" style="color:#e0c66f;text-decoration:none;font-weight:700;">ğ• @getthebag_io</a> |
  <a href="https://t.me/getthebag_io" target="_blank" rel="noopener" style="color:#e0c66f;text-decoration:none;font-weight:700;">Telegram @getthebag_io</a>
</footer>
</div>

<!-- ğŸ”Š Sound toggle with gesture unlock -->
<script>
(function(){
  const btn = document.getElementById('soundToggle');
  const audio = document.getElementById('casinoAmbience');
  const KEY = 'bag_sound_pref';
  let playing = false;

  function setIcon(){
    btn.textContent = playing ? 'ğŸ”Š' : 'ğŸ”‡';
    btn.setAttribute('aria-pressed', playing);
  }

  function playAudio(){
    audio.volume = 0.35;
    return audio.play().then(()=>{
      playing = true;
      setIcon();
      localStorage.setItem(KEY,'on');
      removeGestureUnlock();
    }).catch((e)=>{
      playing = false;
      setIcon();
      return Promise.reject(e);
    });
  }

  function pauseAudio(){
    audio.pause();
    playing = false;
    setIcon();
    localStorage.setItem(KEY,'off');
    armGestureUnlock();
  }

  btn.addEventListener('click',()=> playing ? pauseAudio() : playAudio().catch(()=>{}));

  const GESTURES = ['pointerdown','touchstart','mousedown','keydown'];
  let armed = false;

  function gestureHandler(){
    const pref = localStorage.getItem(KEY);
    if (pref !== 'off' && !playing){
      playAudio().catch(()=>{});
    }
  }
  function armGestureUnlock(){
    if (armed) return;
    armed = true;
    GESTURES.forEach(t => document.addEventListener(t, gestureHandler, {capture:true, passive:true}));
  }
  function removeGestureUnlock(){
    if (!armed) return;
    armed = false;
    GESTURES.forEach(t => document.removeEventListener(t, gestureHandler, {capture:true}));
  }

  window.addEventListener('focus', () => {
    const pref = localStorage.getItem(KEY);
    if (pref !== 'off' && !playing) playAudio().catch(()=>{});
  });
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden){
      const pref = localStorage.getItem(KEY);
      if (pref !== 'off' && !playing) playAudio().catch(()=>{});
    }
  });

  const pref = localStorage.getItem(KEY);
  if (pref === 'off'){
    playing = false;
  } else {
    armGestureUnlock();
  }
  setIcon();
})();
</script>

<!-- ğŸ§ Spotify: PKCE + Web Playback SDK. One-tap from ğŸ§, no app switch. -->
<script>
(function(){
  // ---- Config ----
  const CLIENT_ID = '3cc3b47a65c54b91be924b3875cefea5'; // provided
  const REDIRECT_URI = window.location.origin + window.location.pathname; // add this in Spotify dashboard
  const SCOPES = [
    'streaming',
    'user-read-email',
    'user-read-private',
    'user-read-playback-state',
    'user-modify-playback-state'
  ];
  const PLAYLIST_URI = 'spotify:playlist:0Vt5oZbeLKuqwLq489DJso';

  // ---- Elements ----
  const btn = document.getElementById('spotifyToggle');
  const toast = document.getElementById('toast');

  // ---- Storage keys ----
  const K = {
    access: 'bag_sp_access',
    refresh: 'bag_sp_refresh',
    exp:    'bag_sp_exp',
    ver:    'bag_sp_code_verifier',
    state:  'bag_sp_state'
  };

  // ---- Utils ----
  function showToast(msg, ok=true){
    toast.textContent = msg;
    toast.className = 'toast ' + (ok ? 'ok' : 'err') + ' show';
    setTimeout(()=> toast.classList.remove('show'), 2600);
  }
  function randStr(len=64){
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let s=''; for(let i=0;i<len;i++) s+=chars[Math.floor(Math.random()*chars.length)];
    return s;
  }
  async function sha256base64url(input){
    const enc = new TextEncoder().encode(input);
    const buf = await crypto.subtle.digest('SHA-256', enc);
    const b64 = btoa(String.fromCharCode(...new Uint8Array(buf)))
      .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
    return b64;
  }
  function now(){ return Math.floor(Date.now()/1000); }

  function saveTokens({access_token, refresh_token, expires_in}){
    localStorage.setItem(K.access, access_token);
    if (refresh_token) localStorage.setItem(K.refresh, refresh_token);
    localStorage.setItem(K.exp, String(now() + (expires_in||3600) - 30));
  }
  function getAccessToken(){ return localStorage.getItem(K.access)||''; }
  function isExpired(){
    const exp = parseInt(localStorage.getItem(K.exp)||'0',10);
    return !exp || now() >= exp;
  }
  function clearAuth(){
    Object.values(K).forEach(k=>localStorage.removeItem(k));
  }

  // ---- PKCE auth ----
  async function ensureAuth(){
    // If redirected back with ?code=..., exchange it
    const params = new URLSearchParams(window.location.search);
    const code  = params.get('code');
    const state = params.get('state');

    if (code){
      const storedState = localStorage.getItem(K.state);
      const verifier = localStorage.getItem(K.ver);
      try{
        if (!verifier || state !== storedState) throw new Error('State mismatch');
        const body = new URLSearchParams({
          client_id: CLIENT_ID,
          grant_type: 'authorization_code',
          code: code,
          redirect_uri: REDIRECT_URI,
          code_verifier: verifier
        });
        const res = await fetch('https://accounts.spotify.com/api/token',{
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded'},
          body
        });
        if (!res.ok) throw new Error('Token exchange failed');
        const json = await res.json();
        saveTokens(json);
        // Clean the URL
        history.replaceState({}, document.title, REDIRECT_URI);
        showToast('Spotify linked', true);
      }catch(e){
        showToast('Spotify auth failed', false);
        clearAuth();
        throw e;
      }
    }

    // If we already have a token and itâ€™s not expired, done
    if (getAccessToken() && !isExpired()) return;

    // If token expired and we have refresh, refresh it
    const refresh = localStorage.getItem(K.refresh);
    if (refresh){
      const body = new URLSearchParams({
        client_id: CLIENT_ID,
        grant_type: 'refresh_token',
        refresh_token: refresh
      });
      const res = await fetch('https://accounts.spotify.com/api/token',{
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body
      });
      if (res.ok){
        const json = await res.json();
        saveTokens(json);
        return;
      } else {
        // fall through to new auth
        clearAuth();
      }
    }

    // New login with PKCE
    const verifier = randStr(64);
    const challenge = await sha256base64url(verifier);
    const state2 = randStr(16);
    localStorage.setItem(K.ver, verifier);
    localStorage.setItem(K.state, state2);

    const auth = new URLSearchParams({
      response_type: 'code',
      client_id: CLIENT_ID,
      redirect_uri: REDIRECT_URI,
      code_challenge_method: 'S256',
      code_challenge: challenge,
      state: state2,
      scope: SCOPES.join(' ')
    });

    // Redirect to Spotify (first-time only)
    window.location.href = 'https://accounts.spotify.com/authorize?' + auth.toString();
  }

  // ---- Web Playback SDK ----
  let player, deviceId;

  async function initPlayer(){
    const token = getAccessToken();
    if (!token) throw new Error('No token');

    if (player) return;

    await new Promise((resolve)=>{
      if (window.Spotify && window.Spotify.Player) return resolve();
      window.onSpotifyWebPlaybackSDKReady = resolve;
    });

    player = new Spotify.Player({
      name: '$BAG Casino',
      getOAuthToken: cb => cb(getAccessToken()),
      volume: 0.8
    });

    player.addListener('ready', ({ device_id }) => {
      deviceId = device_id;
      showToast('Headphones ready', true);
    });
    player.addListener('not_ready', ({ device_id }) => {
      if (deviceId === device_id) deviceId = undefined;
      showToast('Headphones sleeping', false);
    });
    player.addListener('initialization_error', ({ message }) => showToast('Init error', false));
    player.addListener('authentication_error', ({ message }) => { showToast('Reauth needed', false); clearAuth(); });
    player.addListener('account_error', ({ message }) => showToast('Premium required', false));

    await player.connect();
  }

  async function transferPlayback(){
    const token = getAccessToken();
    const res = await fetch('https://api.spotify.com/v1/me/player',{
      method:'PUT',
      headers:{'Authorization':'Bearer ' + token, 'Content-Type':'application/json'},
      body: JSON.stringify({ device_ids:[deviceId], play:true })
    });
    if (!res.ok && res.status !== 204) throw new Error('Transfer failed');
  }

  async function startPlaylist(){
    const token = getAccessToken();
    const res = await fetch('https://api.spotify.com/v1/me/player/play',{
      method:'PUT',
      headers:{'Authorization':'Bearer ' + token, 'Content-Type':'application/json'},
      body: JSON.stringify({
        context_uri: PLAYLIST_URI,
        offset:{ position: 0 },
        position_ms: 0
      })
    });
    if (!res.ok && res.status !== 204) throw new Error('Play failed');
    showToast('Playing $BAG playlist', true);
  }

  async function toggleSpotify(){
    try{
      await ensureAuth();          // may redirect first-time
      await initPlayer();          // create SDK player if needed
      if (!deviceId) {
        // Allow a short wait for "ready" callback
        await new Promise(r=>setTimeout(r, 600));
        if (!deviceId) throw new Error('Device not ready');
      }
      await transferPlayback();    // move playback to web player
      await startPlaylist();       // start playlist
      btn.setAttribute('aria-pressed','true');
    }catch(e){
      // Show succinct reason
      if (String(e).includes('Premium')) showToast('Spotify Premium needed', false);
      else showToast('Headphones error', false);
      console.error(e);
    }
  }

  btn.addEventListener('click', toggleSpotify);
})();
</script>

</body>
</html>
