<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="format-detection" content="telephone=no" />
<title>$BAG Poker — Video Poker</title>
<style>
  :root{
    --gold:#ffe175;--bg:#020703;--panel:#0b1b13;--panel2:#0d2217;--muted:#aeb7af;--fg:#f5f7f4;
    --green:#2fbf6b;--red:#e25b4b;--line:#173524;--glow:rgba(255,225,117,.22);
    --card:#0e2318;--card2:#11301f;--edge:#214e35;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1120px;margin:0 auto;padding:16px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  h1{margin:0;font-size:clamp(1.1rem,3.8vw,1.6rem)}
  .badge{font:600 .85rem/1.1 system-ui;padding:6px 10px;border-radius:10px;border:1px solid #284a35;background:#0e2318}
  .board{margin-top:14px;background:linear-gradient(180deg,var(--panel2),var(--panel));border:1px solid #1f3f2c;border-radius:18px;padding:14px}
  .row{display:flex;flex-wrap:wrap;gap:12px}
  .card{flex:1 1 360px;min-width:300px;background:rgba(0,0,0,.18);border:1px solid #173524;border-radius:16px;padding:14px}
  .meta{color:var(--muted);font-size:.92rem}
  .controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:10px}
  input[type="number"]{width:110px;padding:10px;border-radius:10px;border:1px solid #284a35;background:#09170f;color:var(--fg);font-weight:700}
  button{padding:12px 16px;border-radius:12px;border:1px solid #2b523b;background:#10321f;color:var(--fg);font-weight:800;cursor:pointer}
  button.primary{background:linear-gradient(180deg,#174b2f,#10321f);border-color:#2d5c3f;box-shadow:0 0 0 1px #1e3b2a,0 10px 32px rgba(0,0,0,.35)}
  button[disabled]{opacity:.6;cursor:not-allowed}
  .pill{position:fixed;right:16px;bottom:16px;background:linear-gradient(180deg,var(--panel),var(--panel2));
    border:1px solid #1e3b2a;color:var(--fg);padding:10px 12px;border-radius:999px;box-shadow:0 0 0 1px #153021,0 10px 30px rgba(0,0,0,.35);
    display:flex;align-items:center;gap:8px}
  .pill b{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:var(--gold);color:#07150e;font-weight:800}
  .playfield{margin-top:12px;border:1px solid #1e3b2a;border-radius:14px;padding:12px;background:linear-gradient(180deg,var(--card2),var(--card))}
  .hand{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
  .poker-card{aspect-ratio:5/7;border-radius:12px;border:1px solid var(--edge);background:#0b1f15;display:flex;flex-direction:column;justify-content:space-between;padding:8px;cursor:pointer;box-shadow:0 0 0 0 var(--glow)}
  .poker-card.held{outline:2px solid var(--gold);box-shadow:0 0 0 4px var(--glow)}
  .rank{font-weight:900;font-size:1.2rem}
  .suit{font-size:1.1rem}
  .center{display:grid;place-items:center;font-size:2.2rem;opacity:.9}
  .hold-tag{align-self:center;justify-self:center;background:rgba(255,225,117,.12);border:1px solid #5e8e74;color:var(--gold);font-weight:800;padding:2px 6px;border-radius:8px}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .status{margin-top:10px;padding:10px;border:1px dashed #315f45;border-radius:10px;background:#0c1f15;color:var(--muted)}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  .stat{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:10px;background:#0c1f15;border:1px solid #1b3a28}
  .ok{color:var(--green)} .bad{color:var(--red)}
  .payouts{width:100%;border-collapse:collapse}
  .payouts th,.payouts td{border:1px solid #254938;padding:8px}
  .payouts th{background:#0e2419}
  .foot{margin-top:14px;display:flex;justify-content:space-between;gap:10px;color:var(--muted);font-size:.9rem}
  .link{color:var(--gold);text-decoration:none}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>$BAG Poker — Video Poker</h1>
    <div class="badge" id="modeBadge">Mode: DEMO</div>
  </header>

  <section class="board">
    <div class="row">
      <article class="card">
        <h3 style="margin:0 0 4px">Table Controls</h3>
        <div class="meta">Bet in <b>XRP</b>. Demo is ON by default. Enable live with <code>?live=1</code>.</div>

        <div class="controls">
          <label class="badge">Bet (XRP)</label>
          <input id="bet" type="number" inputmode="decimal" min="1" step="1" value="1" />
          <button id="deal" class="primary">DEAL</button>
          <button id="draw" class="">DRAW</button>
          <span class="badge" id="priceBadge">Price: …</span>
        </div>

        <div class="playfield">
          <div class="hand" id="hand"></div>
          <div class="actions">
            <button id="holdAll">HOLD ALL</button>
            <button id="clearHolds">CLEAR HOLDS</button>
          </div>
          <div class="grid" style="margin-top:10px">
            <div class="stat"><span>Hand Result</span><b id="handResult">—</b></div>
            <div class="stat"><span>Bet → $BAG</span><b id="xrpToBag">—</b></div>
          </div>
          <div class="status" id="statusMsg">Demo table active. Wagers are simulated only.</div>
        </div>
      </article>

      <article class="card">
        <h3 style="margin:0 0 4px">Payout Table — Jacks or Better</h3>
        <table class="payouts">
          <thead><tr><th>Hand</th><th>Payout × Bet</th></tr></thead>
          <tbody>
            <tr><td>Royal Flush</td><td>250</td></tr>
            <tr><td>Straight Flush</td><td>50</td></tr>
            <tr><td>Four of a Kind</td><td>25</td></tr>
            <tr><td>Full House</td><td>9</td></tr>
            <tr><td>Flush</td><td>6</td></tr>
            <tr><td>Straight</td><td>4</td></tr>
            <tr><td>Three of a Kind</td><td>3</td></tr>
            <tr><td>Two Pair</td><td>2</td></tr>
            <tr><td>Jacks or Better</td><td>1</td></tr>
            <tr><td>Other</td><td>0</td></tr>
          </tbody>
        </table>

        <div class="grid" style="margin-top:10px">
          <div class="stat"><span>Last Live Price</span><b id="lastPrice">—</b></div>
          <div class="stat"><span>Status</span><b id="priceStatus">awaiting…</b></div>
        </div>

        <div class="foot">
          <div>Built on XRPL. Powered by XRP.</div>
          <a class="link" href="https://getthebag.io" target="_blank" rel="noopener">getthebag.io</a>
        </div>
      </article>
    </div>
  </section>
</div>

<!-- Floating rules pill -->
<div class="pill" title="Video Poker — Jacks or Better. Deal 5 cards, choose which to hold, draw once. Payouts as shown.">
  <b>ℹ️</b><span>Rules</span>
</div>

<script>
/* =========================
   MODE: DEMO default
   ========================= */
(function(){
  const qs = new URLSearchParams(location.search);
  const liveParam = qs.get('live');
  const isLive = liveParam === '1';
  window.__BAG_DEMO = !isLive;
  document.getElementById('modeBadge').textContent = 'Mode: ' + (window.__BAG_DEMO ? 'DEMO' : 'LIVE');
  document.getElementById('statusMsg').textContent = window.__BAG_DEMO
    ? 'Demo table active. Wagers are simulated only.'
    : 'Live mode enabled. Payouts/use would route through on-ledger integrations.';
})();

/* ======================================
   PRICE MANAGER — AMM → last_live fallback
   ======================================

   To enable AMM reads, set window.__BAG_AMM with your issuer:
   window.__BAG_AMM = {
     endpoint: 'wss://xrplcluster.com',
     asset: { currency: 'BAG', issuer: 'rXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX' },
     asset2: { currency: 'XRP' }
   }
*/
const Price = (function(){
  const LS_KEY = '__bag_last_live_price';
  const priceBadge = document.getElementById('priceBadge');
  const lastPriceEl = document.getElementById('lastPrice');
  const statusEl = document.getElementById('priceStatus');

  function getCached(){
    const v = localStorage.getItem(LS_KEY);
    return v ? parseFloat(v) : null;
  }
  function setCached(p){
    if(typeof p === 'number' && isFinite(p) && p > 0) localStorage.setItem(LS_KEY, String(p));
  }

  async function ammFetch(){
    const cfg = window.__BAG_AMM;
    if(!cfg || !cfg.endpoint || !cfg.asset || !cfg.asset2) throw new Error('AMM config missing');
    const ws = new WebSocket(cfg.endpoint);
    const req = { id:'amm-info', command:'amm_info', asset:cfg.asset, asset2:cfg.asset2 };
    const price = await new Promise((resolve,reject)=>{
      let done=false, timer=setTimeout(()=>{ if(!done){done=true; try{ws.close()}catch{}; reject(new Error('timeout')) } }, 6000);
      ws.onopen = ()=> ws.send(JSON.stringify(req));
      ws.onerror = ()=>{ if(!done){done=true; clearTimeout(timer); reject(new Error('ws error'))} };
      ws.onmessage = (msg)=>{
        try{
          const data = JSON.parse(msg.data);
          if(data.id==='amm-info' && data.result && data.result.amm){
            const A = data.result.amm;
            let balA=null, balB=null;
            if(A.amount && A.amount.value){ balA = parseFloat(A.amount.value); }
            if(A.amount2 && A.amount2.value){ balB = parseFloat(A.amount2.value); }
            const isXRP = x => x && (x==='XRP' || x.currency==='XRP');
            const assetIsXRP = isXRP(cfg.asset);
            const asset2IsXRP = isXRP(cfg.asset2);
            if(balA && balB){
              let px = null;
              if(asset2IsXRP) px = balB / balA; else if(assetIsXRP) px = balA / balB;
              if(px && isFinite(px) && px>0){ done=true; clearTimeout(timer); try{ws.close()}catch{}; resolve(px); }
            }
          }
        }catch(e){}
      };
    });
    return price;
  }

  async function getPrice(){
    try{
      statusEl.textContent = 'fetching AMM price…';
      const p = await ammFetch();
      setCached(p);
      statusEl.innerHTML = '<span class="ok">AMM price OK</span>';
      return p;
    }catch(e){
      const cached = getCached();
      if(cached){ statusEl.innerHTML = '<span class="bad">AMM unavailable — using last live</span>'; return cached; }
      statusEl.innerHTML = '<span class="bad">No AMM / no cache</span>';
      return null;
    }
  }

  function fmt(p){ return p==null ? '—' : (p.toFixed(6) + ' XRP/$BAG'); }

  async function refreshUI(){
    const p = await getPrice();
    priceBadge.textContent = 'Price: ' + fmt(p);
    const cached = getCached();
    lastPriceEl.textContent = cached ? (cached.toFixed(6)+' XRP/$BAG') : '—';
    return p;
  }

  return { refreshUI, getCached, setCached };
})();

/* =========================
   VIDEO POKER ENGINE
   ========================= */
const Poker = (function(){
  const PAY = {
    'royal_flush': 250,
    'straight_flush': 50,
    'four_kind': 25,
    'full_house': 9,
    'flush': 6,
    'straight': 4,
    'three_kind': 3,
    'two_pair': 2,
    'jacks_or_better': 1,
    'none': 0
  };

  const SUITS = ['♠','♥','♦','♣'];
  const RANKS = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
  const RANK_VAL = Object.fromEntries(RANKS.map((r,i)=>[r,i+2]));

  const handEl = document.getElementById('hand');
  const handResult = document.getElementById('handResult');
  const xrpToBagEl = document.getElementById('xrpToBag');
  const betInput = document.getElementById('bet');
  const dealBtn = document.getElementById('deal');
  const drawBtn = document.getElementById('draw');
  const holdAllBtn = document.getElementById('holdAll');
  const clearHoldsBtn = document.getElementById('clearHolds');

  let deck = [];
  let hand = [];         // [{rank, suit, held}]
  let phase = 'idle';    // idle | dealt | drawn

  function enforceBetDefault(){
    const v = parseFloat(betInput.value);
    if(!v || v < 1) betInput.value = '1';
  }

  function buildDeck(){
    deck = [];
    for(const s of SUITS){
      for(const r of RANKS){
        deck.push({r,s});
      }
    }
  }
  function shuffle(){
    for(let i=deck.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [deck[i],deck[j]]=[deck[j],deck[i]];
    }
  }
  function drawOne(){ return deck.pop(); }

  function deal(){
    enforceBetDefault();
    buildDeck(); shuffle();
    hand = [];
    for(let i=0;i<5;i++){ const c = drawOne(); hand.push({rank:c.r, suit:c.s, held:false}); }
    phase = 'dealt';
    render();
    handResult.textContent = 'Select cards to HOLD, then DRAW';
    updateConversion();
  }

  function toggleHold(idx){
    if(phase!=='dealt') return;
    hand[idx].held = !hand[idx].held;
    render();
  }

  function holdAll(){ if(phase==='dealt'){ hand.forEach(c=>c.held=true); render(); } }
  function clearHolds(){ if(phase==='dealt'){ hand.forEach(c=>c.held=false); render(); } }

  function draw(){
    if(phase!=='dealt') return;
    for(let i=0;i<5;i++){
      if(!hand[i].held){ const c = drawOne(); hand[i] = {rank:c.r, suit:c.s, held:false}; }
    }
    phase = 'drawn';
    render();
    const evalRes = evaluate(hand);
    const bet = parseFloat(betInput.value)||1;
    const mult = PAY[evalRes.code] ?? 0;
    const win = bet * mult;
    handResult.textContent = `${evalRes.label} — Payout ${mult}× bet → ${win.toFixed(2)} XRP`;
  }

  function render(){
    handEl.innerHTML = '';
    hand.forEach((c,idx)=>{
      const card = document.createElement('div');
      card.className = 'poker-card'+(c.held?' held':'');
      card.title = c.held ? 'Held' : 'Tap to hold';
      card.innerHTML = `
        <div class="rank">${c.rank}</div>
        <div class="center">${c.suit}</div>
        <div class="suit">${c.suit}</div>
        ${c.held?'<div class="hold-tag">HOLD</div>':''}
      `;
      card.addEventListener('click', ()=>toggleHold(idx));
      handEl.appendChild(card);
    });
    dealBtn.disabled = (phase==='dealt');
    drawBtn.disabled = !(phase==='dealt');
  }

  function evaluate(cards){
    const ranks = cards.map(c=>c.rank);
    const suits = cards.map(c=>c.suit);
    const vals  = ranks.map(r=>RANK_VAL[r]).sort((a,b)=>a-b);
    const counts = Object.fromEntries(ranks.map(r=>[r,0]));
    ranks.forEach(r=>counts[r]++);
    const byCount = Object.values(counts).sort((a,b)=>b-a);
    const isFlush = suits.every(s=>s===suits[0]);

    let isStraight = false;
    if(vals[4]-vals[0]===4 && new Set(vals).size===5) isStraight = true;
    if(JSON.stringify(vals)==='[2,3,4,5,14]') isStraight = true;

    const isRoyal = isStraight && isFlush && JSON.stringify(vals)==='[10,11,12,13,14]';

    if(isRoyal) return {code:'royal_flush',label:'Royal Flush'};
    if(isStraight && isFlush) return {code:'straight_flush',label:'Straight Flush'};
    if(byCount[0]===4) return {code:'four_kind',label:'Four of a Kind'};
    if(byCount[0]===3 && byCount[1]===2) return {code:'full_house',label:'Full House'};
    if(isFlush) return {code:'flush',label:'Flush'};
    if(isStraight) return {code:'straight',label:'Straight'};
    if(byCount[0]===3) return {code:'three_kind',label:'Three of a Kind'};
    if(byCount[0]===2 && byCount[1]===2) return {code:'two_pair',label:'Two Pair'};

    const hasHighPair = Object.entries(counts).some(([r,c])=> c===2 && ['J','Q','K','A'].includes(r));
    if(hasHighPair) return {code:'jacks_or_better',label:'Jacks or Better'};

    return {code:'none',label:'No Win'};
  }

  async function updateConversion(){
    const price = await Price.refreshUI(); // XRP per $BAG
    const betXRP = parseFloat(betInput.value)||1;
    if(price && price>0){
      const bagOut = betXRP / price;
      xrpToBagEl.textContent = bagOut.toFixed(2) + ' $BAG';
    } else {
      xrpToBagEl.textContent = '—';
    }
  }

  function bind(){
    dealBtn.addEventListener('click', deal);
    drawBtn.addEventListener('click', draw);
    holdAllBtn.addEventListener('click', holdAll);
    clearHoldsBtn.addEventListener('click', clearHolds);
    betInput.addEventListener('change', enforceBetDefault);
    enforceBetDefault();
  }

  return { bind };
})();

/* =========
   BOOT
   ========= */
window.addEventListener('DOMContentLoaded', ()=>{
  // Optional: supply your AMM to enable live pricing cache refresh
  // window.__BAG_AMM = {
  //   endpoint: 'wss://xrplcluster.com',
  //   asset: { currency: 'BAG', issuer: 'rXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX' },
  //   asset2: { currency: 'XRP' }
  // };

  Poker.bind();
  Price.refreshUI();
});
</script>
</body>
</html>
