<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<meta name="format-detection" content="telephone=no"/>
<title>$BAG Video Poker ‚Äî Jacks or Better</title>

<link rel="preconnect" href="https://api.coingecko.com" crossorigin>
<script src="https://xaman.app/assets/cdn/xumm.min.js"></script>
<script>window.__BAG_FORCE_DEMO = false;</script>

<style>
  *{box-sizing:border-box}
  :root{
    --gold:#ffe175;--bg:#020703;--panel:#0b1b13;--panel2:#0d2217;--muted:#aeb7af;--fg:#f5f7f4;
    --green:#2fbf6b;--line:#173524;--shadow:rgba(0,0,0,.35);
    --cardW:clamp(70px,14vw,112px); --cardH:calc(var(--cardW)*1.42);
  }
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;line-height:1.55}
  img{display:block;max-width:100%;height:auto}

  .back-casino{
    position:fixed;top:18px;left:18px;z-index:1000;
    background:linear-gradient(180deg,#ffe175 0%,#f5c94c 100%);
    color:#08130d;text-decoration:none;font-weight:800;padding:8px 14px;border-radius:10px;
    box-shadow:0 4px 0 #b08a19;transition:all .15s ease
  }

  .game-header{text-align:center;padding:36px 10px 14px}
  .game-header h2{font-size:clamp(1.6rem,5vw,2.2rem);margin:6px 0 0}
  .hero-img{margin:0 auto 10px}
  @media(min-width:900px){.hero-img{width:34vw;max-width:420px}}

  .game-teaser{padding:10px 16px 28px;background:
    radial-gradient(1200px 600px at 10% -10%, #0e2c1d 0%, transparent 60%),
    radial-gradient(900px 500px at 110% 20%, #0b2318 0%, transparent 55%),#060806;
    border-top:1px solid #131313;border-bottom:1px solid #131313}
  .game-wrap{max-width:1080px;margin:0 auto;display:grid;grid-template-columns:1.05fr .95fr;gap:22px}
  @media(max-width:900px){.game-wrap{grid-template-columns:1fr}}

  .panel{background:linear-gradient(180deg,var(--panel) 0%,var(--panel2) 100%);border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 24px var(--shadow)}
  .pad{padding:16px}
  .section-title{font-weight:800;font-size:1.2rem;margin:0 0 12px}
  .micro{font-size:.9rem;color:#cfe0d5}
  .mono{font-variant-numeric:tabular-nums}
  .divider{height:1px;background:#123221;margin:12px 0}

  .choice{display:flex;gap:10px;flex-wrap:wrap}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid #2b6a48;background:#0e2a1c;color:#e9efe9;font-weight:800}
  .preset-chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .preset-chip{
    appearance:none;border:1px solid #249a55;background:#2fbf6b;color:#fff;border-radius:999px;
    padding:8px 12px;font-weight:900;cursor:pointer;box-shadow:0 4px 10px rgba(47,191,107,.18), inset 0 1px 0 rgba(255,255,255,.12)
  }
  .preset-chip.active{box-shadow:0 0 0 2px rgba(255,255,255,.25) inset, 0 8px 22px rgba(47,191,107,.25)}

  /* Felt skin */
  .felt{position:relative;border:1px solid #24533a;border-radius:12px;padding:12px;min-height: 900px;overflow:hidden}
  .felt::before{
    content:"";position:absolute;inset:0;z-index:0;
    background:url("/casino/assets/img/poker-table-1024.webp") center top/cover no-repeat;
  }
  @supports not (background: url("/casino/assets/img/poker-table-1024.webp")){
    .felt::before{background:url("/casino/assets/img/poker-table-1024.png") center top/cover no-repeat}
  }

  .table{position:relative;z-index:1;background:#07140e;border:1px solid #1b4a2f;border-radius:14px;padding:14px;margin-top:160px}
  .marquee{text-align:center;font-weight:900;letter-spacing:.08em;color:#ffe9a6;background:linear-gradient(180deg,#17311f,#0e2419);border:1px solid #254a33;border-radius:12px;padding:8px;margin-bottom:12px}

  .cards-row{display:flex;justify-content:center;gap:14px;flex-wrap:wrap;min-height:calc(var(--cardH) + 60px);padding:8px 4px}
  .card{width:var(--cardW);height:var(--cardH);border-radius:12px;border:2px solid #dcdcdc;background:transparent;overflow:hidden;box-shadow:0 10px 18px rgba(0,0,0,.32)}
  .card img{width:100%;height:100%;object-fit:contain;padding:2%}
  .hold-tag{margin-top:6px;text-align:center;font-weight:800;color:#ffe175;opacity:.0;transition:opacity .15s ease;font-size:.9rem}
  .held .hold-tag{opacity:1}

  .btnbar{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:10px 0 0}
  .btn{min-width:120px;padding:12px 14px;border:0;border-radius:12px;font-weight:900;cursor:pointer;color:#08130d;background:linear-gradient(180deg,#ffe175,#f5c94c)}
  .btn.alt{color:#e9efe9;background:#15261c;border:1px solid #2b6a48}
  .btn:disabled{opacity:.65;cursor:not-allowed}

  .hudbar{display:flex;gap:6px;flex-wrap:wrap;align-items:center;margin:10px 2px 0}
  .pill{background:#0a1e15;border:1px solid #244330;border-radius:999px;padding:6px 10px;font-size:12px;color:#cfe6d8}

  /* Rules FAB */
  .rules-fab{
    position:fixed;right:16px;bottom:16px;z-index:1000;
    padding:10px 14px;border-radius:999px;font-weight:800;border:1px solid #2b6a48;background:#0e2a1c;color:#e9efe9;
    box-shadow:0 8px 24px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);cursor:pointer
  }
  .rules-overlay{position:fixed;inset:0;display:none;place-items:center;z-index:3000;backdrop-filter:blur(6px);background:rgba(0,0,0,.45);padding:18px}
  .rules-modal{width:min(680px,92vw);max-height:min(78vh,840px);overflow:auto;background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--line);border-radius:16px;box-shadow:0 24px 60px var(--shadow);color:var(--fg);padding:18px;position:relative}
  .rules-close{position:absolute;top:8px;right:12px;border:0;background:transparent;color:#e9efe9;font-size:24px;cursor:pointer}

  /* Felt flashes */
  #feltBoard.flash-win{box-shadow:0 0 0 2px #2fbf6b, 0 0 48px rgba(47,191,107,.35) inset;animation:glowGreen 900ms ease}
  #feltBoard.flash-lose{box-shadow:0 0 0 2px #e25b5b, 0 0 48px rgba(226,91,91,.28) inset;animation:glowRed 900ms ease}
  #feltBoard.flash-push{box-shadow:0 0 0 2px #ffe175, 0 0 48px rgba(255,225,117,.25) inset;animation:glowGold 1000ms ease}
  @keyframes glowGreen{from{box-shadow:0 0 0 0 rgba(47,191,107,0) inset}to{box-shadow:0 0 0 2px #2fbf6b,0 0 48px rgba(47,191,107,.35) inset}}
  @keyframes glowRed{from{box-shadow:0 0 0 0 rgba(226,91,91,0) inset}to{box-shadow:0 0 0 2px #e25b5b,0 0 48px rgba(226,91,91,.28) inset}}
  @keyframes glowGold{from{box-shadow:0 0 0 0 rgba(255,225,117,0) inset}to{box-shadow:0 0 0 2px #ffe175,0 0 48px rgba(255,225,117,.25) inset}}
</style>

<!-- Shared overlay / session / quick amounts -->
<script src="/js/bag-overlay.js"></script>
<script src="/js/bag-session.js"></script>
<script src="/js/bag-quick-amounts.js"></script>
</head>
<body>

<a href="/casino/" class="back-casino">‚¨ÖÔ∏è Back to Casino</a>

<section class="game-header">
  <picture>
    <source type="image/webp" srcset="/assets/bag-video-poker-1024.webp 1024w, /assets/bag-video-poker-960.webp 960w" sizes="(min-width:900px) 420px, 90vw">
    <source type="image/png"  srcset="/assets/bag-video-poker-1024.png 1024w, /assets/bag-video-poker-960.png 960w" sizes="(min-width:900px) 420px, 90vw">
    <img src="/assets/bag-video-poker-960.png" alt="$BAG Video Poker" class="hero-img" loading="lazy" decoding="async">
  </picture>
  <h2>üé¥ $BAG VIDEO POKER ‚Äî JACKS OR BETTER</h2>
  <p class="micro">All payouts in $BAG. $XRP bets convert at the live rate</p>
</section>

<section class="game-teaser">
  <div class="game-wrap">

    <!-- LEFT: Stake and live line -->
    <div class="panel pad">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div id="connectStatus" class="micro">Wallet: <span style="color:#e8a85c">not connected</span></div>
        <button id="connectBtn" class="btn" style="min-width:auto;padding:8px 12px">Connect Xaman</button>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div id="sessionStatus" class="micro">Session: <span style="color:#2fbf6b">Practice</span></div>
        <div style="display:flex;gap:8px">
          <button id="startSessionBtn" class="btn" style="min-width:auto;padding:8px 12px">Start Session</button>
          <button id="topUpBtn" class="btn" style="min-width:auto;padding:8px 12px;display:none">Top Up</button>
          <button id="endSessionBtn" class="btn alt" style="min-width:auto;padding:8px 12px;display:none">End</button>
        </div>
      </div>

      <div class="section-title">Stake & Prices</div>
      <div class="micro">Amount</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <div style="display:flex;align-items:center;gap:6px">
          <input id="usdBet" class="mono" type="number" inputmode="decimal" min="0" max="2000" step="0.01" placeholder="0.00" style="width:140px;background:#0b2217;border:1px solid #1b4a2f;border-radius:10px;color:#f3f5f0;padding:10px">
          <span class="micro unit">USD</span>
        </div>
      </div>
      <div
        class="preset-chips"
        id="usdPresets"
        data-quick-amounts
        data-target-usd="#usdBet"
        data-target-qty="#betQty"
        data-currency-toggle="#curToggle"
        data-min-usd="1"
        data-max-usd="2000"
        data-active-class="active"
        data-sync-on-price="1"
      >
        <button type="button" class="preset-chip" data-usd="1">$1</button>
        <button type="button" class="preset-chip" data-usd="2">$2</button>
        <button type="button" class="preset-chip" data-usd="5">$5</button>
        <button type="button" class="preset-chip" data-usd="10">$10</button>
        <button type="button" class="preset-chip" data-usd="20">$20</button>
        <button type="button" class="preset-chip" data-usd="50">$50</button>
        <button type="button" class="preset-chip" data-usd="100">$100</button>
        <button type="button" class="preset-chip" data-usd="max">Max</button>
      </div>

      <div class="divider"></div>

      <div class="micro">Bet currency</div>
      <div class="choice" id="curToggle">
        <label class="chip"><input type="radio" name="betCur" value="XRP" checked> XRP</label>
        <label class="chip"><input type="radio" name="betCur" value="BAG"> BAG</label>
      </div>

      <div style="margin-top:8px">
        <div class="micro">Bet amount</div>
        <div style="display:flex;gap:10px;align-items:center">
          <input id="betQty" class="mono" type="number" inputmode="decimal" min="0" step="any" value="1" style="width:140px;background:#0b2217;border:1px solid #1b4a2f;border-radius:10px;color:#f3f5f0;padding:10px">
          <span class="unit">XRP</span>
        </div>
        <div class="micro" id="betLimits" style="margin-top:6px"></div>
      </div>

      <div class="divider"></div>

      <div class="micro">Live prices</div>
      <div class="muted mono" id="liveLine">
        <span id="liveDot" class="warn">‚óè</span>
        <span> BAG $<span id="liveBAG">‚Äî</span> ¬∑ XRP $<span id="liveXRP">‚Äî</span> <span id="liveNote"></span></span>
        <div class="micro" id="liveConv" style="margin-top:4px;opacity:.9;">1 BAG ‚âà ‚Äî XRP ¬∑ 1 XRP ‚âà ‚Äî BAG</div>
      </div>

      <div class="divider"></div>

      <!-- Payout table -->
      <div class="section-title">Payouts ‚Äî per 1√ó stake</div>
      <div class="micro" id="vpPayouts">
        <ul style="margin:0;padding-left:18px;line-height:1.6">
          <li>Royal Flush ‚Äî <b>250√ó</b> (no progressive)</li>
          <li>Straight Flush ‚Äî <b>50√ó</b></li>
          <li>Four of a Kind ‚Äî <b>25√ó</b></li>
          <li>Full House ‚Äî <b>9√ó</b></li>
          <li>Flush ‚Äî <b>6√ó</b></li>
          <li>Straight ‚Äî <b>4√ó</b></li>
          <li>Three of a Kind ‚Äî <b>3√ó</b></li>
          <li>Two Pair ‚Äî <b>2√ó</b></li>
          <li>Jacks or Better ‚Äî <b>1√ó</b></li>
        </ul>
        <p class="micro" style="opacity:.9;margin-top:8px">Stake is held on deal. Win pays multiplier √ó stake in BAG</p>
      </div>
    </div>

    <!-- RIGHT: Table -->
    <div class="panel pad">
      <div class="marquee">$BAG VIDEO POKER</div>
      <div class="felt" id="feltBoard">
        <div class="table" id="tableBoard">
          <div class="cards-row" id="cardsRow"></div>

          <div class="btnbar">
            <button id="dealBtn" class="btn">Deal</button>
            <button id="drawBtn" class="btn" disabled>Draw</button>
            <button id="againBtn" class="btn" style="display:none">New Hand</button>
          </div>

          <div class="hudbar" aria-live="polite" id="vpHud">
            <span class="pill">Mode: <b id="modeLbl">Demo</b></span>
            <span class="pill">Balance: <b id="balLbl">‚Äî</b> <span id="ccyLbl">BAG</span></span>
            <span class="pill">Bet: <b id="betHud">1</b></span>
            <span class="pill">Last: <b id="lastLbl">‚Äî</b></span>
          </div>

          <p class="micro" id="status" style="text-align:center;margin-top:8px">Set stake then Deal</p>
        </div>
      </div>
    </div>

  </div>
</section>

<!-- Rules FAB + Modal -->
<button class="rules-fab" id="rulesFab" aria-haspopup="dialog" aria-controls="rulesOverlay">‚ÑπÔ∏è Rules</button>
<div class="rules-overlay" id="rulesOverlay" role="dialog" aria-modal="true" aria-labelledby="rulesTitle">
  <div class="rules-modal">
    <button class="rules-close" id="rulesClose" aria-label="Close">√ó</button>
    <h3 id="rulesTitle">üé¥ Video Poker ‚Äî Jacks or Better</h3>
    <ul>
      <li>Bet in XRP or BAG. 5 cards are dealt</li>
      <li>Tap cards to HOLD. Press Draw to replace the rest</li>
      <li>Payouts follow the table shown. Jacks or Better pays 1√ó</li>
      <li>Royal Flush pays 250√ó in this non-progressive table</li>
      <li>Ties do not apply. Best final hand determines payout</li>
    </ul>
    <div class="micro" style="margin-top:8px;color:#cfe0d5">All wins pay in $BAG. Live rate converts XRP stakes</div>
  </div>
</div>

<!-- AUDIO minimal -->
<script>
(function(){
  function ping(f=880, t=0.08, g=0.12){
    const AC = new (window.AudioContext||window.webkitAudioContext)();
    const o=AC.createOscillator(), ga=AC.createGain();
    o.type='triangle'; o.frequency.value=f; ga.gain.value=g;
    o.connect(ga).connect(AC.destination);
    o.start(); setTimeout(()=>{o.stop(); AC.close();}, t*1000);
  }
  window.__vp_snd = {
    deal(){ try{ ping(760,.06,.08); }catch{} },
    hold(){ try{ ping(540,.05,.09); }catch{} },
    draw(){ try{ ping(980,.06,.10); }catch{} },
    win(){ try{ ping(1280,.12,.14); setTimeout(()=>ping(1560,.12,.14),100); }catch{} },
    lose(){ try{ ping(260,.16,.12); }catch{} }
  };
})();
</script>

<!-- CARD FACTORY (same asset paths as Blackjack) -->
<script>
(function(){
  const ROOT = '/assets/cards';
  const BACK = `${ROOT}/back-black.webp`;
  const WORD = {'‚ô†':'spades','‚ô•':'hearts','‚ô¶':'diamonds','‚ô£':'clubs'};
  const R2B  = r => (r==='A'?'ace':r==='K'?'king':r==='Q'?'queen':r==='J'?'jack':r);

  (new Image()).src = BACK;
  function faceUrl(card){ return `${ROOT}/${R2B(card.r)}-${(WORD[card.s]||'spades')}.webp`; }

  function svgFallback(label){
    const wrap = document.createElement('div');
    wrap.className = 'card';
    wrap.innerHTML = `
      <svg viewBox="0 0 256 364" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="${label}">
        <rect x="3" y="3" rx="16" ry="16" width="250" height="358" fill="#fff" stroke="#dcdcdc" stroke-width="6"/>
        <text x="18" y="40" font-family="system-ui,Segoe UI,Arial" font-weight="700" font-size="28" fill="#111">${label}</text>
      </svg>`;
    return wrap;
  }

  function imgCard(src, isBack, label){
    const wrap = document.createElement('div');
    wrap.className = 'card' + (isBack ? ' back' : '');
    const img = document.createElement('img');
    img.decoding='async'; img.loading = isBack ? 'eager' : 'lazy';
    img.width=256; img.height=Math.round(256*1.42);
    let triedBack=false;
    img.onerror=()=>{ if(!triedBack && !isBack){ triedBack=true; img.onerror=()=>{ wrap.replaceWith(svgFallback(label)); }; img.src=BACK; return; } wrap.replaceWith(svgFallback(label)); };
    img.src=src; wrap.appendChild(img);
    return wrap;
  }

  window.__CARD_FACTORY__ = {
    makeCardEl(card, faceDown=false){
      const label = faceDown ? 'Card back' : `${card.r} ${WORD[card.s]||''}`.trim();
      const src   = faceDown ? BACK : faceUrl(card);
      // wrap with hold tag
      const holder = document.createElement('div');
      holder.style.display='flex';
      holder.style.flexDirection='column';
      holder.style.alignItems='center';
      holder.style.userSelect='none';
      const c = imgCard(src, faceDown, label);
      const tag = document.createElement('div');
      tag.className='hold-tag';
      tag.textContent='HOLD';
      holder.appendChild(c); holder.appendChild(tag);
      return holder;
    }
  };
})();
</script>

<!-- PRICES (BAG/XRP live AMM + fallback last live) -->
<script>
(function(){
  const PRICE_REFRESH_MS = 15000;
  const FETCH_TIMEOUT_MS = 8000;
  const LIVE_CACHE_TTL_MS = 24*60*60*1000;
  const VIEW_CACHE_TTL_MS = 6*60*60*1000;

  const BAG_ISSUER = 'rNeYbfb9EDV8c7mNfUuooEEYYzMcEuDFbr';
  const BAG_CODE = 'BAG';

  const VIEW_CACHE_KEY = 'bag_prices_v8';
  const LAST_LIVE_KEY  = 'bag_last_live_v1';
  const XRP_KEY        = 'xrp_usd';

  const PRICES = (window.__PRICES__ = { bagUsd:0, xrpUsd:0, source:'‚Äî' });

  const liveDot = document.getElementById('liveDot');
  const liveBAG = document.getElementById('liveBAG');
  const liveXRP = document.getElementById('liveXRP');
  const liveNote = document.getElementById('liveNote');
  const liveConv = document.getElementById('liveConv');

  function fmt(n){ if (!Number.isFinite(n)) return '‚Äî'; return n.toLocaleString(undefined,{maximumFractionDigits:6}); }
  function cacheSet(k,v){ try{ localStorage.setItem(k, JSON.stringify({t:Date.now(), v})); }catch{} }
  function cacheGet(k, ttlMs){
    try{ const o=JSON.parse(localStorage.getItem(k)||'null'); if(!o) return null; const age = Date.now() - (o.t||0); return age<=ttlMs ? o.v : null;
    }catch{ return null; }
  }
  function timedFetch(url, opts={}, timeout=FETCH_TIMEOUT_MS){
    const ctrl = new AbortController(); const id = setTimeout(()=>ctrl.abort(new Error('timeout')), timeout);
    try{ const u = new URL(url, location.origin); u.searchParams.set('_ts', Date.now().toString());
      return fetch(u.toString(), { ...opts, headers:{Accept:'application/json',...(opts.headers||{})}, mode:'cors', cache:'no-store', credentials:'omit', referrerPolicy:'no-referrer', signal: ctrl.signal });
    } finally { setTimeout(()=>clearTimeout(id),0); }
  }

  function updateLiveLine(){
    liveBAG.textContent = fmt(PRICES.bagUsd);
    liveXRP.textContent = Number.isFinite(PRICES.xrpUsd)
      ? PRICES.xrpUsd.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) : '‚Äî';
    liveDot.className = (PRICES.source==='live-amm' ? 'ok' : PRICES.source==='last-live' ? 'warn' : 'err');
    liveNote.textContent = (PRICES.source==='live-amm' ? ' (AMM live)' : PRICES.source==='last-live' ? ' (last live)' : ' (unavailable)');
    if(PRICES.bagUsd>0 && PRICES.xrpUsd>0){
      const xrpPerBag = PRICES.bagUsd/PRICES.xrpUsd;
      const bagPerXrp = PRICES.xrpUsd/PRICES.bagUsd;
      liveConv.textContent = `1 BAG ‚âà ${xrpPerBag.toLocaleString(undefined,{maximumFractionDigits:6})} XRP ¬∑ 1 XRP ‚âà ${bagPerXrp.toLocaleString(undefined,{maximumFractionDigits:6})} BAG`;
    } else liveConv.textContent = '1 BAG ‚âà ‚Äî XRP ¬∑ 1 XRP ‚âà ‚Äî BAG';
    window.dispatchEvent(new CustomEvent('bag:pricesUpdated'));
  }

  async function fetchXrpUsdLive(){
    try{
      const r = await timedFetch('https://api.coingecko.com/api/v3/simple/price?ids=ripple&vs_currencies=usd');
      if(!r.ok) throw 0;
      const v = (await r.json())?.ripple?.usd;
      if(Number(v)>0){ PRICES.xrpUsd=Number(v); cacheSet(XRP_KEY, PRICES.xrpUsd); return true; }
    }catch{} return false;
  }
  function parseXrpAmount(a){ if (a==null) return null; if (typeof a==='string') return Number(a)/1_000_000; if (typeof a==='object' && a.currency==='XRP') return Number(a.value); return null; }
  function parseIouAmount(a){ if (!a || typeof a!=='object') return null; return Number(a.value); }
  async function fetchBagViaAMMLive(){
    const req = { id:1, command:'amm_info', asset:{currency:BAG_CODE,issuer:BAG_ISSUER}, asset2:{currency:'XRP'} };
    const xrpPerBag = await new Promise((resolve)=>{
      const ws = new WebSocket('wss://s1.ripple.com');
      const t = setTimeout(()=>{ try{ws.close();}catch{}; resolve(null); }, 8000);
      ws.onopen = ()=> ws.send(JSON.stringify(req));
      ws.onerror = ()=>{ clearTimeout(t); try{ws.close();}catch{}; resolve(null); };
      ws.onmessage = (ev)=>{
        try{
          const msg = JSON.parse(ev.data);
          if (msg.id!==1 || !msg.result || !msg.result.amm) return;
          clearTimeout(t); try{ws.close();}catch{};
          const amm = msg.result.amm;
          const bagBal = parseIouAmount(amm.amount);
          const xrpBal = parseXrpAmount(amm.amount2);
          if (!(bagBal>0) || !(xrpBal>0)) return resolve(null);
          const price = xrpBal / bagBal;
          if (!(price>0) || !isFinite(price)) return resolve(null);
          resolve(price);
        }catch{ resolve(null); }
      };
    });
    if (!(xrpPerBag>0)) return false;
    if (!(PRICES.xrpUsd>0)) return false;
    PRICES.bagUsd = PRICES.xrpUsd * xrpPerBag;
    PRICES.source = 'live-amm';
    cacheSet(LAST_LIVE_KEY, { bagUsd: PRICES.bagUsd, xrpUsd: PRICES.xrpUsd });
    cacheSet(VIEW_CACHE_KEY, { bagUsd: PRICES.bagUsd, xrpUsd: PRICES.xrpUsd });
    return true;
  }
  function loadLastLiveBundle(){
    const v = cacheGet(LAST_LIVE_KEY, LIVE_CACHE_TTL_MS);
    if (v && Number(v.bagUsd)>0){ PRICES.bagUsd=Number(v.bagUsd); if(Number(v.xrpUsd)>0) PRICES.xrpUsd=Number(v.xrpUsd); PRICES.source='last-live'; return true; }
    return false;
  }
  function loadViewCache(){
    const v = cacheGet(VIEW_CACHE_KEY, VIEW_CACHE_TTL_MS);
    const x = cacheGet(XRP_KEY, VIEW_CACHE_TTL_MS);
    let ok=false;
    if (v && Number(v.bagUsd)>0){ PRICES.bagUsd=Number(v.bagUsd); if(Number(v.xrpUsd)>0) PRICES.xrpUsd=Number(v.xrpUsd); ok=true; }
    if (!PRICES.xrpUsd && Number(x)>0){ PRICES.xrpUsd=Number(x); ok=true; }
    if (ok && PRICES.source==='‚Äî') PRICES.source='last-live';
    return ok;
  }
  async function refreshPrices(){
    const gotX = await fetchXrpUsdLive();
    const gotB = await fetchBagViaAMMLive();
    if (!(gotX && gotB)){ if (!loadLastLiveBundle()) loadViewCache(); }
    updateLiveLine();
  }
  (async ()=>{ await refreshPrices(); setInterval(refreshPrices, PRICE_REFRESH_MS); })();
})();
</script>

<!-- Universal stake wire -->
<script>
(function(global){
  const PR = ()=>global.__PRICES__ || { bagUsd:0, xrpUsd:0 };
  function getCur(){ const el=document.querySelector('#curToggle input[name="betCur"]:checked'); return el?String(el.value).toUpperCase():'XRP'; }
  function priceFor(cur){ const {bagUsd,xrpUsd}=PR(); return cur==='BAG'?bagUsd:xrpUsd; }
  function fmtUsd(n){ return '$'+(Number(n)||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }

  function init(cfg){
    const usdEl = document.querySelector(cfg.usdInput);
    const qtyEl = document.querySelector(cfg.qtyInput);
    const unitEls = document.querySelectorAll(cfg.unitLabels);
    const curToggle = document.querySelector(cfg.currencyToggle);
    const limitsEl = document.querySelector(cfg.limitsLabel);
    const presets = document.querySelector(cfg.presetsRoot);

    function paintUnits(){ unitEls.forEach(s=> s.textContent = getCur()); }
    function readUsd(){ const v=parseFloat(usdEl?.value||''); return Number.isFinite(v)&&v>0?v:0; }
    function readQty(){ const v=parseFloat(qtyEl?.value||''); return Number.isFinite(v)&&v>0?v:0; }
    function writeUsd(u){ if(!usdEl) return; usdEl.value = u ? (Math.round(u*100)/100).toFixed(2) : ''; }
    function writeQty(q){ if(!qtyEl) return; qtyEl.value = q ? Number(q).toString() : ''; }

    function renderLimits(){
      if(!limitsEl) return;
      const cur=getCur(); const px=priceFor(cur);
      const u = readUsd() || (readQty()*(px>0?px:0)) || 0;
      const warn = (u>0 && u<cfg.minUsd) ? ` ¬∑ <span style="color:#e8a85c">Min ${fmtUsd(cfg.minUsd)}</span>` :
                   (u>cfg.maxUsd) ? ` ¬∑ <span style="color:#e8a85c">Max ${fmtUsd(cfg.maxUsd)}</span>` : '';
      limitsEl.innerHTML = `Limits: ${fmtUsd(cfg.minUsd)}‚Äì${fmtUsd(cfg.maxUsd)} ¬∑ Your stake ‚âà ${fmtUsd(u||0)}${warn}`;
    }

    function syncFromUSD(){
      const px=priceFor(getCur()); const usd=readUsd();
      if (usd && px>0) writeQty(usd/px);
      renderLimits();
    }
    function syncFromQty(){
      const px=priceFor(getCur()); const qty=readQty();
      if (qty && px>0) writeUsd(qty*px);
      renderLimits();
    }

    usdEl?.addEventListener('input', ()=>{ syncFromUSD(); dispatchEvent(new CustomEvent('bag:hudRefresh'));});
    qtyEl?.addEventListener('input', ()=>{ syncFromQty(); dispatchEvent(new CustomEvent('bag:hudRefresh'));});

    curToggle?.addEventListener('change', ()=>{ paintUnits(); syncFromQty(); dispatchEvent(new CustomEvent('bag:hudRefresh')); });
    addEventListener('bag:pricesUpdated', ()=>{ syncFromQty(); });

    if(presets){
      const setActive=(b)=>{ presets.querySelectorAll('.preset-chip').forEach(x=>x.classList.remove(cfg.activeClass)); b&&b.classList.add(cfg.activeClass); };
      const applyUsd=(u)=>{ writeUsd(u); syncFromUSD(); dispatchEvent(new CustomEvent('bag:hudRefresh')); };
      const clamp=(u)=> Math.max(cfg.minUsd, Math.min(cfg.maxUsd, u||0));
      presets.querySelectorAll('button[data-usd]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          let usd = btn.getAttribute('data-usd')==='max' ? cfg.maxUsd : parseFloat(btn.getAttribute('data-usd'))||0;
          usd = clamp(usd); setActive(btn); applyUsd(usd);
        });
      });
    }

    paintUnits(); syncFromQty(); renderLimits();

    // enforce default 1 XRP
    const xrpRadio = document.querySelector('#curToggle input[value="XRP"]');
    if (xrpRadio && !xrpRadio.checked){ xrpRadio.checked = true; xrpRadio.dispatchEvent(new Event('change',{bubbles:true})); }
    if (qtyEl && (!qtyEl.value || Number(qtyEl.value)<=0)){ qtyEl.value='1'; qtyEl.dispatchEvent(new Event('input',{bubbles:true})); }
  }

  global.BAGStakeWire = { init };
})(window);

BAGStakeWire.init({
  usdInput:'#usdBet',
  qtyInput:'#betQty',
  currencyToggle:'#curToggle',
  unitLabels:'.unit',
  limitsLabel:'#betLimits',
  presetsRoot:'#usdPresets',
  minUsd:1,
  maxUsd:2000,
  activeClass:'active',
  syncOnPrice:true
});
</script>

<!-- Demo session like Dice -->
<script>
(function(){
  const DEMO_BAL_KEY='__bag_demo_bag_vp1'; const DEMO_INIT_KEY='__bag_demo_init_vp1'; const START_USD=2000;

  function PR(){ return window.__PRICES__ || { bagUsd:0, xrpUsd:0 }; }
  function getBag(){ try{ const n=Number(localStorage.getItem(DEMO_BAL_KEY)); return Number.isFinite(n)&&n>0?n:0; }catch{ return 0; } }
  function setBag(v){ try{ localStorage.setItem(DEMO_BAL_KEY,String(Math.max(0,Number(v)||0))); }catch{} }

  function seedIfNeeded(){
    if(localStorage.getItem(DEMO_INIT_KEY)) return true;
    const bagUsd=PR().bagUsd||0; if(bagUsd>0){ setBag(START_USD/bagUsd); localStorage.setItem(DEMO_INIT_KEY,'1'); return true; }
    return false;
  }
  function fmt(n){ if(!Number.isFinite(n)) return '‚Äî'; if(Math.abs(n)>=1) return n.toLocaleString(undefined,{maximumFractionDigits:4}); return n.toLocaleString(undefined,{maximumFractionDigits:8}); }
  function fmtUsd(n){ return '$'+(Number(n)||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }

  const statusEl=document.getElementById('sessionStatus');
  const startBtn=document.getElementById('startSessionBtn');
  const topUpBtn=document.getElementById('topUpBtn');
  const endBtn=document.getElementById('endSessionBtn');

  function renderDemo(){
    const bag=getBag(); const {bagUsd,xrpUsd}=PR();
    const usd=(bagUsd>0)?bag*bagUsd:START_USD;
    const xrp=(bagUsd>0 && xrpUsd>0)?(bag*(bagUsd/xrpUsd)):0;
    if(statusEl){ statusEl.innerHTML=`Session: <span style="color:#2fbf6b">Practice</span> ¬∑ <span class="micro">BAG <b>${fmt(bag)}</b> ¬∑ XRP <b>${fmt(xrp)}</b> ¬∑ USD <b>${fmtUsd(usd)}</b></span>`; }
  }

  window.__bagSession = {
    active:()=>true,
    get:()=>({bag:getBag()}),
    spend(bag){ const b=getBag(); if(!(bag>0)||b<bag) return false; setBag(b-bag); renderDemo(); dispatchEvent(new CustomEvent('bag:hudRefresh')); return true; },
    credit(bag){ if(!(bag>0)) return false; setBag(getBag()+bag); renderDemo(); dispatchEvent(new CustomEvent('bag:hudRefresh')); return true; }
  };

  const ok = seedIfNeeded(); renderDemo();
  addEventListener('bag:pricesUpdated', ()=>{ if(!localStorage.getItem(DEMO_INIT_KEY)){ if(seedIfNeeded()) renderDemo(); } else renderDemo(); });
})();
</script>

<!-- HUD small updater -->
<script>
(function(){
  function PR(){ return window.__PRICES__ || { bagUsd:0, xrpUsd:0 }; }
  function fmt(n){ if(!Number.isFinite(n)) return '‚Äî'; return n.toLocaleString(undefined,{maximumFractionDigits:6}); }
  function els(){ return {
    balLbl:document.getElementById('balLbl'), ccyLbl:document.getElementById('ccyLbl'),
    betLbl:document.getElementById('betHud'), modeLbl:document.getElementById('modeLbl'), lastLbl:document.getElementById('lastLbl'),
    betQtyEl:document.getElementById('betQty'), curToggle:document.getElementById('curToggle')
  }; }
  function currency(){ const el=els().curToggle.querySelector('input[name="betCur"]:checked'); return el?String(el.value).toUpperCase():'XRP'; }
  function balances(){
    const bag = (window.__bagSession&&__bagSession.get&&__bagSession.get().bag)||0;
    const {bagUsd,xrpUsd}=PR(); const xrp=(bagUsd>0&&xrpUsd>0)?bag*(bagUsd/xrpUsd):0;
    return {bag,xrp};
  }
  function render(){
    const {balLbl,ccyLbl,betLbl,modeLbl,lastLbl,betQtyEl}=els();
    const ccy=currency(); const {bag,xrp}=balances();
    modeLbl.textContent = window.__BAG_FORCE_DEMO===true ? 'Demo' : 'Live';
    betLbl.textContent = fmt(parseFloat(betQtyEl.value||'1'));
    if(ccy==='XRP'){ balLbl.textContent=fmt(xrp); ccyLbl.textContent='XRP'; } else { balLbl.textContent=fmt(bag); ccyLbl.textContent='BAG'; }
    lastLbl.textContent = String(window.__VP_LAST__||'‚Äî');
  }
  ['bag:hudRefresh','bag:pricesUpdated','storage'].forEach(ev=>addEventListener(ev,render));
  document.getElementById('betQty')?.addEventListener('input',render);
  document.getElementById('curToggle')?.addEventListener('change',render);
  render();
})();
</script>

<!-- VIDEO POKER CORE -->
<script>
const VP = (function(){
  const RANKS=['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
  const SUITS=['‚ô†','‚ô•','‚ô¶','‚ô£'];

  function newDeck(){
    const d=[]; for(const r of RANKS) for(const s of SUITS) d.push({r,s});
    for(let i=d.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [d[i],d[j]]=[d[j],d[i]]; }
    return d;
  }
  function rankIndex(r){ return RANKS.indexOf(r); }

  function evaluate(hand){
    // hand: [{r,s}] length 5
    const counts={}; const suits={};
    hand.forEach(c=>{ counts[c.r]=(counts[c.r]||0)+1; suits[c.s]=(suits[c.s]||0)+1; });
    const ranks=hand.map(c=>rankIndex(c.r)).sort((a,b)=>a-b);

    const isFlush = Object.keys(suits).length===1;
    // Straight including A-low
    let isStraight=false;
    for(let i=0;i<=8;i++){
      if(ranks[0]===i && ranks[1]===i+1 && ranks[2]===i+2 && ranks[3]===i+3 && ranks[4]===i+4) { isStraight=true; break; }
    }
    // A,2,3,4,5
    if(JSON.stringify(ranks)===JSON.stringify([0,1,2,3,12])) isStraight=true;

    const freq = Object.values(counts).sort((a,b)=>b-a); // e.g., [3,2]
    const has4 = freq[0]===4;
    const has3 = freq[0]===3;
    const pairCount = freq.filter(x=>x===2).length;

    const isRoyal = isStraight && isFlush && ['10','J','Q','K','A'].every(r=>counts[r]===1);
    if(isRoyal) return {name:'Royal Flush', mult:250};
    if(isStraight && isFlush) return {name:'Straight Flush', mult:50};
    if(has4) return {name:'Four of a Kind', mult:25};
    if(has3 && pairCount===1) return {name:'Full House', mult:9};
    if(isFlush) return {name:'Flush', mult:6};
    if(isStraight) return {name:'Straight', mult:4};
    if(has3) return {name:'Three of a Kind', mult:3};
    if(pairCount===2) return {name:'Two Pair', mult:2};
    if(pairCount===1){
      const highPair = ['J','Q','K','A'].some(r=>counts[r]===2);
      if(highPair) return {name:'Jacks or Better', mult:1};
    }
    return {name:'No Win', mult:0};
  }

  return { newDeck, evaluate };
})();

(function(){
  const cardsRow = document.getElementById('cardsRow');
  const dealBtn = document.getElementById('dealBtn');
  const drawBtn = document.getElementById('drawBtn');
  const againBtn = document.getElementById('againBtn');
  const statusEl = document.getElementById('status');
  const felt = document.getElementById('feltBoard');

  let deck=[], hand=[], held=[false,false,false,false,false], inHand=false, stakeBag=0, stakeUsd=0;

  function PR(){ return window.__PRICES__||{bagUsd:0,xrpUsd:0}; }
  function currentCurrency(){ const el=document.querySelector('#curToggle input[name="betCur"]:checked'); return el?String(el.value).toUpperCase():'XRP'; }
  function readStakeBag(){
    const qty=parseFloat(document.getElementById('betQty')?.value||0)||0;
    if(!qty) return 0;
    const {bagUsd,xrpUsd}=PR();
    return currentCurrency()==='BAG' ? qty : (bagUsd>0&&xrpUsd>0 ? qty*(xrpUsd/bagUsd) : 0);
  }
  function readStakeUsd(){
    const direct=parseFloat(document.getElementById('usdBet')?.value||'');
    if(Number.isFinite(direct) && direct>0) return direct;
    const qty=parseFloat(document.getElementById('betQty')?.value||0)||0;
    const {bagUsd,xrpUsd}=PR();
    if(currentCurrency()==='BAG') return bagUsd>0 ? qty*bagUsd : 0;
    return xrpUsd>0 ? qty*xrpUsd : 0;
  }
  function setStatus(t){ statusEl.textContent=t; }
  function flash(kind){
    felt.classList.remove('flash-win','flash-lose','flash-push');
    if(kind==='win') felt.classList.add('flash-win');
    else if(kind==='lose') felt.classList.add('flash-lose');
    setTimeout(()=>felt.classList.remove('flash-win','flash-lose','flash-push'), 900);
  }
  function last(t){ window.__VP_LAST__=t; const el=document.getElementById('lastLbl'); if(el) el.textContent=t; }

  function render(){
    cardsRow.innerHTML='';
    hand.forEach((card, i)=>{
      const el = window.__CARD_FACTORY__.makeCardEl(card, false);
      if(held[i]) el.classList.add('held');
      el.style.cursor='pointer';
      el.addEventListener('click', ()=>{
        if(!inHand) return;
        held[i]=!held[i];
        if(held[i]){ el.classList.add('held'); try{ __vp_snd.hold(); }catch{} }
        else el.classList.remove('held');
      });
      cardsRow.appendChild(el);
    });
  }

  function deal(){
    // session + limits
    const MIN_USD=1, MAX_USD=2000;
    const sBag=readStakeBag(); const sUsd=readStakeUsd();
    if(!(window.__bagSession && __bagSession.active && __bagSession.active())) return alert('Start a session at The Cage');
    if(sUsd<MIN_USD) return alert(`Minimum $${MIN_USD.toFixed(2)} stake`);
    if(sUsd>MAX_USD) return alert(`Maximum $${MAX_USD.toFixed(2)} stake`);
    if(!(sBag>0)) return alert('Enter a stake first');
    if(!__bagSession.spend(sBag)) return alert('Insufficient balance');

    stakeBag=sBag; stakeUsd=sUsd;

    deck = VP.newDeck();
    hand = [deck.pop(),deck.pop(),deck.pop(),deck.pop(),deck.pop()];
    held = [false,false,false,false,false];
    inHand=true;

    render();
    try{ __vp_snd.deal(); }catch{}
    setStatus('Tap cards to HOLD then press Draw');
    dealBtn.disabled=true; drawBtn.disabled=false; againBtn.style.display='none';
    last('Dealt');
  }

  function draw(){
    if(!inHand) return;
    for(let i=0;i<5;i++){ if(!held[i]) hand[i]=deck.pop(); }
    render();
    inHand=false;
    drawBtn.disabled=true; againBtn.style.display='inline-block';

    const res = VP.evaluate(hand);
    if(res.mult>0){
      const credit = stakeBag * res.mult;
      __bagSession.credit(credit);
      try{ BAGOverlay.showWin({ message:res.name.toUpperCase(), subtext:`${res.mult}√ó ¬∑ +${(stakeBag*(res.mult-1)).toLocaleString(undefined,{maximumFractionDigits:6})} BAG`, duration:5200, sound:true }); }catch{}
      try{ __vp_snd.win(); }catch{}
      flash('win'); last(`${res.name} ${res.mult}√ó`);
      setStatus(`${res.name} ¬∑ Paid ${res.mult}√ó`);
    }else{
      try{ __vp_snd.lose(); }catch{}
      flash('lose'); last('No Win');
      setStatus('No win');
    }
  }

  function again(){
    hand=[]; held=[false,false,false,false,false]; render();
    dealBtn.disabled=false; drawBtn.disabled=true; againBtn.style.display='none';
    setStatus('Set stake then Deal'); last('‚Äî');
  }

  dealBtn.addEventListener('click', deal);
  drawBtn.addEventListener('click', draw);
  againBtn.addEventListener('click', again);
})();
</script>

<!-- Rules modal logic -->
<script>
(function(){
  const fab=document.getElementById('rulesFab');
  const ov=document.getElementById('rulesOverlay');
  const x=document.getElementById('rulesClose');
  function open(){ ov.style.display='grid'; }
  function close(){ ov.style.display='none'; }
  fab?.addEventListener('click', open);
  x?.addEventListener('click', close);
  ov?.addEventListener('click', e=>{ if(e.target===ov) close(); });
  addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });
})();
</script>

<footer class="footer" style="text-align:center; padding:12px 0; line-height:1.6;">
  ¬© 2025 $BAG Protocol | getthebag.io | Powered by $XRP
  <br>
  <a href="https://x.com/getthebag_io" target="_blank" rel="noopener" style="color:#e0c66f;text-decoration:none;font-weight:700;">ùïè @getthebag_io</a>
  &nbsp;|&nbsp;
  <a href="https://t.me/getthebag_io" target="_blank" rel="noopener" style="color:#e0c66f;text-decoration:none;font-weight:700;">Telegram @getthebag_io</a>
</footer>

</body>
</html>
