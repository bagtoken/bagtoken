<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>$BAG Plinko</title>

<link rel="preconnect" href="https://api.coingecko.com" crossorigin>
<script src="https://xaman.app/assets/cdn/xumm.min.js"></script>

<style>
  *{box-sizing:border-box}
  :root{
    --bg:#020703;--panel:#0b1b13;--panel2:#0d2217;--muted:#aeb7af;--fg:#f5f7f4;
    --green:#2fbf6b;--green-600:#249a55;--line:#173524;--shadow:rgba(0,0,0,.35);
    --lose:#e25b5b; --warn:#e8a85c;
  }
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.55}
  img{display:block;max-width:100%;height:auto}
  button,input{font-size:16px}

  .back-casino{
    position:fixed;top:18px;left:18px;z-index:1000;
    background:linear-gradient(180deg,#ffe175 0%,#f5c94c 100%);
    color:#08130d;text-decoration:none;font-weight:800;padding:8px 14px;border-radius:10px;
    box-shadow:0 4px 0 #b08a19;transition:all .15s ease
  }
  .back-casino:hover{filter:brightness(1.05);box-shadow:0 4px 0 #b08a19,0 14px 28px rgba(255,225,117,.22)}
  .back-casino:active{transform:translateY(1px);box-shadow:0 3px 0 #9a7315}

  .game-header{text-align:center;padding:36px 10px 14px}
  .game-header h2{font-size:clamp(1.6rem,5vw,2.2rem);margin:6px 0 0}
  .game-header img.hero-img{margin:0 auto 10px;filter:drop-shadow(0 10px 24px rgba(46,191,107,.18))}
  @media (min-width:900px){
    .game-header img.hero-img{width:34vw;max-width:420px;margin-left:auto;margin-right:auto}
  }

  .game-teaser{padding:10px 16px 28px;background:
    radial-gradient(1200px 600px at 10% -10%, #0e2c1d 0%, transparent 60%),
    radial-gradient(900px 500px at 110% 20%, #0b2318 0%, transparent 55%),#060806;
    border-top:1px solid #131313;border-bottom:1px solid #131313}
  .game-wrap{max-width:1080px;margin:0 auto;display:grid;grid-template-columns:1.12fr .88fr;gap:22px}
  @media (max-width:900px){.game-wrap{grid-template-columns:1fr}}

  .panel{background:linear-gradient(180deg,var(--panel) 0%,var(--panel2) 100%);border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 24px var(--shadow)}
  .pad{padding:16px}

  .section-title{font-weight:800;font-size:1.2rem;margin:0 0 12px}
  .stack{display:grid;gap:10px}
  .choice{display:flex;gap:10px;flex-wrap:wrap}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid #2b6a48;background:#0e2a1c;color:#e9efe9;font-weight:800}
  .chip input{accent-color:#2fbf6b}
  .mono{font-variant-numeric:tabular-nums}
  .micro{font-size:.85rem;color:#aeb7af}
  .muted{color:#cfd6cf}
  .divider{height:1px;background:#123221;margin:10px 0}

  /* Quick Amount buttons: green with white text */
  .preset-chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .preset-chip{
    appearance:none;border:1px solid var(--green-600);background:var(--green);color:#ffffff;border-radius:999px;
    padding:8px 12px;font-weight:900;letter-spacing:.2px;cursor:pointer;
    box-shadow:0 4px 10px rgba(47,191,107,.18), inset 0 1px 0 rgba(255,255,255,.12);
    transition:transform .06s ease, box-shadow .2s ease, filter .2s ease;
  }
  .preset-chip:hover{filter:brightness(1.03)}
  .preset-chip:active{transform:translateY(1px);box-shadow:0 3px 8px rgba(47,191,107,.16), inset 0 1px 0 rgba(255,255,255,.1)}
  .preset-chip:focus-visible{outline:2px solid #ffffff; outline-offset:2px}
  .preset-chip.active{box-shadow:0 0 0 2px rgba(255,255,255,.25) inset, 0 8px 22px rgba(47,191,107,.25)}

  .btn-roll{
    width:100%;margin-top:12px;padding:16px 22px;font-size:1.15rem;font-weight:900;text-transform:uppercase;
    letter-spacing:.5px;border:0;border-radius:14px;color:#08130d;background:linear-gradient(180deg,#ffe175 0%, #f5c94c 100%);
    box-shadow:0 6px 0 #b08a19, 0 16px 32px rgba(255,225,117,.18), inset 0 1px 0 rgba(255,255,255,.35);
    transition:transform .06s ease, box-shadow .2s ease, filter .2s ease; cursor:pointer;
  }
  .btn-roll:disabled{opacity:.65;cursor:not-allowed}

  /* HUD pills (under Drop). Balance on its own row */
  .hudbar{ display:grid; grid-template-columns:1fr; gap:6px; align-items:center; margin:8px 2px 0; }
  .pill{ background:#0a1e15; border:1px solid #244330; border-radius:999px; padding:6px 10px; font-size:12px; color:#cfe6d8 }
  .hudbar .row2{ display:flex; flex-wrap:wrap; gap:6px; }

  /* Board visuals */
  .stage{position:relative;display:flex;align-items:center;justify-content:center;overflow:hidden;margin-top:10px}
  .canvas-wrap{
    position:relative;width:100%;max-width:720px;aspect-ratio:3/4;border-radius:14px;
    box-shadow:0 10px 30px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.04);
    background: radial-gradient(120% 120% at 50% 0%, #0b2016 0%, #07120d 60%, #060a08 100%);
  }
  canvas{position:absolute;inset:0;width:100%;height:100%}

  /* Rules pill + modal (Blackjack style) */
  .rules-fab{
    position:fixed; right:16px; bottom:16px; z-index:1000;
    padding:10px 14px; border-radius:999px; font-weight:800;
    border:1px solid #2b6a48; background:#0e2a1c; color:#e9efe9;
    box-shadow:0 8px 24px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
    cursor:pointer;
  }
  .rules-overlay{ position:fixed; inset:0; display:none; place-items:center; z-index:3000; backdrop-filter:blur(6px); background:rgba(0,0,0,.45); padding:18px; }
  .rules-modal{ width:min(680px,92vw); max-height:min(78vh,840px); overflow:auto; background:linear-gradient(180deg,var(--panel) 0%, var(--panel2) 100%); border:1px solid var(--line); border-radius:16px; box-shadow:0 24px 60px var(--shadow); color:var(--fg); padding:18px; position:relative; }
  .rules-close{ position:absolute; top:8px; right:12px; border:0; background:transparent; color:#e9efe9; font-size:24px; line-height:1; cursor:pointer; }
</style>
</head>
<body>

<a href="/casino/" class="back-casino">‚¨ÖÔ∏è Back to Casino</a>

<section class="game-header">
  <picture>
    <source type="image/webp" srcset="/assets/bag-plinko-1024.webp 1024w, /assets/bag-plinko-960.webp 960w" sizes="(min-width:900px) 420px, 90vw">
    <source type="image/png"  srcset="/assets/bag-plinko-1024.png 1024w, /assets/bag-plinko-960.png 960w" sizes="(min-width:900px) 420px, 90vw">
    <img src="/assets/bag-plinko-960.png" alt="$BAG Plinko" class="hero-img" loading="lazy" decoding="async">
  </picture>
  <h2>ü™ô $BAG PLINKO</h2>
  <p class="micro" style="margin-top:4px;opacity:.9;">üí∞ <strong>All payouts are in $BAG.</strong> $XRP bets convert automatically at the live rate.</p>
</section>

<section class="game-teaser" aria-labelledby="game-teaser-title">
  <div class="game-wrap">

    <!-- LEFT: Controls -->
    <div class="panel pad">
      <!-- CONNECT -->
      <div id="connectRow" style="display:flex;justify-content:space-between;align-items:center;margin:-2px 0 10px 0%;">
        <div id="connectStatus" class="micro" style="opacity:.9">Wallet: <span style="color:#e8a85c">not connected</span></div>
        <button id="connectBtn" class="btn-roll" style="min-width:auto;padding:10px 14px;">Connect Xaman</button>
      </div>

      <!-- SESSION -->
      <div id="sessionRow" style="display:flex;justify-content:space-between;align-items:center;margin:6px 0 10px 0%;">
        <div id="sessionStatus" class="micro" style="opacity:.9">Session: <span style="color:#2fbf6b">Practice:</span></div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="startSessionBtn" class="btn-roll" style="min-width:auto;padding:8px 12px;">Start Session</button>
          <button id="topUpBtn" class="btn-roll" style="min-width:auto;padding:8px 12px;display:none;">Top Up</button>
          <button id="endSessionBtn" class="btn-roll" style="min-width:auto;padding:8px 12px;display:none;background:#15261c;color:#e9efe9;border:1px solid #2b6a48;">End</button>
        </div>
      </div>

      <div class="section-title">Stake & Prices</div>
      <div class="stack">
        <div>
          <div class="micro">Amount</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
            <div style="display:flex;align-items:center;gap:6px">
              <input id="usdBet" class="mono" type="number" inputmode="decimal" enterkeyhint="done" min="0" max="2000" step="0.01" placeholder="0.00" style="width:140px;background:#0b2217;border:1px solid #1b4a2f;border-radius:10px;color:#f3f5f0;padding:10px">
              <span class="micro">USD</span>
            </div>
          </div>
          <!-- ‚úÖ Quick-picks ($1..Max) -->
          <div class="preset-chips" id="usdPresets" role="group" aria-label="Quick bet"></div>
        </div>

        <div>
          <div class="micro">Bet currency</div>
          <div class="choice" id="curToggle">
            <label class="chip"><input type="radio" name="betCur" value="XRP" checked> XRP</label>
            <label class="chip"><input type="radio" name="betCur" value="BAG"> BAG</label>
          </div>
        </div>

        <div>
          <div class="micro">Bet amount</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
            <div>
              <input id="betQty" class="mono" type="number" inputmode="decimal" enterkeyhint="done" min="0" step="any" value="1" style="width:140px;background:#0b2217;border:1px solid #1b4a2f;border-radius:10px;color:#f3f5f0;padding:10px">
              <span class="unit">XRP</span>
            </div>
          </div>
          <div class="micro" id="betLimits" style="margin-top:6px"></div>
        </div>

        <div class="divider"></div>

        <div class="micro">Live prices</div>
        <div class="muted mono" id="liveLine">
          <span id="liveDot" class="warn">‚óè</span>
          <span> BAG $<span id="liveBAG">‚Äî</span> ¬∑ XRP $<span id="liveXRP">‚Äî</span> <span id="liveNote"></span></span>
          <div class="micro" id="liveConv" style="margin-top:4px;opacity:.9;">1 BAG ‚âà ‚Äî XRP ¬∑ 1 XRP ‚âà ‚Äî BAG</div>
        </div>

        <div class="divider"></div>

        <!-- Table / Board -->
        <div class="stage">
          <div class="canvas-wrap" id="boardWrap">
            <canvas id="game" aria-label="Plinko board"></canvas>
          </div>
        </div>

        <div class="result" style="margin-top:12px;padding:12px;border:1px solid #1b4a2f;border-radius:12px;background:#0b2217;display:flex;align-items:center;gap:10px">
          <div class="n" style="font-weight:900">Result:</div>
          <div id="resText" class="t">‚Äî</div>
        </div>

        <!-- Drop -->
        <div style="margin-top:18px;text-align:center">
          <button id="dropBtn" class="btn-roll" style="width:min(360px,90%)">Drop Coin</button>
        </div>

        <!-- ‚úÖ HUD under Drop: Balance on its own line, others below -->
        <div class="hudbar" id="bjHud" aria-live="polite">
          <span class="pill" id="balancePill">Balance: <b id="balLbl">‚Äî</b> <span id="ccyLbl">BAG</span></span>
          <div class="row2">
            <span class="pill">Mode: <b id="modeLbl">Demo</b></span>
            <span class="pill">Bet: <b id="betHud">1</b></span>
            <span class="pill">Last: <b id="lastLbl">‚Äî</b></span>
          </div>
        </div>

        <p class="micro" style="text-align:center;margin-top:8px;opacity:.75;">
          üîä If you don't hear sound: tap once, turn off Silent, raise volume.
        </p>
        <div id="status" class="micro" style="text-align:center;margin-top:8px">Ready ‚Äî set a stake and Drop</div>
      </div>
    </div>

    <!-- RIGHT: (kept minimal) -->
    <div class="panel pad">
      <h3 style="margin:0 0 8px;font-size:1.2rem;">Payouts</h3>
      <ul style="margin:0;padding-left:18px;color:#cfd6cf">
        <li><b>Scratch</b>: 0√ó (lose)</li>
        <li><b>Win</b>: 1.25√ó</li>
        <li><b>Jackpot</b>: 2.00√ó</li>
      </ul>
      <div class="divider"></div>
      <div class="micro">Min $1 ‚Äî Max $2,000. Payouts settle in BAG.</div>
    </div>

  </div>
</section>

<!-- Rules FAB + Modal -->
<button class="rules-fab" id="rulesFab" aria-haspopup="dialog" aria-controls="rulesOverlay">‚ÑπÔ∏è Rules</button>
<div class="rules-overlay" id="rulesOverlay" role="dialog" aria-modal="true" aria-labelledby="rulesTitle">
  <div class="rules-modal" role="document">
    <button class="rules-close" id="rulesClose" aria-label="Close">√ó</button>
    <h3 id="rulesTitle">ü™ô Plinko ‚Äî How it plays</h3>
    <ul>
      <li><b>Drop:</b> Tap <b>Drop Coin</b> or press <b>Space</b> to release. Tap/drag or use <b>‚Üê/‚Üí</b> to aim the drop point.</li>
      <li><b>Board:</b> The coin bounces down pegs and lands in a slot.</li>
      <li><b>Slots:</b> <b>Scratch</b> (lose), <b>Win</b> (1.25√ó), or <b>Jackpot</b> (2.00√ó).</li>
      <li><b>Payouts:</b> All payouts settle in <b>$BAG</b>. XRP bets auto-convert at the live rate.</li>
      <li><b>Limits:</b> Min $1 ¬∑ Max $2,000.</li>
    </ul>
    <div class="micro" style="color:var(--muted)">House payouts/visuals on this page apply.</div>
  </div>
</div>

<!-- ===== PRICES ===== -->
<script>
(function(){
  const PRICE_REFRESH_MS = 15000, FETCH_TIMEOUT_MS = 8000;
  const LIVE_CACHE_TTL_MS = 24*60*60*1000, VIEW_CACHE_TTL_MS = 6*60*60*1000;

  const BAG_ISSUER = 'rNeYbfb9EDV8c7mNfUuooEEYYzMcEuDFbr';
  const BAG_CODE = 'BAG';

  const VIEW_CACHE_KEY = 'bag_prices_v8';
  const LAST_LIVE_KEY  = 'bag_last_live_v1';
  const XRP_KEY        = 'xrp_usd';

  const PRICES = (window.__PRICES__ = { bagUsd:0, xrpUsd:0, source:'‚Äî', ts:0 });

  const liveDot = document.getElementById('liveDot');
  const liveBAG = document.getElementById('liveBAG');
  const liveXRP = document.getElementById('liveXRP');
  const liveNote = document.getElementById('liveNote');
  const liveConv = document.getElementById('liveConv');

  function fmt(n){ if (!Number.isFinite(n)) return '‚Äî'; return n.toLocaleString(undefined,{maximumFractionDigits:6}); }
  function cacheSet(k,v){ try{ localStorage.setItem(k, JSON.stringify({t:Date.now(), v})); }catch{} }
  function cacheGet(k, ttlMs){
    try{
      const o=JSON.parse(localStorage.getItem(k)||'null');
      if(!o) return null;
      const age = Date.now() - (o.t||0);
      return age<=ttlMs ? o.v : null;
    }catch{ return null; }
  }
  function timedFetch(url, opts={}, timeout=FETCH_TIMEOUT_MS){
    const ctrl = new AbortController();
    const id = setTimeout(()=>ctrl.abort(new Error('timeout')), timeout);
    try{
      const u = new URL(url, location.origin);
      u.searchParams.set('_ts', Date.now().toString());
      return fetch(u.toString(), {
        ...opts,
        headers: { Accept:'application/json', ...(opts.headers||{}) },
        mode:'cors', cache:'no-store', credentials:'omit', referrerPolicy:'no-referrer',
        signal: ctrl.signal
      });
    } finally { setTimeout(()=>clearTimeout(id),0); }
  }

  function updateLiveLine(){
    if (liveBAG)  liveBAG.textContent  = fmt(PRICES.bagUsd);
    if (liveXRP)  liveXRP.textContent  = Number.isFinite(PRICES.xrpUsd)
      ? PRICES.xrpUsd.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})
      : '‚Äî';
    if (liveDot)  liveDot.className    = (PRICES.source==='live-amm' ? 'ok' : PRICES.source==='last-live' ? 'warn' : 'err');
    if (liveNote) liveNote.textContent = (PRICES.source==='live-amm' ? ' (AMM live)' : PRICES.source==='last-live' ? ' (last live)' : ' (unavailable)');
    if (liveConv){
      if(PRICES.bagUsd>0 && PRICES.xrpUsd>0){
        const xrpPerBag = PRICES.bagUsd/PRICES.xrpUsd;
        const bagPerXrp = PRICES.xrpUsd/PRICES.bagUsd;
        liveConv.textContent = `1 BAG ‚âà ${xrpPerBag.toLocaleString(undefined,{maximumFractionDigits:6})} XRP ¬∑ 1 XRP ‚âà ${bagPerXrp.toLocaleString(undefined,{maximumFractionDigits:6})} BAG`;
      } else {
        liveConv.textContent = '1 BAG ‚âà ‚Äî XRP ¬∑ 1 XRP ‚âà ‚Äî BAG';
      }
    }
    window.dispatchEvent(new CustomEvent('bag:pricesUpdated'));
  }

  async function fetchXrpUsdLive(){
    try{
      const r = await timedFetch('https://api.coingecko.com/api/v3/simple/price?ids=ripple&vs_currencies=usd');
      if(!r.ok) throw 0;
      const v = (await r.json())?.ripple?.usd;
      if(Number(v)>0){
        PRICES.xrpUsd = Number(v);
        cacheSet(XRP_KEY, PRICES.xrpUsd);
        return true;
      }
    }catch(_){}
    return false;
  }
  function parseXrpAmount(a){ if (a==null) return null; if (typeof a==='string') return Number(a)/1_000_000; if (typeof a==='object' && a.currency==='XRP') return Number(a.value); return null; }
  function parseIouAmount(a){ if (!a || typeof a!=='object') return null; return Number(a.value); }
  async function fetchBagViaAMMLive(){
    const req = { id:1, command:'amm_info', asset:{currency:BAG_CODE,issuer:BAG_ISSUER}, asset2:{currency:'XRP'} };
    const xrpPerBag = await new Promise((resolve)=>{
      const ws = new WebSocket('wss://s1.ripple.com');
      const t = setTimeout(()=>{ try{ws.close();}catch{}; resolve(null); }, 8000);
      ws.onopen = ()=> ws.send(JSON.stringify(req));
      ws.onerror = ()=>{ clearTimeout(t); try{ws.close();}catch{}; resolve(null); };
      ws.onmessage = (ev)=>{
        try{
          const msg = JSON.parse(ev.data);
          if (msg.id!==1 || !msg.result || !msg.result.amm) return;
          clearTimeout(t); try{ws.close();}catch{};
          const amm = msg.result.amm;
          const bagBal = parseIouAmount(amm.amount);
          const xrpBal = parseXrpAmount(amm.amount2);
          if (!(bagBal>0) || !(xrpBal>0)) return resolve(null);
          const price = xrpBal / bagBal;
          if (!(price>0) || !isFinite(price)) return resolve(null);
          resolve(price);
        }catch{ resolve(null); }
      };
    });
    if (!(xrpPerBag>0)) return false;
    if (!(PRICES.xrpUsd>0)) return false;
    PRICES.bagUsd = PRICES.xrpUsd * xrpPerBag;
    PRICES.source = 'live-amm';
    cacheSet(LAST_LIVE_KEY, { bagUsd: PRICES.bagUsd, xrpUsd: PRICES.xrpUsd });
    cacheSet(VIEW_CACHE_KEY, { bagUsd: PRICES.bagUsd, xrpUsd: PRICES.xrpUsd });
    return true;
  }

  function loadLastLiveBundle(){
    const v = cacheGet(LAST_LIVE_KEY, LIVE_CACHE_TTL_MS);
    if (v && Number(v.bagUsd)>0){
      PRICES.bagUsd = Number(v.bagUsd);
      if (Number(v.xrpUsd)>0) PRICES.xrpUsd = Number(v.xrpUsd);
      PRICES.source = 'last-live';
      return true;
    }
    return false;
  }
  function loadViewCache(){
    const v = cacheGet(VIEW_CACHE_KEY, VIEW_CACHE_TTL_MS);
    const x = cacheGet(XRP_KEY, VIEW_CACHE_TTL_MS);
    let ok = false;
    if (v && Number(v.bagUsd)>0){
      PRICES.bagUsd = Number(v.bagUsd);
      if (Number(v.xrpUsd)>0) PRICES.xrpUsd = Number(v.xrpUsd);
      ok = true;
    }
    if (!PRICES.xrpUsd && Number(x)>0){ PRICES.xrpUsd = Number(x); ok = true; }
    if (ok && PRICES.source==='‚Äî') PRICES.source = 'last-live';
    return ok;
  }

  async function refreshPrices(){
    let liveOk = false;
    const gotX = await fetchXrpUsdLive();
    const gotBag = await fetchBagViaAMMLive();
    liveOk = gotX && gotBag;
    if (!liveOk){
      if (!loadLastLiveBundle()) loadViewCache();
    }
    updateLiveLine();
  }

  (async ()=>{ await refreshPrices(); setInterval(refreshPrices, PRICE_REFRESH_MS); })();

  addEventListener('storage', (e)=>{
    if (e.key === VIEW_CACHE_KEY || e.key === XRP_KEY || e.key === LAST_LIVE_KEY){
      if (!loadLastLiveBundle()) loadViewCache();
      updateLiveLine();
    }
  });
})();
</script>

<!-- ===== WIRE (USD‚ÜîUnits + HUD & Limits) ===== -->
<script>
(function(){
  const MIN_USD=1, MAX_USD=2000;

  const usdEl = document.getElementById('usdBet');
  const qtyEl = document.getElementById('betQty');
  const curToggle = document.getElementById('curToggle');
  const unitEls = document.querySelectorAll('.unit');
  const limitsEl = document.getElementById('betLimits');

  function PR(){ return window.__PRICES__ || { bagUsd:0, xrpUsd:0 }; }
  function getCur(){ const el=curToggle?.querySelector('input[name="betCur"]:checked'); return el ? String(el.value).toUpperCase() : 'XRP'; }
  function priceFor(cur){ const { bagUsd, xrpUsd } = PR(); return cur==='BAG' ? bagUsd : xrpUsd; }
  function fmtUsd(n){ return '$'+(Number(n)||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }
  function writeUsd(u){ if(!usdEl) return; usdEl.value = u ? (Math.round(u*100)/100).toFixed(2) : ''; }
  function writeQty(q){ if(!qtyEl) return; const d=6; qtyEl.value = q ? Number(q).toFixed(Math.min(6,d)).replace(/\.?0+$/,'') : ''; }
  function readUsd(){ const v=parseFloat(usdEl?.value||''); return Number.isFinite(v)&&v>0?v:0; }
  function readQty(){ const v=parseFloat(qtyEl?.value||''); return Number.isFinite(v)&&v>0?v:0; }

  function renderLimits(){
    if(!limitsEl) return;
    const cur = getCur();
    const px  = priceFor(cur);
    const u = readUsd() || (readQty() * (px>0?px:0)) || 0;
    const warn = (u>0 && u<MIN_USD) ? ` ¬∑ <span style="color:#e8a85c">Min ${fmtUsd(MIN_USD)}</span>` :
                 (u>MAX_USD) ? ` ¬∑ <span style="color:#e8a85c">Max ${fmtUsd(MAX_USD)}</span>` : '';
    limitsEl.innerHTML = `Limits: ${fmtUsd(MIN_USD)}‚Äì${fmtUsd(MAX_USD)} ¬∑ Your stake ‚âà ${fmtUsd(u||0)}${warn}`;
  }

  function syncFromUSD(){
    const px = priceFor(getCur());
    const usd = readUsd();
    if (usd && px>0){ writeQty(usd / px); } else if(!usd){ writeQty(''); }
    renderLimits();
  }
  function syncFromQty(){
    const px = priceFor(getCur());
    const qty = readQty();
    if (qty && px>0){ writeUsd(qty * px); } else if(!qty){ writeUsd(''); }
    renderLimits();
  }

  usdEl?.addEventListener('input', ()=>{ syncFromUSD(); dispatchEvent(new CustomEvent('bag:hudRefresh')); });
  qtyEl?.addEventListener('input', ()=>{ syncFromQty(); dispatchEvent(new CustomEvent('bag:hudRefresh')); });

  curToggle?.addEventListener('change', ()=>{
    unitEls.forEach(s=> s.textContent = getCur());
    syncFromUSD();
    dispatchEvent(new CustomEvent('bag:hudRefresh'));
  });

  addEventListener('bag:pricesUpdated', ()=>{ syncFromUSD(); });

  // Quick chips mount
  (function mountChips(){
    const row = document.getElementById('usdPresets');
    if (!row) return;
    const PRESETS = [1,2,5,10,20,50,100,'max'];
    PRESETS.forEach(v=>{
      const b=document.createElement('button');
      b.type='button'; b.className='preset-chip'; b.textContent=(v==='max'?'Max':`$${v}`); b.dataset.usd=String(v);
      b.addEventListener('click', ()=>{
        const val = b.dataset.usd;
        let usd = val==='max' ? MAX_USD : Number(val)||0;
        usd = Math.max(MIN_USD, Math.min(MAX_USD, usd));
        writeUsd(usd); syncFromUSD();
        row.querySelectorAll('.preset-chip').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
      });
      row.appendChild(b);
    });
  })();

  // Initial paint
  unitEls.forEach(s=> s.textContent = getCur());
  syncFromUSD();
})();
</script>

<!-- ===== SIMPLE DEMO SESSION (Practice) ===== -->
<script>
(function(){
  const DEMO_BAL_KEY='__bag_demo_bag_v2';
  if(localStorage.getItem(DEMO_BAL_KEY)==null){ localStorage.setItem(DEMO_BAL_KEY,'1000'); }

  const statusEl  = document.getElementById('sessionStatus');
  const startBtn  = document.getElementById('startSessionBtn');
  const topUpBtn  = document.getElementById('topUpBtn');
  const endBtn    = document.getElementById('endSessionBtn');

  function fmt(n){
    if(!Number.isFinite(n)) return '‚Äî';
    if(Math.abs(n)>=1) return n.toLocaleString(undefined,{maximumFractionDigits:4});
    if(Math.abs(n)>=1e-2) return n.toLocaleString(undefined,{maximumFractionDigits:6});
    if(Math.abs(n)>=1e-4) return n.toLocaleString(undefined,{maximumFractionDigits:8});
    return n.toLocaleString(undefined,{maximumFractionDigits:10});
  }
  function getBag(){ return Number(localStorage.getItem(DEMO_BAL_KEY)||'0')||0; }
  function setBag(v){ localStorage.setItem(DEMO_BAL_KEY, String(Math.max(0,Number(v)||0))); }

  function render(){
    const bag=getBag();
    const bagUsd=(window.__PRICES__?.bagUsd||0)*bag;
    if(statusEl){
      statusEl.innerHTML = 'Practice: <span style="color:#2fbf6b">'+fmt(bag)+' BAG</span>' + (bagUsd?` <span class="micro" style="opacity:.75">($${bagUsd.toFixed(2)})</span>`:'');
    }
    if(startBtn) startBtn.style.display='inline-block';
    if(topUpBtn) topUpBtn.style.display='none';
    if(endBtn)   endBtn.style.display='none';
  }
  render();
  addEventListener('bag:pricesUpdated', render);

  window.__bagSession = {
    active:()=>true,
    get:()=>({addr:'demo', bag:getBag(), ts:Date.now()}),
    set:()=>{},
    spend(bag){ const b=getBag(); if(!(bag>0)||b<bag) return false; setBag(b-bag); render(); dispatchEvent(new CustomEvent('bag:hudRefresh')); return true; },
    credit(bag){ if(!(bag>0)) return false; setBag(getBag()+bag); render(); dispatchEvent(new CustomEvent('bag:hudRefresh')); return true; }
  };
})();
</script>

<!-- ===== RULES MODAL ===== -->
<script>
(function(){
  const fab = document.getElementById('rulesFab');
  const ov  = document.getElementById('rulesOverlay');
  const x   = document.getElementById('rulesClose');
  function open(){ ov.style.display='grid'; }
  function close(){ ov.style.display='none'; }
  fab?.addEventListener('click', open);
  x?.addEventListener('click', close);
  ov?.addEventListener('click', (e)=>{ if(e.target===ov) close(); });
  addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });
})();
</script>

<!-- ===== PLINKO CORE (kept intact; only UI/hud hooks) ===== -->
<script>
(function(){
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const W=640, H=880; canvas.width=W; canvas.height=H;

  const WALL_PAD=24, TOP=110, BOTTOM=120;
  const BALL_R=8, PEG_R=6;
  const GRAVITY=0.34, RESTITUTION=0.78, FRICTION=0.996;
  const SUBSTEPS=2;

  const slotLeft = 24, slotRight = 640-24;
  const PAY = ['L',1.25,'L',2,'L',1.25,'L'];
  const SLOTS = PAY.length;
  const slotW = (slotRight-slotLeft)/SLOTS;

  // pegs grid
  (function makePegs(){
    const pegs=[]; const ROWS=15, COLS=13;
    const pegAreaLeft=slotLeft, pegAreaRight=slotRight;
    const sx=(pegAreaRight-pegAreaLeft-40)/(COLS-1);
    const sy=(H-BOTTOM-TOP-60)/(ROWS-1);
    for(let r=0;r<ROWS;r++){
      const off=(r%2===0)?0:sx/2;
      for(let c=0;c<COLS;c++){
        const x=pegAreaLeft+20+c*sx+off;
        if(x<=pegAreaLeft+PEG_R||x>=pegAreaRight-PEG_R) continue;
        const y=TOP+r*sy;
        pegs.push({x,y,r:PEG_R});
      }
    }
    window.__PLINKO_PEGS__=pegs;
  })();

  const dropBtn=document.getElementById('dropBtn');
  const resText=document.getElementById('resText');
  const statusEl=document.getElementById('status');
  const betQty = document.getElementById('betQty');

  const balLbl=document.getElementById('balLbl');
  const ccyLbl=document.getElementById('ccyLbl');
  const betHud=document.getElementById('betHud');
  const modeLbl=document.getElementById('modeLbl');
  const lastLbl=document.getElementById('lastLbl');

  function PR(){ return window.__PRICES__ || {bagUsd:0,xrpUsd:0}; }
  function cur(){ return document.querySelector('#curToggle input[name="betCur"]:checked')?.value || 'XRP'; }
  function stakeBag(){
    const qty=parseFloat(betQty?.value||'0')||0;
    const {bagUsd,xrpUsd}=PR();
    if(cur()==='BAG') return qty;
    if(bagUsd>0 && xrpUsd>0) return qty*(xrpUsd/bagUsd);
    return 0;
  }

  function hud(){
    try{
      const sess=(window.__bagSession?.get?.()||{});
      const bag=Number(sess.bag)||0;
      const {bagUsd,xrpUsd}=PR();
      const xrp=(bagUsd>0 && xrpUsd>0)? bag*(bagUsd/xrpUsd):0;

      if(betHud) betHud.textContent = String(parseFloat(betQty?.value||'0')||0);
      if(modeLbl) modeLbl.textContent = (window.__BAG_FORCE_DEMO===true?'Demo':'Live');
      if(lastLbl) lastLbl.textContent = String(window.__PLINKO_LAST__||'‚Äî');

      if(cur().toUpperCase()==='XRP'){
        if(balLbl) balLbl.textContent = (xrp||0).toLocaleString(undefined,{maximumFractionDigits:6});
        if(ccyLbl) ccyLbl.textContent = 'XRP';
      }else{
        if(balLbl) balLbl.textContent = (bag||0).toLocaleString(undefined,{maximumFractionDigits:6});
        if(ccyLbl) ccyLbl.textContent = 'BAG';
      }
    }catch{}
  }
  ['bag:sessionStarted','bag:sessionToppedUp','bag:sessionEnded','bag:pricesUpdated','bag:hudRefresh'].forEach(ev=>addEventListener(ev,hud));
  betQty?.addEventListener('input', hud);
  document.getElementById('curToggle')?.addEventListener('change', hud);
  hud();

  let ball=null, dropping=false, safety=null;

  const leftWall = 24, rightWall = 640-24;
  const boardTop=TOP, boardBottom=H-BOTTOM;

  function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
  function aimXFromClient(clientX){
    const r = canvas.getBoundingClientRect();
    return clamp((clientX - r.left) * (canvas.width / r.width), leftWall+BALL_R, rightWall-BALL_R);
  }

  canvas.addEventListener('pointerdown', e=>{
    const nx=aimXFromClient(e.clientX);
    window.__DROP_X__=nx;
    try{canvas.setPointerCapture(e.pointerId);}catch{}
  });
  canvas.addEventListener('pointermove', e=>{
    const nx=aimXFromClient(e.clientX);
    window.__DROP_X__=nx;
  });
  addEventListener('keydown', e=>{
    let dx=window.__DROP_X__ ?? (leftWall+rightWall)/2;
    if(e.key==='ArrowLeft'){ e.preventDefault(); dx=clamp(dx-10,leftWall+BALL_R,rightWall-BALL_R); }
    if(e.key==='ArrowRight'){ e.preventDefault(); dx=clamp(dx+10,leftWall+BALL_R,rightWall-BALL_R); }
    if(e.code==='Space'){ e.preventDefault(); if(!dropping) dropBtn?.click(); }
    window.__DROP_X__=dx;
  });

  dropBtn?.addEventListener('click', ()=>{
    const usd = (()=>{ const q=parseFloat(betQty?.value||'0')||0; const {bagUsd,xrpUsd}=PR(); return cur()==='BAG' ? (bagUsd>0?q*bagUsd:0) : (xrpUsd>0?q*xrpUsd:0); })();
    if(!(usd>=1)){ resText.textContent='Min $1'; return; }

    const bagToSpend = stakeBag();
    if(!window.__bagSession?.active?.()){ alert('Start a session first'); return; }
    if(!(bagToSpend>0)){ alert('Enter a stake first'); return; }
    if(!window.__bagSession.spend(bagToSpend)){ alert('Insufficient balance'); return; }

    window.__PLINKO_LAST_STAKE_BAG__ = bagToSpend;
    window.__PLINKO_LAST_STAKE_USD__ = usd;

    startDrop();
  });

  function startDrop(){
    dropping=true; dropBtn.disabled=true; resText.textContent='‚Äî'; statusEl.textContent='Dropping‚Ä¶';
    const startX = clamp(window.__DROP_X__ ?? (leftWall+rightWall)/2, leftWall+BALL_R, rightWall-BALL_R);
    ball = { x:startX, y:boardTop-30, vx:0, vy:0.3, r:BALL_R, inSlot:-1, rest:0, alive:true };
    clearTimeout(safety);
    safety=setTimeout(()=>{ if(dropping) resolveByIndex(slotIdxFromX(ball.x)); }, 12000);
  }

  function slotIdxFromX(x){ const c = clamp(x, slotLeft+1, slotRight-1); return Math.max(0, Math.min(SLOTS-1, Math.floor((c-slotLeft)/slotW))); }

  function resolveByIndex(idx){
    if(!ball) return;
    ball.alive=false; dropping=false; dropBtn.disabled=false;
    clearTimeout(safety); safety=null;

    const rule = PAY[idx] ?? 'L';
    if (rule==='L'){
      window.__PLINKO_LAST__='Scratch';
      resText.textContent='Scratch (lose)'; statusEl.textContent='Resolved';
      hud(); dispatchEvent(new CustomEvent('bag:hudRefresh')); return;
    }
    const mult=Number(rule)||1.25;
    window.__PLINKO_LAST__ = (mult>=2?'Jackpot 2√ó':'Win 1.25√ó');
    resText.textContent = (mult>=2?'üéâ Jackpot 2√ó':'Win 1.25√ó');
    statusEl.textContent='Resolved';

    const bagStake = Number(window.__PLINKO_LAST_STAKE_BAG__||stakeBag()||0);
    const bagPayout = bagStake * mult;
    try{ window.__bagSession?.credit?.(bagPayout); }catch{}
    hud(); dispatchEvent(new CustomEvent('bag:hudRefresh'));
  }

  function stepBall(b){
    const fx = Math.pow(FRICTION, 1/SUBSTEPS), gy = GRAVITY / SUBSTEPS;
    for(let s=0;s<SUBSTEPS;s++){
      b.vy += gy; b.x += b.vx/SUBSTEPS; b.y += b.vy/SUBSTEPS; b.vx *= fx; b.vy *= fx;

      if(b.x - BALL_R < leftWall){ b.x = leftWall + BALL_R;  b.vx =  Math.abs(b.vx)*RESTITUTION; }
      if(b.x + BALL_R > rightWall){ b.x = rightWall - BALL_R; b.vx = -Math.abs(b.vx)*RESTITUTION; }

      // pegs
      const pegs = window.__PLINKO_PEGS__ || [];
      for(const p of pegs){
        const dx=b.x-p.x, dy=b.y-p.y, dist=Math.hypot(dx,dy)||0.0001, minD=BALL_R+PEG_R;
        if(dist<minD){
          const nx=dx/dist, ny=dy/dist;
          b.x += nx*(minD-dist); b.y += ny*(minD-dist);
          const vDot=b.vx*nx + b.vy*ny;
          b.vx = (b.vx - 2*vDot*nx)*RESTITUTION;
          b.vy = (b.vy - 2*vDot*ny)*RESTITUTION;
        }
      }

      // slots region
      if (b.inSlot<0 && (b.y + BALL_R) >= boardBottom){ b.inSlot = slotIdxFromX(b.x); }
      if (b.inSlot>=0){
        const left  = slotLeft + b.inSlot*slotW + BALL_R;
        const right = slotLeft + (b.inSlot+1)*slotW - BALL_R;
        const floor = boardBottom + 54 - BALL_R;
        if (b.x < left){  b.x = left;  b.vx = Math.abs(b.vx)*0.55; }
        if (b.x > right){ b.x = right; b.vx =-Math.abs(b.vx)*0.55; }
        if (b.y > floor){ b.y = floor; b.vy = -Math.abs(b.vy)*0.35; b.vx *= 0.985; }
        const center = slotLeft + b.inSlot*slotW + slotW/2;
        b.vx += (center - b.x) * 0.01;
        b.vx *= 0.985; b.vy *= 0.985;
        const speed=Math.hypot(b.vx,b.vy);
        const onFloor=Math.abs(b.y-floor)<0.6;
        b.rest = (speed<0.06 && onFloor) ? (b.rest+1) : 0;
        if (b.rest>=10){ resolveByIndex(b.inSlot); return; }
      }
    }
  }

  function drawBoard(){
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle='#0b1b13'; ctx.fillRect(0,0,W,H);

    // frame
    ctx.strokeStyle='#1c3b27'; ctx.lineWidth=4;
    ctx.strokeRect(slotLeft-8, TOP-40, (slotRight-slotLeft)+16, (H-BOTTOM)-TOP+60);

    // pegs
    ctx.fillStyle='#b8933e';
    for(const p of (window.__PLINKO_PEGS__||[])){ ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill(); }

    // slot baseline + dividers
    ctx.strokeStyle='#2a4d38'; ctx.lineWidth=3;
    ctx.beginPath(); ctx.moveTo(slotLeft, H-BOTTOM); ctx.lineTo(slotRight, H-BOTTOM); ctx.stroke();
    for(let i=1;i<SLOTS;i++){
      const x=slotLeft+i*slotW;
      ctx.beginPath(); ctx.moveTo(x, H-BOTTOM); ctx.lineTo(x, H-BOTTOM+50); ctx.stroke();
    }

    // labels
    const labels=['Scratch','1.25√ó','Scratch','2√ó','Scratch','1.25√ó','Scratch'];
    const colors=['#e25b5b','#baf2cd','#e25b5b','#ffd700','#e25b5b','#baf2cd','#e25b5b'];
    ctx.font='14px system-ui, -apple-system, Segoe UI, Roboto, Arial'; ctx.textAlign='center';
    for(let i=0;i<SLOTS;i++){
      const cx = slotLeft + i*slotW + slotW/2;
      ctx.fillStyle=colors[i]; ctx.fillText(labels[i], cx, H-BOTTOM+72);
    }

    // aim guide / ghost
    if(!dropping){
      const gx = clamp(window.__DROP_X__ ?? (slotLeft+slotRight)/2, slotLeft+BALL_R, rightWall-BALL_R);
      ctx.save();
      ctx.setLineDash([6,6]);
      ctx.strokeStyle = '#2a5';
      ctx.globalAlpha = .75;
      ctx.beginPath(); ctx.moveTo(gx, TOP-40); ctx.lineTo(gx, TOP); ctx.stroke();
      ctx.restore();
      ctx.save();
      const r=BALL_R;
      const g=ctx.createRadialGradient(gx-3,TOP-33,2,gx,TOP-30,r);
      g.addColorStop(0,'#fff2a6'); g.addColorStop(.55,'#d9a93e'); g.addColorStop(1,'#8b5e13');
      ctx.fillStyle=g; ctx.beginPath(); ctx.arc(gx,TOP-30,r,0,Math.PI*2); ctx.fill();
      ctx.lineWidth=1; ctx.strokeStyle='rgba(0,0,0,.35)'; ctx.stroke();
      ctx.restore();
    }
  }
  function drawBall(x,y){
    const r=BALL_R;
    const g=ctx.createRadialGradient(x-3,y-3,2,x,y,r);
    g.addColorStop(0,'#fff2a6'); g.addColorStop(.55,'#d9a93e'); g.addColorStop(1,'#8b5e13');
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
    ctx.lineWidth=1; ctx.strokeStyle='rgba(0,0,0,.35)'; ctx.stroke();
  }

  (function loop(){
    requestAnimationFrame(loop);
    drawBoard();
    if(ball && ball.alive){
      stepBall(ball);
      drawBall(ball.x, ball.y);
    }
  })();
})();
</script>

<script>
if('serviceWorker' in navigator){ navigator.serviceWorker.register('/service-worker.js').catch(()=>{}); }
</script>

</body>
</html>
