<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>BAG Dice</title>

<link rel="preconnect" href="https://api.coingecko.com" crossorigin>
<script src="https://xaman.app/assets/cdn/xumm.min.js"></script>
<script>window.__BAG_FORCE_DEMO = false;</script>

<!-- Optional Three.js (enable with ?three=1) -->
<script>
(function(){
  const qs = new URLSearchParams(location.search);
  if (qs.get('three') !== '1') return;
  function load(src, done, fail){
    var s=document.createElement('script');
    s.src=src; s.async=true; s.onload=done; s.onerror=fail; document.head.appendChild(s);
  }
  load('https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js',
    ()=>{ window.__THREE_READY__=true; },
    ()=>{
      load('https://unpkg.com/three@0.158.0/build/three.min.js',
        ()=>{ window.__THREE_READY__=true; },
        ()=>{ window.__THREE_FAILED__=true; console.error('[bag-dice] three.js failed to load'); }
      );
    }
  );
})();
</script>

<style>
  *{box-sizing:border-box}
  :root{
    --gold:#ffe175;--bg:#020703;--panel:#0b1b13;--panel2:#0d2217;--muted:#aeb7af;--fg:#f5f7f4;
    --green:#2fbf6b;--line:#173524;--shadow:rgba(0,0,0,.35);
    --win-bg: rgba(10,12,16,.70);
    --lose:#e25b5b; --warn:#e8a85c;
  }
  html,body{margin:0;background:var(--bg);color:var(--fg);
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.55}
  img{display:block;max-width:100%;height:auto}
  button,input{font-size:16px}

  .back-casino{
    position:fixed;top:18px;left:18px;z-index:1000;
    background:linear-gradient(180deg,#ffe175 0%,#f5c94c 100%);
    color:#08130d;text-decoration:none;font-weight:800;padding:8px 14px;border-radius:10px;
    box-shadow:0 4px 0 #b08a19;transition:all .15s ease
  }
  .back-casino:hover{filter:brightness(1.05);box-shadow:0 4px 0 #b08a19,0 14px 28px rgba(255,225,117,.22)}
  .back-casino:active{transform:translateY(1px);box-shadow:0 3px 0 #9a7315}

  .game-header{text-align:center;padding:36px 10px 14px}
  .game-header img.hero-img{margin-bottom:10px;filter:drop-shadow(0 10px 24px rgba(46,191,107,.18))}
  .game-header h2{font-size:clamp(1.6rem,5vw,2.2rem);margin:6px 0 0}
  @media (min-width:900px){
    .game-header img.hero-img{width:34vw;max-width:420px;margin-left:auto;margin-right:auto}
  }

  .game-teaser{padding:10px 16px 60px;background:
    radial-gradient(1200px 600px at 10% -10%, #0e2c1d 0%, transparent 60%),
    radial-gradient(900px 500px at 110% 20%, #0b2318 0%, transparent 55%),#060806;
    border-top:1px solid #131313;border-bottom:1px solid #131313}
  .game-wrap{max-width:1080px;margin:0 auto;display:grid;grid-template-columns:1.12fr .88fr;gap:22px}
  @media (max-width:900px){.game-wrap{grid-template-columns:1fr}}

  .panel{background:linear-gradient(180deg,var(--panel) 0%,var(--panel2) 100%);
    border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 24px var(--shadow)}
  .mock{padding:16px}

  .section-title{font-weight:800;font-size:1.2rem;margin:0 0 12px}
  .stake-box{padding:14px}
  .stack{display:grid;gap:10px}
  .choice{display:flex;gap:10px;flex-wrap:wrap}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid #2b6a48;background:#0e2a1c;color:#e9efe9;font-weight:800}
  .chip input{accent-color:#2fbf6b}
  .mono{font-variant-numeric:tabular-nums}
  .micro{font-size:.85rem;color:#a8b5ab}
  .muted{color:#cfd6cf}
  .divider{height:1px;background:#123221;margin:10px 0}
  .callout{margin-top:12px;padding:12px;border:1px dashed #29543d;border-radius:12px;background:#0c2418;color:#e4efe7}
  .payout-grid{display:grid;gap:4px}
  .payout-grid .row{display:flex;justify-content:space-between}
  .payout-grid .lab{color:#cfd6cf}
  .payout-grid .val{font-variant-numeric:tabular-nums}

  #liveDot{margin-right:6px}
  .ok{color:#2fbf6b}
  .warn{color:#e8a85c}
  .err{color:#e25b5b}

  .table{background:#07140e;border:1px solid #1b4a2f;border-radius:14px;padding:14px}
  .felt{
    display:grid;grid-template-columns:1fr;gap:12px;
    background:#091a13;border:1px solid #24533a;border-radius:12px;padding:12px;overflow:hidden
  }
  .marquee{ text-align:center;font-weight:900;letter-spacing:.08em;
    color:#ffe9a6;background:linear-gradient(180deg,#17311f,#0e2419);
    border:1px solid #254a33;border-radius:12px;padding:8px }
  .stage3d{ height:260px; position:relative; border-radius:10px; overflow:hidden; }
  .stage3d canvas{ display:block; width:100%; height:100%; }
  .roll-row{display:flex;justify-content:center}
  .btn-roll{
    width:min(360px,90%);padding:16px 22px;margin-top:2px;
    font-size:1.15rem;font-weight:900;text-transform:uppercase;letter-spacing:.5px;border:0;border-radius:14px;
    color:#08130d;background:linear-gradient(180deg,#ffe175 0%, #f5c94c 100%);
    box-shadow:0 6px 0 #b08a19, 0 16px 32px rgba(255,225,117,.18), inset 0 1px 0 rgba(255,255,255,.35);
    transition:transform .06s ease, box-shadow .2s ease, filter .2s ease; cursor:pointer;
  }
  .btn-roll:active{transform:translateY(2px);box-shadow:0 4px 0 #9a7315,0 12px 24px rgba(255,225,117,.2), inset 0 1px 0 rgba(255,255,255,.3)}
  .btn-roll:disabled{opacity:.65;cursor:not-allowed}
  .btn-roll:focus-visible, .chip:focus-within { outline:2px solid #ffe175; outline-offset:2px; }

  .result{margin-top:10px;padding:12px;border:1px solid #1b4a2f;border-radius:12px;background:#0b2217;display:flex;align-items:center;gap:10px}
  .t.win{color:#2fbf6b}.t.scratch{color:#e8a85c}.t.lose{color:var(--lose)}

  /* CSS fallback dice */
  .css-dice-wrap{ position:absolute; inset:0; display:grid; place-items:center; gap:48px; }
  .css-die{ position:relative; width:96px; height:96px; transform-style:preserve-3d; }
  .css-face{
    position:absolute; inset:0; transform-style:preserve-3d;
    background:#fff center/cover no-repeat;
    border-radius:16px; box-shadow:inset 0 0 0 2px #dadada;
  }
  .css-face.f1{ transform: translateZ(48px); }
  .css-face.f6{ transform: rotateX(180deg) translateZ(48px); }
  .css-face.f3{ transform: rotateY(90deg) translateZ(48px); }
  .css-face.f4{ transform: rotateY(-90deg) translateZ(48px); }
  .css-face.f2{ transform: rotateX(-90deg) translateZ(48px); }
  .css-face.f5{ transform: rotateX(90deg) translateZ(48px); }
  .css-die{ transition: transform .65s cubic-bezier(.2,.9,.2,1); }
  .settle{ animation:settle .35s ease-out; }
  @keyframes settle{
    0%{ transform:translateY(-6px) rotateZ(.6deg) }
    55%{ transform:translateY(2px) rotateZ(-.5deg) }
    100%{ transform:translateY(0) rotateZ(0) }
  }

  /* WIN overlay visuals */
  #win-overlay{ position:fixed; inset:0; display:none; place-items:center; background:radial-gradient(60% 60% at 50% 50%, rgba(24,160,251,.28), transparent 70%), var(--win-bg); z-index:2147483647; backdrop-filter:saturate(120%) blur(2px); }
  #win-card{ position:relative; text-align:center; padding:24px 32px; border-radius:16px; background:rgba(0,0,0,.35); box-shadow:0 10px 40px rgba(0,0,0,.45), inset 0 0 80px rgba(0,255,200,.06); transform:scale(.9); opacity:0; animation:win-pop .35s cubic-bezier(.2,.9,.2,1) forwards, win-float 1.8s ease-in-out .35s infinite; }
  #win-text{
    font: 900 64px/1 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    letter-spacing:.06em;
    background:linear-gradient(90deg, #fff, #00ffb2, #fff);
    background-size:200% 100%;
    -webkit-background-clip:text; background-clip:text;
    color:transparent; -webkit-text-fill-color:transparent;
    text-shadow: 0 0 18px rgba(0,255,178,.35), 0 0 48px rgba(0,255,178,.25);
    filter:drop-shadow(0 4px 10px rgba(0,0,0,.35));
    animation:shine 1.6s linear infinite;
    white-space:nowrap;
  }
  #win-sub{ margin-top:8px; color:#e7f6ff; opacity:.9; font: 600 16px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
  #win-close{ position:absolute; top:8px; right:10px; border:0; background:transparent; color:#cfeaff; font:700 20px/1 system-ui; cursor:pointer; padding:6px 8px; opacity:.7; }
  #win-canvas{ position:fixed; inset:0; pointer-events:none; z-index:2147483646; display:none; }
  @keyframes win-pop{ to{ transform:scale(1); opacity:1; } }
  @keyframes win-float{ 0%,100%{ transform:translateY(0) } 50%{ transform:translateY(-6px) } }
  @media (prefers-reduced-motion: reduce){
    #win-card{ animation:none; transform:none; opacity:1; }
    #win-text{ animation:none; }
  }

  .hudbar{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; margin:6px 2px 0; }
  .pill{ background:#0a1e15; border:1px solid #244330; border-radius:999px; padding:6px 10px; font-size:12px; color:#cfe6d8 }
  .hudbar .pill b{ font-weight:800 }

  .preset-chips{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  .preset-chip{
    appearance:none; border:1px solid #2b6a48; background:#0e2a1c; color:#e9efe9;
    border-radius:999px; padding:6px 10px; font-weight:800; cursor:pointer;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.06);
  }
  .preset-chip:focus-visible{ outline:2px solid var(--gold); outline-offset:2px; }
  .preset-chip.active{ background:#173c28; border-color:#3fa86a; box-shadow:0 0 0 2px rgba(63,168,106,.25) inset; }
</style>

<script src="/js/bag-session.js"></script>
</head>
<body>

<a href="/casino/" class="back-casino">‚¨ÖÔ∏è Back to Casino</a>

<section class="game-header">
  <picture>
    <source type="image/webp"
            srcset="/assets/bag-dice-960.webp 960w, /assets/bag-dice-1024.webp 1024w"
            sizes="(min-width:900px) 420px, 70vw">
    <img
      class="hero-img"
      src="/assets/bag-dice-1024.png"
      srcset="/assets/bag-dice-960.png 960w, /assets/bag-dice-1024.png 1024w"
      sizes="(min-width:900px) 420px, 70vw"
      alt="BAG Dice"
      width="1024" height="576"
      loading="lazy" decoding="async">
  </picture>
  <h2>üé≤ $BAG DICE ‚Äî Pass Line</h2>
  <p class="micro" style="margin-top:4px;opacity:.9;">üí∞ <strong>All payouts are in $BAG.</strong> $XRP bets convert automatically at the live rate.</p>
</section>

<section class="game-teaser" aria-labelledby="game-teaser-title">
  <div class="game-wrap">

    <!-- LEFT -->
    <div class="panel mock" id="bagDiceDemo">
      <!-- CONNECT -->
      <div id="connectRow" style="display:flex;justify-content:space-between;align-items:center;margin:-2px 0 10px 0%;">
        <div id="connectStatus" class="micro" style="opacity:.9">Wallet: <span style="color:#e8a85c">not connected</span></div>
        <button id="connectBtn" style="padding:10px 14px;font-weight:800;border:0;border-radius:12px;color:#08130d;background:linear-gradient(180deg,#ffe175 0%, #f5c94c 100%);box-shadow:0 4px 0 #b08a19;cursor:pointer;">Connect Xaman</button>
      </div>
      <!-- SESSION -->
      <div id="sessionRow" style="display:flex;justify-content:space-between;align-items:center;margin:6px 0 10px 0%;">
        <div id="sessionStatus" class="micro" style="opacity:.9">Session: <span style="color:#e8a85c">not started</span></div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="startSessionBtn" style="padding:8px 12px;font-weight:800;border:0;border-radius:10px;color:#08130d;background:linear-gradient(180deg,#ffe175 0%, #f5c94c 100%);box-shadow:0 3px 0 #b08a19;cursor:pointer;">Start Session</button>
          <button id="topUpBtn" style="padding:8px 12px;font-weight:800;border:0;border-radius:10px;color:#08130d;background:linear-gradient(180deg,#ffe175 0%, #f5c94c 100%);box-shadow:0 3px 0 #b08a19;cursor:pointer;display:none;">Top Up</button>
          <button id="endSessionBtn" style="padding:8px 12px;font-weight:800;border:0;border-radius:10px;background:#15261c;color:#dfe9e2;border:1px solid #2b6a48;cursor:pointer;display:none;">End</button>
        </div>
      </div>

      <div class="section-title">Stake & Prices</div>

      <div class="stake-box">
        <div class="stack">
          <div>
            <div class="micro">Amount</div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
              <div style="display:flex;align-items:center;gap:6px">
                <input id="usdBet" class="mono" type="number" inputmode="decimal" enterkeyhint="done" min="0" max="2000" step="0.01" placeholder="0.00" style="width:140px;background:#0b2217;border:1px solid #1b4a2f;border-radius:10px;color:#f3f5f0;padding:10px">
                <span class="micro" aria-hidden="true">USD</span>
              </div>
            </div>
            <!-- PRESETS -->
            <div class="preset-chips" id="usdPresets" role="group" aria-label="Quick bet">
              <button type="button" class="preset-chip" data-usd="1">$1</button>
              <button type="button" class="preset-chip" data-usd="2">$2</button>
              <button type="button" class="preset-chip" data-usd="5">$5</button>
              <button type="button" class="preset-chip" data-usd="10">$10</button>
              <button type="button" class="preset-chip" data-usd="20">$20</button>
              <button type="button" class="preset-chip" data-usd="50">$50</button>
              <button type="button" class="preset-chip" data-usd="100">$100</button>
              <button type="button" class="preset-chip" data-usd="max">Max</button>
            </div>
          </div>

          <div>
            <div class="micro">Bet currency</div>
            <div class="choice" id="curToggle">
              <label class="chip"><input type="radio" name="betCur" value="XRP" checked> XRP</label>
              <label class="chip"><input type="radio" name="betCur" value="BAG"> BAG</label>
            </div>
          </div>

          <div>
            <div class="micro">Bet amount</div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
              <div>
                <input id="betQty" class="mono" type="number" inputmode="decimal" enterkeyhint="done" min="0" step="any" value="1" style="width:140px;background:#0b2217;border:1px solid #1b4a2f;border-radius:10px;color:#f3f5f0;padding:10px">
                <span class="unit">XRP</span>
              </div>
            </div>
            <div class="micro" id="betLimits" style="margin-top:6px"></div>
          </div>

          <div class="divider"></div>

          <div class="micro">Live prices</div>
          <div class="muted mono" id="liveLine">
            <span id="liveDot" class="warn">‚óè</span>
            <span> BAG $<span id="liveBAG">‚Äî</span> ¬∑ XRP $<span id="liveXRP">‚Äî</span> <span id="liveNote"></span></span>
            <div class="micro" id="liveConv" style="margin-top:4px;opacity:.9;">1 BAG ‚âà ‚Äî XRP ¬∑ 1 XRP ‚âà ‚Äî BAG</div>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Payouts preview -->
      <div class="callout mono" id="payoutBox">
        <div class="payout-grid">
          <div class="row"><div class="lab"><strong>Come-out WIN</strong> (7 or 11):</div><div class="val" id="payWinComeOut">‚Äî</div></div>
          <div class="row"><div class="lab"><strong>Point WIN</strong> (roll point before 7):</div><div class="val" id="payWinPoint">‚Äî</div></div>
          <div class="row"><div class="lab"><strong>JACKPOT</strong> (random upgrade on any WIN):</div><div class="val" id="payJackpot">‚Äî</div></div>
          <div class="row"><div class="lab"><strong>SEVEN OUT / CRAPS</strong> (lose):</div><div class="val" id="payLose">0 BAG ($0.00)</div></div>
          <div class="row"><div class="lab"><strong>Point established</strong> (no payout yet):</div><div class="val" id="payHold">Stake held</div></div>
        </div>
        <div class="micro" style="margin-top:6px;opacity:.85;">
          Pass Line: 7/11 on come-out = WIN ¬∑ 2/3/12 = CRAPS (lose) ¬∑ Any other total sets the <b>Point</b>. Then roll until <b>point</b> (WIN) or <b>7</b> (SEVEN OUT, lose).
          Come-out win pays <b>1.25√ó</b>; point win pays <b>1.00√ó</b>. <b>Jackpot</b> may randomly upgrade a WIN to <b>2.00√ó</b> total.
        </div>
      </div>

      <!-- DICE table -->
      <div class="dice-wrap">
        <div class="marquee">$BAG DICE</div>
        <div class="table">
          <div class="felt">
            <div id="dice3d" class="stage3d" aria-label="3D dice area">
              <!-- CSS fallback always visible; 3D will draw a canvas over it if enabled -->
              <div id="cssDice" class="css-dice-wrap">
                <div class="css-die" id="d1">
                  <div class="css-face f1"></div><div class="css-face f2"></div><div class="css-face f3"></div>
                  <div class="css-face f4"></div><div class="css-face f5"></div><div class="css-face f6"></div>
                </div>
                <div class="css-die" id="d2">
                  <div class="css-face f1"></div><div class="css-face f2"></div><div class="css-face f3"></div>
                  <div class="css-face f4"></div><div class="css-face f5"></div><div class="css-face f6"></div>
                </div>
              </div>
            </div>
            <div class="roll-row">
              <button id="rollBtn" class="btn-roll">ROLL</button>
            </div>

            <!-- HUD -->
            <div class="hudbar" aria-live="polite" id="diceHud">
              <span class="pill">Mode: <b id="modeLbl">Demo</b></span>
              <span class="pill">Balance: <b id="balLbl">‚Äî</b> <span id="ccyLbl">BAG</span></span>
              <span class="pill">Bet: <b id="betLbl">1</b></span>
              <span class="pill">Last: <b id="lastLbl">‚Äî</b></span>
            </div>

            <p class="micro" style="text-align:center;margin-top:8px;opacity:.75;">
              üîä If you don‚Äôt hear sound: tap ROLL once, turn off Silent mode, and raise volume.
            </p>
            <div class="result"><div class="t" id="rollText" role="status" aria-live="polite">Come-out roll ‚Äî Need 7 or 11 to WIN ¬∑ 2/3/12 is CRAPS ¬∑ otherwise sets the Point</div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="panel" style="padding:16px">
      <h3 style="margin:0 0 8px;font-size:1.2rem;">How it plays (Pass Line)</h3>

      <p style="color:#cfd6cf;margin:0 0 8px;">
        Bet the <b>Pass Line</b>. The first roll is the <b>come-out roll</b>.
      </p>

      <h4 style="margin:12px 0 6px;">Come-out roll</h4>
      <ul style="margin:0;padding-left:18px;color:#cfd6cf">
        <li><b>7 or 11</b> ‚Üí <b>Pass Line WIN</b> (pays <b>1.25√ó</b> total).</li>
        <li><b>2, 3, or 12</b> ‚Üí <b>CRAPS</b> (you lose, round ends).</li>
        <li><b>4, 5, 6, 8, 9, or 10</b> ‚Üí That number becomes the <b>Point</b>. Your stake stays up.</li>
      </ul>

      <h4 style="margin:12px 0 6px;">Point phase</h4>
      <ul style="margin:0;padding-left:18px;color:#cfd6cf">
        <li>Roll until either the <b>Point</b> is made (you <b>WIN 1.00√ó</b>) or a <b>7</b> appears (<b>SEVEN OUT</b>, you lose).</li>
        <li>Any other total is a <b>neutral</b> roll ‚Äî no payout; stake remains.</li>
      </ul>

      <h4 style="margin:12px 0 6px;">Payouts</h4>
      <ul style="margin:0;padding-left:18px;color:#cfd6cf">
        <li><b>Come-out WIN</b> (7/11) ‚Äî <b>1.25√ó total</b></li>
        <li><b>Point WIN</b> ‚Äî <b>1.00√ó total</b></li>
        <li><b>JACKPOT</b> ‚Äî <b>2.00√ó total</b> (random upgrade on any WIN)</li>
        <li><b>CRAPS / SEVEN OUT</b> ‚Äî lose</li>
      </ul>

      <p class="micro" style="margin-top:10px">Practice mode enabled ‚Äî on-ledger play wires in after QA. All payouts settle in <b>$BAG</b>. $XRP stakes convert at live rate automatically.</p>
    </div>

  </div>
</section>

<!-- Celebration overlay -->
<canvas id="win-canvas"></canvas>
<div id="win-overlay" role="dialog" aria-live="polite" aria-label="Win notification">
  <div id="win-card">
    <button id="win-close" aria-label="Close">√ó</button>
    <div id="win-text">WIN</div>
    <div id="win-sub">Nice roll</div>
  </div>
</div>

<!-- AUDIO -->
<audio id="sndRoll" preload="auto">
  <source src="/assets/sounds/dice-roll.mp3" type="audio/mpeg">
</audio>
<audio id="sndWin" preload="auto">
  <source src="/assets/sounds/win-chime.mp3" type="audio/mpeg">
</audio>

<!-- PRICES -->
<script>
(() => {
  const liveDot = document.getElementById('liveDot');
  const elBAG = document.getElementById('liveBAG');
  const elXRP = document.getElementById('liveXRP');
  const elConv = document.getElementById('liveConv');
  const elNote = document.getElementById('liveNote');

  let price = {
    BAG_USD: null,
    XRP_USD: null
  };

  async function fetchXRP() {
    try{
      const r = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=ripple&vs_currencies=usd',{cache:'no-store'});
      const j = await r.json();
      price.XRP_USD = Number(j?.ripple?.usd) || null;
    }catch(e){ price.XRP_USD = null; }
  }

  // BAG pricing: prefer a global from your session layer (locked config), else omit
  function readBagFromSession(){
    // Accept any of these if your /js/bag-session.js defines them
    if (typeof window.BAG_PRICE_USD === 'number') return window.BAG_PRICE_USD;
    if (window.BAG && typeof window.BAG.price_usd === 'number') return window.BAG.price_usd;
    if (window.__BAG__ && typeof window.__BAG__.price_usd === 'number') return window.__BAG__.price_usd;
    return null;
  }

  function updateUI(){
    const bag = price.BAG_USD;
    const xrp = price.XRP_USD;
    if (bag) elBAG.textContent = bag.toFixed(Math.max(4, bag<0.01?6:4));
    else elBAG.textContent = '‚Äî';
    if (xrp) elXRP.textContent = xrp.toFixed(4);

    if (bag && xrp){
      const bag_per_xrp = xrp / bag;  // 1 XRP in BAG
      const xrp_per_bag = bag / xrp;  // 1 BAG in XRP
      elConv.textContent = `1 BAG ‚âà ${xrp_per_bag.toFixed(6)} XRP ¬∑ 1 XRP ‚âà ${bag_per_xrp.toFixed(2)} BAG`;
      liveDot.className = 'ok';
      elNote.textContent = '';
      document.dispatchEvent(new CustomEvent('bag:prices', {detail:{...price, bag_per_xrp, xrp_per_bag}}));
    } else {
      liveDot.className = 'warn';
      elNote.textContent = '  BAG price pending';
    }
  }

  async function refresh(){
    price.BAG_USD = readBagFromSession();
    await fetchXRP();
    updateUI();
  }

  refresh();
  setInterval(refresh, 30000);
})();
</script>

<!-- USD presets, bet limits, payout preview -->
<script>
(() => {
  const usdInput = document.getElementById('usdBet');
  const presets = document.getElementById('usdPresets');
  const betQty = document.getElementById('betQty');
  const unitSpan = document.querySelector('.unit');
  const curToggle = document.getElementById('curToggle');
  const betLimits = document.getElementById('betLimits');

  const payCO = document.getElementById('payWinComeOut');
  const payPT = document.getElementById('payWinPoint');
  const payJP = document.getElementById('payJackpot');

  let state = {
    betCurrency: 'XRP',
    bag_per_xrp: null,
    xrp_per_bag: null,
    BAG_USD: null,
    XRP_USD: null
  };

  function calcFromUSD(usd){
    // return {xrp, bag}
    if (state.XRP_USD) var xrp = usd / state.XRP_USD;
    if (state.BAG_USD) var bag = usd / state.BAG_USD;
    return { xrp: xrp||0, bag: bag||0 };
  }

  function refreshPayoutPreview(){
    const qty = Number(betQty.value)||0;
    const cur = state.betCurrency;

    // Convert stake to BAG for display and USD equivalence
    let stake_bag = 0, stake_usd = 0;
    if (cur === 'XRP'){
      if (state.bag_per_xrp) stake_bag = qty * state.bag_per_xrp;
      if (state.XRP_USD)      stake_usd = qty * state.XRP_USD;
    } else {
      stake_bag = qty;
      if (state.BAG_USD) stake_usd = qty * state.BAG_USD;
    }

    function fmt(bag, usd){
      const b = isFinite(bag)? bag : 0;
      const u = isFinite(usd)? usd : 0;
      return `${b.toFixed(2)} BAG ($${u.toFixed(2)})`;
    }

    const co_mult = 1.25;
    const pt_mult = 1.00;
    const jp_mult = 2.00;

    payCO.textContent = fmt(stake_bag*co_mult, stake_usd*co_mult);
    payPT.textContent = fmt(stake_bag*pt_mult, stake_usd*pt_mult);
    payJP.textContent = fmt(stake_bag*jp_mult, stake_usd*jp_mult);
  }

  // Limits
  function refreshLimits(){
    // Demo: loose guide
    betLimits.textContent = state.betCurrency==='XRP'
      ? 'Min 0.1 XRP ¬∑ Max 100 XRP'
      : 'Min 100 BAG ¬∑ Max 100000 BAG';
  }

  presets.addEventListener('click', (e)=>{
    const b = e.target.closest('button[data-usd]');
    if(!b) return;
    const v = b.dataset.usd;
    if (v === 'max'){ usdInput.value = 100; }
    else usdInput.value = Number(v).toFixed(2);

    // Auto-fill betQty based on chosen currency using prices
    const usd = Number(usdInput.value)||0;
    if (state.betCurrency === 'XRP' && state.XRP_USD){
      betQty.value = (usd / state.XRP_USD).toFixed(4);
    } else if (state.betCurrency === 'BAG' && state.BAG_USD){
      betQty.value = Math.max(1, Math.floor(usd / state.BAG_USD));
    }
    refreshPayoutPreview();
  });

  curToggle.addEventListener('change', (e)=>{
    const val = (new FormData(curToggle)).get('betCur');
    state.betCurrency = val;
    unitSpan.textContent = val;
    document.getElementById('ccyLbl').textContent = val;
    refreshLimits();
    refreshPayoutPreview();
  });

  betQty.addEventListener('input', refreshPayoutPreview);
  usdInput.addEventListener('input', ()=>{
    // keep USD as a helper; user can still edit betQty directly
  });

  document.addEventListener('bag:prices', (e)=>{
    const d = e.detail||{};
    state.BAG_USD = d.BAG_USD;
    state.XRP_USD = d.XRP_USD;
    state.bag_per_xrp = d.bag_per_xrp;
    state.xrp_per_bag = d.xrp_per_bag;
    refreshPayoutPreview();
  });

  refreshLimits();
})();
</script>

<!-- Celebration overlay logic -->
<script>
(() => {
  const overlay = document.getElementById('win-overlay');
  const closeBtn = document.getElementById('win-close');
  const winCanvas = document.getElementById('win-canvas');

  function showWin(text='WIN', sub='Nice roll'){
    document.getElementById('win-text').textContent = text;
    document.getElementById('win-sub').textContent = sub;
    overlay.style.display = 'grid';
    winCanvas.style.display = 'block';
    // simple confetti dots
    const ctx = winCanvas.getContext('2d');
    let w,h,parts=[];
    function resize(){ w=winCanvas.width=innerWidth; h=winCanvas.height=innerHeight; }
    resize(); let t=0;
    for(let i=0;i<120;i++) parts.push({x:Math.random()*w,y:-20-Math.random()*h,r:2+Math.random()*3,vy:1+Math.random()*3});
    let anim=true;
    (function loop(){
      if(!anim) return;
      ctx.clearRect(0,0,w,h);
      ctx.globalAlpha=0.9;
      for(const p of parts){
        ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fillStyle='white'; ctx.fill();
        p.y+=p.vy;
        if(p.y>h+10) { p.y=-10; p.x=Math.random()*w; }
      }
      t++; requestAnimationFrame(loop);
    })();
    function end(){ anim=false; overlay.style.display='none'; winCanvas.style.display='none'; }
    closeBtn.onclick=end;
    overlay.onclick=(e)=>{ if(e.target===overlay) end(); };
    setTimeout(end, 2500);
  }

  window.__bagShowWin = showWin;
})();
</script>

<!-- Game logic + CSS dice fallback + audio -->
<script>
(() => {
  // --- ELEMENTS ---
  const btnRoll = document.getElementById('rollBtn');
  const rollText = document.getElementById('rollText');
  const modeLbl = document.getElementById('modeLbl');
  const balLbl  = document.getElementById('balLbl');
  const betLbl  = document.getElementById('betLbl');
  const lastLbl = document.getElementById('lastLbl');
  const ccyLbl  = document.getElementById('ccyLbl');
  const betQty  = document.getElementById('betQty');
  const curToggle = document.getElementById('curToggle');

  const sndRoll = document.getElementById('sndRoll');
  const sndWin  = document.getElementById('sndWin');

  // --- STATE ---
  const qs = new URLSearchParams(location.search);
  const LIVE = qs.get('live')==='1' && window.__BAG_FORCE_DEMO!==true;
  modeLbl.textContent = LIVE ? 'Live' : 'Demo';

  let state = {
    balance_bag: 100000,          // demo credit in BAG
    comeOut: true,
    point: null,
    rolling: false,
    lockedStake: 0,               // BAG units locked for the round
    betCurrency: 'XRP'
  };

  // HUD init
  function refreshHUD(){
    balLbl.textContent = Math.max(0, state.balance_bag).toFixed(2);
    betLbl.textContent = document.getElementById('betQty').value || '0';
    ccyLbl.textContent = state.betCurrency;
  }

  function currencyFromUI(){
    const val = (new FormData(curToggle)).get('betCur');
    state.betCurrency = val;
    refreshHUD();
  }
  curToggle.addEventListener('change', currencyFromUI);
  currencyFromUI();

  // map die face -> rotation (CSS cube)
  const faceRot = {
    1: 'rotateX(0deg) rotateY(0deg)',
    2: 'rotateX(90deg) rotateY(0deg)',
    3: 'rotateY(90deg)',
    4: 'rotateY(-90deg)',
    5: 'rotateX(-90deg)',
    6: 'rotateX(180deg)'
  };
  const d1 = document.getElementById('d1');
  const d2 = document.getElementById('d2');

  function randFace(){ return 1 + Math.floor(Math.random()*6); }

  let audioPrimed = false;
  function primeAudio(){
    if (audioPrimed) return;
    // must be called from a user gesture
    try{ sndRoll.play().then(()=>{ sndRoll.pause(); sndRoll.currentTime=0; audioPrimed=true; }).catch(()=>{}); }catch(e){}
    try{ sndWin.play().then(()=>{ sndWin.pause(); sndWin.currentTime=0; audioPrimed=true; }).catch(()=>{}); }catch(e){}
  }

  function playRoll(){ try{ sndRoll.currentTime=0; sndRoll.play().catch(()=>{}); }catch(e){} }
  function playWin(){ try{ sndWin.currentTime=0; sndWin.play().catch(()=>{}); }catch(e){} }

  function lockStake(){
    // Convert current bet to BAG and lock it (demo only)
    const qty = Number(betQty.value)||0;
    const cur = state.betCurrency;
    // read pricing snapshot from last event
    let rate = window.__lastPriceSnapshot;
    let stake_bag = 0;
    if (cur==='XRP'){
      if (rate?.bag_per_xrp) stake_bag = qty * rate.bag_per_xrp;
    } else {
      stake_bag = qty;
    }
    stake_bag = Math.max(0, stake_bag);
    state.lockedStake = stake_bag;
  }

  // listen to price events for conversions
  window.__lastPriceSnapshot = null;
  document.addEventListener('bag:prices', (e)=>{ window.__lastPriceSnapshot = e.detail; });

  function settleWin(mult, label){
    const won = state.lockedStake * mult;
    state.balance_bag += won;
    rollText.className='t win';
    rollText.textContent = `${label} ‚Äî +${won.toFixed(2)} BAG`;
    window.__bagShowWin('WIN', label);
    playWin();
    // New round
    state.comeOut = true;
    state.point = null;
    state.lockedStake = 0;
  }

  function settleLose(label){
    rollText.className='t lose';
    rollText.textContent = `${label} ‚Äî You lose`;
    // New round
    state.comeOut = true;
    state.point = null;
    state.lockedStake = 0;
  }

  function doRoll(){
    if (state.rolling) return;
    primeAudio();
    // On first come-out, lock the stake and deduct it from demo balance
    if (state.comeOut){
      lockStake();
      if (state.lockedStake <= 0){
        rollText.className='t scratch';
        rollText.textContent = 'Set a valid stake';
        return;
      }
      state.balance_bag -= state.lockedStake;
      if (state.balance_bag < 0) state.balance_bag = 0;
    }

    state.rolling = true;
    btnRoll.disabled = true;
    playRoll();

    // Animate dice
    const f1 = randFace();
    const f2 = randFace();
    d1.classList.remove('settle'); d2.classList.remove('settle');
    // add some spin noise then land
    d1.style.transform = `rotateX(${Math.random()*720-360}deg) rotateY(${Math.random()*720-360}deg)`;
    d2.style.transform = `rotateX(${Math.random()*720-360}deg) rotateY(${Math.random()*720-360}deg)`;

    setTimeout(()=>{
      d1.style.transform = faceRot[f1];
      d2.style.transform = faceRot[f2];
      d1.classList.add('settle'); d2.classList.add('settle');

      const total = f1+f2;
      lastLbl.textContent = total;
      resolveOutcome(total);
      refreshHUD();
      state.rolling = false;
      btnRoll.disabled = false;
    }, 650);
  }

  function resolveOutcome(total){
    if (state.comeOut){
      if (total===7 || total===11){
        // 1.25x
        // Jackpot 10% chance ‚Üí 2.0x instead
        const jp = Math.random() < 0.10;
        settleWin(jp ? 2.00 : 1.25, jp ? 'JACKPOT ‚Äî Come-out WIN' : 'Come-out WIN');
        return;
      }
      if (total===2 || total===3 || total===12){
        settleLose('CRAPS');
        return;
      }
      // set point
      state.point = total;
      state.comeOut = false;
      rollText.className='t scratch';
      rollText.textContent = `Point is ${state.point} ‚Äî roll point to WIN 1.00√ó ¬∑ 7 is SEVEN OUT`;
      return;
    }
    // Point phase
    if (total === state.point){
      const jp = Math.random() < 0.08; // slightly lower JP during point
      settleWin(jp ? 2.00 : 1.00, jp ? 'JACKPOT ‚Äî Point WIN' : 'Point WIN');
      return;
    }
    if (total === 7){
      settleLose('SEVEN OUT');
      return;
    }
    // neutral
    rollText.className='t scratch';
    rollText.textContent = `Rolled ${total} ‚Äî still need ${state.point} before 7`;
  }

  btnRoll.addEventListener('click', doRoll);

  // Simple session buttons (demo placeholders)
  document.getElementById('startSessionBtn').addEventListener('click', ()=>{
    document.getElementById('sessionStatus').innerHTML = 'Session: <span style="color:#2fbf6b">active</span>';
    document.getElementById('topUpBtn').style.display='inline-block';
    document.getElementById('endSessionBtn').style.display='inline-block';
  });
  document.getElementById('endSessionBtn').addEventListener('click', ()=>{
    document.getElementById('sessionStatus').innerHTML = 'Session: <span style="color:#e8a85c">not started</span>';
    document.getElementById('topUpBtn').style.display='none';
    document.getElementById('endSessionBtn').style.display='none';
  });
  document.getElementById('topUpBtn').addEventListener('click', ()=>{
    state.balance_bag += 50000;
    refreshHUD();
  });

  // Connect button placeholder
  document.getElementById('connectBtn').addEventListener('click', ()=>{
    document.getElementById('connectStatus').innerHTML = 'Wallet: <span style="color:#2fbf6b">connected</span>';
  });

  refreshHUD();
})();
</script>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/service-worker.js').catch(()=>{});
}
</script>

<footer class="footer" style="text-align:center; padding:12px 0; line-height:1.6;">
  ¬© 2025 $BAG Protocol | getthebag.io | Powered by $XRP
  <br>
  <a href="https://x.com/getthebag_io" target="_blank" rel="noopener" style="color:#e0c66f;text-decoration:none;font-weight:700;"> ùïè @getthebag_io</a> |
  <a href="https://t.me/getthebag_io" target="_blank" rel="noopener" style="color:#e0c66f;text-decoration:none;font-weight:700;">Telegram @getthebag_io</a>
</footer>

</body>
</html>
