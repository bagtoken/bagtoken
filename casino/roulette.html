<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>$BAG Roulette</title>

<link rel="preconnect" href="https://api.coingecko.com" crossorigin>
<script src="https://xaman.app/assets/cdn/xumm.min.js"></script>
<script>window.__BAG_FORCE_DEMO = false;</script>

<style>
  :root {
    --gold: #ffe175; --bg: #020703; --panel: #0b1b13; --panel2: #0d2217; --muted: #aeb7af; --fg: #f5f7f4;
    --green: #2fbf6b; --green-600: #249a55; --line: #173524; --shadow: rgba(0,0,0,.35);
    --lose: #e25b5b; --warn: #e8a85c;
    --roulette-red: #e25b5b; --roulette-black: #0a1e15; --roulette-green: #2fbf6b;
    --ball-r: 160px; --pocket-h: 26px; --marker-origin: 200px; --wheel-font: 14px;
  }
  * { box-sizing: border-box; }
  html, body { margin: 0; background: var(--bg); color: var(--fg); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; line-height: 1.55; -webkit-text-size-adjust: 100%; }
  body { touch-action: manipulation; }
  img { display: block; max-width: 100%; height: auto; }
  button, input { font-size: 16px; }

  .back-casino {
    position: fixed; top: 18px; left: 18px; z-index: 1000;
    background: linear-gradient(180deg, #ffe175 0%, #f5c94c 100%);
    color: #08130d; text-decoration: none; font-weight: 800; padding: 8px 14px; border-radius: 10px;
    box-shadow: 0 4px 0 #b08a19; transition: all .15s ease;
  }
  .back-casino:hover { filter: brightness(1.05); box-shadow: 0 4px 0 #b08a19, 0 14px 28px rgba(255,225,117,.22); }
  .back-casino:active { transform: translateY(1px); box-shadow: 0 3px 0 #9a7315; }
  @media (max-width: 640px) { .back-casino { font-size: .9rem; padding: 7px 12px; } }

  .game-header { text-align: center; padding: 36px 10px 14px; }
  .game-header img.hero-img { margin-bottom: 10px; filter: drop-shadow(0 10px 24px rgba(46,191,107,.18)); }
  .game-header h2 { font-size: clamp(1.6rem, 5vw, 2.2rem); margin: 6px 0 0; }
  @media (min-width: 900px) { .game-header img.hero-img { width: 34vw; max-width: 420px; margin-left: auto; margin-right: auto; } }

  .game-wrap { max-width: 1080px; margin: 0 auto; display: grid; grid-template-columns: 1.12fr .88fr; gap: 22px; }
  @media (max-width: 900px) { .game-wrap { grid-template-columns: 1fr; } }

  .panel { background: linear-gradient(180deg, var(--panel) 0%, var(--panel2) 100%); border: 1px solid var(--line); border-radius: 16px; box-shadow: 0 8px 24px var(--shadow); }
  .pad { padding: 16px; }

  .section-title { font-weight: 800; font-size: 1.2rem; margin: 0 0 12px; }
  .stack { display: grid; gap: 10px; }
  .choice { display: flex; gap: 10px; flex-wrap: wrap; }
  .chip { display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 999px; border: 1px solid #2b6a48; background: #0e2a1c; color: #e9efe9; font-weight: 800; }
  .chip input { accent-color: #2fbf6b; }
  .mono { font-variant-numeric: tabular-nums; }
  .micro { font-size: .85rem; color: #a8b5ab; }
  .muted { color: #cfd6cf; }
  .divider { height: 1px; background: #123221; margin: 10px 0; }
  .callout { margin-top: 12px; padding: 12px; border: 1px dashed #29543d; border-radius: 12px; background: #0c2418; color: #e4efe7; }

  #liveDot { margin-right: 6px; }
  .ok { color: #2fbf6b; }
  .warn { color: #e8a85c; }
  .err { color: #e25b5b; }

  .wheelBox { position: relative; aspect-ratio: 1; border-radius: 14px; background: radial-gradient(circle at 50% 45%, rgba(255,255,255,.08), transparent 55%); overflow: hidden; }
  .wood {
    position: absolute; inset: 6% 6% 6% 6%; border-radius: 50%;
    background: radial-gradient(circle at 50% 50%, rgba(255,255,255,.07), rgba(0,0,0,.35) 70%), conic-gradient(from 0deg, #744923, #5e3a1b 25%, #744923 50%, #5e3a1b 75%, #744923 100%);
    box-shadow: inset 0 0 0 12px #b8844f, inset 0 0 0 20px #8d5b2e;
  }
  .pockets { position: absolute; inset: 10% 10% 10% 10%; border-radius: 50%; transform: rotate(0deg); transition: transform 4.2s cubic-bezier(.15,.9,.15,1); }
  .pocket {
    position: absolute; left: 50%; top: 50%; transform-origin: 0% 0%; width: 46%; height: var(--pocket-h); margin-top: calc(var(--pocket-h) * -0.5);
    border-radius: 4px 999px 999px 4px; display: flex; align-items: center; justify-content: flex-end; padding-right: 10px;
    font-weight: 900; font-size: var(--wheel-font); color: #fff; border: 1px solid #0007; text-shadow: 0 1px 2px #000c; user-select: none;
  }
  .pocket.green { background: var(--roulette-green); }
  .pocket.red { background: var(--roulette-red); }
  .pocket.black { background: var(--roulette-black); }
  .spindle { position: absolute; inset: 27% 27% 27% 27%; border-radius: 50%; background: radial-gradient(circle at 50% 40%, #d2a253, #8b612d 70%); box-shadow: 0 8px 16px var(--shadow); }
  .ball {
    position: absolute; width: 18px; height: 18px; background: #eee; border-radius: 50%; box-shadow: 0 1px 4px #000a;
    left: 50%; top: 50%; margin: -9px; transform-origin: 0 0; transform: rotate(0deg) translate(var(--ball-r));
    transition: transform 4.2s cubic-bezier(.15,.9,.15,1);
  }
  .marker { position: absolute; left: 50%; top: 50%; width: 3px; height: 22px; background: #d2a253; transform-origin: 50% var(--marker-origin); border-radius: 2px; }

  .board { display: grid; gap: 6px; }
  .bar { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 8px; }
  .bet-chip {
    width: 40px; height: 40px; border-radius: 50%; border: 2px solid #d8b800; background: radial-gradient(circle, #ffe688, #ffd700);
    color: #1b1500; font-weight: 900; display: grid; place-items: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,.35);
  }
  .bet-chip.active { outline: 2px solid #fff; }
  .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
  @media (min-width: 760px) { .grid { grid-template-columns: repeat(5, 1fr); } }
  .cell {
    background: #0b1f16; border: 1px solid #1b3b2c; border-radius: 10px; padding: 8px; min-height: 46px;
    display: grid; place-items: center; font-weight: 800; cursor: pointer; user-select: none; position: relative;
  }
  .cell:hover { background: #0e2a1c; border-color: #2b6a48; }
  .cell[data-kind="n"].red { color: #ffb3b3; }
  .cell[data-kind="n"].black { color: #ddd; }
  .cell[data-kind="n"].green { color: #bff3c8; }
  .badge { position: absolute; bottom: 4px; right: 6px; background: #0e2a1c; border: 1px solid #204a32; border-radius: 6px; padding: 2px 6px; font-size: 11px; color: #ddefe5; }
  .legend { font-size: 12px; color: var(--muted); margin-top: 8px; }
  .toast {
    position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%); background: #0b1b13; border: 1px solid #173524; color: #e7efe9;
    padding: 8px 12px; border-radius: 10px; font-weight: 700; opacity: 0; pointer-events: none; transition: opacity .25s, transform .25s; z-index: 1000;
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(-4px); }
  .win { color: #2fbf6b; font-weight: 900; }
  .lose { color: #e25b5b; font-weight: 900; }

  .preset-chips { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
  .preset-chip {
    appearance: none; border: 1px solid var(--green-600); background: var(--green); color: #ffffff; border-radius: 999px;
    padding: 8px 12px; font-weight: 900; letter-spacing: .2px; cursor: pointer;
    box-shadow: 0 4px 10px rgba(47,191,107,.18), inset 0 1px 0 rgba(255,255,255,.12); transition: transform .06s ease, box-shadow .2s ease, filter .2s ease;
  }
  .preset-chip:hover { filter: brightness(1.03); }
  .preset-chip:active { transform: translateY(1px); box-shadow: 0 3px 8px rgba(47,191,107,.16), inset 0 1px 0 rgba(255,255,255,.1); }
  .preset-chip:focus-visible { outline: 2px solid #ffffff; outline-offset: 2px; }
  .preset-chip.active { box-shadow: 0 0 0 2px rgba(255,255,255,.25) inset, 0 8px 22px rgba(47,191,107,.25); }

  .btn {
    padding: 10px 14px; font-weight: 800; border: 0; border-radius: 12px; color: #08130d;
    background: linear-gradient(180deg, #ffe175 0%, #f5c94c 100%); box-shadow: 0 4px 0 #b08a19; cursor: pointer;
    transition: transform .06s ease, box-shadow .2s ease, filter .2s ease;
  }
  .btn:hover { filter: brightness(1.05); box-shadow: 0 4px 0 #b08a19, 0 14px 28px rgba(255,225,117,.22); }
  .btn:active { transform: translateY(1px); box-shadow: 0 3px 0 #9a7315; }
  .btn:disabled { opacity: .65; cursor: not-allowed; }
  .btn.alt { background: #15261c; color: #dfe9e2; border: 1px solid #2b6a48; box-shadow: 0 4px 0 #1b3b2c; }
  .btn.alt:hover { box-shadow: 0 4px 0 #1b3b2c, 0 14px 28px rgba(47,191,107,.18); }
  .btn.alt:active { box-shadow: 0 3px 0 #1b3b2c; }

  .pill {
    background: #0a1e15; border: 1px solid #244330; border-radius: 999px; padding: 6px 10px;
    font-size: 12px; color: #cfe6d8; font-weight: 600;
  }
  .pill b { font-weight: 800; }
  .hudbar { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; margin: 6px 0 10px; }
</style>
</head>
<body>
<a href="/casino/" class="back-casino" aria-label="Back to Casino">‚¨Ö Back to Casino</a>

<section class="game-header">
  <picture>
    <source type="image/webp" srcset="/assets/bag-roulette-960.webp 960w, /assets/bag-roulette-1024.webp 1024w" sizes="(min-width:900px) 420px, 70vw">
    <img class="hero-img" src="/assets/bag-roulette-960.png" srcset="/assets/bag-roulette-960.png 960w, /assets/bag-roulette-1024.png 1024w" sizes="(min-width:900px) 420px, 70vw" alt="$BAG Roulette" loading="lazy" decoding="async">
  </picture>
  <h2>üé∞ $BAG Roulette</h2>
  <p class="micro" style="margin-top:4px;opacity:.9;">üí∞ <strong>All payouts are in $BAG.</strong> $XRP bets convert automatically at the live rate.</p>
</section>

<section class="game-teaser" aria-labelledby="game-teaser-title">
  <div class="game-wrap">
    <div class="panel pad">
      <div id="connectRow" style="display:flex;justify-content:space-between;align-items:center;margin:-2px 0 10px 0;">
        <div id="connectStatus" class="micro" style="opacity:.9">Wallet: <span style="color:#e8a85c">not connected</span></div>
        <button id="connectBtn" class="btn">Connect Xaman</button>
      </div>

      <div id="sessionRow" style="display:flex;justify-content:space-between;align-items:center;margin:6px 0 10px 0;">
        <div id="sessionStatus" class="micro" style="opacity:.9">Session: <span style="color:#e8a85c">not started</span></div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="startSessionBtn" class="btn">Start Session</button>
          <button id="topUpBtn" class="btn" style="display:none;">Top Up</button>
          <button id="endSessionBtn" class="btn alt" style="display:none;">End</button>
        </div>
      </div>

      <div class="section-title">Stake & Prices</div>
      <div class="stack">
        <div>
          <div class="micro">Amount</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
            <div style="display:flex;align-items:center;gap:6px">
              <input id="usdBet" class="mono" type="number" inputmode="decimal" min="0" max="2000" step="0.01" placeholder="0.00" style="width:140px;background:#0b2217;border:1px solid #1b4a2f;border-radius:10px;color:#f3f5f0;padding:10px">
              <span class="micro unit">USD</span>
            </div>
          </div>
          <div class="preset-chips" id="usdPresets" role="group" aria-label="Quick bet">
            <button type="button" class="preset-chip" data-usd="1">$1</button>
            <button type="button" class="preset-chip" data-usd="2">$2</button>
            <button type="button" class="preset-chip" data-usd="5">$5</button>
            <button type="button" class="preset-chip" data-usd="10">$10</button>
            <button type="button" class="preset-chip" data-usd="20">$20</button>
            <button type="button" class="preset-chip" data-usd="50">$50</button>
            <button type="button" class="preset-chip" data-usd="100">$100</button>
            <button type="button" class="preset-chip" data-usd="max">Max</button>
          </div>
        </div>

        <div>
          <div class="micro">Bet currency</div>
          <div class="choice" id="curToggle" role="radiogroup" aria-label="Bet currency">
            <label class="chip"><input type="radio" name="betCur" value="XRP" checked> XRP</label>
            <label class="chip"><input type="radio" name="betCur" value="BAG"> BAG</label>
          </div>
        </div>

        <div>
          <div class="micro">Chip value</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
            <div>
              <input id="betQty" class="mono" type="number" inputmode="decimal" min="0" step="any" value="1" style="width:140px;background:#0b2217;border:1px solid #1b4a2f;border-radius:10px;color:#f3f5f0;padding:10px">
              <span class="unit">XRP</span>
            </div>
          </div>
          <div class="micro" id="betLimits" style="margin-top:6px"></div>
        </div>

        <div class="divider"></div>
        <div class="micro">Live prices</div>
        <div class="muted mono" id="liveLine">
          <span id="liveDot" class="warn">‚óè</span>
          <span> BAG $<span id="liveBAG">‚Äî</span> ¬∑ XRP $<span id="liveXRP">‚Äî</span> <span id="liveNote"></span></span>
          <div class="micro" id="liveConv" style="margin-top:4px;opacity:.9;">1 BAG ‚âà ‚Äî XRP ¬∑ 1 XRP ‚âà ‚Äî BAG</div>
        </div>

        <div class="divider"></div>
        <div class="micro">Balance (demo)</div>
        <div class="mono" id="balanceLbl">‚Äî BAG</div>
        <div class="callout mono">Straight pays <b>35:1</b> ¬∑ Dozen/Column pays <b>2:1</b> ¬∑ Red/Black, Even/Odd, Low/High pays <b>1:1</b></div>
      </div>
      <div class="hudbar" id="bottomHud" style="justify-content:center;">
        <span class="pill" id="modePill">Mode: <b>Demo</b></span>
        <span class="pill" id="balPill">Balance: <b id="balLbl">1000.00</b> <span id="ccyLbl">BAG</span></span>
        <span class="pill" id="betPill">Bet: <b>‚Äî</b></span>
        <span class="pill" id="lastPill">Last: <b>‚Äî</b></span>
      </div>
    </div>

    <div class="panel pad">
      <div class="wheelBox" id="wheel">
        <div class="wood"></div>
        <div id="ring" class="pockets" aria-label="Roulette wheel pockets"></div>
        <div class="spindle"></div>
        <div id="ball" class="ball" aria-hidden="true"></div>
        <div class="marker"></div>
      </div>
      <div class="controls" style="margin-top:12px">
        <button id="spin" class="btn">SPIN</button>
        <button id="undo" class="btn alt">UNDO</button>
        <button id="clear" class="btn alt">CLEAR</button>
        <div id="result" class="micro" role="status" aria-live="polite"></div>
      </div>
      <div class="stat">
        <div>Round <span id="round">0</span></div>
        <div>Last <span id="last">‚Äî</span></div>
        <div>Seed <span id="seed">‚Äî</span></div>
        <div>Total stake <span id="stakeTotal" class="money">0</span> <span id="stakeUnit">BAG</span></div>
      </div>
      <div class="board">
        <div class="bar">
          <strong>Chip</strong>
          <div id="chips" style="display:flex;gap:8px;flex-wrap:wrap">
            <div class="bet-chip" data-v="1">1</div>
            <div class="bet-chip" data-v="5">5</div>
            <div class="bet-chip active" data-v="10">10</div>
            <div class="bet-chip" data-v="25">25</div>
            <div class="bet-chip" data-v="100">100</div>
          </div>
        </div>
        <div class="grid" id="grid"></div>
        <div class="grid" id="outsides">
          <div class="cell" data-kind="rb" data-val="RED">RED</div>
          <div class="cell" data-kind="rb" data-val="BLACK">BLACK</div>
          <div class="cell" data-kind="eo" data-val="EVEN">EVEN</div>
          <div class="cell" data-kind="eo" data-val="ODD">ODD</div>
          <div class="cell" data-kind="hl" data-val="LOW">1‚Äì18</div>
          <div class="cell" data-kind="hl" data-val="HIGH">19‚Äì36</div>
          <div class="cell" data-kind="dozen" data-val="D1">1‚Äì12</div>
          <div class="cell" data-kind="dozen" data-val="D2">13‚Äì24</div>
          <div class="cell" data-kind="dozen" data-val="D3">25‚Äì36</div>
          <div class="cell" data-kind="col" data-val="C1">Column 1</div>
          <div class="cell" data-kind="col" data-val="C2">Column 2</div>
          <div class="cell" data-kind="col" data-val="C3">Column 3</div>
        </div>
        <div class="legend">Tap cells to add chips. UNDO removes the last chip. CLEAR wipes all bets.</div>
      </div>
      <div id="log" style="margin-top:10px;font:12px ui-monospace;color:var(--muted);max-height:100px;overflow:auto"></div>
    </div>
  </div>
</section>

<div id="toast" class="toast"></div>

<script src="/js/bag-session.js"></script>
<script src="/js/bag-overlay.js"></script>

<script>
/* Audio */
(function(){
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let AC=null, MASTER=null, primed=false, COMP=null;

  function getAC(){
    if (AC && AC.state!=='closed') return AC;
    if (!AudioCtx) return null;
    AC = new AudioCtx();
    MASTER = AC.createGain();
    MASTER.gain.value = .28;
    MASTER.connect(AC.destination);
    return AC;
  }
  async function resume(){ const ac=getAC(); if(!ac) return; if(ac.state==='suspended'){ try{ await ac.resume(); }catch{} } }

  function ensureFX(){
    const ac=getAC(); if(!ac) return null;
    if(!COMP){
      COMP=ac.createDynamicsCompressor();
      COMP.threshold.value=-26; COMP.knee.value=24; COMP.ratio.value=10;
      COMP.attack.value=0.002; COMP.release.value=0.22;
      COMP.connect(MASTER);
    }
    return COMP;
  }
  function outNode(){ return ensureFX() || MASTER; }

  function primeAll(){
    if(primed) return; primed=true;
    resume().catch(()=>{});
    primePools();
  }
  window.addEventListener('pointerdown', primeAll, {once:true,passive:true});
  window.addEventListener('wheel', primeAll, {once:true,passive:true});
  window.addEventListener('keydown', primeAll, {once:true,passive:true});
  window.addEventListener('touchmove', primeAll, {once:true,passive:true});
  window.addEventListener('touchstart', primeAll, {once:true,passive:true});
  window.addEventListener('mousemove', primeAll, {once:true,passive:true});
  window.addEventListener('scroll', primeAll, {once:true,passive:true});
  document.addEventListener('scroll', primeAll, {once:true,passive:true,capture:true});

  const SPIN_CANDS = ['/assets/sounds/roulette_spin.mp3'];
  const CHIP_CANDS = ['/assets/sounds/chip_click.mp3'];
  const LOSE_CANDS = ['/assets/sounds/lose_thud.mp3'];

  async function probeUrl(u){ try{ const r=await fetch(u,{method:'GET',cache:'force-cache'}); return r.ok; }catch{ return false; } }
  function mkPool(src, n=2){
    const a=[]; for(let i=0;i<n;i++){ const t=new Audio(src); t.preload='auto'; t.crossOrigin='anonymous'; t.setAttribute('playsinline',''); a.push(t); }
    let idx=0;
    return { play(){ const t=a[idx=(idx+1)%a.length]; try{ t.pause(); t.currentTime=0; t.play().catch(()=>{});}catch{} } };
  }
  let poolSpin=null, poolChip=null, poolLose=null;
  async function primePools(){
    for(const u of SPIN_CANDS){ if(await probeUrl(u)){ poolSpin = mkPool(u,2); break; } }
    for(const u of CHIP_CANDS){ if(await probeUrl(u)){ poolChip = mkPool(u,3); break; } }
    for(const u of LOSE_CANDS){ if(await probeUrl(u)){ poolLose = mkPool(u,2); break; } }
  }

  window.__playSpin = async function(){ try{ await resume(); }catch{} if (poolSpin) poolSpin.play(); };
  window.__playChip = async function(){ try{ await resume(); }catch{} if (poolChip) poolChip.play(); };
  window.__playLose = async function(){ try{ await resume(); }catch{} if (poolLose) poolLose.play(); };

  window.__bagAudio = {
    chime(){ const ac=getAC(); if(!ac||ac.state!=='running') return; const now=ac.currentTime;
      [880,1320,1760].forEach((f,i)=>{ const o=ac.createOscillator(); o.type='triangle'; o.frequency.value=f;
        const g=ac.createGain(); g.gain.setValueAtTime(.0001,now+i*.02); g.gain.linearRampToValueAtTime(.18,now+i*.02+.04); g.gain.exponentialRampToValueAtTime(.0001,now+i*.02+.32);
        o.connect(g).connect(MASTER); o.start(now+i*.02); o.stop(now+i*.02+.34); });
    },
    resume
  };
})();

/* Prices */
(function(){
  const PRICE_REFRESH_MS = 30000;
  const FETCH_TIMEOUT_MS = 8000;
  const LIVE_CACHE_TTL_MS = 24*60*60*1000;
  const VIEW_CACHE_TTL_MS = 6*60*60*1000;

  const BAG_ISSUER = 'rNeYbfb9EDV8c7mNfUuooEEYYzMcEuDFbr';
  const BAG_CODE = 'BAG';

  const VIEW_CACHE_KEY = 'bag_prices_v8';
  const LAST_LIVE_KEY = 'bag_last_live_v1';
  const XRP_KEY = 'xrp_usd';

  const PRICES = (window.__PRICES__ = { bagUsd:0, xrpUsd:0, source:'‚Äî', ts:0 });

  const liveDot = document.getElementById('liveDot');
  const liveBAG = document.getElementById('liveBAG');
  const liveXRP = document.getElementById('liveXRP');
  const liveNote = document.getElementById('liveNote');
  const liveConv = document.getElementById('liveConv');

  function fmt(n){ if (!Number.isFinite(n)) return '‚Äî'; return n.toLocaleString(undefined,{maximumFractionDigits:6}); }
  function cacheSet(k,v){ try{ localStorage.setItem(k, JSON.stringify({t:Date.now(), v})); }catch{} }
  function cacheGet(k, ttlMs){ try{ const o=JSON.parse(localStorage.getItem(k)||'null'); if(!o) return null; const age=Date.now()-(o.t||0); return age<=ttlMs?o.v:null; }catch{ return null; } }
  function timedFetch(url, opts={}, timeout=FETCH_TIMEOUT_MS){
    const ctrl=new AbortController(); const id=setTimeout(()=>ctrl.abort(new Error('timeout')),timeout);
    try{
      const u=new URL(url, location.origin); u.searchParams.set('_ts', Date.now().toString());
      return fetch(u.toString(), { ...opts, headers:{Accept:'application/json',...(opts.headers||{})}, mode:'cors', cache:'no-store', credentials:'omit', referrerPolicy:'no-referrer', signal:ctrl.signal });
    } finally { setTimeout(()=>clearTimeout(id),0); }
  }
  function updateLiveLine(){
    if (liveBAG) liveBAG.textContent = fmt(PRICES.bagUsd);
    if (liveXRP) liveXRP.textContent = Number.isFinite(PRICES.xrpUsd)? PRICES.xrpUsd.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) : '‚Äî';
    if (liveDot) liveDot.className = (PRICES.source==='live-amm' ? 'ok' : PRICES.source==='last-live' ? 'warn' : 'err');
    if (liveNote) liveNote.textContent = (PRICES.source==='live-amm' ? ' (AMM live)' : PRICES.source==='last-live' ? ' (last live)' : ' (unavailable)');
    if (liveConv){
      if(PRICES.bagUsd>0 && PRICES.xrpUsd>0){
        const xrpPerBag=PRICES.bagUsd/PRICES.xrpUsd, bagPerXrp=PRICES.xrpUsd/PRICES.bagUsd;
        liveConv.textContent=`1 BAG ‚âà ${xrpPerBag.toLocaleString(undefined,{maximumFractionDigits:6})} XRP ¬∑ 1 XRP ‚âà ${bagPerXrp.toLocaleString(undefined,{maximumFractionDigits:6})} BAG`;
      } else { liveConv.textContent='1 BAG ‚âà ‚Äî XRP ¬∑ 1 XRP ‚âà ‚Äî BAG'; }
    }
    window.dispatchEvent(new CustomEvent('bag:pricesUpdated'));
  }
  async function fetchXrpUsdLive(){
    try{ const r=await timedFetch('https://api.coingecko.com/api/v3/simple/price?ids=ripple&vs_currencies=usd'); if(!r.ok) throw 0;
      const v=(await r.json())?.ripple?.usd; if(Number(v)>0){ PRICES.xrpUsd=Number(v); cacheSet(XRP_KEY, PRICES.xrpUsd); return true; } }catch(_){}
    return false;
  }
  function parseXrpAmount(a){ if (a==null) return null; if (typeof a==='string') return Number(a)/1_000_000; if (typeof a==='object' && a.currency==='XRP') return Number(a.value); return null; }
  function parseIouAmount(a){ if (!a || typeof a!=='object') return null; return Number(a.value); }
  async function fetchBagViaAMMLive(){
    const req={ id:1, command:'amm_info', asset:{currency:BAG_CODE,issuer:BAG_ISSUER}, asset2:{currency:'XRP'} };
    const xrpPerBag=await new Promise(resolve=>{
      const ws=new WebSocket('wss://s1.ripple.com'); const t=setTimeout(()=>{ try{ws.close();}catch{}; resolve(null); },8000);
      ws.onopen=()=>ws.send(JSON.stringify(req));
      ws.onerror=()=>{ clearTimeout(t); try{ws.close();}catch{}; resolve(null); };
      ws.onmessage=(ev)=>{ try{ const msg=JSON.parse(ev.data); if(msg.id!==1||!msg.result||!msg.result.amm) return;
        clearTimeout(t); try{ws.close();}catch{};
        const amm=msg.result.amm; const bagBal=parseIouAmount(amm.amount); const xrpBal=parseXrpAmount(amm.amount2);
        if(!(bagBal>0)||!(xrpBal>0)) return resolve(null);
        const price=xrpBal/bagBal; if(!(price>0)||!isFinite(price)) return resolve(null); resolve(price);
      }catch{ resolve(null); } };
    });
    if(!(xrpPerBag>0)) return false; if(!(PRICES.xrpUsd>0)) return false;
    PRICES.bagUsd = PRICES.xrpUsd * xrpPerBag; PRICES.source='live-amm';
    cacheSet(LAST_LIVE_KEY,{ bagUsd:PRICES.bagUsd, xrpUsd:PRICES.xrpUsd }); cacheSet(VIEW_CACHE_KEY,{ bagUsd:PRICES.bagUsd, xrpUsd:PRICES.xrpUsd });
    return true;
  }
  function loadLastLiveBundle(){ const v=cacheGet(LAST_LIVE_KEY, LIVE_CACHE_TTL_MS); if(v&&Number(v.bagUsd)>0){ PRICES.bagUsd=Number(v.bagUsd); if(Number(v.xrpUsd)>0) PRICES.xrpUsd=Number(v.xrpUsd); PRICES.source='last-live'; return true; } return false; }
  function loadViewCache(){ const v=cacheGet(VIEW_CACHE_KEY, VIEW_CACHE_TTL_MS); const x=cacheGet(XRP_KEY, VIEW_CACHE_TTL_MS); let ok=false;
    if(v&&Number(v.bagUsd)>0){ PRICES.bagUsd=Number(v.bagUsd); if(Number(v.xrpUsd)>0) PRICES.xrpUsd=Number(v.xrpUsd); ok=true; }
    if(!PRICES.xrpUsd && Number(x)>0){ PRICES.xrpUsd=Number(x); ok=true; }
    if(ok && PRICES.source==='‚Äî') PRICES.source='last-live'; return ok;
  }
  async function refreshPrices(){ const gotX=await fetchXrpUsdLive(); const gotB=await fetchBagViaAMMLive(); if(!(gotX&&gotB)){ if(!loadLastLiveBundle()) loadViewCache(); } updateLiveLine(); }
  (async ()=>{ await refreshPrices(); setInterval(refreshPrices, PRICE_REFRESH_MS); })();
  addEventListener('storage', (e)=>{ if([VIEW_CACHE_KEY,XRP_KEY,LAST_LIVE_KEY].includes(e.key)){ if(!loadLastLiveBundle()) loadViewCache(); updateLiveLine(); } });
})();

/* USD Autofill and Presets */
(function(){
  const usdBetEl = document.getElementById('usdBet');
  const betQtyEl = document.getElementById('betQty');
  const curToggle = document.getElementById('curToggle');
  const unitSpans = document.querySelectorAll('.unit');
  const betLimits = document.getElementById('betLimits');
  const presets = document.getElementById('usdPresets');

  const MIN_USD = 1, MAX_USD = 2000;

  function currentCurrency(){ const el=curToggle?.querySelector('input[name="betCur"]:checked'); return el?String(el.value).toUpperCase():'XRP'; }
  function priceForCurrent(){ const {bagUsd,xrpUsd}=window.__PRICES__||{}; return currentCurrency()==='BAG'?bagUsd:xrpUsd; }
  function qty(){ const v=parseFloat(betQtyEl?.value||''); return Number.isFinite(v)&&v>0?v:1; }
  function derivedUsd(){ const px=priceForCurrent(); const q=qty(); return px>0?q*px:0; }
  function usd(n){ return '$'+(Number(n)||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }

  function clearPresetActive(){ try{ presets?.querySelectorAll('.preset-chip.active').forEach(b=>b.classList.remove('active')); }catch{} }

  function setFromUsd(value){
    const u=Math.max(0, Math.min(MAX_USD, Number(value)||0));
    if (usdBetEl){ usdBetEl.value=u?u.toFixed(2):''; usdBetEl.dataset.userTyped = u?'1':'0'; }
    const px=priceForCurrent();
    if (betQtyEl){ betQtyEl.value = (px>0 && u>0) ? (Math.floor((u/px)*1e6)/1e6) : ''; }
    renderLimits();
    updateChipValue();
    window.dispatchEvent(new CustomEvent('bag:hudRefresh'));
  }

  function autoFillUsd(){
    if(!usdBetEl) return;
    if(usdBetEl.dataset.userTyped==='1') return;
    const v=derivedUsd();
    if(v>0){ usdBetEl.value=(Math.round(v*100)/100).toFixed(2); usdBetEl.dataset.autofill='1'; }
    else { usdBetEl.value=''; usdBetEl.dataset.autofill='0'; }
  }

  function renderLimits(){
    const direct = parseFloat(usdBetEl?.value||'');
    const uv = Number.isFinite(direct)&&direct>0 ? direct : derivedUsd();
    const warn = (uv>0 && uv<MIN_USD) ? ` ¬∑ <span style="color:#e8a85c">Min $${MIN_USD.toFixed(2)}</span>` :
                 (uv>MAX_USD) ? ` ¬∑ <span style="color:#e8a85c">Max $${MAX_USD.toFixed(2)}</span>` : '';
    if (betLimits) betLimits.innerHTML = `Limits: $${MIN_USD.toFixed(2)}‚Äì$${MAX_USD.toFixed(2)} ¬∑ Your stake ‚âà ${usd(uv)}${warn}`;
  }

  function updateChipValue(){
    const v = parseFloat(betQtyEl?.value||'0');
    chip = Number.isFinite(v) && v > 0 ? Math.floor(v) : 1;
    document.querySelectorAll('#chips .bet-chip').forEach(el => {
      el.classList.toggle('active', Number(el.dataset.v) === chip);
    });
  }

  usdBetEl?.addEventListener('input', ()=>{ clearPresetActive(); usdBetEl.dataset.userTyped = (usdBetEl.value && usdBetEl.value.length) ? '1' : '0'; renderLimits(); });
  betQtyEl?.addEventListener('input', ()=>{ clearPresetActive(); autoFillUsd(); renderLimits(); updateChipValue(); });
  curToggle?.addEventListener('change', ()=>{ unitSpans.forEach(s=>s.textContent=currentCurrency()); if(usdBetEl?.dataset.userTyped==='1'){ setFromUsd(parseFloat(usdBetEl.value)||0); } else { autoFillUsd(); renderLimits(); } updateChipValue(); });
  addEventListener('bag:pricesUpdated', ()=>{ if(usdBetEl?.dataset.userTyped==='1'){ setFromUsd(parseFloat(usdBetEl.value)||0); } else { autoFillUsd(); renderLimits(); } });

  unitSpans.forEach(s=>s.textContent=currentCurrency());
  autoFillUsd(); renderLimits();
})();

/* Demo Mode */
(function(){
  const qs = new URLSearchParams(location.search);
  const forceLive = qs.get('live') === '1';

  const statusEl = document.getElementById('sessionStatus');
  const startBtn = document.getElementById('startSessionBtn');
  const topUpBtn = document.getElementById('topUpBtn');
  const endBtn = document.getElementById('endSessionBtn');
  const connectEl = document.getElementById('connectBtn');

  const DEMO_KEY = '__bag_demo_roulette_v1';
  const START_BAG = 1000;

  function getBal(){ try{ const n=Number(localStorage.getItem(DEMO_KEY)); return Number.isFinite(n)&&n>0?n:START_BAG; }catch{ return START_BAG; } }
  function setBal(v){ try{ localStorage.setItem(DEMO_KEY, String(Math.max(0, Number(v)))); }catch{} }
  if(localStorage.getItem(DEMO_KEY)==null) setBal(START_BAG);

  function fmt(n){
    if(!Number.isFinite(n)) return '‚Äî';
    if(Math.abs(n)>=1) return n.toLocaleString(undefined,{maximumFractionDigits:4});
    if(Math.abs(n)>=1e-2) return n.toLocaleString(undefined,{maximumFractionDigits:6});
    if(Math.abs(n)>=1e-4) return n.toLocaleString(undefined,{maximumFractionDigits:8});
    return n.toLocaleString(undefined,{maximumFractionDigits:10});
  }
  function fmtUsd(n){ return '$'+(Number(n)||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }

  function renderDemo(){
    const bag=getBal();
    const bagUsd=(window.__PRICES__?.bagUsd||0)*bag;
    if(statusEl){
      statusEl.innerHTML='Practice: <span style="color:#2fbf6b">'+fmt(bag)+' BAG</span>' +
        (bagUsd?` <span class="micro" style="opacity:.75">(${fmtUsd(bagUsd)})</span>`:'');
    }
    if(startBtn) startBtn.style.display='inline-block';
    if(topUpBtn) topUpBtn.style.display='none';
    if(endBtn) endBtn.style.display='none';
    if(connectEl) connectEl.style.opacity='0.9';
  }

  const demoSession={
    active:()=>true,
    get:()=>({addr:'demo',bag:getBal(),ts:Date.now()}),
    spend(bag){ const b=getBal(); if(!(bag>0)||b<bag) return false; setBal(b-bag); try{ window.refreshBal && window.refreshBal(); }catch{} return true; },
    credit(bag){ if(!(bag>0)) return false; setBal(getBal()+bag); try{ window.refreshBal && window.refreshBal(); }catch{} return true; }
  };

  function enableDemo(){
    try{ Object.defineProperty(window,'__BAG_FORCE_DEMO',{value:true, configurable:true}); }catch{ window.__BAG_FORCE_DEMO=true; }
    window.__bagSession = demoSession;
    renderDemo();
  }
  function enableLive(){ window.__BAG_FORCE_DEMO=false; window.dispatchEvent(new CustomEvent('bag:pricesUpdated')); }

  if (forceLive) enableLive(); else enableDemo();
  addEventListener('bag:pricesUpdated', ()=>{ if(window.__BAG_FORCE_DEMO) renderDemo(); });

  window.refreshBal = function(){
    const balLbl=document.getElementById('balanceLbl');
    if(!balLbl) return;
    const bag=getBal();
    balLbl.textContent = bag.toLocaleString(undefined,{maximumFractionDigits:6});
  };

  window.getDemoBal = getBal;
  window.setDemoBal = setBal;
})();

/* HUD Updater */
(function(){
  const curToggle = document.getElementById('curToggle');
  const balLbl = document.getElementById('balLbl');
  const ccyLbl = document.getElementById('ccyLbl');
  const betPill = document.getElementById('betPill').querySelector('b');
  const modePill = document.getElementById('modePill').querySelector('b');
  const lastPill = document.getElementById('lastPill').querySelector('b');

  function PR(){ return window.__PRICES__ || { bagUsd:0, xrpUsd:0 }; }
  function fmt(n, max=6){ const x=Number(n); if(!Number.isFinite(x)) return '‚Äî'; return x.toLocaleString(undefined,{maximumFractionDigits:max}); }
  function selectedMode(){ return (window.__BAG_FORCE_DEMO === true) ? 'Demo' : 'Live'; }
  function currentCurrency(){ const el=curToggle?.querySelector('input[name="betCur"]:checked'); return el?String(el.value).toUpperCase():'XRP'; }

  function getBalances(){
    const sess = (window.__bagSession && window.__bagSession.get && window.__bagSession.get()) || {};
    const bag = Number(sess.bag) || 0;
    let xrp = Number(sess.xrp);
    if (!(xrp > 0)){
      const { bagUsd, xrpUsd } = PR();
      if (bagUsd > 0 && xrpUsd > 0) xrp = bag * (bagUsd / xrpUsd);
      else xrp = 0;
    }
    return { bag, xrp };
  }

  function renderHud(){
    try{
      if(modePill) modePill.textContent = selectedMode();
      if(betPill) betPill.textContent = fmt(totalStake());
      if(lastPill) lastPill.textContent = String(window.__ROULETTE_LAST__ || '‚Äî');
      const ccy = currentCurrency();
      const { bag, xrp } = getBalances();
      if (ccy === 'XRP'){
        if(balLbl) balLbl.textContent = fmt(xrp, 6);
        if(ccyLbl) ccyLbl.textContent = 'XRP';
      } else {
        if(balLbl) balLbl.textContent = fmt(bag, 6);
        if(ccyLbl) ccyLbl.textContent = 'BAG';
      }
    }catch(e){}
  }

  ['bag:sessionStarted','bag:sessionToppedUp','bag:sessionEnded','bag:pricesUpdated','bag:walletConnected','bag:walletDisconnected','bag:hudRefresh']
    .forEach(ev => addEventListener(ev, renderHud));
  addEventListener('storage', (e)=>{ if (e && e.key === '__bag_demo_roulette_v1') renderHud(); });

  renderHud();
  let tries = 0;
  const iv = setInterval(()=>{ renderHud(); if(++tries>40) clearInterval(iv); }, 500);
})();

/* Wheel Geometry */
(function(){
  const WHEEL = ["00",27,10,25,29,12,8,19,31,18,6,21,33,16,4,23,35,14,2,0,28,9,26,30,11,7,20,32,17,5,22,34,15,3,24,36,13,1];
  const COLOR = {};
  ["00",0].forEach(n=>COLOR[n]="green");
  [1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36].forEach(n=>COLOR[n]="red");
  [2,4,6,8,10,11,13,15,17,20,22,24,26,28,29,31,33,35].forEach(n=>COLOR[n]="black");
  const COLUMN = {};
  [1,4,7,10,13,16,19,22,25,28,31,34].forEach(n=>COLUMN[n]="C1");
  [2,5,8,11,14,17,20,23,26,29,32,35].forEach(n=>COLUMN[n]="C2");
  [3,6,9,12,15,18,21,24,27,30,33,36].forEach(n=>COLUMN[n]="C3");

  const ring = document.getElementById('ring');
  const DEG = 360 / WHEEL.length;
  WHEEL.forEach((val,i)=>{
    const el=document.createElement('div');
    el.className = 'pocket ' + (COLOR[val]||'black');
    el.style.transform = `rotate(${i*DEG}deg) translate(-2%, -50%)`;
    el.textContent = String(val);
    ring.appendChild(el);
  });

  const wheelBox = document.getElementById('wheel');
  const ballEl = document.getElementById('ball');
  function sizeWheel(){
    const r=wheelBox.getBoundingClientRect();
    const size=Math.min(r.width,r.height);
    const ballR = size*0.39;
    const pocketH = Math.max(20, Math.round(size*0.04));
    const markerOrigin = Math.round(size*0.40);
    const font = Math.max(10, Math.round(size*0.028));
    wheelBox.style.setProperty('--ball-r', ballR+'px');
    wheelBox.style.setProperty('--pocket-h', pocketH+'px');
    wheelBox.style.setProperty('--marker-origin', markerOrigin+'px');
    wheelBox.style.setProperty('--wheel-font', font+'px');
  }
  addEventListener('resize', sizeWheel, {passive:true}); sizeWheel();

  const grid = document.getElementById('grid');
  const NUMBERS = ["00",0, ...Array.from({length:36},(_,i)=>i+1)];
  NUMBERS.forEach(n=>{
    const c=document.createElement('div');
    c.className='cell';
    c.dataset.kind='n';
    c.dataset.val=String(n);
    const color=COLOR[n]||'black';
    c.classList.add(color);
    c.textContent=String(n);
    grid.appendChild(c);
  });

  window.WHEEL = WHEEL;
  window.COLOR = COLOR;
  window.COLUMN = COLUMN;
})();

/* Betting Logic */
(function(){
  const $ = id => document.getElementById(id);
  const chips = $('chips').querySelectorAll('.bet-chip');
  let chip=10;
  chips.forEach(el=>{
    el.addEventListener('click', ()=>{
      chips.forEach(x=>x.classList.remove('active'));
      el.classList.add('active'); chip=Number(el.dataset.v)||1;
      try{ window.__playChip && window.__playChip(); }catch{}
    });
  });

  const bets = { n: {}, rb: {}, eo: {}, hl: {}, dozen: {}, col: {} };
  const undoStack=[];

  function stakeUsdEq(){
    const qty = chip;
    const P = window.__PRICES__ || {};
    const cur = document.querySelector('#curToggle input[name="betCur"]:checked')?.value.toUpperCase() || 'XRP';
    if (cur === 'BAG') return P.bagUsd > 0 ? qty * P.bagUsd : 0;
    return P.xrpUsd > 0 ? qty * P.xrpUsd : 0;
  }
  function stakeBag(){
    const qty = chip;
    const { bagUsd, xrpUsd } = window.__PRICES__ || {};
    const cur = document.querySelector('#curToggle input[name="betCur"]:checked')?.value.toUpperCase() || 'XRP';
    return cur === 'BAG' ? qty : (bagUsd > 0 && xrpUsd > 0 ? qty * (xrpUsd / bagUsd) : 0);
  }

  function bumpBet(kind, key, amt){
    const b = bets[kind];
    const nxt = (Number(b[key])||0) + amt;
    b[key] = nxt;
    undoStack.push({kind,key,amt});
    paintCell(kind,key);
    renderBetTotal();
    $('betPill').querySelector('b').textContent = fmt(totalStake());
    try{ window.__playChip && window.__playChip(); }catch{}
  }
  function paintCell(kind,key){
    const sel = kind==='n' ? `.cell[data-kind="n"][data-val="${key}"]` : `.cell[data-kind="${kind}"][data-val="${key}"]`;
    const el = document.querySelector(sel);
    if(!el) return;
    el.querySelector('.badge')?.remove();
    const v = bets[kind][key];
    if(v>0){
      const bd=document.createElement('div'); bd.className='badge'; bd.textContent=v;
      el.appendChild(bd);
    }
  }
  function clearAllBets(){
    Object.keys(bets).forEach(k=>{ Object.keys(bets[k]).forEach(key=>bets[k][key]=0); });
    undoStack.length=0;
    document.querySelectorAll('.badge').forEach(b=>b.remove());
    renderBetTotal();
    $('betPill').querySelector('b').textContent = '‚Äî';
  }
  function undoLast(){
    const last=undoStack.pop(); if(!last) return;
    const cur = Number(bets[last.kind][last.key])||0;
    bets[last.kind][last.key] = Math.max(0, cur - last.amt);
    paintCell(last.kind,last.key);
    renderBetTotal();
    $('betPill').querySelector('b').textContent = fmt(totalStake());
  }
  function totalStake(){
    let t=0;
    Object.values(bets.n).forEach(v=>t+=v||0);
    ['rb','eo','hl','dozen','col'].forEach(k=>Object.values(bets[k]).forEach(v=>t+=v||0));
    return t;
  }
  function renderBetTotal(){
    $('stakeTotal').textContent = fmt(totalStake());
    $('stakeUnit').textContent = document.querySelector('#curToggle input[name="betCur"]:checked')?.value.toUpperCase() || 'XRP';
  }

  $('grid').addEventListener('click', (e)=>{
    const el=e.target.closest('.cell'); if(!el) return;
    const key=el.dataset.val;
    bumpBet('n', key, chip);
  });
  $('outsides').addEventListener('click', (e)=>{
    const el=e.target.closest('.cell'); if(!el) return;
    const kind=el.dataset.kind, key=el.dataset.val;
    bumpBet(kind, key, chip);
  });
  $('clear').addEventListener('click', clearAllBets);
  $('undo').addEventListener('click', undoLast);

  window.bets = bets;
  window.undoStack = undoStack;
  window.chip = () => chip;
})();

/* Game Logic */
(function(){
  const $ = id => document.getElementById(id);
  const toastEl=$('toast');
  function toast(t){ toastEl.textContent=t; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'),1400); }

  let spinning=false, round=0;
  function randUint32(){ const a=new Uint32Array(1); crypto.getRandomValues(a); return a[0]>>>0; }
  function pickIndex(){
    const n=window.WHEEL.length;
    const zone=Math.floor(0x100000000/n)*n;
    let x; do{ x=randUint32(); }while(x>=zone);
    return x % n;
  }

  function computeWin(hit){
    let win=0, notes=[], maxMult=0;
    Object.entries(window.bets.n).forEach(([k,v])=>{
      if(v>0 && String(hit)===k){ win += v*35; notes.push(`Straight(${k}) +35x`); maxMult=Math.max(maxMult,35); }
    });
    Object.entries(window.bets.rb).forEach(([k,v])=>{
      if(v>0 && window.COLOR[hit] && window.COLOR[hit].toUpperCase()===k){ win += v*1; notes.push('RB +1x'); maxMult=Math.max(maxMult,1); }
    });
    Object.entries(window.bets.eo).forEach(([k,v])=>{
      if(v>0 && typeof hit==="number" && hit!==0){
        if((k==='EVEN' && hit%2===0) || (k==='ODD' && hit%2===1)){ win += v*1; notes.push('EO +1x'); maxMult=Math.max(maxMult,1); }
      }
    });
    Object.entries(window.bets.hl).forEach(([k,v])=>{
      if(v>0 && typeof hit==="number" && hit!==0){
        if((k==='LOW' && hit>=1 && hit<=18) || (k==='HIGH' && hit>=19 && hit<=36)){ win += v*1; notes.push('HL +1x'); maxMult=Math.max(maxMult,1); }
      }
    });
    Object.entries(window.bets.dozen).forEach(([k,v])=>{
      if(v>0 && typeof hit==="number" && hit!==0){
        const ok = (k==='D1'&&hit>=1&&hit<=12)||(k==='D2'&&hit>=13&&hit<=24)||(k==='D3'&&hit>=25&&hit<=36);
        if(ok){ win += v*2; notes.push('Dozen +2x'); maxMult=Math.max(maxMult,2); }
      }
    });
    Object.entries(window.bets.col).forEach(([k,v])=>{
      if(v>0 && window.COLUMN[hit]===k){ win += v*2; notes.push('Column +2x'); maxMult=Math.max(maxMult,2); }
    });
    return {win, notes, maxMult};
  }

  function fmt(n, max=6){ const x=Number(n); if(!Number.isFinite(x)) return '‚Äî'; return x.toLocaleString(undefined,{maximumFractionDigits:max}); }
  function fmtUsd(n){ return '$'+(Number(n)||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }
  function currentCurrency(){ const el=document.querySelector('#curToggle input[name="betCur"]:checked'); return el?String(el.value).toUpperCase():'XRP'; }
  function PR(){ return window.__PRICES__ || { bagUsd:0, xrpUsd:0 }; }
  function winSubtext(win, cost){
    const gain = win - cost;
    const fromUsd = cost * (currentCurrency() === 'BAG' ? (PR().bagUsd || 0) : (PR().xrpUsd || 0));
    const toUsd = win * (currentCurrency() === 'BAG' ? (PR().bagUsd || 0) : (PR().xrpUsd || 0));
    return `+${fmt(gain)} ${currentCurrency()} ¬∑ ${fmtUsd(fromUsd)} ‚Üí ${fmtUsd(toUsd)}`;
  }

  $('spin').addEventListener('click', async ()=>{
    if(spinning) return;
    const cost = totalStake();
    if(!(cost>0)){ toast('Place a bet first'); return; }

    const MIN_USD = 1, MAX_USD = 2000;
    const costBag = stakeBag();
    const costUsd = stakeUsdEq();
    if (!window.__BAG_FORCE_DEMO){
      if (!window.__bagSession || !window.__bagSession.active || !window.__bagSession.active()) return toast('Start a session at The Cage');
      if (costUsd < MIN_USD) return toast(`Minimum $${MIN_USD.toFixed(2)} stake`);
      if (costUsd > MAX_USD) return toast(`Maximum $${MAX_USD.toFixed(2)} stake`);
      if (!(costBag>0)) return toast('Enter a stake first');
      if (!window.__bagSession.spend(costBag)) return toast('Insufficient balance');
    } else {
      const bal=window.getDemoBal(); if(bal<costBag){ toast('Insufficient balance'); return; }
      window.setDemoBal(bal-costBag);
    }
    window.__ROULETTE_LAST_STAKE_BAG__ = costBag;
    window.__ROULETTE_LAST_STAKE_USD__ = costUsd;

    spinning=true; round++;
    $('round').textContent=String(round);
    $('seed').textContent='rng';
    try{ window.__playSpin && window.__playSpin(); }catch{}

    const idx=pickIndex();
    const hit=window.WHEEL[idx];

    const revs=6;
    const DEG = 360 / window.WHEEL.length;
    const targetDeg=360*revs + (360 - idx*DEG);
    const ring=$('ring');
    const ballEl=$('ball');
    ring.style.transition='transform 4.2s cubic-bezier(.15,.9,.15,1)';
    ring.style.transform=`rotate(${targetDeg}deg)`;
    ballEl.style.transition='transform 4.2s cubic-bezier(.15,.9,.15,1)';
    ballEl.style.transform=`rotate(${-(targetDeg+720)}deg) translate(var(--ball-r))`;

    setTimeout(()=>{
      $('last').textContent=String(hit);
      const {win,notes,maxMult} = computeWin(hit);
      const gain = win - cost;
      const resEl = $('result');
      const ccy = currentCurrency();
      if(gain>=0){
        resEl.innerHTML = `<span class="win">WIN +${fmt(gain)} ${ccy}</span> on ${String(hit)} ${notes.length?'¬∑ '+notes.join(' ¬∑ '):''}`;
        window.__ROULETTE_LAST__ = 'WIN';
        try{
          window.BAGOverlay.showWin({
            message: maxMult>=35 ? 'STRAIGHT WIN!' : 'WIN',
            subtext: winSubtext(win, cost),
            duration: maxMult>=35 ? 5600 : 4200,
            sound: true,
            showImage: true
          });
          window.__bagAudio.chime();
        }catch{}
      }else{
        resEl.innerHTML = `<span class="lose">LOSS ${fmt(gain)} ${ccy}</span> on ${String(hit)}`;
        window.__ROULETTE_LAST__ = 'LOSE';
        try{ window.__playLose && window.__playLose(); }catch{}
      }
      $('lastPill').querySelector('b').textContent = window.__ROULETTE_LAST__;

      let winBag = win;
      if(ccy==='XRP'){ winBag = win * (PR().xrpUsd>0 && PR().bagUsd>0 ? (PR().xrpUsd/PR().bagUsd) : 0); }
      if(!window.__BAG_FORCE_DEMO){
        try{ if(winBag>0 && window.__bagSession.credit) window.__bagSession.credit(winBag); }catch{}
      }else{
        if(winBag>0) window.setDemoBal(window.getDemoBal()+winBag);
      }
      window.refreshBal && window.refreshBal();
      window.dispatchEvent(new CustomEvent('bag:hudRefresh'));

      log(`#${round} ¬∑ Hit ${String(hit)} ¬∑ Cost ${fmt(cost)} ${ccy} ¬∑ Win ${fmt(win)} ${ccy} ¬∑ Net ${fmt(gain)} ${ccy}`);
      spinning=false;
    }, 4300);
  });

  function log(s){ const el=$('log'); el.textContent = s + "\n" + el.textContent; }
})();

/* Disable Zoom */
document.addEventListener('gesturestart', (e)=>{ e.preventDefault(); }, {passive:false});
document.addEventListener('dblclick', (e)=>{ e.preventDefault(); }, {capture:true});
window.addEventListener('wheel', (e)=>{ if(e.ctrlKey){ e.preventDefault(); } }, {passive:false});

/* Service Worker */
if('serviceWorker' in navigator){ navigator.serviceWorker.register('/service-worker.js').catch(()=>{}); }
</script>

<footer class="footer" style="text-align:center;padding:12px 0;line-height:1.6;">
  ¬© 2025 $BAG Protocol | getthebag.io | Powered by $XRP
  <br>
  <a href="https://x.com/getthebag_io" target="_blank" rel="noopener" style="color:#e0c66f;text-decoration:none;font-weight:700;">ùïè @getthebag_io</a>
  &nbsp;|&nbsp;
  <a href="https://t.me/getthebag_io" target="_blank" rel="noopener" style="color:#e0c66f;text-decoration:none;font-weight:700;">Telegram @getthebag_io</a>
  &nbsp;|&nbsp;
  <a href="https://getthebag.io/support" target="_blank" rel="noopener" style="color:#e0c66f;text-decoration:none;font-weight:700;">Support</a>
  &nbsp;|&nbsp;
  <a href="https://getthebag.io/terms" target="_blank" rel="noopener" style="color:#e0c66f;text-decoration:none;font-weight:700;">Terms</a>
  &nbsp;|&nbsp;
  <a href="https://getthebag.io/privacy" target="_blank" rel="noopener" style="color:#e0c66f;text-decoration:none;font-weight:700;">Privacy</a>
</footer>
</body>
</html>
