<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>$BAG Blackjack</title>

<link rel="preconnect" href="https://xaman.app" crossorigin>

<style>
  *{box-sizing:border-box}
  :root{
    --gold:#ffd700;--bg:#020703;--panel:#0b1b13;--panel2:#0d2217;--muted:#aeb7af;--fg:#f5f7f4;
    --green:#2fbf6b;--green2:#34c759;--line:#173524;--shadow:rgba(0,0,0,.35);--red:#e25b5b;
    /* Responsive card sizing */
    --card-w: clamp(48px, 14vw, 76px);
    --card-h: calc(var(--card-w) * 1.42);
    --card-radius: 10px;
    --pip-size: clamp(20px, 5vw, 28px);
    --corner-size: clamp(11px, 3.2vw, 13px);
  }
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  header{display:flex;align-items:center;gap:14px;margin:6px 0 12px;flex-wrap:wrap}
  header img{height:40px;width:auto}
  .tag{font-size:12px;border:1px solid var(--line);padding:2px 8px;border-radius:999px;color:var(--muted);background:#08120c}
  .tag.gold{color:#1b1500;background:linear-gradient(#ffe688,#ffd700);border-color:#d8b800}
  .tag.demo{color:#16301f;background:#0a2215;border-color:#1c4729}

  .hud{display:flex;flex-wrap:wrap;gap:10px;margin:8px 0 16px}
  .hud .panel{background:var(--panel);border:1px solid #0f2b1e;border-radius:12px;box-shadow:0 8px 20px var(--shadow);padding:10px 14px;display:flex;align-items:center;gap:10px}
  .hud .panel strong{color:var(--gold)}
  .hud .mode{background:#0a1e15;border:1px solid #244330;border-radius:999px;color:#cfe6d8;padding:6px 10px}

  .currency-toggle{display:flex;background:#0a1c13;border:1px solid #143a25;border-radius:10px;overflow:hidden}
  .currency-toggle button{border:0;background:transparent;color:var(--muted);padding:8px 12px;cursor:pointer}
  .currency-toggle button.active{background:#11321f;color:var(--fg)}

  .felt{background:radial-gradient(1200px 600px at 50% -10%, #16432b 0%, #0f2c1e 55%, #0a2016 100%);border:1px solid #153b27;border-radius:18px;padding:16px;position:relative;overflow:hidden}
  .felt:before{content:"";position:absolute;inset:0;pointer-events:none;background:linear-gradient(transparent, rgba(0,0,0,.18) 80%)}

  .row{display:flex;justify-content:center;gap:12px;flex-wrap:wrap}
  .hand{min-height:calc(var(--card-h) + 32px);display:flex;align-items:flex-start;gap:10px;position:relative;padding-top:28px;flex-wrap:nowrap}
  .label{position:absolute;top:0;left:0;font-size:12px;color:var(--muted)}
  .total-badge{position:absolute;top:0;right:0;background:#0f2e20;border:1px solid #1a5136;color:var(--gold);padding:2px 8px;border-radius:999px;font-size:12px}

  .card{width:var(--card-w);height:var(--card-h);border-radius:var(--card-radius);background:#fff;border:2px solid #d7d7d7;box-shadow:0 6px 14px rgba(0,0,0,.35);position:relative;display:grid;place-items:center;font-weight:700;backface-visibility:hidden;transform:translateZ(0)}
  .card.red{color:#c1121f}
  .card.black{color:#111}
  .card .corner{position:absolute;font-size:var(--corner-size);line-height:1.05}
  .card .tl{top:6px;left:8px;text-align:left}
  .card .br{bottom:6px;right:8px;transform:rotate(180deg);text-align:left}
  .card .pip{font-size:var(--pip-size)}
  .card.back{background:repeating-linear-gradient(45deg,#0b1b13 0px,#0b1b13 6px,#0e2217 6px,#0e2217 12px);border-color:#193d2b}

  .actions{display:flex;justify-content:center;gap:10px;margin:10px 0 0;flex-wrap:wrap}
  .actions button{background:#0e2419;border:1px solid #19442e;color:var(--fg);padding:12px 14px;border-radius:10px;cursor:pointer;min-width:120px;min-height:44px}
  .actions button.primary{background:linear-gradient(#174d32,#0f3625);border-color:#1f6a46}
  .actions button:disabled{opacity:.45;cursor:not-allowed}

  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{width:44px;height:44px;border-radius:50%;border:2px solid #d8b800;background:radial-gradient(circle,#ffe688,#ffd700);color:#1b1500;font-weight:800;display:grid;place-items:center;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.35)}
  .betbox{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .bet{min-width:110px;text-align:center;background:#0c2419;border:1px solid #18432d;border-radius:10px;padding:10px 12px}

  .msg{margin:10px auto 0;max-width:720px;text-align:center;color:var(--muted)}
  .msg strong{color:#fff}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#0f2e20;border:1px solid #1a4a33;color:#eaf7ee;padding:10px 12px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.4);opacity:0;pointer-events:none;transition:opacity .25s, transform .25s;z-index:9999}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)}
  .split-ribbon{position:absolute;top:0;left:50%;transform:translate(-50%,-40%);background:#153e2a;border:1px solid #256648;padding:2px 8px;border-radius:8px;font-size:12px;color:var(--gold)}
  .paytable{margin-top:10px;font-size:12px;color:var(--muted);display:flex;gap:14px;justify-content:center;flex-wrap:wrap}

  /* Small screens */
  @media (max-width:480px){
    .wrap{padding:14px}
    .hud .panel{padding:8px 10px}
    .actions button{min-width:46%; flex:1}
    .bet{min-width:100px}
  }
</style>

<!-- Session helper (shared with other games) -->
<script src="/js/bag-session.js"></script>
</head>
<body>
<div class="wrap">
  <header>
    <img src="https://getthebag.io/logo.png" alt="$BAG" onerror="this.style.display='none'">
    <div class="tag gold">$BAG Blackjack</div>
    <div id="demoTag" class="tag demo" style="display:none">Demo</div>
  </header>

  <div class="hud">
    <div class="mode" id="modePill">Mode: DEMO</div>
    <div class="panel"><strong>Balance</strong><span id="balance">—</span></div>
    <div class="panel betbox">
      <strong>Bet</strong><div class="bet"><span id="bet">0</span> <span id="unit">BAG</span></div>
      <div class="chips">
        <div class="chip" data-v="1">1</div>
        <div class="chip" data-v="5">5</div>
        <div class="chip" data-v="10">10</div>
        <div class="chip" data-v="50">50</div>
        <div class="chip" data-v="100">100</div>
      </div>
      <button id="clearBet" class="actions">Clear</button>
    </div>
    <div class="panel">
      <strong>Currency</strong>
      <div class="currency-toggle" id="ccyToggle">
        <button data-ccy="BAG" class="active">$BAG</button>
        <button data-ccy="XRP">$XRP</button>
      </div>
    </div>
  </div>

  <section class="felt">
    <div class="row">
      <div class="hand" id="dealerHand">
        <div class="label">Dealer</div>
        <div class="total-badge" id="dealerTotal">0</div>
      </div>
    </div>

    <div class="row" id="playerArea">
      <div class="hand" id="playerHand0">
        <div class="label">You</div>
        <div class="total-badge" id="playerTotal0">0</div>
      </div>
    </div>

    <div class="actions">
      <button id="deal" class="primary">Deal</button>
      <button id="hit" disabled>Hit</button>
      <button id="stand" disabled>Stand</button>
      <button id="double" disabled>Double</button>
      <button id="split" disabled>Split</button>
      <button id="newHand" style="display:none">New Hand</button>
    </div>

    <div class="msg" id="message">Place your bet then Deal</div>
    <div class="paytable">
      <div><b>Blackjack</b> pays 2×</div>
      <div><b>Win</b> pays 1.25×</div>
      <div><b>Push</b> returns bet</div>
      <div>Dealer hits soft 17</div>
      <div>Single 52-card deck</div>
    </div>
  </section>
</div>

<div id="toast" class="toast"></div>

<script>
/* ========= Pricing, session, and HUD ========= */
const PRICES = Object.assign({ xrpUsd: 0.50, bagUsd: 0.0001 }, (window.__PRICES__||window.PRICES||{}));
const DEMO_KEY='__bag_demo_blackjack_v1';

const demoTag = document.getElementById('demoTag');
const modePill = document.getElementById('modePill');
function inDemo(){ return window.__BAG_FORCE_DEMO===true || !window.__bagSession || !window.__bagSession.active || !window.__bagSession.active(); }
function getDemoBal(){ try{ const v=Number(localStorage.getItem(DEMO_KEY)); return Number.isFinite(v)&&v>0?v:1000 }catch{return 1000} }
function setDemoBal(v){ try{ localStorage.setItem(DEMO_KEY, String(Math.max(0,Number(v)||0))); }catch{} }
if(localStorage.getItem(DEMO_KEY)==null) setDemoBal(1000);
function renderMode(){ const live=!inDemo(); demoTag.style.display=live?'none':'inline-block'; modePill.textContent = 'Mode: ' + (live?'LIVE':'DEMO'); }

function sessionBalanceBAG(){
  if(inDemo()) return getDemoBal();
  try{ const s = window.__bagSession && window.__bagSession.get && window.__bagSession.get(); return s && Number(s.bag)>0 ? Number(s.bag) : 0; }catch{ return 0; }
}
function spendBAG(amount){
  if(!(amount>0)) return true;
  if(inDemo()){
    const b=getDemoBal(); if(b<amount) return false; setDemoBal(b-amount); return true;
  }
  try{ return !!(window.__bagSession && __bagSession.spend && __bagSession.spend(amount)); }catch{ return false; }
}
function creditBAG(amount){
  if(!(amount>0)) return;
  if(inDemo()){ setDemoBal(getDemoBal()+amount); return; }
  try{ if(window.__bagSession && __bagSession.credit) __bagSession.credit(amount); }catch{}
}

/* ========= Config ========= */
const CONFIG = {
  blackjackPayout: 2.0,    // Natural blackjack
  regularWinPayout: 1.25,  // Standard win
  pushPayout: 1.0,         // Refund
  allowDouble: true,
  allowSplit: true,        // One split only
  dealerHitsSoft17: true,
  decks: 1                 // Single deck
};

/* ========= Demo flag / currency ========= */
renderMode();
let currency = 'BAG';

/* ========= State ========= */
let balanceBAG = sessionBalanceBAG(); // always store in BAG units
let betDisplay = 0;                   // shown in selected currency units
let shoe = [];
let playerHands = [];   // array of hands if split
let dealerHand = [];
let activeHandIndex = 0;
let hasSplit = false;
let roundOver = false;

/* ========= Elements ========= */
const elBalance = document.getElementById('balance');
const elBet = document.getElementById('bet');
const elUnit = document.getElementById('unit');
const elDealerHand = document.getElementById('dealerHand');
const elDealerTotal = document.getElementById('dealerTotal');
const elPlayerArea = document.getElementById('playerArea');
const elMessage = document.getElementById('message');
const elToast = document.getElementById('toast');

const btnDeal = document.getElementById('deal');
const btnHit = document.getElementById('hit');
const btnStand = document.getElementById('stand');
const btnDouble = document.getElementById('double');
const btnSplit = document.getElementById('split');
const btnNew = document.getElementById('newHand');
const btnClearBet = document.getElementById('clearBet');

/* ========= Audio (autoplay-safe) ========= */
let _ac=null;
function ac(){ if(_ac && _ac.state!=='closed') return _ac; const AC=window.AudioContext||window.webkitAudioContext; if(!AC) return null; _ac=new AC(); return _ac; }
async function resumeAudio(){ const c=ac(); if(c && c.state==='suspended'){ try{ await c.resume(); }catch{} } }
function beep(freq=440, dur=0.08, type='triangle', gain=0.05){
  const c=ac(); if(!c || c.state!=='running') return;
  try{
    const o=c.createOscillator(), g=c.createGain();
    o.type=type; o.frequency.value=freq; g.gain.value=gain; o.connect(g); g.connect(c.destination);
    o.start(); setTimeout(()=>{ try{o.stop();o.disconnect();g.disconnect();}catch{} }, dur*1000);
  }catch{}
}
const sfx = {
  chip: () => beep(280, 0.05,'square',0.04),
  deal: () => beep(520, 0.06,'sawtooth',0.04),
  win:  () => [520,700,880].forEach((f,i)=>setTimeout(()=>beep(f,0.07,'sine',0.06),i*90)),
  lose: () => [220,180,140].forEach((f,i)=>setTimeout(()=>beep(f,0.09,'sine',0.05),i*120))
};
['click','touchstart','keydown'].forEach(ev=>addEventListener(ev, ()=>resumeAudio(), {passive:true, once:true}));

/* ========= Currency helpers ========= */
function displayToUSD(v){
  if(currency==='BAG') return PRICES.bagUsd>0 ? v*PRICES.bagUsd : 0;
  if(currency==='XRP') return PRICES.xrpUsd>0 ? v*PRICES.xrpUsd : 0;
  return 0;
}
function usdToBAG(usd){ return PRICES.bagUsd>0 ? (usd/PRICES.bagUsd) : 0; }
function displayToBAG(v){ return usdToBAG(displayToUSD(v)); }
function fmtAmountDisplay(v){
  const n = Number(v||0);
  return (currency==='BAG' ? n.toFixed(2) : n.toFixed(6));
}
function fmtBalance(){
  if(currency==='BAG') return `${balanceBAG.toFixed(2)} BAG`;
  // convert BAG to XRP for HUD
  const {bagUsd,xrpUsd}=PRICES;
  if(bagUsd>0 && xrpUsd>0){
    const xrp = balanceBAG*(bagUsd/xrpUsd);
    return `${xrp.toFixed(6)} XRP`;
  }
  return '—';
}

/* ========= Utilities ========= */
function shuffle(a){
  for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]; }
  return a;
}
function buildShoe(){
  const ranks=['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
  const suits=['♠','♥','♦','♣'];
  const tmp=[];
  for(let d=0; d<CONFIG.decks; d++) for(const r of ranks) for(const s of suits) tmp.push({r,s});
  shoe = shuffle(tmp);
}
function handValue(hand){
  let total=0, aces=0;
  for(const c of hand){
    if(c.r==='A'){ total+=11; aces++; }
    else if(['K','Q','J','10'].includes(c.r)) total+=10;
    else total+=parseInt(c.r,10);
  }
  while(total>21 && aces>0){ total-=10; aces--; }
  const soft = (aces>0 && total<=21);
  return {total, soft};
}
function isBlackjack(hand){
  if(hand.length!==2) return false;
  const vals = hand.map(c=>c.r);
  return vals.includes('A') && ['10','J','Q','K'].some(v=>vals.includes(v));
}
function canSplit(hand){
  if(!CONFIG.allowSplit || hasSplit) return false;
  if(hand.length!==2) return false;
  const [a,b]=hand;
  const v = (x)=> x.r==='A' ? 11 : ['K','Q','J','10'].includes(x.r) ? 10 : parseInt(x.r,10);
  return v(a)===v(b);
}
function showToast(txt){
  elToast.textContent = txt;
  elToast.classList.add('show');
  setTimeout(()=>elToast.classList.remove('show'), 1300);
}

/* ========= Rendering ========= */
function clearHands(){
  elDealerHand.querySelectorAll('.card').forEach(n=>n.remove());
  const first = document.getElementById('playerHand0');
  if(first) first.querySelectorAll('.card').forEach(c=>c.remove());
  [...elPlayerArea.querySelectorAll('.hand')].forEach((n,i)=>{ if(i>0) n.remove(); });
}
function renderCard(node, card, facedown=false){
  const c = document.createElement('div');
  c.className = facedown ? 'card back' : ('card ' + (['♥','♦'].includes(card.s)?'red':'black'));
  if(!facedown){
    c.innerHTML = `
      <div class="corner tl">${card.r}<br>${card.s}</div>
      <div class="pip">${card.s}</div>
      <div class="corner br">${card.r}<br>${card.s}</div>
    `;
  }
  node.appendChild(c);
}
function ensurePlayerHandsContainers(){
  elPlayerArea.innerHTML='';
  playerHands.forEach((_,i)=>{
    const h = document.createElement('div');
    h.className='hand';
    h.id='playerHand'+i;
    h.innerHTML = `<div class="label">You ${playerHands.length>1?`(Hand ${i+1})`:''}</div>
                   <div class="total-badge" id="playerTotal${i}">0</div>`;
    elPlayerArea.appendChild(h);
    if(playerHands.length>1 && i===activeHandIndex){
      const r=document.createElement('div'); r.className='split-ribbon'; r.textContent='Active';
      h.appendChild(r);
    }
  });
}
function updateTotals(){
  const dv = handValue(dealerHand).total;
  elDealerTotal.textContent = dv>0? dv: 0;
  playerHands.forEach((h,i)=>{
    const pv = handValue(h).total;
    const tEl = document.getElementById('playerTotal'+i);
    if (tEl) tEl.textContent = pv;
  });
}
function updateHUD(){
  balanceBAG = sessionBalanceBAG(); // refresh from session/demo
  elBalance.textContent = fmtBalance();
  elBet.textContent = fmtAmountDisplay(betDisplay);
  elUnit.textContent = currency;
}

/* ========= Flow ========= */
function resetRoundUI(){
  btnDeal.disabled = false;
  btnHit.disabled = true;
  btnStand.disabled = true;
  btnDouble.disabled = true;
  btnSplit.disabled = true;
  btnNew.style.display = 'none';
  elMessage.innerHTML = 'Place your bet then Deal';
}
function startRound(){
  // Spend the displayed bet (converted to BAG) up front
  const bagStake = displayToBAG(betDisplay);
  if(!(betDisplay>0) || !(bagStake>0)){ showToast('Invalid bet'); return; }
  if(!spendBAG(bagStake)){ showToast('Insufficient balance'); return; }

  updateHUD(); // reflect spend
  hasSplit=false; activeHandIndex=0;
  roundOver=false;

  clearHands();
  dealerHand=[]; playerHands=[[]];
  ensurePlayerHandsContainers();

  // deal: player, dealer, player, dealer(facedown)
  const p0 = document.getElementById('playerHand0');
  dealTo(playerHands[0], p0);
  dealTo(dealerHand, elDealerHand);
  dealTo(playerHands[0], p0);
  dealTo(dealerHand, elDealerHand, true);
  updateTotals();

  btnDeal.disabled = true;

  // naturals
  const pBJ = isBlackjack(playerHands[0]);

  if(pBJ){
    revealDealerHole();
    const dBJ = isBlackjack(dealerHand);
    const deltaBag = settleSingleHandBAG(playerHands[0], dBJ ? 'push-bj' : 'blackjack');
    if(deltaBag>0) creditBAG(deltaBag);
    updateHUD();
    endRoundControls();
    return;
  }

  // Enable actions
  btnHit.disabled = false;
  btnStand.disabled = false;
  btnDouble.disabled = CONFIG.allowDouble;
  btnSplit.disabled = canSplit(playerHands[0]);
  elMessage.innerHTML = 'Play your hand';
}
function dealTo(targetHand, targetNode, facedown=false){
  if(shoe.length === 0) buildShoe();
  const c = shoe.pop(); targetHand.push(c); sfx.deal();
  renderCard(targetNode, c, facedown);
}
function revealDealerHole(){
  const cards = elDealerHand.querySelectorAll('.card');
  if(cards.length>=2 && cards[1].classList.contains('back')){
    cards[1].remove();
    renderCard(elDealerHand, dealerHand[1], false);
  }
  updateTotals();
}

/* ========= Player actions ========= */
btnDeal.addEventListener('click', startRound);

btnHit.addEventListener('click', ()=>{
  const idx=activeHandIndex;
  const node=document.getElementById('playerHand'+idx);
  dealTo(playerHands[idx], node);
  updateTotals();
  // after any hit, double is no longer allowed on this hand
  btnDouble.disabled = true;
  const v=handValue(playerHands[idx]).total;
  if(v>21){
    markMessage(`Hand ${playerHands.length>1?idx+1:''} busts`);
    nextHandOrDealer(true);
  }
});

btnStand.addEventListener('click', ()=>{
  markMessage(`Hand ${playerHands.length>1?activeHandIndex+1:''} stands`);
  nextHandOrDealer(true);
});

btnDouble.addEventListener('click', ()=>{
  const idx=activeHandIndex;
  if(playerHands[idx].length!==2){ showToast('Double only on first turn'); return; }
  // spend an extra stake immediately (same as initial)
  const bagStake = displayToBAG(betDisplay);
  if(!spendBAG(bagStake)){ showToast('Insufficient balance'); return; }
  updateHUD();
  playerHands[idx]._doubled = true;

  markMessage(`Hand ${playerHands.length>1?idx+1:''} doubled`);
  const node=document.getElementById('playerHand'+idx);
  dealTo(playerHands[idx], node);
  updateTotals();
  // after double, auto-stand this hand
  nextHandOrDealer(true);
});

btnSplit.addEventListener('click', ()=>{
  const h0=playerHands[0];
  if(!canSplit(h0)) return;
  const bagStake = displayToBAG(betDisplay);
  if(!spendBAG(bagStake)){ showToast('Insufficient balance'); return; }
  updateHUD();
  hasSplit=true;

  // split into two hands
  const c2=h0.pop();
  playerHands=[ [h0[0]], [c2] ];
  ensurePlayerHandsContainers();

  // render first card in each and deal one more to each
  const h0Node = document.getElementById('playerHand0');
  const h1Node = document.getElementById('playerHand1');
  renderCard(h0Node, playerHands[0][0]);
  renderCard(h1Node, playerHands[1][0]);
  dealTo(playerHands[0], h0Node);
  dealTo(playerHands[1], h1Node);
  updateTotals();

  activeHandIndex = 0;
  highlightActive();
  btnSplit.disabled = true; // one split only
  btnDouble.disabled = false; // still allowed on first action of each split hand
});

btnNew.addEventListener('click', ()=>{
  resetRoundUI();
});

/* ========= Flow helpers ========= */
function highlightActive(){
  document.querySelectorAll('.split-ribbon').forEach(n=>n.remove());
  if(playerHands.length>1){
    const h=document.getElementById('playerHand'+activeHandIndex);
    if (h){
      const r=document.createElement('div'); r.className='split-ribbon'; r.textContent='Active';
      h.appendChild(r);
    }
  }
}
function nextHandOrDealer(/* stoodOrBusted */){
  // Double only available at first action of a hand; when moving, re-evaluate for next hand
  if(playerHands.length>1){
    activeHandIndex++;
    if(activeHandIndex<playerHands.length){
      highlightActive();
      btnDouble.disabled = !(CONFIG.allowDouble && playerHands[activeHandIndex].length===2);
      btnHit.disabled = false;
      btnStand.disabled = false;
      return;
    }
  }
  dealerPlayAndSettle();
}
function dealerPlayAndSettle(){
  revealDealerHole();
  // dealer hits to 17 (hit soft 17 if configured)
  let dv = handValue(dealerHand);
  while(dv.total<17 || (dv.total===17 && dv.soft && CONFIG.dealerHitsSoft17)){
    dealTo(dealerHand, elDealerHand);
    dv = handValue(dealerHand);
  }
  updateTotals();

  let totalBagDelta = 0;
  if(playerHands.length===1){
    totalBagDelta += settleSingleHandBAG(playerHands[0]);
  }else{
    playerHands.forEach((h,idx)=>{ totalBagDelta += settleSingleHandBAG(h, undefined, idx); });
  }
  if(totalBagDelta>0) creditBAG(totalBagDelta);
  updateHUD();
  endRoundControls();
}
function settleSingleHandBAG(hand, override, splitIndex){
  // returns positive BAG delta to credit (stake+win for wins, stake for push, 0 on losses)
  let bagDelta = 0;
  const pv = handValue(hand).total;
  const dv = handValue(dealerHand).total;

  const stakeBagBase = displayToBAG(betDisplay);
  const doubledFlag = hand._doubled === true;
  const stakeBag = stakeBagBase * (doubledFlag ? 2 : 1);

  if(pv>21){
    markMessage(`Hand ${playerHands.length>1?(splitIndex+1)+' ':''}busts — dealer wins`);
    sfx.lose();
    return 0;
  }
  if(override==='blackjack'){
    const win = stakeBagBase * CONFIG.blackjackPayout;
    bagDelta += stakeBagBase + win; // return stake + win
    markMessage('Blackjack. Paid 2×');
    sfx.win();
    return bagDelta;
  }
  if(override==='push-bj'){
    bagDelta += stakeBagBase;
    markMessage('Both have Blackjack — push');
    return bagDelta;
  }

  if(dv>21){
    const win = stakeBag * CONFIG.regularWinPayout;
    bagDelta += stakeBag + win;
    markMessage(`Dealer busts — you win ${CONFIG.regularWinPayout.toFixed(2)}×`);
    sfx.win();
  }else if(pv>dv){
    if(isBlackjack(hand) && !doubledFlag && !hasSplit){
      // natural already handled earlier; treat as regular if reached here
      const win = stakeBag * CONFIG.blackjackPayout;
      bagDelta += stakeBag + win;
      markMessage(`Blackjack — paid 2×`);
    }else{
      const win = stakeBag * CONFIG.regularWinPayout;
      bagDelta += stakeBag + win;
      markMessage(`You win ${CONFIG.regularWinPayout.toFixed(2)}×`);
    }
    sfx.win();
  }else if(pv<dv){
    markMessage('Dealer wins');
    sfx.lose();
  }else{
    bagDelta += stakeBag * CONFIG.pushPayout; // return stake
    markMessage('Push — bet returned');
  }
  return bagDelta;
}
function endRoundControls(){
  btnHit.disabled = true;
  btnStand.disabled = true;
  btnDouble.disabled = true;
  btnSplit.disabled = true;
  btnDeal.disabled = true;
  btnNew.style.display = 'inline-block';
  roundOver = true;
}

/* ========= Messaging ========= */
function markMessage(t){
  elMessage.innerHTML = `<strong>${t}</strong>`;
}

/* ========= Betting & Currency ========= */
document.querySelectorAll('.chip').forEach(ch=>{
  ch.addEventListener('click', ()=>{
    if(roundOver===true || btnDeal.disabled===false){
      const v=Number(ch.dataset.v)||0;
      // Check if user can afford this added amount in current currency
      const neededBag = displayToBAG(betDisplay + v) - displayToBAG(betDisplay);
      const afford = sessionBalanceBAG() >= neededBag;
      if(afford){
        betDisplay += v;
        updateHUD();
        sfx.chip();
      }else{
        showToast('Insufficient balance');
      }
    }else{
      showToast('Bet locked for this round');
    }
  }, {passive:true});
});
btnClearBet.addEventListener('click', ()=>{
  if(btnDeal.disabled) { showToast('Bet locked for this round'); return; }
  betDisplay=0; updateHUD();
});
document.getElementById('ccyToggle').addEventListener('click', (e)=>{
  if(e.target.tagName!=='BUTTON') return;
  document.querySelectorAll('#ccyToggle button').forEach(b=>b.classList.remove('active'));
  e.target.classList.add('active');
  currency = e.target.dataset.ccy;
  updateHUD();
});

/* ========= Init ========= */
function init(){
  buildShoe();
  balanceBAG = sessionBalanceBAG();
  betDisplay = 0;
  updateHUD();
  resetRoundUI();
}
init();

/* ========= Reshuffle guard ========= */
setInterval(()=>{ if(shoe.length<15){ buildShoe(); showToast('Shuffled'); } }, 1500);

// Live session/price updates (optional events your shell can dispatch)
addEventListener('bag:pricesUpdated', ()=>updateHUD(), {passive:true});
addEventListener('bag:sessionUpdated', ()=>{ renderMode(); updateHUD(); }, {passive:true});
</script>
</body>
</html>
