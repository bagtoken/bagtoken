<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>$BAG Blackjack</title>

<link rel="preconnect" href="https://api.coingecko.com" crossorigin>
<script src="https://xaman.app/assets/cdn/xumm.min.js"></script>
<script>window.__BAG_FORCE_DEMO = false;</script>

<style>
  *{box-sizing:border-box}
  :root{
    --gold:#ffe175;--bg:#020703;--panel:#0b1b13;--panel2:#0d2217;--muted:#aeb7af;--fg:#f5f7f4;
    --green:#2fbf6b;--line:#173524;--shadow:rgba(0,0,0,.35);--lose:#e25b5b; --warn:#e8a85c;
    --card-w: clamp(60px, 15vw, 90px); --card-h: calc(var(--card-w) * 1.42);
  }
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.55}
  img{display:block;max-width:100%;height:auto}
  button,input{font-size:16px}

  .back-casino{position:fixed;top:18px;left:18px;z-index:1000;background:linear-gradient(180deg,#ffe175 0%,#f5c94c 100%);
    color:#08130d;text-decoration:none;font-weight:800;padding:8px 14px;border-radius:10px;box-shadow:0 4px 0 #b08a19;transition:all .15s ease}
  .back-casino:hover{filter:brightness(1.05);box-shadow:0 4px 0 #b08a19,0 14px 28px rgba(255,225,117,.22)}
  .back-casino:active{transform:translateY(1px);box-shadow:0 3px 0 #9a7315}

  .game-header{text-align:center;padding:36px 10px 14px}
  .game-header img.hero-img{margin-bottom:10px;filter:drop-shadow(0 10px 24px rgba(46,191,107,.18))}
  .game-header h2{font-size:clamp(1.6rem,5vw,2.2rem);margin:6px 0 0}
  @media (min-width:900px){.game-header img.hero-img{width:34vw;max-width:420px;margin-left:auto;margin-right:auto}}

  .game-teaser{padding:10px 16px 60px;background:
    radial-gradient(1200px 600px at 10% -10%, #0e2c1d 0%, transparent 60%),
    radial-gradient(900px 500px at 110% 20%, #0b2318 0%, transparent 55%),#060806;
    border-top:1px solid #131313;border-bottom:1px solid #131313}
  .game-wrap{max-width:1080px;margin:0 auto;display:grid;grid-template-columns:1.12fr .88fr;gap:22px}
  @media (max-width:900px){.game-wrap{grid-template-columns:1fr}}

  .panel{background:linear-gradient(180deg,var(--panel) 0%,var(--panel2) 100%);border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 24px var(--shadow)}
  .mock{padding:16px}
  .section-title{font-weight:800;font-size:1.2rem;margin:0 0 12px}
  .stake-box{padding:14px}
  .stack{display:grid;gap:10px}
  .choice{display:flex;gap:10px;flex-wrap:wrap}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid #2b6a48;background:#0e2a1c;color:#e9efe9;font-weight:800}
  .chip input{accent-color:#2fbf6b}
  .mono{font-variant-numeric:tabular-nums}
  .micro{font-size:.85rem;color:#a8b5ab}
  .muted{color:#cfd6cf}
  .divider{height:1px;background:#123221;margin:10px 0}
  .callout{margin-top:12px;padding:12px;border:1px dashed #29543d;border-radius:12px;background:#0c2418;color:#e4efe7}
  .payout-grid{display:grid;gap:4px}
  .payout-grid .row{display:flex;justify-content:space-between}
  .payout-grid .lab{color:#cfd6cf}
  .payout-grid .val{font-variant-numeric:tabular-nums}

  #liveDot{margin-right:6px}
  .ok{color:#2fbf6b}.warn{color:#e8a85c}.err{color:#e25b5b}

  .table{background:#07140e;border:1px solid #1b4a2f;border-radius:14px;padding:14px}
  .felt{display:grid;grid-template-columns:1fr;gap:12px;background:#091a13;border:1px solid #24533a;border-radius:12px;padding:12px;overflow:hidden}
  .marquee{text-align:center;font-weight:900;letter-spacing:.08em;color:#ffe9a6;background:linear-gradient(180deg,#17311f,#0e2419);border:1px solid #254a33;border-radius:12px;padding:8px}

  .btn-row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:6px}
  .btn{min-width:120px;padding:12px 14px;font-weight:900;border:0;border-radius:12px;cursor:pointer;color:#08130d;background:linear-gradient(180deg,#ffe175 0%, #f5c94c 100%);box-shadow:0 6px 0 #b08a19, 0 16px 32px rgba(255,225,117,.18), inset 0 1px 0 rgba(255,255,255,.35)}
  .btn.alt{color:#e9efe9;background:#15261c;box-shadow:none;border:1px solid #2b6a48}
  .btn:disabled{opacity:.65;cursor:not-allowed}

  .hudbar{display:flex;gap:6px;flex-wrap:wrap;align-items:center;margin:6px 2px 0}
  .pill{background:#0a1e15;border:1px solid #244330;border-radius:999px;padding:6px 10px;font-size:12px;color:#cfe6d8}
  .hudbar .pill b{font-weight:800}

  .hand{position:relative;min-height:calc(var(--card-h) + 36px);padding-top:24px}
  .label{position:absolute;top:0;left:0;color:#cfd6cf;font-size:12px}
  .total{position:absolute;top:0;right:0;background:#0f2e20;border:1px solid #1a5136;color:#ffe175;padding:3px 10px;border-radius:999px;font-size:12px}
  .cards{display:flex;gap:10px;flex-wrap:nowrap}

  .card{width:var(--card-w);height:var(--card-h);border-radius:12px;border:2px solid #e6e6e6;background:linear-gradient(#fff,#f6faf8);box-shadow:0 10px 22px rgba(0,0,0,.35);display:grid;place-items:center;position:relative;font-weight:800;transform:translateY(14px);opacity:0;animation:in .16s ease-out forwards}
  @keyframes in{to{transform:translateY(0);opacity:1}}
  .card.red{color:#c1121f}.card.black{color:#111}
  .corner{position:absolute;font-size:clamp(12px,2.4vw,14px);line-height:1.05}
  .tl{top:7px;left:8px}.br{bottom:7px;right:8px;transform:rotate(180deg)}
  .pip{font-size:clamp(22px,3.4vw,28px)}
  .back{background:repeating-linear-gradient(45deg,#0b1b13 0px,#0b1b13 6px,#0e2217 6px,#0e2217 12px);border-color:#193d2b}

  .result{margin-top:10px;padding:12px;border:1px solid #1b4a2f;border-radius:12px;background:#0b2217;color:#dfece7}
  .t.win{color:#2fbf6b}.t.push{color:#e8a85c}.t.lose{color:#e25b5b}

  /* WIN overlay */
  #win-overlay{ position:fixed; inset:0; display:none; place-items:center; background:radial-gradient(60% 60% at 50% 50%, rgba(24,160,251,.28), transparent 70%), rgba(10,12,16,.70); z-index:2147483647; backdrop-filter:saturate(120%) blur(2px); }
  #win-card{ position:relative; text-align:center; padding:24px 32px; border-radius:16px; background:rgba(0,0,0,.35); box-shadow:0 10px 40px rgba(0,0,0,.45), inset 0 0 80px rgba(0,255,200,.06); transform:scale(.9); opacity:0; animation:win-pop .35s cubic-bezier(.2,.9,.2,1) forwards, win-float 1.8s ease-in-out .35s infinite; }
  #win-text{ font:900 56px/1 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; letter-spacing:.06em; background:linear-gradient(90deg, #fff, #00ffb2, #fff); background-size:200% 100%; -webkit-background-clip:text; color:transparent; -webkit-text-fill-color:transparent; text-shadow: 0 0 18px rgba(0,255,178,.35), 0 0 48px rgba(0,255,178,.25); filter:drop-shadow(0 4px 10px rgba(0,0,0,.35)); animation:shine 1.6s linear infinite; white-space:nowrap; }
  #win-sub{ margin-top:8px; color:#e7f6ff; opacity:.9; font: 600 16px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
  #win-close{ position:absolute; top:8px; right:10px; border:0; background:transparent; color:#cfeaff; font:700 20px/1; cursor:pointer; padding:6px 8px; opacity:.7; }
  #win-canvas{ position:fixed; inset:0; pointer-events:none; z-index:2147483646; display:none; }
  @keyframes win-pop{ to{ transform:scale(1); opacity:1; } }
  @keyframes win-float{ 0%,100%{ transform:translateY(0) } 50%{ transform:translateY(-6px) } }
</style>

<script src="/js/bag-session.js"></script>
</head>
<body>

<a href="/casino/" class="back-casino">‚¨ÖÔ∏è Back to Casino</a>

<section class="game-header">
  <img src="/assets/bag-blackjack.jpeg" alt="BAG Blackjack" class="hero-img" loading="lazy" decoding="async">
  <h2>üé¥ $BAG BLACKJACK</h2>
  <p class="micro" style="margin-top:4px;opacity:.9;">üí∞ <strong>All payouts are in $BAG.</strong> $XRP bets convert automatically at the live rate.</p>
</section>

<section class="game-teaser">
  <div class="game-wrap">

    <!-- LEFT: Controls / Prices / Session (identical structure to Dice) -->
    <div class="panel mock" id="bagBJ">
      <!-- CONNECT -->
      <div id="connectRow" style="display:flex;justify-content:space-between;align-items:center;margin:-2px 0 10px 0%;">
        <div id="connectStatus" class="micro" style="opacity:.9">Wallet: <span style="color:#e8a85c">not connected</span></div>
        <button id="connectBtn" style="padding:10px 14px;font-weight:800;border:0;border-radius:12px;color:#08130d;background:linear-gradient(180deg,#ffe175 0%, #f5c94c 100%);box-shadow:0 4px 0 #b08a19;cursor:pointer;">Connect Xaman</button>
      </div>

      <!-- SESSION -->
      <div id="sessionRow" style="display:flex;justify-content:space-between;align-items:center;margin:6px 0 10px 0%;">
        <div id="sessionStatus" class="micro" style="opacity:.9">Session: <span style="color:#e8a85c">not started</span></div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="startSessionBtn" style="padding:8px 12px;font-weight:800;border:0;border-radius:10px;color:#08130d;background:linear-gradient(180deg,#ffe175 0%, #f5c94c 100%);box-shadow:0 3px 0 #b08a19;cursor:pointer;">Start Session</button>
          <button id="topUpBtn" style="padding:8px 12px;font-weight:800;border:0;border-radius:10px;color:#08130d;background:linear-gradient(180deg,#ffe175 0%, #f5c94c 100%);box-shadow:0 3px 0 #b08a19;cursor:pointer;display:none;">Top Up</button>
          <button id="endSessionBtn" style="padding:8px 12px;font-weight:800;border:0;border-radius:10px;background:#15261c;color:#dfe9e2;border:1px solid #2b6a48;cursor:pointer;display:none;">End</button>
        </div>
      </div>

      <div class="section-title">Stake & Prices</div>

      <div class="stake-box">
        <div class="stack">
          <div>
            <div class="micro">Amount</div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
              <div style="display:flex;align-items:center;gap:6px">
                <input id="usdBet" class="mono" type="number" inputmode="decimal" enterkeyhint="done" min="0" max="2000" step="0.01" placeholder="0.00" style="width:140px;background:#0b2217;border:1px solid #1b4a2f;border-radius:10px;color:#f3f5f0;padding:10px">
                <span class="micro" aria-hidden="true">USD</span>
              </div>
            </div>
            <div class="preset-chips" id="usdPresets" role="group" aria-label="Quick bet" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
              <button type="button" class="preset-chip" data-usd="1">$1</button>
              <button type="button" class="preset-chip" data-usd="2">$2</button>
              <button type="button" class="preset-chip" data-usd="5">$5</button>
              <button type="button" class="preset-chip" data-usd="10">$10</button>
              <button type="button" class="preset-chip" data-usd="20">$20</button>
              <button type="button" class="preset-chip" data-usd="50">$50</button>
              <button type="button" class="preset-chip" data-usd="100">$100</button>
              <button type="button" class="preset-chip" data-usd="max">Max</button>
            </div>
          </div>

          <div>
            <div class="micro">Bet currency</div>
            <div class="choice" id="curToggle">
              <label class="chip"><input type="radio" name="betCur" value="XRP" checked> XRP</label>
              <label class="chip"><input type="radio" name="betCur" value="BAG"> BAG</label>
            </div>
          </div>

          <div>
            <div class="micro">Bet amount</div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
              <div>
                <input id="betQty" class="mono" type="number" inputmode="decimal" enterkeyhint="done" min="0" step="any" value="1" style="width:140px;background:#0b2217;border:1px solid #1b4a2f;border-radius:10px;color:#f3f5f0;padding:10px">
                <span class="unit">XRP</span>
              </div>
            </div>
            <div class="micro" id="betLimits" style="margin-top:6px"></div>
          </div>

          <div class="divider"></div>

          <div class="micro">Live prices</div>
          <div class="muted mono" id="liveLine">
            <span id="liveDot" class="warn">‚óè</span>
            <span> BAG $<span id="liveBAG">‚Äî</span> ¬∑ XRP $<span id="liveXRP">‚Äî</span> <span id="liveNote"></span></span>
            <div class="micro" id="liveConv" style="margin-top:4px;opacity:.9;">1 BAG ‚âà ‚Äî XRP ¬∑ 1 XRP ‚âà ‚Äî BAG</div>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Payouts preview -->
      <div class="callout mono" id="payoutBox">
        <div class="payout-grid">
          <div class="row"><div class="lab"><strong>Blackjack</strong> (natural):</div><div class="val" id="payBJ">‚Äî</div></div>
          <div class="row"><div class="lab"><strong>Regular win</strong>:</div><div class="val" id="payWin">‚Äî</div></div>
          <div class="row"><div class="lab"><strong>Push</strong>:</div><div class="val" id="payPush">‚Äî</div></div>
          <div class="row"><div class="lab"><strong>Loss</strong>:</div><div class="val">0 BAG ($0.00)</div></div>
        </div>
        <div class="micro" style="margin-top:6px;opacity:.85;">
          Dealer hits soft 17 ¬∑ Single deck ¬∑ Double on first action ¬∑ One split.
          Blackjack pays <b>2.00√ó</b>, regular win <b>1.25√ó</b>, push returns stake.
        </div>
      </div>
    </div>

    <!-- RIGHT: Table -->
    <div class="panel" style="padding:16px">
      <div class="marquee">$BAG TABLE</div>
      <div class="table">
        <div class="felt" id="felt">
          <div class="hand" id="dealer">
            <div class="label">Dealer</div><div class="total" id="dealerTotal">0</div>
            <div class="cards" id="dealerCards"></div>
          </div>
          <div class="hand" id="player">
            <div class="label">You</div><div class="total" id="playerTotal">0</div>
            <div class="cards" id="playerCards"></div>
          </div>

          <div id="splitArea"></div>

          <div class="btn-row">
            <button id="dealBtn"   class="btn">Deal</button>
            <button id="hitBtn"    class="btn" disabled>Hit</button>
            <button id="standBtn"  class="btn" disabled>Stand</button>
            <button id="doubleBtn" class="btn alt" disabled>Double</button>
            <button id="splitBtn"  class="btn alt" disabled>Split</button>
            <button id="againBtn"  class="btn" style="display:none">New Hand</button>
          </div>

          <!-- HUD -->
          <div class="hudbar" aria-live="polite" id="bjHud">
            <span class="pill">Mode: <b id="modeLbl">Demo</b></span>
            <span class="pill">Balance: <b id="balLbl">‚Äî</b> <span id="ccyLbl">BAG</span></span>
            <span class="pill">Bet: <b id="betLbl">1</b></span>
            <span class="pill">Last: <b id="lastLbl">‚Äî</b></span>
          </div>

          <div class="result" id="statusText">Place a stake, then Deal</div>
        </div>
      </div>
    </div>

  </div>
</section>

<!-- Celebration overlay (same component as Dice) -->
<canvas id="win-canvas"></canvas>
<div id="win-overlay" role="dialog" aria-live="polite" aria-label="Win notification">
  <div id="win-card">
    <button id="win-close" aria-label="Close">√ó</button>
    <div id="win-text">WIN</div>
    <div id="win-sub">Nice hand</div>
  </div>
</div>

<!-- Celebration overlay logic -->
<script>
(function(){
  const overlay=document.getElementById('win-overlay');
  const canvas=document.getElementById('win-canvas');
  const ctx=canvas.getContext('2d');
  const closeBtn=document.getElementById('win-close');
  const sub=document.getElementById('win-sub');
  const title=document.getElementById('win-text');
  let rafId=null, particles=[], start=0, dur=2000;

  function size(){ const dpr=Math.min(devicePixelRatio||1,2);
    canvas.width=innerWidth*dpr; canvas.height=innerHeight*dpr;
    canvas.style.width=innerWidth+'px'; canvas.style.height=innerHeight+'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  size(); addEventListener('resize', size);

  function fire(n){
    particles.length=0;
    const colors=['#ffffff','#00ffb2','#18a0fb','#ffd166','#f72585'];
    for(let i=0;i<n;i++){
      particles.push({x:innerWidth*.5,y:innerHeight*.4,vx:(Math.random()-.5)*6,vy:-(3+Math.random()*5),g:.16,rot:Math.random()*6.28,vr:(Math.random()-.5)*.25,sz:6+Math.random()*10,col:colors[(Math.random()*colors.length)|0],shape:Math.random()<.4?'circle':(Math.random()<.5?'square':'tri')});
    }
  }
  function draw(){ ctx.clearRect(0,0,innerWidth,innerHeight);
    particles.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.vy+=p.g; p.rot+=p.vr;
      ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot); ctx.fillStyle=p.col; const s=p.sz;
      if(p.shape==='circle'){ ctx.beginPath(); ctx.arc(0,0,s*0.6,0,Math.PI*2); ctx.fill(); }
      else if(p.shape==='square'){ ctx.fillRect(-s/2,-s/2,s,s); }
      else { ctx.beginPath(); ctx.moveTo(0,-s/1.2); ctx.lineTo(s/1.2,s/1.2); ctx.lineTo(-s/1.2,s/1.2); ctx.closePath(); ctx.fill(); }
      ctx.restore();
    });
  }
  function anim(ts){ if(!start) start=ts; draw(); if(ts-start<dur){ rafId=requestAnimationFrame(anim); } else stop(); }
  function stop(){ cancelAnimationFrame(rafId); ctx.clearRect(0,0,innerWidth,innerHeight); canvas.style.display='none'; }
  function show(){ overlay.style.display='grid'; }
  function hide(){ overlay.style.display='none'; stop(); }

  closeBtn.addEventListener('click', hide);
  overlay.addEventListener('click', e=>{ if(e.target===overlay) hide(); });
  addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ try{ window.__winTimer && clearTimeout(__winTimer);}catch{}; hide(); }});

  window.showWin=function(opts={}){ 
    const { message='WIN', subtext='Nice hand', sound=true, duration=3800 }=opts;
    title.textContent=message; sub.textContent=subtext; show(); canvas.style.display='block'; fire(180);
    if(sound) try{ window.__bagAudio && __bagAudio.chime(); }catch(e){}
    cancelAnimationFrame(rafId); start=0; dur=2200; rafId=requestAnimationFrame(anim);
    clearTimeout(window.__winTimer); window.__winTimer=setTimeout(hide, Math.max(1200,duration));
  };
})();
</script>

<!-- AUDIO (same as Dice) -->
<script>
(function(){
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let AC=null, MASTER=null, lastTap=0, watchdog=null;

  function getAC(){
    if (AC && AC.state!=='closed') return AC;
    if (!AudioCtx) return null;
    AC = new AudioCtx();
    MASTER = AC.createGain();
    MASTER.gain.value = .22;
    MASTER.connect(AC.destination);
    return AC;
  }
  async function resume(){ const ac=getAC(); if (!ac) return; if (ac.state === 'suspended'){ try{ await ac.resume(); }catch{} } }
  addEventListener('pointerdown', ()=>{ lastTap=Date.now(); resume(); ping(); }, {passive:true});
  addEventListener('visibilitychange', ()=>{ if(!document.hidden) resume(); });

  if(!watchdog){ watchdog = setInterval(()=>{ const ac=getAC(); if(!ac) return; if(Date.now()-lastTap<30000 && ac.state==='suspended') resume(); }, 1500); }

  function ping(){ try{ const ac=getAC(); if(!ac||ac.state!=='running') return; const o=ac.createOscillator(), g=ac.createGain(); g.gain.value=.0001; o.connect(g).connect(MASTER); const t=ac.currentTime; o.start(t); o.stop(t+.02);}catch{} }
  function chime(){ const ac=getAC(); if(!ac||ac.state!=='running') return; const now=ac.currentTime;
    [880,1320,1760].forEach((f,i)=>{ const o=ac.createOscillator(); o.type='triangle'; o.frequency.value=f;
      const g=ac.createGain(); g.gain.setValueAtTime(.0001,now+i*.02); g.gain.linearRampToValueAtTime(.18,now+i*.02+.04); g.gain.exponentialRampToValueAtTime(.0001,now+i*.02+.32);
      o.connect(g).connect(MASTER); o.start(now+i*.02); o.stop(now+i*.02+.34); });
  }
  function thud(){ const ac=getAC(); if(!ac||ac.state!=='running') return;
    const o=ac.createOscillator(), g=ac.createGain(); o.type='sine';
    const t=ac.currentTime; o.frequency.setValueAtTime(260,t); o.frequency.exponentialRampToValueAtTime(140,t+.22);
    g.gain.setValueAtTime(.0001,t); g.gain.linearRampToValueAtTime(.10,t+.02); g.gain.exponentialRampToValueAtTime(.0001,t+.25);
    o.connect(g).connect(MASTER); o.start(t); o.stop(t+.27);
  }
  window.__bagAudio = { chime, thud, resume };
})();
</script>

<!-- PRICES (identical engine & keys to Dice) -->
<script>
(function(){
  const PRICE_REFRESH_MS = 15000, FETCH_TIMEOUT_MS = 8000, LIVE_CACHE_TTL_MS = 86400000, VIEW_CACHE_TTL_MS = 21600000;
  const XRPL_WSS = 'wss://s1.ripple.com', BAG_ISSUER = 'rNeYbfb9EDV8c7mNfUuooEEYYzMcEuDFbr', BAG_CODE = 'BAG';
  const VIEW_CACHE_KEY = 'bag_prices_v8', LAST_LIVE_KEY='bag_last_live_v1', XRP_KEY='xrp_usd';
  const PRICES = (window.__PRICES__ = window.__PRICES__ || { bagUsd:0, xrpUsd:0, source:'‚Äî', ts:0 });

  const liveDot=document.getElementById('liveDot'), liveBAG=document.getElementById('liveBAG'), liveXRP=document.getElementById('liveXRP'), liveNote=document.getElementById('liveNote'), liveConv=document.getElementById('liveConv');
  function fmt(n){ return Number.isFinite(n)? n.toLocaleString(undefined,{maximumFractionDigits:6}) : '‚Äî'; }
  function cacheSet(k,v){ try{ localStorage.setItem(k, JSON.stringify({t:Date.now(), v})); }catch{} }
  function cacheGet(k,ttl){ try{ const o=JSON.parse(localStorage.getItem(k)||'null'); if(!o) return null; return (Date.now()-(o.t||0) <= ttl) ? o.v : null; }catch{ return null; } }
  function timedFetch(url,opts={},timeout=FETCH_TIMEOUT_MS){ const ctrl=new AbortController(); const id=setTimeout(()=>ctrl.abort(new Error('timeout')),timeout);
    try{ const u=new URL(url,location.origin); u.searchParams.set('_ts',Date.now().toString()); return fetch(u.toString(),{...opts,headers:{Accept:'application/json',...(opts.headers||{})},mode:'cors',cache:'no-store',credentials:'omit',referrerPolicy:'no-referrer',signal:ctrl.signal}); } finally { setTimeout(()=>clearTimeout(id),0); } }
  function updateLiveLine(){
    if (liveBAG) liveBAG.textContent=fmt(PRICES.bagUsd);
    if (liveXRP) liveXRP.textContent=Number.isFinite(PRICES.xrpUsd)?PRICES.xrpUsd.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}):'‚Äî';
    if (liveDot) liveDot.className=(PRICES.source==='live-amm'?'ok':PRICES.source==='last-live'?'warn':'err');
    if (liveNote) liveNote.textContent=(PRICES.source==='live-amm'?' (AMM live)':PRICES.source==='last-live'?' (last live)':' (unavailable)');
    if (liveConv){
      if(PRICES.bagUsd>0 && PRICES.xrpUsd>0){
        const xrpPerBag=PRICES.bagUsd/PRICES.xrpUsd, bagPerXrp=PRICES.xrpUsd/PRICES.bagUsd;
        liveConv.textContent=`1 BAG ‚âà ${xrpPerBag.toLocaleString(undefined,{maximumFractionDigits:6})} XRP ¬∑ 1 XRP ‚âà ${bagPerXrp.toLocaleString(undefined,{maximumFractionDigits:6})} BAG`;
      } else liveConv.textContent='1 BAG ‚âà ‚Äî XRP ¬∑ 1 XRP ‚âà ‚Äî BAG';
    }
    try{ window.dispatchEvent(new CustomEvent('bag:pricesUpdated')); }catch{}
  }
  async function fetchXrpUsdLive(){ try{ const r=await timedFetch('https://api.coingecko.com/api/v3/simple/price?ids=ripple&vs_currencies=usd'); if(!r.ok) throw 0; const v=(await r.json())?.ripple?.usd; if(Number(v)>0){ PRICES.xrpUsd=Number(v); cacheSet(XRP_KEY,PRICES.xrpUsd); return true; } }catch{} return false; }
  function parseXrpAmount(a){ if(a==null)return null; if(typeof a==='string') return Number(a)/1_000_000; if(typeof a==='object'&&a.currency==='XRP') return Number(a.value); return null; }
  function parseIouAmount(a){ if(!a||typeof a!=='object') return null; return Number(a.value); }
  async function fetchBagViaAMMLive(){
    const req={id:1,command:'amm_info',asset:{currency:BAG_CODE,issuer:BAG_ISSUER},asset2:{currency:'XRP'}};
    const xrpPerBag=await new Promise((resolve)=>{
      const ws=new WebSocket(XRPL_WSS); const t=setTimeout(()=>{ try{ws.close();}catch{}; resolve(null); },8000);
      ws.onopen=()=>ws.send(JSON.stringify(req)); ws.onerror=()=>{ clearTimeout(t); try{ws.close();}catch{}; resolve(null); };
      ws.onmessage=(ev)=>{ try{ const msg=JSON.parse(ev.data); if(msg.id!==1||!msg.result||!msg.result.amm) return;
        clearTimeout(t); try{ws.close();}catch{}; const amm=msg.result.amm; const bagBal=parseIouAmount(amm.amount); const xrpBal=parseXrpAmount(amm.amount2);
        if(!(bagBal>0) || !(xrpBal>0)) return resolve(null); const price=xrpBal/bagBal; if(!(price>0)||!isFinite(price)) return resolve(null); resolve(price);
      }catch{ resolve(null); } };
    });
    if(!(xrpPerBag>0)) return false; if(!(PRICES.xrpUsd>0)) return false;
    PRICES.bagUsd=PRICES.xrpUsd*xrpPerBag; PRICES.source='live-amm';
    cacheSet(LAST_LIVE_KEY,{bagUsd:PRICES.bagUsd,xrpUsd:PRICES.xrpUsd}); cacheSet(VIEW_CACHE_KEY,{bagUsd:PRICES.bagUsd,xrpUsd:PRICES.xrpUsd}); return true;
  }
  function loadLastLiveBundle(){ const v=cacheGet(LAST_LIVE_KEY,LIVE_CACHE_TTL_MS); if(v && Number(v.bagUsd)>0){ PRICES.bagUsd=Number(v.bagUsd); if(Number(v.xrpUsd)>0) PRICES.xrpUsd=Number(v.xrpUsd); PRICES.source='last-live'; return true; } return false; }
  function loadViewCache(){ const v=cacheGet(VIEW_CACHE_KEY,VIEW_CACHE_TTL_MS), x=cacheGet(XRP_KEY,VIEW_CACHE_TTL_MS); let ok=false;
    if(v && Number(v.bagUsd)>0){ PRICES.bagUsd=Number(v.bagUsd); if(Number(v.xrpUsd)>0) PRICES.xrpUsd=Number(v.xrpUsd); ok=true; }
    if(!PRICES.xrpUsd && Number(x)>0){ PRICES.xrpUsd=Number(x); ok=true; }
    if(ok && PRICES.source==='‚Äî') PRICES.source='last-live'; return ok;
  }
  async function refreshPrices(){ const gotX=await fetchXrpUsdLive(); const gotB=await fetchBagViaAMMLive(); if(!(gotX && gotB)){ if(!loadLastLiveBundle()) loadViewCache(); } updateLiveLine(); }
  (async ()=>{ await refreshPrices(); setInterval(refreshPrices, PRICE_REFRESH_MS); })();
  window.addEventListener('storage', (e)=>{ if (e.key===VIEW_CACHE_KEY || e.key===XRP_KEY || e.key===LAST_LIVE_KEY){ if(!loadLastLiveBundle()) loadViewCache(); updateLiveLine(); } });
})();
</script>

<!-- USD autofill + payouts + limits + PRESETS (same behavior as Dice) -->
<script>
(function(){
  const usdBetEl=document.getElementById('usdBet'), betQtyEl=document.getElementById('betQty'), curToggle=document.getElementById('curToggle'), unitSpan=document.querySelector('.unit');
  const payBJ=document.getElementById('payBJ'), payWin=document.getElementById('payWin'), payPush=document.getElementById('payPush');
  const betLimits=document.getElementById('betLimits'), presets=document.getElementById('usdPresets');
  const MIN_USD=1, MAX_USD=2000; const PR=()=>window.__PRICES__||{bagUsd:0,xrpUsd:0};

  function currentCurrency(){ const el=curToggle?.querySelector('input[name="betCur"]:checked'); return el?String(el.value).toUpperCase():'XRP'; }
  function priceForCurrent(){ const {bagUsd,xrpUsd}=PR(); return currentCurrency()==='BAG'?bagUsd:xrpUsd; }
  function qty(){ const v=parseFloat(betQtyEl?.value||''); return Number.isFinite(v)&&v>0?v:1; }
  function derivedUsd(){ const px=priceForCurrent(), q=qty(); return px>0?q*px:0; }
  function fmt(n,max=6){ return Number.isFinite(n)? n.toLocaleString(undefined,{maximumFractionDigits:max}) : '‚Äî'; }
  function usd(n){ return '$'+(Number(n)||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }

  function clearPresetActive(){ try{ presets?.querySelectorAll('.preset-chip.active').forEach(b=>b.classList.remove('active')); }catch{} }
  function setFromUsd(value){
    const u=Math.max(0,Math.min(MAX_USD,Number(value)||0));
    if(usdBetEl){ usdBetEl.value=u?u.toFixed(2):''; usdBetEl.dataset.userTyped=u?'1':'0'; }
    const px=priceForCurrent();
    if(betQtyEl){ betQtyEl.value=(px>0 && u>0)? (Math.floor((u/px)*1e6)/1e6) : ''; }
    updatePayouts(); renderLimits(); window.dispatchEvent(new CustomEvent('bag:hudRefresh'));
  }
  function autoFillUsd(){
    if(!usdBetEl || usdBetEl.dataset.userTyped==='1') return;
    const v=derivedUsd(); usdBetEl.value=v? (Math.round(v*100)/100).toFixed(2) : ''; usdBetEl.dataset.autofill=v?'1':'0';
  }
  function updatePayouts(){
    const {bagUsd}=PR(); const q=qty(); const isBAG=currentCurrency()==='BAG';
    const bagStake = isBAG ? q : (bagUsd>0 ? q*(PR().xrpUsd/bagUsd) : 0);
    const usdStake = (function(){ const d=parseFloat(usdBetEl?.value||''); return Number.isFinite(d)&&d>0?d:derivedUsd(); })();
    const mBJ=2.00, mW=1.25, mP=1.00;
    if(payBJ)  payBJ.textContent  = `${fmt(bagStake*mBJ)} BAG (${usd(usdStake*mBJ)})`;
    if(payWin) payWin.textContent = `${fmt(bagStake*mW)} BAG (${usd(usdStake*mW)})`;
    if(payPush)payPush.textContent= `${fmt(bagStake*mP)} BAG (${usd(usdStake*mP)})`;
  }
  function renderLimits(){
    const uv=(function(){ const d=parseFloat(usdBetEl?.value||''); return Number.isFinite(d)&&d>0?d:derivedUsd(); })()||0;
    const warn = (uv>0 && uv<MIN_USD)?` ¬∑ <span style="color:#e8a85c">Min $${MIN_USD.toFixed(2)}</span>` : (uv>MAX_USD?` ¬∑ <span style="color:#e8a85c">Max $${MAX_USD.toFixed(2)}</span>`:'');
    if(betLimits) betLimits.innerHTML=`Limits: $${MIN_USD.toFixed(2)}‚Äì$${MAX_USD.toFixed(2)} ¬∑ Your stake ‚âà $${uv.toFixed(2)}${warn}`;
  }

  usdBetEl?.addEventListener('input', ()=>{ clearPresetActive(); usdBetEl.dataset.userTyped=(usdBetEl.value&&usdBetEl.value.length)?'1':'0'; updatePayouts(); renderLimits(); });
  betQtyEl?.addEventListener('input', ()=>{ clearPresetActive(); autoFillUsd(); updatePayouts(); renderLimits(); });
  curToggle?.addEventListener('change', ()=>{ const span=document.querySelector('.unit'); if(span) span.textContent=currentCurrency();
    if(usdBetEl?.dataset.userTyped==='1'){ const val=parseFloat(usdBetEl.value)||0; setFromUsd(val); } else { autoFillUsd(); updatePayouts(); renderLimits(); } });
  window.addEventListener('bag:pricesUpdated', ()=>{ if(usdBetEl?.dataset.userTyped==='1'){ const val=parseFloat(usdBetEl.value)||0; setFromUsd(val); } else { autoFillUsd(); updatePayouts(); renderLimits(); } });

  presets?.addEventListener('click',(e)=>{ const b=e.target.closest('.preset-chip'); if(!b) return; clearPresetActive(); b.classList.add('active');
    const d=b.dataset.usd; const val=(d==='max')?2000:Math.max(0,Number(d)||0); setFromUsd(val); });

  const span=document.querySelector('.unit'); if(span) span.textContent=currentCurrency();
  autoFillUsd(); updatePayouts(); renderLimits();
})();
</script>

<!-- BLACKJACK: game logic using Dice's locked-stake & demo/live behavior -->
<script>
(function(){
  const dealBtn   = document.getElementById('dealBtn');
  const hitBtn    = document.getElementById('hitBtn');
  const standBtn  = document.getElementById('standBtn');
  const doubleBtn = document.getElementById('doubleBtn');
  const splitBtn  = document.getElementById('splitBtn');
  const againBtn  = document.getElementById('againBtn');

  const dealerCards = document.getElementById('dealerCards');
  const playerCards = document.getElementById('playerCards');
  const dealerTotal = document.getElementById('dealerTotal');
  const playerTotal = document.getElementById('playerTotal');
  const splitArea   = document.getElementById('splitArea');
  const statusText  = document.getElementById('statusText');

  const betQtyEl = document.getElementById('betQty');
  const usdBetEl = document.getElementById('usdBet');
  const curToggle = document.getElementById('curToggle');

  const PR = ()=>window.__PRICES__||{bagUsd:0,xrpUsd:0};
  const MIN_USD=1, MAX_USD=2000;

  // HUD "Last" (Blackjack-local)
  window.__BJ_LAST__ = window.__BJ_LAST__ || '‚Äî';
  function setLast(s){ try{ window.__BJ_LAST__ = s; window.dispatchEvent(new CustomEvent('bag:hudRefresh')); }catch{} }

  function currentCurrency(){ const el=curToggle?.querySelector('input[name="betCur"]:checked'); return el?String(el.value).toUpperCase():'XRP'; }
  function stakeBag(){
    const q=parseFloat(betQtyEl?.value||0)||0; if(!q) return 0; const {bagUsd,xrpUsd}=PR();
    if(currentCurrency()==='BAG') return q; if(bagUsd>0 && xrpUsd>0) return q*(xrpUsd/bagUsd); return 0;
  }
  function stakeUsd(){
    const direct=parseFloat(usdBetEl?.value||'');
    if(Number.isFinite(direct)&&direct>0) return direct;
    const q=parseFloat(betQtyEl?.value||0)||0; const {bagUsd,xrpUsd}=PR();
    if(currentCurrency()==='BAG') return bagUsd>0 ? q*bagUsd : 0;
    return xrpUsd>0 ? q*xrpUsd : 0;
  }
  function fmtUsd(n){ return '$'+(Number(n)||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }

  // Config
  const CONFIG = { decks:1, hitSoft17:true, allowDouble:true, allowSplit:true, mBJ:2.00, mWIN:1.25, mPUSH:1.00 };

  // Shoe & helpers
  let shoe=[];
  function buildShoe(){ const R=['A','2','3','4','5','6','7','8','9','10','J','Q','K'], S=['‚ô†','‚ô•','‚ô¶','‚ô£']; const t=[]; for(let d=0;d<CONFIG.decks;d++) for(const r of R) for(const s of S) t.push({r,s}); for(let i=t.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [t[i],t[j]]=[t[j],t[i]]; } shoe=t; }
  function draw(){ if(!shoe.length) buildShoe(); return shoe.pop(); }
  function val(hand){ let t=0,a=0; for(const c of hand){ if(c.r==='A'){t+=11;a++;} else if(['K','Q','J','10'].includes(c.r)) t+=10; else t+=parseInt(c.r,10); } while(t>21 && a>0){ t-=10; a--; } return {total:t, soft:(a>0 && t<=21)}; }
  function isBJ(h){ if(h.length!==2) return false; const v=h.map(c=>c.r); return v.includes('A') && ['10','J','Q','K'].some(x=>v.includes(x)); }
  function canSplit(h){ if(!CONFIG.allowSplit || STATE.split) return false; if(h.length!==2) return false; const fv=(x)=>x.r==='A'?11:(['K','Q','J','10'].includes(x.r)?10:parseInt(x.r,10)); return fv(h[0])===fv(h[1]); }

  // Rendering
  function cardEl(c,back=false){ const el=document.createElement('div'); el.className= back? 'card back':'card '+(['‚ô•','‚ô¶'].includes(c.s)?'red':'black');
    if(!back) el.innerHTML = `<div class="corner tl">${c.r}<br>${c.s}</div><div class="pip">${c.s}</div><div class="corner br">${c.r}<br>${c.s}</div>`; return el; }
  function clearTable(){ dealerCards.innerHTML=''; playerCards.innerHTML=''; splitArea.innerHTML=''; dealerTotal.textContent='0'; playerTotal.textContent='0'; }
  function addSplitRow(i){ const row=document.createElement('div'); row.className='hand'; row.innerHTML=`<div class="label">You (Hand ${i+1})</div><div class="total" id="pT_${i}">0</div><div class="cards" id="pC_${i}"></div>`; splitArea.appendChild(row); }
  function updateTotals(){ dealerTotal.textContent=val(STATE.dealer).total;
    if(STATE.hands.length===1){ playerTotal.textContent=val(STATE.hands[0]).total; }
    else{ STATE.hands.forEach((h,i)=>{ const t=val(h).total; (i===0?playerTotal:document.getElementById('pT_'+i)).textContent=t; }); } }
  function setStatus(t,cls){ statusText.className='result'+(cls?(' t '+cls):''); statusText.textContent=t; }

  // Session wrappers (live only spends/credits; demo just simulates like Dice)
  function spendBAG(n){ if(!(n>0)) return true; try{ return !!(__bagSession && __bagSession.spend && __bagSession.spend(n)); }catch{ return false; } }
  function creditBAG(n){ if(!(n>0)) return; try{ __bagSession && __bagSession.credit && __bagSession.credit(n);}catch{} }

  // Round state with locked stake
  const STATE = { dealer:[], hands:[], active:0, split:false, locked:0, usdLocked:0, live:false };

  function lockStake(){
    const sBag = stakeBag(), sUsd = stakeUsd();
    const starting = true;
    if (!window.__BAG_FORCE_DEMO){
      if (!(sUsd>=MIN_USD) || sUsd>MAX_USD) return [false,`Stake must be $${MIN_USD.toFixed(2)}‚Äì$${MAX_USD.toFixed(2)}`];
      if (!(sBag>0)) return [false,'Enter a stake first'];
      if (!spendBAG(sBag)) return [false,'Insufficient balance'];
    } else {
      // Demo: no spend, just lock snapshots (same as Dice)
      if (!(sBag>0)) return [false,'Enter a stake first'];
    }
    STATE.locked=sBag; STATE.usdLocked=sUsd; return [true,''];
  }

  function revealHole(){ const backs=[...dealerCards.children].filter(n=>n.classList.contains('back')); if(backs[0]) backs[0].replaceWith(cardEl(STATE.dealer[1],false)); updateTotals(); }
  function hit(i){ const node=(STATE.hands.length===1)?playerCards:(i===0?playerCards:document.getElementById('pC_'+i));
    const c=draw(); STATE.hands[i].push(c); node.appendChild(cardEl(c)); updateTotals(); }
  function nextHandOrDealer(){
    if(STATE.hands.length>1){
      STATE.active++;
      if(STATE.active<STATE.hands.length){
        doubleBtn.disabled = !(STATE.hands[STATE.active].length===2);
        hitBtn.disabled=false; standBtn.disabled=false;
        setStatus(`Hand ${STATE.active+1}: your move`); return;
      }
    }
    dealerPhase();
  }
  function dealerPhase(){
    revealHole();
    let dv=val(STATE.dealer);
    while(dv.total<17 || (dv.total===17 && dv.soft && CONFIG.hitSoft17)){
      const c=draw(); STATE.dealer.push(c); dealerCards.appendChild(cardEl(c)); dv=val(STATE.dealer);
    }
    updateTotals(); settleAll();
  }

  function settleAll(override){
    let totalCredit=0; const base=STATE.locked; const usd=STATE.usdLocked;

    function doHand(h){
      const pv=val(h).total, dv=val(STATE.dealer).total; const doubled=h._dbl===true; const stake=base*(doubled?2:1);

      if(override==='blackjack'){
        totalCredit += stake*CONFIG.mBJ;
        setStatus('Blackjack ‚Äî paid 2.00√ó','win'); setLast('Blackjack 2√ó');
        showWin({ message:'BLACKJACK', subtext:`+${(stake*(CONFIG.mBJ-1)).toLocaleString(undefined,{maximumFractionDigits:6})} BAG ¬∑ ${fmtUsd(usd)} ‚Üí ${fmtUsd(usd*CONFIG.mBJ)}` });
        return;
      }
      if(override==='push-bj'){ totalCredit += stake*CONFIG.mPUSH; setStatus('Push (both Blackjack) ‚Äî stake returned','push'); setLast('Push'); return; }

      if(pv>21){ setStatus('Busted ‚Äî dealer wins','lose'); setLast('Scratch'); try{ window.__bagAudio && __bagAudio.thud(); }catch{}; return; }
      if(dv>21 || pv>dv){
        const mult=(isBJ(h)&&!doubled&&!STATE.split)?CONFIG.mBJ:CONFIG.mWIN;
        totalCredit += stake*mult;
        const sub=`+${(stake*(mult-1)).toLocaleString(undefined,{maximumFractionDigits:6})} BAG ¬∑ ${fmtUsd(usd)} ‚Üí ${fmtUsd(usd*mult)}`;
        setStatus(mult===CONFIG.mBJ?'Blackjack ‚Äî 2.00√ó':`You win ${CONFIG.mWIN.toFixed(2)}√ó`,'win');
        setLast(mult===CONFIG.mBJ?'Blackjack 2√ó':'Win 1.25√ó'); showWin({ message: mult===CONFIG.mBJ?'BLACKJACK':'WIN', subtext: sub });
      } else if(pv<dv){
        setStatus('Dealer wins','lose'); setLast('Scratch'); try{ window.__bagAudio && __bagAudio.thud(); }catch{}
      } else { totalCredit += stake*CONFIG.mPUSH; setStatus('Push ‚Äî stake returned','push'); setLast('Push'); }
    }

    if(STATE.hands.length===1) doHand(STATE.hands[0]); else STATE.hands.forEach(doHand);
    if(!window.__BAG_FORCE_DEMO && totalCredit>0) creditBAG(totalCredit);

    hitBtn.disabled=true; standBtn.disabled=true; doubleBtn.disabled=true; splitBtn.disabled=true; dealBtn.disabled=true; againBtn.style.display='inline-block';
    STATE.live=false;
  }

  function startRound(){
    const [ok,err]=lockStake(); if(!ok) return alert(err);
    clearTable(); STATE.dealer=[]; STATE.hands=[[]]; STATE.active=0; STATE.split=false; STATE.live=true;
    document.getElementById('betLbl').textContent=String(parseFloat(betQtyEl.value||0)||0);

    const c1=draw(), c2=draw(), c3=draw(), c4=draw();
    STATE.hands[0].push(c1); playerCards.appendChild(cardEl(c1));
    STATE.dealer.push(c2); dealerCards.appendChild(cardEl(c2));
    STATE.hands[0].push(c3); playerCards.appendChild(cardEl(c3));
    STATE.dealer.push(c4); dealerCards.appendChild(cardEl(c4,true));
    updateTotals();

    dealBtn.disabled=true; hitBtn.disabled=false; standBtn.disabled=false; doubleBtn.disabled=false; splitBtn.disabled=!canSplit(STATE.hands[0]); againBtn.style.display='none';
    setStatus('Play your hand'); setLast('Dealt');

    if(isBJ(STATE.hands[0])){
      revealHole(); const dBJ=isBJ(STATE.dealer);
      settleAll(dBJ?'push-bj':'blackjack');
    }
  }

  // Buttons
  dealBtn.addEventListener('click', startRound);
  hitBtn.addEventListener('click', ()=>{ doubleBtn.disabled=true; hit(STATE.active);
    if(val(STATE.hands[STATE.active]).total>21){ setStatus(`Hand ${STATE.hands.length>1?STATE.active+1:''} busts`,'lose'); nextHandOrDealer(); }});
  standBtn.addEventListener('click', ()=>{ setStatus(`Hand ${STATE.hands.length>1?STATE.active+1:''} stands`); nextHandOrDealer(); });
  doubleBtn.addEventListener('click', ()=>{
    const h=STATE.hands[STATE.active]; if(h.length!==2) return alert('Double only on first action');
    if(!window.__BAG_FORCE_DEMO){ if(!spendBAG(STATE.locked)) return alert('Insufficient balance'); }
    h._dbl=true; hit(STATE.active); nextHandOrDealer();
  });
  splitBtn.addEventListener('click', ()=>{
    const h=STATE.hands[0]; if(!canSplit(h)) return;
    if(!window.__BAG_FORCE_DEMO){ if(!spendBAG(STATE.locked)) return alert('Insufficient balance'); }
    STATE.split=true; const a=h[0], b=h[1]; STATE.hands=[[a],[b]];
    playerCards.innerHTML=''; playerTotal.textContent='0'; splitArea.innerHTML=''; addSplitRow(1);
    playerCards.appendChild(cardEl(a)); document.getElementById('pC_1').appendChild(cardEl(b));
    hit(0); hit(1); updateTotals(); STATE.active=0; splitBtn.disabled=true; doubleBtn.disabled=false; setStatus('Split ‚Äî play Hand 1');
  });
  againBtn.addEventListener('click', ()=>{ clearTable(); dealBtn.disabled=false; hitBtn.disabled=true; standBtn.disabled=true; doubleBtn.disabled=true; splitBtn.disabled=true; againBtn.style.display='none'; setStatus('Place a stake, then Deal'); setLast('‚Äî'); });

  // HUD (same style as Dice, but reads BJ "last")
  (function(){
    const curToggle = document.getElementById('curToggle');
    function PR(){ return window.__PRICES__ || { bagUsd:0, xrpUsd:0 }; }
    function fmt(n, max=6){ const x=Number(n); if(!Number.isFinite(x)) return '‚Äî'; return x.toLocaleString(undefined,{maximumFractionDigits:max}); }
    function els(){ return { balLbl:document.getElementById('balLbl'), ccyLbl:document.getElementById('ccyLbl'), betLbl:document.getElementById('betLbl'), modeLbl:document.getElementById('modeLbl'), lastLbl:document.getElementById('lastLbl'), betQtyEl:document.getElementById('betQty') }; }
    function selectedMode(){ return (window.__BAG_FORCE_DEMO === true) ? 'Demo' : 'Live'; }
    function currentCurrency(){ const el=curToggle?.querySelector('input[name="betCur"]:checked'); return el?String(el.value).toUpperCase():'XRP'; }
    function getBalances(){
      const sess=(window.__bagSession && window.__bagSession.get && window.__bagSession.get())||{};
      const bag=Number(sess.bag)||0; let xrp=Number(sess.xrp);
      if(!(xrp>0)){ const {bagUsd,xrpUsd}=PR(); if(bagUsd>0 && xrpUsd>0) xrp=bag*(bagUsd/xrpUsd); else xrp=0; }
      return { bag, xrp };
    }
    function currentBet(){ const {betQtyEl}=els(); const v=parseFloat(betQtyEl?.value||'0'); if(!Number.isFinite(v)||v<0) return 0; return Math.max(0, Math.floor(v)); }
    function renderHud(){
      try{
        const { balLbl, ccyLbl, betLbl, modeLbl, lastLbl }=els();
        const mode=selectedMode(); const ccy=currentCurrency(); const {bag,xrp}=getBalances();
        if(modeLbl) modeLbl.textContent=mode;
        if(betLbl)  betLbl.textContent=String(currentBet());
        if(lastLbl) lastLbl.textContent=String(window.__BJ_LAST__||'‚Äî');
        if(balLbl && ccyLbl){ if(ccy==='XRP'){ balLbl.textContent=fmt(xrp,6); ccyLbl.textContent='XRP'; } else { balLbl.textContent=fmt(bag,6); ccyLbl.textContent='BAG'; } }
      }catch(e){}
    }
    ['bag:sessionStarted','bag:sessionToppedUp','bag:sessionEnded','bag:pricesUpdated','bag:walletConnected','bag:walletDisconnected','bag:hudRefresh'].forEach(ev=>addEventListener(ev,renderHud));
    document.getElementById('betQty')?.addEventListener('input', renderHud);
    curToggle?.addEventListener('change', renderHud);
    addEventListener('storage',(e)=>{ if(e && e.key==='__bag_demo_bag_v1') renderHud(); });
    renderHud(); let tries=0; const iv=setInterval(()=>{ renderHud(); if(++tries>40) clearInterval(iv); },500);
  })();

  // Boot
  function boot(){
    buildShoe();
    if(!usdBetEl.value){
      usdBetEl.value='1.00';
      usdBetEl.dispatchEvent(new Event('input',{bubbles:true}));
    }
    setStatus('Place a stake, then Deal');
  }
  boot();
  setInterval(()=>{ if(shoe.length<15) buildShoe(); }, 2000);
})();
</script>

<!-- Practice Mode Wrapper (Demo default; Live only with ?live=1) ‚Äî identical behavior to Dice -->
<script>
(function(){
  const qs=new URLSearchParams(location.search); const forceLive = qs.get('live') === '1';

  const $=(s)=>document.querySelector(s);
  const statusEl=$('#sessionStatus'), startBtn=$('#startSessionBtn'), topUpBtn=$('#topUpBtn'), endBtn=$('#endSessionBtn'), connectEl=$('#connectBtn'), connectStatus=$('#connectStatus');

  const DEMO_KEY='__bag_demo_bag_v1'; // same key as Dice so balance is shared
  const START_BAG=1000;

  function getBal(){ try{ const n=Number(localStorage.getItem(DEMO_KEY)); return Number.isFinite(n)&&n>0?n:START_BAG; }catch{ return START_BAG; } }
  function setBal(v){ try{ localStorage.setItem(DEMO_KEY,String(Math.max(0,Number(v)))) }catch{} }
  if(localStorage.getItem(DEMO_KEY)==null) setBal(START_BAG);

  function fmt(n){ if(!Number.isFinite(n)) return '‚Äî'; if(Math.abs(n)>=1) return n.toLocaleString(undefined,{maximumFractionDigits:4});
    if(Math.abs(n)>=1e-2) return n.toLocaleString(undefined,{maximumFractionDigits:6});
    if(Math.abs(n)>=1e-4) return n.toLocaleString(undefined,{maximumFractionDigits:8});
    return n.toLocaleString(undefined,{maximumFractionDigits:10}); }
  function fmtUsd(n){ return '$'+(Number(n)||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }

  function renderDemo(){
    const bag=getBal(), bagUsd=(window.__PRICES__?.bagUsd||0)*bag;
    if(statusEl){ statusEl.innerHTML='Practice: <span style="color:#2fbf6b)">'+fmt(bag)+' BAG</span>' + (bagUsd?` <span class="micro" style="opacity:.75">(${fmtUsd(bagUsd)})</span>`:''); }
    if(startBtn) startBtn.style.display='inline-block';
    if(topUpBtn) topUpBtn.style.display='none';
    if(endBtn)   endBtn.style.display='none';
  }

  const demoSession={
    active:()=>true,
    get:()=>({addr:'demo',bag:getBal(),ts:Date.now()}),
    set:()=>{},
    spend(bag){ const b=getBal(); if(!(bag>0)||b<bag) return false; setBal(b-bag); renderDemo(); return true; },
    credit(bag){ if(!(bag>0)) return false; setBal(getBal()+bag); renderDemo(); return true; }
  };

  function forceBetXRP1(){
    const bet=document.getElementById('betQty'), usd=document.getElementById('usdBet'), unit=document.querySelector('.unit');
    const xrpRadio=document.querySelector('#curToggle input[value="XRP"]');
    if(xrpRadio && !xrpRadio.checked){ xrpRadio.checked=true; xrpRadio.dispatchEvent(new Event('change',{bubbles:true})); }
    if(unit) unit.textContent='XRP';
    if(bet){ bet.value='1'; bet.dispatchEvent(new Event('input',{bubbles:true})); bet.dispatchEvent(new Event('change',{bubbles:true})); }
    if(usd){ usd.dataset.userTyped='0'; usd.dispatchEvent(new Event('input',{bubbles:true})); usd.dispatchEvent(new Event('change',{bubbles:true})); }
    window.dispatchEvent(new CustomEvent('bag:hudRefresh'));
  }

  function enableDemo(){
    try{ Object.defineProperty(window,'__BAG_FORCE_DEMO',{value:true, configurable:true}); }catch{ window.__BAG_FORCE_DEMO=true; }
    window.__bagSession=demoSession; renderDemo();

    forceBetXRP1(); setTimeout(forceBetXRP1,0);
    const once=()=>{ forceBetXRP1(); window.removeEventListener('bag:pricesUpdated',once); };
    window.addEventListener('bag:pricesUpdated', once);

    if(connectEl) connectEl.style.opacity='0.9';
    if(connectStatus) connectStatus.innerHTML = 'Wallet: <span style="color:#e8a85c">not connected</span>';
  }

  function enableLive(){
    window.__BAG_FORCE_DEMO=false;
    // your /js/bag-session.js connection/session flow wires here
    if(connectStatus) connectStatus.innerHTML = 'Wallet: <span style="color:#2fbf6b">connected</span>';
    window.dispatchEvent(new CustomEvent('bag:pricesUpdated'));
  }

  if(forceLive) enableLive(); else enableDemo();
  window.addEventListener('bag:pricesUpdated', ()=>{ if(window.__BAG_FORCE_DEMO) renderDemo(); });
})();
</script>

<!-- HUD updater (Mode / Balance / Bet / Last) re-used style -->
<script>
(function(){
  const curToggle=document.getElementById('curToggle');
  function PR(){ return window.__PRICES__ || { bagUsd:0, xrpUsd:0 }; }
  function fmt(n,max=6){ const x=Number(n); if(!Number.isFinite(x)) return '‚Äî'; return x.toLocaleString(undefined,{maximumFractionDigits:max}); }
  function els(){ return { balLbl:document.getElementById('balLbl'), ccyLbl:document.getElementById('ccyLbl'), betLbl:document.getElementById('betLbl'), modeLbl:document.getElementById('modeLbl'), lastLbl:document.getElementById('lastLbl'), betQtyEl:document.getElementById('betQty') }; }
  function selectedMode(){ return (window.__BAG_FORCE_DEMO === true) ? 'Demo' : 'Live'; }
  function currentCurrency(){ const el=curToggle?.querySelector('input[name="betCur"]:checked'); return el?String(el.value).toUpperCase():'XRP'; }
  function getBalances(){
    const sess=(window.__bagSession && window.__bagSession.get && window.__bagSession.get())||{};
    const bag=Number(sess.bag)||0; let xrp=Number(sess.xrp);
    if(!(xrp>0)){ const {bagUsd,xrpUsd}=PR(); if(bagUsd>0 && xrpUsd>0) xrp=bag*(bagUsd/xrpUsd); else xrp=0; }
    return { bag, xrp };
  }
  function currentBet(){ const {betQtyEl}=els(); const v=parseFloat(betQtyEl?.value||'0'); if(!Number.isFinite(v)||v<0) return 0; return Math.max(0, Math.floor(v)); }
  function renderHud(){
    try{
      const { balLbl, ccyLbl, betLbl, modeLbl, lastLbl }=els();
      const mode=selectedMode(), ccy=currentCurrency(), {bag,xrp}=getBalances();
      if(modeLbl) modeLbl.textContent=mode;
      if(betLbl)  betLbl.textContent=String(currentBet());
      if(lastLbl) lastLbl.textContent=String(window.__BJ_LAST__ || '‚Äî');
      if(balLbl && ccyLbl){ if(ccy==='XRP'){ balLbl.textContent=fmt(xrp,6); ccyLbl.textContent='XRP'; } else { balLbl.textContent=fmt(bag,6); ccyLbl.textContent='BAG'; } }
    }catch(e){}
  }
  ['bag:sessionStarted','bag:sessionToppedUp','bag:sessionEnded','bag:pricesUpdated','bag:walletConnected','bag:walletDisconnected','bag:hudRefresh'].forEach(ev=>addEventListener(ev,renderHud));
  document.getElementById('betQty')?.addEventListener('input', renderHud);
  curToggle?.addEventListener('change', renderHud);
  addEventListener('storage',(e)=>{ if(e && e.key==='__bag_demo_bag_v1') renderHud(); });
  renderHud();
  let tries=0; const iv=setInterval(()=>{ renderHud(); if(++tries>40) clearInterval(iv); },500);
})();
</script>

<script>
if ('serviceWorker' in navigator) { navigator.serviceWorker.register('/service-worker.js').catch(()=>{}); }
</script>

<footer class="footer" style="text-align:center; padding:12px 0; line-height:1.6%;">
  ¬© 2025 $BAG Protocol | getthebag.io | Powered by $XRP
  <br>
  <a href="https://x.com/getthebag_io" target="_blank" rel="noopener" style="color:#e0c66f;text-decoration:none;font-weight:700;"> ùïè @getthebag_io</a> |
  <a href="https://t.me/getthebag_io" target="_blank" rel="noopener" style="color:#e0c66f;text-decoration:none;font-weight:700;">Telegram @getthebag_io</a>
</footer>

</body>
</html>
