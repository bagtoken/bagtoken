<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>$BAG Blackjack</title>

<link rel="preconnect" href="https://api.coingecko.com" crossorigin>
<script src="https://xaman.app/assets/cdn/xumm.min.js"></script>
<script>window.__BAG_FORCE_DEMO = false;</script>

<style>
  *{box-sizing:border-box}
  :root{
    --gold:#ffe175;--bg:#020703;--panel:#0b1b13;--panel2:#0d2217;--muted:#aeb7af;--fg:#f5f7f4;
    --green:#2fbf6b;--line:#173524;--shadow:rgba(0,0,0,.35);
    --lose:#e25b5b; --warn:#e8a85c;
    --content: 1200px;

    /* Cards */
    --card-w: clamp(64px, 10vw, 92px);
    --card-h: calc(var(--card-w)*1.42);
    --corner: clamp(12px,2.4vw,14px);
    --pip: clamp(22px,3.2vw,28px);
  }
  html,body{margin:0;background:var(--bg);color:var(--fg);
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.55}
  img{display:block;max-width:100%;height:auto}
  button,input{font-size:16px}

  .back-casino{
    position:fixed;top:18px;left:18px;z-index:1000;
    background:linear-gradient(180deg,#ffe175 0%,#f5c94c 100%);color:#08130d;text-decoration:none;font-weight:800;
    padding:8px 14px;border-radius:10px;box-shadow:0 4px 0 #b08a19;transition:all .15s ease
  }
  .back-casino:hover{filter:brightness(1.05);box-shadow:0 4px 0 #b08a19,0 14px 28px rgba(255,225,117,.22)}
  .back-casino:active{transform:translateY(1px);box-shadow:0 3px 0 #9a7315}

  .game-header{text-align:center;padding:36px 10px 14px;max-width:var(--content);margin:0 auto}
  .game-header img.hero-img{margin-bottom:10px;filter:drop-shadow(0 10px 24px rgba(46,191,107,.18))}
  .game-header h2{font-size:clamp(1.6rem,5vw,2.4rem);margin:6px 0 0}
  @media (min-width:900px){
    .game-header img.hero-img{width:34vw;max-width:420px;margin-left:auto;margin-right:auto}
  }

  .game-teaser{padding:10px 16px 60px;background:
    radial-gradient(1200px 600px at 10% -10%, #0e2c1d 0%, transparent 60%),
    radial-gradient(900px 500px at 110% 20%, #0b2318 0%, transparent 55%),#060806;
    border-top:1px solid #131313;border-bottom:1px solid #131313}
  .game-wrap{max-width:1080px;margin:0 auto;display:grid;grid-template-columns:1.12fr .88fr;gap:22px}
  @media (max-width:900px){.game-wrap{grid-template-columns:1fr}}

  .panel{background:linear-gradient(180deg,var(--panel) 0%,var(--panel2) 100%);
    border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 24px var(--shadow)}
  .mock{padding:16px}

  .section-title{font-weight:800;font-size:1.2rem;margin:0 0 12px}
  .stake-box{padding:14px}
  .stack{display:grid;gap:10px}
  .choice{display:flex;gap:10px;flex-wrap:wrap}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid #2b6a48;background:#0e2a1c;color:#e9efe9;font-weight:800}
  .chip input{accent-color:#2fbf6b}
  .mono{font-variant-numeric:tabular-nums}
  .micro{font-size:.85rem;color:#a8b5ab}
  .muted{color:#cfd6cf}
  .divider{height:1px;background:#123221;margin:10px 0}
  .callout{margin-top:12px;padding:12px;border:1px dashed #29543d;border-radius:12px;background:#0c2418;color:#e4efe7}
  .payout-grid{display:grid;gap:4px}
  .payout-grid .row{display:flex;justify-content:space-between}
  .payout-grid .lab{color:#cfd6cf}
  .payout-grid .val{font-variant-numeric:tabular-nums}

  #liveDot{margin-right:6px}
  .ok{color:#2fbf6b}
  .warn{color:#e8a85c}
  .err{color:#e25b5b}

  /* Table */
  .table{background:#07140e;border:1px solid #1b4a2f;border-radius:14px;padding:14px}
  .felt{
    display:grid;grid-template-columns:1fr;gap:12px;
    background:#091a13;border:1px solid #24533a;border-radius:12px;padding:12px;overflow:hidden
  }
  .marquee{ text-align:center;font-weight:900;letter-spacing:.08em;
    color:#ffe9a6;background:linear-gradient(180deg,#17311f,#0e2419);
    border:1px solid #254a33;border-radius:12px;padding:8px }
  .stageBJ{ position:relative; padding:12px; background:
      radial-gradient(1400px 700px at 50% -10%, #1a5a3c 0%, #114c33 55%, #0b2a1c 100%);
    border:1px solid #153b27;border-radius:14px; min-height:280px; }

  .titlebar{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:8px}
  .titlebar .sub{font-size:12px;color:#cfd6cf}

  .row{display:flex;justify-content:center;gap:12px;flex-wrap:wrap}
  .hand{min-height:calc(var(--card-h) + 36px);display:flex;align-items:flex-start;gap:12px;position:relative;padding-top:28px}
  .label{position:absolute;top:0;left:0;font-size:12px;color:#cfd6cf}
  .total-badge{position:absolute;top:0;right:0;background:#0f2e20;border:1px solid #1a5136;color:#ffe175;padding:3px 10px;border-radius:999px;font-size:12px}

  .card{
    width:var(--card-w);height:var(--card-h);border-radius:12px;
    background:linear-gradient(180deg,#ffffff, #f3f6f6);
    border:2px solid #e1e1e1;box-shadow:0 10px 20px rgba(0,0,0,.35);
    position:relative;display:grid;place-items:center;font-weight:800;
    transform:translateY(20px);opacity:0;animation:slideIn .18s ease-out forwards;
    will-change:transform,opacity;backface-visibility:hidden
  }
  @keyframes slideIn{to{transform:translateY(0);opacity:1}}
  .card.red{color:#c1121f}
  .card.black{color:#101114}
  .card .corner{position:absolute;font-size:var(--corner);line-height:1.05}
  .card .tl{top:7px;left:8px;text-align:left}
  .card .br{bottom:7px;right:8px;transform:rotate(180deg);text-align:left}
  .card .pip{font-size:var(--pip)}
  .card .suit{width:20px;height:20px;display:inline-block}
  .card.back{
    background:repeating-linear-gradient(45deg,#0b1b13 0px,#0b1b13 6px,#0e2217 6px,#0e2217 12px),
               radial-gradient(#123423,#0f271b);
    border-color:#193d2b
  }

  .btn-row{display:flex;justify-content:center;gap:10px;flex-wrap:wrap}
  .btn{
    width:min(220px,92%);padding:14px 18px;margin-top:2px;
    font-size:clamp(1.0rem,1.1vw,1.15rem);font-weight:900;letter-spacing:.2px;border:0;border-radius:14px;
    color:#08130d;background:linear-gradient(180deg,#ffe175 0%, #f5c94c 100%);
    box-shadow:0 6px 0 #b08a19, 0 16px 32px rgba(255,225,117,.18), inset 0 1px 0 rgba(255,255,255,.35);
    transition:transform .06s ease, box-shadow .2s ease, filter .2s ease; cursor:pointer;
  }
  .btn:active{transform:translateY(2px);box-shadow:0 4px 0 #9a7315,0 12px 24px rgba(255,225,117,.2), inset 0 1px 0 rgba(255,255,255,.3)}
  .btn:disabled{opacity:.55;cursor:not-allowed}
  .btn.s{ width:auto; min-width:140px; }
  .btn.alt{ color:#e9efe9; background:#15261c; box-shadow:none; border:1px solid #2b6a48; }

  .hudbar{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; margin:6px 2px 0; }
  .pill{ background:#0a1e15; border:1px solid #244330; border-radius:999px; padding:6px 10px; font-size:12px; color:#cfe6d8 }
  .hudbar .pill b{ font-weight:800 }

  .msg{margin:8px 0 0;text-align:center;color:#cfd6cf}
  .result{margin-top:10px;padding:12px;border:1px solid #1b4a2f;border-radius:12px;background:#0b2217;display:flex;align-items:center;gap:10px}
  .t.win{color:#2fbf6b}.t.push{color:#e8a85c}.t.lose{color:var(--lose)}

  .preset-chips{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  .preset-chip{
    appearance:none; border:1px solid #2b6a48; background:#0e2a1c; color:#e9efe9;
    border-radius:999px; padding:6px 10px; font-weight:800; cursor:pointer;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.06);
  }
  .preset-chip.active{ background:#173c28; border-color:#3fa86a; box-shadow:0 0 0 2px rgba(63,168,106,.25) inset; }
</style>

<script src="/js/bag-session.js"></script>
</head>
<body>

<a href="/casino/" class="back-casino">‚¨ÖÔ∏è Back to Casino</a>

<section class="game-header">
  <img src="/assets/bag-blackjack.jpeg" alt="$BAG Blackjack" class="hero-img" loading="lazy" decoding="async">
  <h2>üé¥ $BAG BLACKJACK</h2>
  <p class="micro" style="margin-top:4px;opacity:.9;">üí∞ <strong>All payouts settle in $BAG.</strong> $XRP bets convert automatically at the live rate.</p>
</section>

<section class="game-teaser">
  <div class="game-wrap">

    <!-- LEFT: Controls + Table -->
    <div class="panel mock" id="bagBJ">

      <!-- CONNECT -->
      <div id="connectRow" style="display:flex;justify-content:space-between;align-items:center;margin:-2px 0 10px 0%;">
        <div id="connectStatus" class="micro" style="opacity:.9">Wallet: <span style="color:#e8a85c">not connected</span></div>
        <button id="connectBtn" style="padding:10px 14px;font-weight:800;border:0;border-radius:12px;color:#08130d;background:linear-gradient(180deg,#ffe175 0%, #f5c94c 100%);box-shadow:0 4px 0 #b08a19;cursor:pointer;">Connect Xaman</button>
      </div>

      <!-- SESSION -->
      <div id="sessionRow" style="display:flex;justify-content:space-between;align-items:center;margin:6px 0 10px 0%;">
        <div id="sessionStatus" class="micro" style="opacity:.9">Session: <span style="color:#e8a85c">not started</span></div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="startSessionBtn" style="padding:8px 12px;font-weight:800;border:0;border-radius:10px;color:#08130d;background:linear-gradient(180deg,#ffe175 0%, #f5c94c 100%);box-shadow:0 3px 0 #b08a19;cursor:pointer;">Start Session</button>
          <button id="topUpBtn" style="padding:8px 12px;font-weight:800;border:0;border-radius:10px;color:#08130d;background:linear-gradient(180deg,#ffe175 0%, #f5c94c 100%);box-shadow:0 3px 0 #b08a19;cursor:pointer;display:none;">Top Up</button>
          <button id="endSessionBtn" style="padding:8px 12px;font-weight:800;border:0;border-radius:10px;background:#15261c;color:#dfe9e2;border:1px solid #2b6a48;cursor:pointer;display:none;">End</button>
        </div>
      </div>

      <div class="section-title">Stake & Prices</div>
      <div class="stake-box">
        <div class="stack">
          <div>
            <div class="micro">Amount</div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
              <div style="display:flex;align-items:center;gap:6px">
                <input id="usdBet" class="mono" type="number" inputmode="decimal" enterkeyhint="done" min="0" max="2000" step="0.01" placeholder="0.00" style="width:140px;background:#0b2217;border:1px solid #1b4a2f;border-radius:10px;color:#f3f5f0;padding:10px">
                <span class="micro" aria-hidden="true">USD</span>
              </div>
            </div>
            <div class="preset-chips" id="usdPresets" role="group" aria-label="Quick bet">
              <button type="button" class="preset-chip" data-usd="1">$1</button>
              <button type="button" class="preset-chip" data-usd="2">$2</button>
              <button type="button" class="preset-chip" data-usd="5">$5</button>
              <button type="button" class="preset-chip" data-usd="10">$10</button>
              <button type="button" class="preset-chip" data-usd="20">$20</button>
              <button type="button" class="preset-chip" data-usd="50">$50</button>
              <button type="button" class="preset-chip" data-usd="100">$100</button>
              <button type="button" class="preset-chip" data-usd="max">Max</button>
            </div>
          </div>

          <div>
            <div class="micro">Bet currency</div>
            <div class="choice" id="curToggle">
              <label class="chip"><input type="radio" name="betCur" value="XRP" checked> XRP</label>
              <label class="chip"><input type="radio" name="betCur" value="BAG"> BAG</label>
            </div>
          </div>

          <div>
            <div class="micro">Bet amount</div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
              <div>
                <input id="betQty" class="mono" type="number" inputmode="decimal" enterkeyhint="done" min="0" step="any" value="1" style="width:140px;background:#0b2217;border:1px solid #1b4a2f;border-radius:10px;color:#f3f5f0;padding:10px">
                <span class="unit">XRP</span>
              </div>
            </div>
            <div class="micro" id="betLimits" style="margin-top:6px"></div>
          </div>

          <div class="divider"></div>

          <div class="micro">Live prices</div>
          <div class="muted mono" id="liveLine">
            <span id="liveDot" class="warn">‚óè</span>
            <span> BAG $<span id="liveBAG">‚Äî</span> ¬∑ XRP $<span id="liveXRP">‚Äî</span> <span id="liveNote"></span></span>
            <div class="micro" id="liveConv" style="margin-top:4px;opacity:.9;">1 BAG ‚âà ‚Äî XRP ¬∑ 1 XRP ‚âà ‚Äî BAG</div>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Payout preview (per-hand) -->
      <div class="callout mono" id="payoutBox">
        <div class="payout-grid">
          <div class="row"><div class="lab"><strong>Blackjack</strong> (A+10 on deal):</div><div class="val" id="payBJ">‚Äî</div></div>
          <div class="row"><div class="lab"><strong>Regular WIN</strong> (dealer lower):</div><div class="val" id="payWin">‚Äî</div></div>
          <div class="row"><div class="lab"><strong>Push</strong> (tie):</div><div class="val" id="payPush">‚Äî</div></div>
          <div class="row"><div class="lab"><strong>Double</strong> (extra 1√ó stake):</div><div class="val" id="payDouble">‚Äî</div></div>
          <div class="row"><div class="lab"><strong>Split</strong> (extra 1√ó stake):</div><div class="val" id="paySplit">‚Äî</div></div>
        </div>
        <div class="micro" style="margin-top:6px;opacity:.85;">
          Dealer hits <b>soft 17</b>. Blackjack pays <b>2.00√ó</b>. Regular win pays <b>1.25√ó</b>. Push returns stake. Doubling/Splitting immediately locks an additional <b>1√ó</b> stake each.
        </div>
      </div>

      <!-- BLACKJACK table -->
      <div class="marquee">$BAG BLACKJACK</div>
      <div class="table">
        <div class="felt">
          <div class="stageBJ">
            <div class="titlebar">
              <div class="sub">Single deck ¬∑ Dealer hits soft 17 ¬∑ All payouts in $BAG</div>
              <div class="sub"><b>Blackjack 2.00√ó</b> ¬∑ <b>Win 1.25√ó</b> ¬∑ <b>Push refund</b></div>
            </div>

            <div class="row">
              <div class="hand" id="dealerHand">
                <div class="label">Dealer</div>
                <div class="total-badge" id="dealerTotal">0</div>
              </div>
            </div>

            <div class="row" id="playerArea">
              <div class="hand" id="playerHand0">
                <div class="label">You</div>
                <div class="total-badge" id="playerTotal0">0</div>
              </div>
            </div>

            <div class="btn-row" style="margin-top:8px">
              <button id="deal"   class="btn s">Deal</button>
              <button id="hit"    class="btn s" disabled>Hit</button>
              <button id="stand"  class="btn s" disabled>Stand</button>
              <button id="double" class="btn s alt" disabled>Double</button>
              <button id="split"  class="btn s alt" disabled>Split</button>
              <button id="newHand" class="btn s" style="display:none">New Hand</button>
            </div>

            <div class="hudbar" aria-live="polite" id="bjHud">
              <span class="pill">Mode: <b id="modeLbl">Demo</b></span>
              <span class="pill">Balance: <b id="balLbl">‚Äî</b> <span id="ccyLbl">BAG</span></span>
              <span class="pill">Bet: <b id="betLbl">1</b></span>
              <span class="pill">Last: <b id="lastLbl">‚Äî</b></span>
            </div>

            <p class="micro" style="text-align:center;margin-top:8px;opacity:.75;">
              üîä If you don‚Äôt hear sound: tap Deal once, turn off Silent mode, and raise volume.
            </p>

            <div class="result"><div class="t" id="roundText" role="status" aria-live="polite">Place a stake, then Deal</div></div>
            <p class="msg" id="message"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Rules -->
    <div class="panel" style="padding:16px">
      <h3 style="margin:0 0 8px;font-size:1.2rem;">Table Rules</h3>
      <ul style="margin:8px 0 8px 18px;color:#cfd6cf">
        <li>Goal: beat the dealer without going over 21.</li>
        <li>Card values ‚Äî 2‚Äì10 face value; J/Q/K = 10; A = 1 or 11.</li>
        <li>Dealer draws to 17 and <b>hits soft 17</b>.</li>
        <li>Actions: <b>Hit</b>, <b>Stand</b>, <b>Double</b> (first turn only; +1√ó stake), <b>Split</b> (one split; +1√ó stake).</li>
        <li><b>Blackjack 2.00√ó</b> ¬∑ <b>Regular Win 1.25√ó</b> ¬∑ <b>Push</b> = stake returned.</li>
      </ul>
      <p class="micro" style="margin-top:10px">Practice mode enabled ‚Äî on-ledger play wires in after QA. All payouts settle in <b>$BAG</b>. $XRP stakes convert at live rate automatically.</p>
    </div>

  </div>
</section>

<!-- Celebration overlay (same as Dice) -->
<canvas id="win-canvas"></canvas>
<div id="win-overlay" role="dialog" aria-live="polite" aria-label="Win notification">
  <div id="win-card">
    <button id="win-close" aria-label="Close">√ó</button>
    <div id="win-text">WIN</div>
    <div id="win-sub">Nice hand</div>
  </div>
</div>

<!-- Celebration overlay logic (same as Dice) -->
<script>
(function(){
  const overlay=document.getElementById('win-overlay');
  const canvas=document.getElementById('win-canvas');
  const ctx=canvas.getContext('2d');
  const closeBtn=document.getElementById('win-close');
  const sub=document.getElementById('win-sub');
  const title=document.getElementById('win-text');
  let rafId=null, particles=[], start=0, dur=2000;

  function size(){ const dpr=Math.min(devicePixelRatio||1,2);
    canvas.width=innerWidth*dpr; canvas.height=innerHeight*dpr;
    canvas.style.width=innerWidth+'px'; canvas.style.height=innerHeight+'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  size(); addEventListener('resize', size);

  function fire(n){
    particles.length=0;
    const colors=['#ffffff','#00ffb2','#18a0fb','#ffd166','#f72585'];
    for(let i=0;i<n;i++){
      particles.push({x:innerWidth*.5,y:innerHeight*.4,vx:(Math.random()-.5)*6,vy:-(3+Math.random()*5),g:.16,rot:Math.random()*6.28,vr:(Math.random()-.5)*.25,sz:6+Math.random()*10,col:colors[(Math.random()*colors.length)|0],shape:Math.random()<.4?'circle':(Math.random()<.5?'square':'tri')});
    }
  }
  function draw(){ ctx.clearRect(0,0,innerWidth,innerHeight);
    particles.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.vy+=p.g; p.rot+=p.vr;
      ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot); ctx.fillStyle=p.col; const s=p.sz;
      if(p.shape==='circle'){ ctx.beginPath(); ctx.arc(0,0,s*0.6,0,Math.PI*2); ctx.fill(); }
      else if(p.shape==='square'){ ctx.fillRect(-s/2,-s/2,s,s); }
      else { ctx.beginPath(); ctx.moveTo(0,-s/1.2); ctx.lineTo(s/1.2,s/1.2); ctx.lineTo(-s/1.2,s/1.2); ctx.closePath(); ctx.fill(); }
      ctx.restore();
    });
  }
  function anim(ts){ if(!start) start=ts; draw(); if(ts-start<dur){ rafId=requestAnimationFrame(anim); } else stop(); }
  function stop(){ cancelAnimationFrame(rafId); ctx.clearRect(0,0,innerWidth,innerHeight); canvas.style.display='none'; }
  function show(){ overlay.style.display='grid'; }
  function hide(){ overlay.style.display='none'; stop(); }

  closeBtn.addEventListener('click', hide);
  overlay.addEventListener('click', e=>{ if(e.target===overlay) hide(); });
  addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ try{ window.__winTimer && clearTimeout(__winTimer);}catch{}; hide(); }});

  window.showWin=function(opts={}){ 
    const { message='WIN', subtext='Nice hand', sound=true, duration=4000 }=opts;
    title.textContent=message; sub.textContent=subtext; show(); canvas.style.display='block'; fire(180);
    if(sound) try{ window.__bagAudio && __bagAudio.chime(); }catch(e){}
    cancelAnimationFrame(rafId); start=0; dur=2200; rafId=requestAnimationFrame(anim);
    clearTimeout(window.__winTimer); window.__winTimer=setTimeout(hide, Math.max(1200,duration));
  };
})();
</script>

<!-- AUDIO (shared style with Dice) -->
<script>
(function(){
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let AC=null, MASTER=null, lastTap=0, watchdog=null;

  function getAC(){
    if (AC && AC.state!=='closed') return AC;
    if (!AudioCtx) return null;
    AC = new AudioCtx();
    MASTER = AC.createGain();
    MASTER.gain.value = .22;
    MASTER.connect(AC.destination);
    return AC;
  }
  async function resume(){
    const ac = getAC();
    if (!ac) return;
    if (ac.state === 'suspended'){ try{ await ac.resume(); }catch{} }
  }

  addEventListener('pointerdown', ()=>{ lastTap=Date.now(); resume(); ping(); }, {passive:true});
  addEventListener('visibilitychange', ()=>{ if(!document.hidden) resume(); });

  if(!watchdog){
    watchdog = setInterval(()=>{ const ac=getAC(); if(!ac) return;
      if(Date.now()-lastTap<30000 && ac.state==='suspended') resume();
    }, 1500);
  }

  function ping(){
    try{
      const ac=getAC(); if(!ac||ac.state!=='running') return;
      const o=ac.createOscillator(), g=ac.createGain();
      g.gain.value=.0001; o.connect(g).connect(MASTER);
      const t=ac.currentTime; o.start(t); o.stop(t+.02);
    }catch{}
  }

  function blip(){ const ac=getAC(); if(!ac||ac.state!=='running') return; const t=ac.currentTime;
    const o=ac.createOscillator(); o.type='triangle'; o.frequency.value=540;
    const g=ac.createGain(); g.gain.setValueAtTime(.0001,t); g.gain.linearRampToValueAtTime(.12,t+.02); g.gain.exponentialRampToValueAtTime(.0001,t+.2);
    o.connect(g).connect(MASTER); o.start(t); o.stop(t+.22);
  }
  function thud(){ const ac=getAC(); if(!ac||ac.state!=='running') return;
    const o=ac.createOscillator(), g=ac.createGain(); o.type='sine';
    const t=ac.currentTime; o.frequency.setValueAtTime(260,t); o.frequency.exponentialRampToValueAtTime(140,t+.22);
    g.gain.setValueAtTime(.0001,t); g.gain.linearRampToValueAtTime(.10,t+.02); g.gain.exponentialRampToValueAtTime(.0001,t+.25);
    o.connect(g).connect(MASTER); o.start(t); o.stop(t+.27);
  }
  function chime(){ const ac=getAC(); if(!ac||ac.state!=='running') return; const now=ac.currentTime;
    [880,1320,1760].forEach((f,i)=>{ const o=ac.createOscillator(); o.type='triangle'; o.frequency.value=f;
      const g=ac.createGain(); g.gain.setValueAtTime(.0001,now+i*.02); g.gain.linearRampToValueAtTime(.18,now+i*.02+.04); g.gain.exponentialRampToValueAtTime(.0001,now+i*.02+.32);
      o.connect(g).connect(MASTER); o.start(now+i*.02); o.stop(now+i*.02+.34); });
  }
  window.__bagAudio = { chime, thud, blip, resume };
})();
</script>

<!-- PRICES (identical engine to Dice) -->
<script>
/* same price engine as Dice ‚Äî emits window.__PRICES__ + bag:pricesUpdated */
(function(){
  const PRICE_REFRESH_MS = 15000;
  const FETCH_TIMEOUT_MS = 8000;
  const LIVE_CACHE_TTL_MS = 24*60*60*1000;
  const VIEW_CACHE_TTL_MS = 6*60*60*1000;

  const XRPL_WSS = 'wss://s1.ripple.com';
  const BAG_ISSUER = 'rNeYbfb9EDV8c7mNfUuooEEYYzMcEuDFbr';
  const BAG_CODE = 'BAG';

  const VIEW_CACHE_KEY = 'bag_prices_v8';
  const LAST_LIVE_KEY  = 'bag_last_live_v1';
  const XRP_KEY        = 'xrp_usd';

  const PRICES = (window.__PRICES__ = window.PRICES = window.__PRICES__ || window.PRICES || { bagUsd:0, xrpUsd:0, source:'‚Äî', ts:0 });

  const liveDot = document.getElementById('liveDot');
  const liveBAG = document.getElementById('liveBAG');
  const liveXRP = document.getElementById('liveXRP');
  const liveNote = document.getElementById('liveNote');
  const liveConv = document.getElementById('liveConv');

  function fmt(n){ return Number.isFinite(n) ? n.toLocaleString(undefined,{maximumFractionDigits:6}) : '‚Äî'; }
  function cacheSet(k,v){ try{ localStorage.setItem(k, JSON.stringify({t:Date.now(), v})); }catch{} }
  function cacheGet(k, ttlMs){
    try{
      const o=JSON.parse(localStorage.getItem(k)||'null');
      if(!o) return null;
      const age = Date.now() - (o.t||0);
      return age<=ttlMs ? o.v : null;
    }catch{ return null; }
  }
  function timedFetch(url, opts={}, timeout=FETCH_TIMEOUT_MS){
    const ctrl = new AbortController();
    const id = setTimeout(()=>ctrl.abort(new Error('timeout')), timeout);
    try{
      const u = new URL(url, location.origin);
      u.searchParams.set('_ts', Date.now().toString());
      return fetch(u.toString(), {
        ...opts,
        headers: { Accept:'application/json', ...(opts.headers||{}) },
        mode:'cors', cache:'no-store', credentials:'omit', referrerPolicy:'no-referrer',
        signal: ctrl.signal
      });
    } finally { setTimeout(()=>clearTimeout(id),0); }
  }

  function updateLiveLine(){
    if (liveBAG)  liveBAG.textContent  = fmt(PRICES.bagUsd);
    if (liveXRP)  liveXRP.textContent  = Number.isFinite(PRICES.xrpUsd)
      ? PRICES.xrpUsd.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})
      : '‚Äî';
    if (liveDot)  liveDot.className    = (PRICES.source==='live-amm' ? 'ok' : PRICES.source==='last-live' ? 'warn' : 'err');
    if (liveNote) liveNote.textContent = (PRICES.source==='live-amm' ? ' (AMM live)' : PRICES.source==='last-live' ? ' (last live)' : ' (unavailable)');
    if (liveConv){
      if(PRICES.bagUsd>0 && PRICES.xrpUsd>0){
        const xrpPerBag = PRICES.bagUsd/PRICES.xrpUsd;
        const bagPerXrp = PRICES.xrpUsd/PRICES.bagUsd;
        liveConv.textContent = `1 BAG ‚âà ${xrpPerBag.toLocaleString(undefined,{maximumFractionDigits:6})} XRP ¬∑ 1 XRP ‚âà ${bagPerXrp.toLocaleString(undefined,{maximumFractionDigits:6})} BAG`;
      } else {
        liveConv.textContent = '1 BAG ‚âà ‚Äî XRP ¬∑ 1 XRP ‚âà ‚Äî BAG';
      }
    }
    try{
      window.PRICES = window.__PRICES__ = PRICES;
      window.dispatchEvent(new CustomEvent('bag:pricesUpdated'));
    }catch{}
  }

  async function fetchXrpUsdLive(){
    try{
      const r = await timedFetch('https://api.coingecko.com/api/v3/simple/price?ids=ripple&vs_currencies=usd');
      if(!r.ok) throw 0;
      const v = (await r.json())?.ripple?.usd;
      if(Number(v)>0){
        PRICES.xrpUsd = Number(v);
        cacheSet(XRP_KEY, PRICES.xrpUsd);
        return true;
      }
    }catch(_){}
    return false;
  }
  function parseXrpAmount(a){ if (a==null) return null; if (typeof a==='string') return Number(a)/1_000_000; if (typeof a==='object' && a.currency==='XRP') return Number(a.value); return null; }
  function parseIouAmount(a){ if (!a || typeof a!=='object') return null; return Number(a.value); }
  async function fetchBagViaAMMLive(){
    const req = { id:1, command:'amm_info', asset:{currency:BAG_CODE,issuer:BAG_ISSUER}, asset2:{currency:'XRP'} };
    const xrpPerBag = await new Promise((resolve)=>{
      const ws = new WebSocket(XRPL_WSS);
      const t = setTimeout(()=>{ try{ws.close();}catch{}; resolve(null); }, 8000);
      ws.onopen = ()=> ws.send(JSON.stringify(req));
      ws.onerror = ()=>{ clearTimeout(t); try{ws.close();}catch{}; resolve(null); };
      ws.onmessage = (ev)=>{
        try{
          const msg = JSON.parse(ev.data);
          if (msg.id!==1 || !msg.result || !msg.result.amm) return;
          clearTimeout(t); try{ws.close();}catch{};
          const amm = msg.result.amm;
          const bagBal = parseIouAmount(amm.amount);
          const xrpBal = parseXrpAmount(amm.amount2);
          if (!(bagBal>0) || !(xrpBal>0)) return resolve(null);
          const price = xrpBal / bagBal;
          if (!(price>0) || !isFinite(price)) return resolve(null);
          resolve(price);
        }catch{ resolve(null); }
      };
    });
    if (!(xrpPerBag>0)) return false;
    if (!(PRICES.xrpUsd>0)) return false;
    PRICES.bagUsd = PRICES.xrpUsd * xrpPerBag;
    PRICES.source = 'live-amm';
    cacheSet(LAST_LIVE_KEY, { bagUsd: PRICES.bagUsd, xrpUsd: PRICES.xrpUsd });
    cacheSet(VIEW_CACHE_KEY, { bagUsd: PRICES.bagUsd, xrpUsd: PRICES.xrpUsd });
    return true;
  }

  function loadLastLiveBundle(){
    const v = cacheGet(LAST_LIVE_KEY, LIVE_CACHE_TTL_MS);
    if (v && Number(v.bagUsd)>0){
      PRICES.bagUsd = Number(v.bagUsd);
      if (Number(v.xrpUsd)>0) PRICES.xrpUsd = Number(v.xrpUsd);
      PRICES.source = 'last-live';
      return true;
    }
    return false;
  }
  function loadViewCache(){
    const v = cacheGet(VIEW_CACHE_KEY, VIEW_CACHE_TTL_MS);
    const x = cacheGet(XRP_KEY, VIEW_CACHE_TTL_MS);
    let ok = false;
    if (v && Number(v.bagUsd)>0){
      PRICES.bagUsd = Number(v.bagUsd);
      if (Number(v.xrpUsd)>0) PRICES.xrpUsd = Number(v.xrpUsd);
      ok = true;
    }
    if (!PRICES.xrpUsd && Number(x)>0){ PRICES.xrpUsd = Number(x); ok = true; }
    if (ok && PRICES.source==='‚Äî') PRICES.source = 'last-live';
    return ok;
  }

  async function refreshPrices(){
    let liveOk = false;
    const gotX = await fetchXrpUsdLive();
    const gotBag = await fetchBagViaAMMLive();
    liveOk = gotX && gotBag;
    if (!liveOk){
      if (!loadLastLiveBundle()) loadViewCache();
    }
    PRICES.ts = Date.now();
    updateLiveLine();
  }

  (async ()=>{ await refreshPrices(); setInterval(refreshPrices, PRICE_REFRESH_MS); })();

  window.addEventListener('storage', (e)=>{
    if (e.key === VIEW_CACHE_KEY || e.key === XRP_KEY || e.key === LAST_LIVE_KEY){
      if (!loadLastLiveBundle()) loadViewCache();
      updateLiveLine();
    }
  });
})();
</script>

<!-- ===== DEMO SAFETY SHIM (ensures demo wallet + default $1 stake) ===== -->
<script>
(function(){
  const KEY='__bag_demo_blackjack_v1';
  function seed(){ try{ if(localStorage.getItem(KEY)==null) localStorage.setItem(KEY,'1000'); }catch{} }
  function demoSession(){
    return {
      active:()=>true,
      get:()=>({bag:Number(localStorage.getItem(KEY))||1000, ts:Date.now()}),
      spend:(n)=>{ const b=Number(localStorage.getItem(KEY))||1000; if(!(n>0)) return true; if(b<n) return false; localStorage.setItem(KEY,String(b-n)); window.dispatchEvent(new CustomEvent('bag:hudRefresh')); return true; },
      credit:(n)=>{ const b=Number(localStorage.getItem(KEY))||1000; if(!(n>0)) return true; localStorage.setItem(KEY,String(b+n)); window.dispatchEvent(new CustomEvent('bag:hudRefresh')); return true; }
    };
  }
  seed();

  // Default to DEMO unless explicitly forced live (?live=1)
  const qs = new URLSearchParams(location.search);
  const forceLive = qs.get('live')==='1';
  if (!forceLive) {
    window.__BAG_FORCE_DEMO = true;
    if (!window.__bagSession || !window.__bagSession.active || !window.__bagSession.active()){
      window.__bagSession = demoSession();
    }
  }

  // Prefer a USD stake so it doesn't depend on price timing
  document.addEventListener('DOMContentLoaded', ()=>{
    const usd = document.getElementById('usdBet');
    if (usd && !usd.value){
      usd.value='1.00';
      usd.dataset.userTyped='1';
      usd.dispatchEvent(new Event('input',{bubbles:true}));
      usd.dispatchEvent(new Event('change',{bubbles:true}));
    }
  });
})();
</script>

<!-- USD autofill + payouts + limits + PRESETS (same UX as Dice) -->
<script>
(function(){
  const usdBetEl = document.getElementById('usdBet');
  const betQtyEl = document.getElementById('betQty');
  const curToggle = document.getElementById('curToggle');
  const unitSpan  = document.querySelector('.unit');

  const payBJ  = document.getElementById('payBJ');
  const payWin = document.getElementById('payWin');
  const payPush= document.getElementById('payPush');
  const payDouble = document.getElementById('payDouble');
  const paySplit  = document.getElementById('paySplit');

  const betLimits = document.getElementById('betLimits');

  const presets   = document.getElementById('usdPresets');

  const MIN_USD = 1, MAX_USD = 2000;

  const PR = ()=>window.__PRICES__||{bagUsd:0,xrpUsd:0};

  function currentCurrency(){
    const el = curToggle?.querySelector('input[name="betCur"]:checked');
    return el ? String(el.value).toUpperCase() : 'XRP';
  }
  function priceForCurrent(){
    const {bagUsd,xrpUsd}=PR();
    return currentCurrency()==='BAG' ? bagUsd : xrpUsd;
  }
  function qty(){ const v=parseFloat(betQtyEl?.value||''); return Number.isFinite(v)&&v>0?v:1; }
  function derivedUsd(){
    const px = priceForCurrent(), q=qty();
    return px>0 ? q*px : 0;
  }
  function fmt(n,max=6){ return Number.isFinite(n)? n.toLocaleString(undefined,{maximumFractionDigits:max}) : '‚Äî'; }
  function usd(n){ return '$'+(Number(n)||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }

  function clearPresetActive(){ try{ presets?.querySelectorAll('.preset-chip.active').forEach(b=>b.classList.remove('active')); }catch{} }

  function bagFromInputs(){
    const {bagUsd,xrpUsd}=PR();
    const q = qty();
    if (currentCurrency()==='BAG') return q;
    if (bagUsd>0 && xrpUsd>0) return q*(xrpUsd/bagUsd);
    return 0;
  }

  function setFromUsd(value){
    const u = Math.max(0, Math.min(MAX_USD, Number(value)||0));
    if (usdBetEl){
      usdBetEl.value = u ? u.toFixed(2) : '';
      usdBetEl.dataset.userTyped = u ? '1' : '0';
    }
    const px = priceForCurrent();
    if (betQtyEl){
      if (px>0 && u>0){
        const units = Math.floor((u/px)*1e6)/1e6;
        betQtyEl.value = units || '';
      } else {
        betQtyEl.value = '';
      }
    }
    updatePayouts();
    renderLimits();
    window.dispatchEvent(new CustomEvent('bag:hudRefresh'));
  }

  function autoFillUsd(){
    if (!usdBetEl || usdBetEl.dataset.userTyped==='1') return;
    const v = derivedUsd();
    if (v>0){
      usdBetEl.value = (Math.round(v*100)/100).toFixed(2);
      usdBetEl.dataset.autofill='1';
    }else{
      usdBetEl.value = '';
      usdBetEl.dataset.autofill='0';
    }
  }

  function updatePayouts(){
    const bagStake = bagFromInputs();
    const usdStake = (function(){
      const direct = parseFloat(usdBetEl?.value||'');
      return Number.isFinite(direct)&&direct>0 ? direct : derivedUsd();
    })();

    const BJ=2.00, W=1.25, P=1.00;

    if (payBJ)    payBJ.textContent    = `${fmt(bagStake*BJ)} BAG (${usd(usdStake*BJ)})`;
    if (payWin)   payWin.textContent   = `${fmt(bagStake*W)} BAG (${usd(usdStake*W)})`;
    if (payPush)  payPush.textContent  = `${fmt(bagStake*P)} BAG (${usd(usdStake*P)})`;
    if (payDouble)payDouble.textContent= `Spend +${fmt(bagStake)} BAG now (pays ${fmt(bagStake*W)} on win)`;
    if (paySplit) paySplit.textContent = `Spend +${fmt(bagStake)} BAG now (second hand added)`;
  }

  function renderLimits(){
    const uv = (function(){
      const direct = parseFloat(usdBetEl?.value||'');
      return Number.isFinite(direct)&&direct>0 ? direct : derivedUsd();
    })() || 0;

    const warn = (uv>0 && uv<MIN_USD) ? ` ¬∑ <span style="color:#e8a85c">Min $${MIN_USD.toFixed(2)}</span>` :
                 (uv>MAX_USD) ? ` ¬∑ <span style="color:#e8a85c">Max $${MAX_USD.toFixed(2)}</span>` : '';
    if (betLimits) betLimits.innerHTML = `Limits: $${MIN_USD.toFixed(2)}‚Äì$${MAX_USD.toFixed(2)} ¬∑ Your stake ‚âà $${uv.toFixed(2)}${warn}`;
  }

  usdBetEl?.addEventListener('input', ()=>{ clearPresetActive(); usdBetEl.dataset.userTyped = (usdBetEl.value && usdBetEl.value.length) ? '1' : '0'; updatePayouts(); renderLimits(); });
  betQtyEl?.addEventListener('input', ()=>{ clearPresetActive(); autoFillUsd(); updatePayouts(); renderLimits(); });
  curToggle?.addEventListener('change', ()=>{ if(unitSpan) unitSpan.textContent=currentCurrency(); if (usdBetEl?.dataset.userTyped==='1'){ setFromUsd(parseFloat(usdBetEl.value)||0); } else { autoFillUsd(); updatePayouts(); renderLimits(); } });
  window.addEventListener('bag:pricesUpdated', ()=>{ if (usdBetEl?.dataset.userTyped==='1'){ setFromUsd(parseFloat(usdBetEl.value)||0); } else { autoFillUsd(); updatePayouts(); renderLimits(); } });

  // Presets
  const presetsEl = document.getElementById('usdPresets');
  presetsEl?.addEventListener('click', (e)=>{
    const b = e.target.closest('.preset-chip'); if(!b) return;
    clearPresetActive(); b.classList.add('active');
    const v = (b.dataset.usd==='max') ? 2000 : Math.max(0, Number(b.dataset.usd)||0);
    setFromUsd(v);
  });

  if(unitSpan) unitSpan.textContent=currentCurrency();
  autoFillUsd(); updatePayouts(); renderLimits();
})();
</script>

<!-- Game logic -->
<script>
(function(){
  // ===== Helpers synced with Dice HUD =====
  const roundText  = document.getElementById('roundText');
  const curToggle  = document.getElementById('curToggle');
  const betQtyEl   = document.getElementById('betQty');
  const usdBetEl   = document.getElementById('usdBet');

  const PR = ()=>window.__PRICES__||{bagUsd:0,xrpUsd:0};
  function currentCurrency(){ const el = curToggle?.querySelector('input[name="betCur"]:checked'); return el ? String(el.value).toUpperCase() : 'XRP'; }
  function stakeBagFromInputs(){
    const q = parseFloat(betQtyEl?.value||0) || 0;
    const {bagUsd,xrpUsd} = PR();
    if (currentCurrency()==='BAG') return q;
    if (bagUsd>0 && xrpUsd>0) return q*(xrpUsd/bagUsd);
    return 0;
  }
  function stakeUsdFromInputs(){
    const direct = parseFloat(usdBetEl?.value||'');
    if (Number.isFinite(direct) && direct>0) return direct;
    const q = parseFloat(betQtyEl?.value||0) || 0;
    const {bagUsd,xrpUsd} = PR();
    if (currentCurrency()==='BAG') return bagUsd>0 ? q*bagUsd : 0;
    return xrpUsd>0 ? q*xrpUsd : 0;
  }
  function fmtUsd(n){ return '$'+(Number(n)||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }
  function setLast(s){ try{ window.__BJ_LAST__ = s; window.dispatchEvent(new CustomEvent('bag:hudRefresh')); }catch{} }

  // ===== Cards & rules =====
  const CONFIG = { decks:1, dealerHitsSoft17:true, allowDouble:true, allowSplit:true, mBJ:2.00, mWIN:1.25, mPUSH:1.00 };

  let shoe=[];
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
  function buildShoe(){ const ranks=['A','2','3','4','5','6','7','8','9','10','J','Q','K']; const suits=['‚ô†','‚ô•','‚ô¶','‚ô£']; const tmp=[]; for(let d=0;d<CONFIG.decks;d++) for(const r of ranks) for(const s of suits) tmp.push({r,s}); shoe=shuffle(tmp); }
  function handValue(h){
    let t=0,a=0; for(const c of h){ if(c.r==='A'){t+=11;a++;} else if(['K','Q','J','10'].includes(c.r)) t+=10; else t+=parseInt(c.r,10); }
    while(t>21 && a>0){ t-=10; a--; } const soft=(a>0 && t<=21); return {total:t, soft};
  }
  function isBlackjack(h){ if(h.length!==2) return false; const v=h.map(c=>c.r); return v.includes('A') && ['10','J','Q','K'].some(x=>v.includes(x)); }
  function canSplit(h){
    if(!CONFIG.allowSplit || STATE.hasSplit) return false;
    if(h.length!==2) return false;
    const v=x=>x.r==='A'?11:(['K','Q','J','10'].includes(x.r)?10:parseInt(x.r,10));
    return v(h[0])===v(h[1]);
  }

  // ===== UI bits =====
  const elDealerHand = document.getElementById('dealerHand');
  const elDealerTotal= document.getElementById('dealerTotal');
  const elPlayerArea = document.getElementById('playerArea');
  const elMessage    = document.getElementById('message');

  function suitColor(s){ return (s==='‚ô•'||s==='‚ô¶') ? 'red' : 'black'; }
  function suitSVG(s){
    const map={
      '‚ô†':'<svg class="suit" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C9 6 3 9 3 13a4 4 0 0 0 7 2c-1 3-4 4-4 7h12c0-3-3-4-4-7a4 4 0 0 0 7-2c0-4-6-7-9-11z"/></svg>',
      '‚ô•':'<svg class="suit" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21s-8-4.534-10-9.5C1 7.5 4.5 4 8 4c2 0 3.5 1 4 2 0.5-1 2-2 4-2 3.5 0 7 3.5 6 7.5C20 16.466 12 21 12 21z"/></svg>',
      '‚ô¶':'<svg class="suit" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l7 10-7 10L5 12 12 2z"/></svg>',
      '‚ô£':'<svg class="suit" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4a4 4 0 0 0-4 4c0 .5.1 1 .3 1.5A4 4 0 1 0 9 16h2v3H9v1h6v-1h-2v-3h2a4 4 0 1 0 .7-6.5c.2-.5.3-1 .3-1.5a4 4 0 0 0-4-4z"/></svg>'
    };
    return map[s] || '';
  }
  function renderCard(node, card, facedown=false){
    const c=document.createElement('div');
    c.className = facedown ? 'card back' : ('card '+suitColor(card.s));
    c.innerHTML = facedown ? '' : `<div class="corner tl">${card.r}<br>${card.s}</div><div class="pip">${suitSVG(card.s)}</div><div class="corner br">${card.r}<br>${card.s}</div>`;
    node.appendChild(c);
  }
  function clearHands(){
    elDealerHand.innerHTML = '<div class="label">Dealer</div><div class="total-badge" id="dealerTotal">0</div>';
    elPlayerArea.innerHTML = `
      <div class="hand" id="playerHand0">
        <div class="label">You</div>
        <div class="total-badge" id="playerTotal0">0</div>
      </div>`;
  }
  function ensurePlayerHandsContainers(){
    elPlayerArea.innerHTML='';
    STATE.playerHands.forEach((_,i)=>{
      const h = document.createElement('div');
      h.className='hand'; h.id='playerHand'+i;
      h.innerHTML = `<div class="label">You ${STATE.playerHands.length>1?`(Hand ${i+1})`:''}</div>
                     <div class="total-badge" id="playerTotal${i}">0</div>`;
      elPlayerArea.appendChild(h);
    });
  }
  function updateTotals(){
    elDealerTotal.textContent = handValue(STATE.dealerHand).total || 0;
    STATE.playerHands.forEach((h,i)=>{
      const pv=handValue(h).total;
      const tEl=document.getElementById('playerTotal'+i);
      if(tEl) tEl.textContent = pv;
    });
  }

  // ===== Session (like Dice) with tolerant demo spend =====
  function spendBAG(amount){
    if(!(amount>0)) return true;
    if(window.__BAG_FORCE_DEMO===true){
      if (window.__bagSession && __bagSession.spend) return !!__bagSession.spend(amount);
      return true; // optimistic allow in demo
    }
    try{ return !!(window.__bagSession && __bagSession.spend && __bagSession.spend(amount)); }catch{ return false; }
  }
  function creditBAG(n){ if(!(n>0)) return; try{ __bagSession && __bagSession.credit && __bagSession.credit(n); }catch{} }

  // ===== Round State =====
  const STATE = {
    lockedBagBase:0,   // initial per-hand stake
    dealerHand:[],
    playerHands:[],
    activeHand:0,
    hasSplit:false,
    roundLive:false
  };

  // ===== Controls
  const btnDeal = document.getElementById('deal');
  const btnHit  = document.getElementById('hit');
  const btnStand= document.getElementById('stand');
  const btnDouble=document.getElementById('double');
  const btnSplit =document.getElementById('split');
  const btnNew   =document.getElementById('newHand');

  function resetUI(){
    btnDeal.disabled=false;
    btnHit.disabled=true; btnStand.disabled=true; btnDouble.disabled=true; btnSplit.disabled=true;
    btnNew.style.display='none';
    setText('Place a stake, then Deal'); roundText.className='t';
  }

  function setText(t){ roundText.textContent=t; }
  function flashWin(gainBag, baseUsd, mult){
    showWin({message: (mult>=2?'BLACKJACK':'WIN'), subtext:`+${gainBag.toLocaleString(undefined,{maximumFractionDigits:6})} BAG ¬∑ ${fmtUsd(baseUsd)} ‚Üí ${fmtUsd(baseUsd*mult)}`, duration: (mult>=2?5200:3800)});
  }

  function dealTo(targetHand, targetNode, facedown=false){
    if(shoe.length===0) buildShoe();
    const c=shoe.pop(); targetHand.push(c);
    renderCard(targetNode, c, facedown);
    try{ window.__bagAudio && __bagAudio.blip(); }catch{}
  }

  function startRound(){
    const stakeBag = stakeBagFromInputs();
    const stakeUsd = stakeUsdFromInputs();
    if (!window.__BAG_FORCE_DEMO){
      if (!window.__bagSession || !__bagSession.active()){ alert('Start a session at The Cage'); return; }
      if (!(stakeUsd>=1) || stakeUsd>2000){ alert('Stake must be $1‚Äì$2000'); return; }
    }
    if (!(stakeBag>0)){ alert('Enter a stake first'); return; }

    // lock initial stake (per hand)
    if (!spendBAG(stakeBag)){ alert('Insufficient balance'); return; }
    STATE.lockedBagBase = stakeBag;
    STATE.roundLive = true;
    STATE.hasSplit = false;
    STATE.activeHand = 0;
    STATE.dealerHand=[]; STATE.playerHands=[[]];

    clearHands();
    ensurePlayerHandsContainers();

    const p0 = document.getElementById('playerHand0');
    dealTo(STATE.playerHands[0], p0);
    dealTo(STATE.dealerHand, elDealerHand);
    dealTo(STATE.playerHands[0], p0);
    // dealer hole
    const hole = shoe.pop(); STATE.dealerHand.push(hole); renderCard(elDealerHand, hole, true);

    updateTotals();
    btnDeal.disabled = true;
    btnHit.disabled=false; btnStand.disabled=false; btnDouble.disabled=true; btnSplit.disabled=false;
    if (STATE.playerHands[0].length===2) btnDouble.disabled=false;
    if (!canSplit(STATE.playerHands[0])) btnSplit.disabled=true;

    // naturals
    if (isBlackjack(STATE.playerHands[0])){
      revealDealerHole();
      const dBJ = isBlackjack(STATE.dealerHand);
      settleAll(dBJ ? 'push-bj' : 'blackjack');
      return;
    }
    setLast('Dealt');
    setText('Play your hand');
  }

  function revealDealerHole(){
    const cards = elDealerHand.querySelectorAll('.card');
    for(let i=cards.length-1;i>=0;i--){
      if(cards[i].classList.contains('back')){ cards[i].remove(); break; }
    }
    renderCard(elDealerHand, STATE.dealerHand[1], false);
    updateTotals();
  }

  // Actions
  btnDeal.addEventListener('click', startRound);
  btnHit.addEventListener('click', ()=>{
    const idx=STATE.activeHand;
    const node=document.getElementById('playerHand'+idx);
    dealTo(STATE.playerHands[idx], node);
    updateTotals();
    btnDouble.disabled = true; // double only first action
    if(handValue(STATE.playerHands[idx]).total>21){
      setText(`Hand ${STATE.playerHands.length>1?idx+1:''} busts`);
      nextHandOrDealer(true);
    }
  });
  btnStand.addEventListener('click', ()=>{ setText(`Hand ${STATE.playerHands.length>1?STATE.activeHand+1:''} stands`); nextHandOrDealer(true); });
  btnDouble.addEventListener('click', ()=>{
    const idx=STATE.activeHand;
    if(STATE.playerHands[idx].length!==2) return alert('Double only on first turn');
    if(!spendBAG(STATE.lockedBagBase)) return alert('Insufficient balance');
    STATE.playerHands[idx]._doubled=true;
    const node=document.getElementById('playerHand'+idx);
    dealTo(STATE.playerHands[idx], node);
    updateTotals();
    nextHandOrDealer(true);
  });
  btnSplit.addEventListener('click', ()=>{
    const h0=STATE.playerHands[0];
    if(!canSplit(h0)) return;
    if(!spendBAG(STATE.lockedBagBase)) return alert('Insufficient balance');
    STATE.hasSplit=true;
    const c2=h0.pop();
    STATE.playerHands=[ [h0[0]], [c2] ];
    ensurePlayerHandsContainers();
    const h0Node=document.getElementById('playerHand0');
    const h1Node=document.getElementById('playerHand1');
    renderCard(h0Node, STATE.playerHands[0][0]);
    renderCard(h1Node, STATE.playerHands[1][0]);
    dealTo(STATE.playerHands[0], h0Node);
    dealTo(STATE.playerHands[1], h1Node);
    updateTotals();
    STATE.activeHand=0;
    btnSplit.disabled=true;
    btnDouble.disabled=false;
  });
  btnNew.addEventListener('click', ()=>{ resetUI(); setLast('‚Äî'); });

  function nextHandOrDealer(){
    if(STATE.playerHands.length>1){
      STATE.activeHand++;
      if(STATE.activeHand<STATE.playerHands.length){
        btnDouble.disabled = !(STATE.playerHands[STATE.activeHand].length===2);
        btnHit.disabled=false; btnStand.disabled=false;
        return;
      }
    }
    dealerPlayAndSettle();
  }

  function dealerPlayAndSettle(){
    revealDealerHole();
    let dv=handValue(STATE.dealerHand);
    while(dv.total<17 || (dv.total===17 && dv.soft && CONFIG.dealerHitsSoft17)){
      dealTo(STATE.dealerHand, elDealerHand);
      dv=handValue(STATE.dealerHand);
    }
    updateTotals();
    settleAll();
  }

  function settleAll(override){ // override: 'blackjack' | 'push-bj'
    let totalCredit=0, baseUsd = stakeUsdFromInputs();

    function settleHand(hand, idx){
      const pv=handValue(hand).total, dv=handValue(STATE.dealerHand).total;
      const doubled = hand._doubled===true;
      const stake = STATE.lockedBagBase * (doubled?2:1);

      if (override==='blackjack'){
        const pay = stake * CONFIG.mBJ;
        totalCredit += pay;
        roundText.className='t win';
        roundText.textContent = 'Blackjack ‚Äî paid 2.00√ó';
        setLast('Blackjack 2√ó');
        try{ window.__bagAudio && __bagAudio.chime(); }catch{}
        flashWin(pay - stake, baseUsd, CONFIG.mBJ);
        return;
      }
      if (override==='push-bj'){
        const pay = stake * CONFIG.mPUSH;
        totalCredit += pay;
        roundText.className='t push'; roundText.textContent = 'Push (both Blackjack) ‚Äî stake returned';
        setLast('Push');
        return;
      }

      if (pv>21){
        roundText.className='t lose'; roundText.textContent='Busted ‚Äî dealer wins';
        setLast('Scratch');
        try{ window.__bagAudio && __bagAudio.thud(); }catch{}
        return;
      }
      if (dv>21 || pv>dv){
        const mult = (isBlackjack(hand) && !doubled && !STATE.hasSplit) ? CONFIG.mBJ : CONFIG.mWIN;
        const pay = stake * mult;
        totalCredit += pay;
        roundText.className='t win';
        roundText.textContent = mult===CONFIG.mBJ ? 'Blackjack ‚Äî 2.00√ó' : `You win ${CONFIG.mWIN.toFixed(2)}√ó`;
        setLast(mult===CONFIG.mBJ ? 'Blackjack 2√ó' : 'Win 1.25√ó');
        try{ window.__bagAudio && __bagAudio.chime(); }catch{}
        flashWin(pay - stake, baseUsd, mult);
      } else if (pv<dv){
        roundText.className='t lose'; roundText.textContent='Dealer wins';
        setLast('Scratch');
        try{ window.__bagAudio && __bagAudio.thud(); }catch{}
      } else {
        const pay = stake * CONFIG.mPUSH;
        totalCredit += pay;
        roundText.className='t push'; roundText.textContent='Push ‚Äî stake returned';
        setLast('Push');
      }
    }

    if (STATE.playerHands.length===1) settleHand(STATE.playerHands[0],0);
    else STATE.playerHands.forEach(settleHand);

    if (totalCredit>0) creditBAG(totalCredit);

    // end round
    btnHit.disabled=true; btnStand.disabled=true; btnDouble.disabled=true; btnSplit.disabled=true;
    btnDeal.disabled=true; btnNew.style.display='inline-block';
    STATE.roundLive=false;
  }

  // Init
  function init(){ buildShoe(); resetUI(); }
  init();

  // Reshuffle guard
  setInterval(()=>{ if(shoe.length<15){ buildShoe(); } }, 2000);
})();
</script>

<!-- Practice Mode Wrapper (parity with Dice; kept minimal since shim handles defaults) -->
<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const forceLive = qs.get('live') === '1';

  const $ = (s)=>document.querySelector(s);
  const statusEl  = $('#sessionStatus');
  const startBtn  = $('#startSessionBtn');
  const topUpBtn  = $('#topUpBtn');
  const endBtn    = $('#endSessionBtn');
  const connectEl = $('#connectBtn');

  function fmt(n){
    if(!Number.isFinite(n)) return '‚Äî';
    if(Math.abs(n)>=1) return n.toLocaleString(undefined,{maximumFractionDigits:4});
    if(Math.abs(n)>=1e-2) return n.toLocaleString(undefined,{maximumFractionDigits:6});
    if(Math.abs(n)>=1e-4) return n.toLocaleString(undefined,{maximumFractionDigits:8});
    return n.toLocaleString(undefined,{maximumFractionDigits:10});
  }
  function fmtUsd(n){ return '$'+(Number(n)||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }

  function renderDemo(){
    const bag=(window.__bagSession?.get?.().bag)||0;
    const bagUsd=(window.__PRICES__?.bagUsd||0)*bag;
    if(statusEl){
      statusEl.innerHTML='Practice: <span style="color:#2fbf6b)">'+fmt(bag)+' BAG</span>' +
        (bagUsd?` <span class="micro" style="opacity:.75">(${fmtUsd(bagUsd)})</span>`:'');
    }
    if(startBtn) startBtn.style.display='inline-block';
    if(topUpBtn) topUpBtn.style.display='none';
    if(endBtn)   endBtn.style.display='none';
  }

  function enableDemo(){
    try{ Object.defineProperty(window,'__BAG_FORCE_DEMO',{value:true, configurable:true}); }catch{ window.__BAG_FORCE_DEMO=true; }
    renderDemo();
    if (connectEl) connectEl.style.opacity='0.9';
  }
  function enableLive(){ window.__BAG_FORCE_DEMO=false; window.dispatchEvent(new CustomEvent('bag:pricesUpdated')); }

  if (forceLive) enableLive(); else enableDemo();

  window.addEventListener('bag:pricesUpdated', ()=>{ if(window.__BAG_FORCE_DEMO) renderDemo(); });

})();
</script>

<!-- HUD updater (parity with Dice) -->
<script>
(function(){
  const curToggle = document.getElementById('curToggle');

  function PR(){ return window.__PRICES__ || { bagUsd:0, xrpUsd:0 }; }
  function fmt(n, max=6){ const x=Number(n); if(!Number.isFinite(x)) return '‚Äî'; return x.toLocaleString(undefined,{maximumFractionDigits:max}); }

  function els(){ 
    return { 
      balLbl: document.getElementById('balLbl'),
      ccyLbl: document.getElementById('ccyLbl'),
      betLbl: document.getElementById('betLbl'),
      modeLbl: document.getElementById('modeLbl'),
      lastLbl: document.getElementById('lastLbl'),
      betQtyEl: document.getElementById('betQty'),
    }; 
  }

  function selectedMode(){ return (window.__BAG_FORCE_DEMO === true) ? 'Demo' : 'Live'; }
  function currentCurrency(){
    const el = curToggle?.querySelector('input[name="betCur"]:checked');
    return el ? String(el.value).toUpperCase() : 'XRP';
  }

  function getBalances(){
    const sess = (window.__bagSession && window.__bagSession.get && window.__bagSession.get()) || {};
    const bag = Number(sess.bag) || 0;
    let xrp = Number(sess.xrp);
    if (!(xrp > 0)) {
      const { bagUsd, xrpUsd } = PR();
      if (bagUsd > 0 && xrpUsd > 0) xrp = bag * (bagUsd / xrpUsd);
      else xrp = 0;
    }
    return { bag, xrp };
  }

  function currentBet(){
    const { betQtyEl } = els();
    const v = parseFloat(betQtyEl?.value || '0');
    if (!Number.isFinite(v) || v < 0) return 0;
    return Math.max(0, v);
  }

  function renderHud(){
    try{
      const { balLbl, ccyLbl, betLbl, modeLbl, lastLbl } = els();
      const mode = selectedMode();
      const ccy  = currentCurrency();
      const { bag, xrp } = getBalances();

      if (modeLbl) modeLbl.textContent = mode;
      if (betLbl)  betLbl.textContent  = String(currentBet());
      if (lastLbl) lastLbl.textContent = String(window.__BJ_LAST__ || '‚Äî');

      if (balLbl && ccyLbl){
        if (ccy === 'XRP'){ balLbl.textContent = fmt(xrp, 6); ccyLbl.textContent='XRP'; }
        else { balLbl.textContent = fmt(bag, 6); ccyLbl.textContent='BAG'; }
      }
    }catch(e){}
  }

  [
    'bag:sessionStarted','bag:sessionToppedUp','bag:sessionEnded',
    'bag:pricesUpdated','bag:walletConnected','bag:walletDisconnected',
    'bag:hudRefresh'
  ].forEach(ev => addEventListener(ev, renderHud));

  document.getElementById('betQty')?.addEventListener('input', renderHud);
  curToggle?.addEventListener('change', renderHud);

  addEventListener('storage', (e)=>{ if (e && e.key === '__bag_demo_blackjack_v1') renderHud(); });

  renderHud();
  let tries = 0; 
  const iv = setInterval(()=>{ renderHud(); if(++tries>40) clearInterval(iv); }, 500);
})();
</script>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/service-worker.js').catch(()=>{});
}
</script>

<footer class="footer" style="text-align:center; padding:12px 0; line-height:1.6;">
  ¬© 2025 $BAG Protocol | getthebag.io | Powered by $XRP
  <br>
  <a href="https://x.com/getthebag_io" target="_blank" rel="noopener" style="color:#e0c66f;text-decoration:none;font-weight:700;"> ùïè @getthebag_io</a> |
  <a href="https://t.me/getthebag_io" target="_blank" rel="noopener" style="color:#e0c66f;text-decoration:none;font-weight:700;">Telegram @getthebag_io</a>
</footer>

</body>
</html>
