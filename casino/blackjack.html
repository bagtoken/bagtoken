<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>$BAG Blackjack</title>

<link rel="preconnect" href="https://xaman.app" crossorigin>

<style>
  *{box-sizing:border-box}
  :root{
    --gold:#ffd700;--bg:#020703;--panel:#0b1b13;--panel2:#0d2217;--muted:#aeb7af;--fg:#f5f7f4;
    --green:#2fbf6b;--green2:#34c759;--line:#173524;--shadow:rgba(0,0,0,.35);--red:#e25b5b;
    --accent:#1f6a46;

    /* Sizing */
    --wrap-w: 1200px;
    --felt-pad: clamp(12px, 2.2vw, 22px);

    /* Card sizing responsive */
    --card-w: clamp(64px, 10vw, 92px);
    --card-h: calc(var(--card-w) * 1.42);
    --card-r: 12px;
    --pip: clamp(22px, 3.2vw, 28px);
    --corner: clamp(12px, 2.4vw, 14px);

    /* Buttons */
    --btn-h: 54px;
    --btn-r: 12px;
    --btn-fs: clamp(14px, 1.8vw, 16px);
  }

  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:var(--wrap-w);margin:0 auto;padding:18px}
  header{display:flex;align-items:center;gap:14px;margin:6px 0 14px;flex-wrap:wrap}
  header img{height:40px;width:auto}
  .tag{font-size:12px;border:1px solid var(--line);padding:2px 8px;border-radius:999px;color:var(--muted);background:#08120c}
  .tag.gold{color:#1b1500;background:linear-gradient(#ffe688,#ffd700);border-color:#d8b800}
  .tag.demo{color:#16301f;background:#0a2215;border-color:#1c4729}

  /* HUD Grid */
  .hud{display:grid;gap:12px;margin:10px 0 18px;
       grid-template-columns: 1fr 1fr; }
  @media(min-width:900px){
    .hud{grid-template-columns: 1.2fr 1.2fr .9fr .9fr;}
  }
  .panel{background:var(--panel);border:1px solid #0f2b1e;border-radius:14px;box-shadow:0 10px 22px var(--shadow);padding:12px}
  .panel h4{margin:0 0 8px 0;color:var(--gold);font-size:13px;letter-spacing:.25px}
  .kv{display:grid;grid-template-columns: repeat(3,1fr);gap:8px}
  .kv .cell{background:#0a1e15;border:1px solid #143a25;border-radius:10px;padding:8px 10px}
  .kv .label{font-size:11px;color:var(--muted)}
  .kv .val{font-weight:700}

  .mode{display:inline-flex;align-items:center;gap:8px;background:#0a1e15;border:1px solid #244330;border-radius:999px;color:#cfe6d8;padding:6px 10px}

  .currency-toggle{display:flex;background:#0a1c13;border:1px solid #143a25;border-radius:12px;overflow:hidden}
  .currency-toggle button{border:0;background:transparent;color:var(--muted);padding:10px 14px;cursor:pointer;font-weight:600}
  .currency-toggle button.active{background:#11321f;color:var(--fg)}

  /* Felt / table */
  .felt{
    background:
      radial-gradient(1400px 700px at 50% -10%, #1a5a3c 0%, #114c33 55%, #0b2a1c 100%);
    border:1px solid #153b27;border-radius:22px;padding:var(--felt-pad);
    position:relative;overflow:hidden
  }
  .felt:before{content:"";position:absolute;inset:0;pointer-events:none;background:linear-gradient(transparent, rgba(0,0,0,.16) 78%)}

  .titlebar{
    display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;gap:12px;flex-wrap:wrap
  }
  .titlebar .table-label{font-size:12px;color:var(--muted)}
  .titlebar .pay-hint{font-size:12px;color:var(--muted)}
  .titlebar b{color:var(--gold)}

  .row{display:flex;justify-content:center;gap:12px;flex-wrap:wrap}
  .hand{min-height:calc(var(--card-h) + 36px);display:flex;align-items:flex-start;gap:12px;position:relative;padding-top:28px;flex-wrap:nowrap}
  .label{position:absolute;top:0;left:0;font-size:12px;color:var(--muted)}
  .total-badge{position:absolute;top:0;right:0;background:#0f2e20;border:1px solid #1a5136;color:var(--gold);padding:3px 10px;border-radius:999px;font-size:12px}

  /* Card — pro look */
  .card{
    width:var(--card-w);height:var(--card-h);border-radius:var(--card-r);
    background:linear-gradient(180deg,#ffffff, #f3f6f6);
    border:2px solid #e1e1e1;box-shadow:0 10px 20px rgba(0,0,0,.35);
    position:relative;display:grid;place-items:center;font-weight:800;
    transform:translateY(20px);opacity:0;animation:slideIn .18s ease-out forwards;
    will-change:transform,opacity;backface-visibility:hidden
  }
  @keyframes slideIn{
    to{transform:translateY(0);opacity:1}
  }
  .card.red{color:#c1121f}
  .card.black{color:#101114}
  .card .corner{position:absolute;font-size:var(--corner);line-height:1.05}
  .card .tl{top:7px;left:8px;text-align:left}
  .card .br{bottom:7px;right:8px;transform:rotate(180deg);text-align:left}
  .card .pip{font-size:var(--pip)}
  .card .suit{width:20px;height:20px;display:inline-block;vertical-align:baseline}
  .card.back{
    background:
      repeating-linear-gradient(45deg,#0b1b13 0px,#0b1b13 6px,#0e2217 6px,#0e2217 12px),
      radial-gradient(#123423,#0f271b);
    border-color:#193d2b
  }
  /* Dealer hole flip */
  .flip{transform-style:preserve-3d; perspective:800px}
  .flip > .face{position:absolute;inset:0;border-radius:var(--card-r);backface-visibility:hidden}
  .flip > .backface{transform:rotateY(180deg)}
  .reveal{animation:reveal .4s ease-out forwards}
  @keyframes reveal{
    0%{transform:rotateY(0deg)}
    100%{transform:rotateY(180deg)}
  }

  /* Actions */
  .controls{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin:14px 0 4px}
  .btn{
    min-height:var(--btn-h);min-width:140px;padding:0 18px;border-radius:var(--btn-r);
    border:1px solid var(--accent);background:linear-gradient(#1d5439,#153c29);
    color:var(--fg);font-weight:800;font-size:var(--btn-fs);letter-spacing:.2px;cursor:pointer;
    box-shadow:0 10px 20px rgba(0,0,0,.35)
  }
  .btn.secondary{border-color:#244a34;background:#122a1f}
  .btn.gold{background:linear-gradient(#ffe688,#ffd700);color:#1b1500;border-color:#d8b800}
  .btn:disabled{opacity:.45;cursor:not-allowed}

  /* Bet box and chips */
  .betline{display:flex;align-items:center;gap:12px;flex-wrap:wrap;justify-content:center;margin-top:4px}
  .betpill{display:flex;align-items:center;gap:8px;background:#0c2419;border:1px solid #18432d;border-radius:999px;padding:10px 14px;font-weight:700}
  .chips{display:flex;gap:10px;flex-wrap:wrap}
  .chip{
    width:54px;height:54px;border-radius:50%;border:2px solid #d8b800;
    background:radial-gradient(circle,#ffe688,#ffd700);
    color:#1b1500;font-weight:900;display:grid;place-items:center;cursor:pointer;
    box-shadow:0 6px 14px rgba(0,0,0,.35);user-select:none
  }

  .msg{margin:12px auto 0;max-width:780px;text-align:center;color:var(--muted);font-size:14px}
  .msg strong{color:#fff}

  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#0f2e20;border:1px solid #1a4a33;color:#eaf7ee;padding:10px 12px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.4);opacity:0;pointer-events:none;transition:opacity .25s, transform .25s;z-index:9999}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)}
  .split-ribbon{position:absolute;top:0;left:50%;transform:translate(-50%,-40%);background:#153e2a;border:1px solid #256648;padding:2px 8px;border-radius:8px;font-size:12px;color:var(--gold)}

  .subtle{font-size:12px;color:var(--muted)}

  /* Responsive tightening */
  @media (max-width:520px){
    .wrap{padding:14px}
    .btn{min-width:46%;flex:1}
    .chips{justify-content:center}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <img src="https://getthebag.io/logo.png" alt="$BAG" onerror="this.style.display='none'">
    <div class="tag gold">$BAG Blackjack</div>
    <div id="demoTag" class="tag demo" style="display:none">Demo</div>
    <span class="mode" id="modePill">Mode: DEMO</span>
  </header>

  <!-- HUD -->
  <section class="hud">
    <div class="panel">
      <h4>Balance</h4>
      <div class="kv">
        <div class="cell"><div class="label">$BAG</div><div class="val" id="balBAG">—</div></div>
        <div class="cell"><div class="label">$XRP</div><div class="val" id="balXRP">—</div></div>
        <div class="cell"><div class="label">$USD</div><div class="val" id="balUSD">—</div></div>
      </div>
    </div>

    <div class="panel">
      <h4>Bet</h4>
      <div class="kv">
        <div class="cell"><div class="label">$BAG</div><div class="val" id="betBAG">0.00</div></div>
        <div class="cell"><div class="label">$XRP</div><div class="val" id="betXRP">0.000000</div></div>
        <div class="cell"><div class="label">$USD</div><div class="val" id="betUSD">0.00</div></div>
      </div>
    </div>

    <div class="panel">
      <h4>Last Result</h4>
      <div class="kv">
        <div class="cell"><div class="label">$BAG</div><div class="val" id="resBAG">—</div></div>
        <div class="cell"><div class="label">$XRP</div><div class="val" id="resXRP">—</div></div>
        <div class="cell"><div class="label">$USD</div><div class="val" id="resUSD">—</div></div>
      </div>
      <div class="subtle" id="resNote" style="margin-top:6px">—</div>
    </div>

    <div class="panel">
      <h4>Currency</h4>
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
        <div class="currency-toggle" id="ccyToggle">
          <button data-ccy="BAG" class="active">$BAG</button>
          <button data-ccy="XRP">$XRP</button>
        </div>
        <div class="subtle" id="pxInfo">$XRP $ —  |  $BAG $ —</div>
      </div>
    </div>
  </section>

  <!-- Felt -->
  <section class="felt">
    <div class="titlebar">
      <div class="table-label">Dealer stands on 17  •  Dealer hits soft 17</div>
      <div class="pay-hint"><b>Blackjack pays 2×</b>  •  <b>Win pays 1.25×</b>  •  <b>Push returns bet</b></div>
    </div>

    <div class="row">
      <div class="hand" id="dealerHand">
        <div class="label">Dealer</div>
        <div class="total-badge" id="dealerTotal">0</div>
      </div>
    </div>

    <div class="row" id="playerArea">
      <div class="hand" id="playerHand0">
        <div class="label">You</div>
        <div class="total-badge" id="playerTotal0">0</div>
      </div>
    </div>

    <div class="controls">
      <button id="deal" class="btn gold">Deal</button>
      <button id="hit" class="btn" disabled>Hit</button>
      <button id="stand" class="btn" disabled>Stand</button>
      <button id="double" class="btn secondary" disabled>Double</button>
      <button id="split" class="btn secondary" disabled>Split</button>
      <button id="newHand" class="btn" style="display:none">New Hand</button>
    </div>

    <div class="betline">
      <div class="betpill">
        <span style="opacity:.75;margin-right:4px">Bet</span>
        <strong id="betDisplay">0.00</strong>
        <span id="unit" style="opacity:.75;margin-left:2px">BAG</span>
      </div>
      <div class="chips">
        <div class="chip" data-v="1">1</div>
        <div class="chip" data-v="5">5</div>
        <div class="chip" data-v="10">10</div>
        <div class="chip" data-v="50">50</div>
        <div class="chip" data-v="100">100</div>
      </div>
      <button id="clearBet" class="btn secondary" style="min-width:120px">Clear</button>
    </div>

    <div class="msg" id="message">Place your bet then Deal</div>
  </section>
</div>

<div id="toast" class="toast"></div>

<script>
/* ===== Prices & session shims ===== */
const PRICES = Object.assign({ xrpUsd: 0.50, bagUsd: 0.0001 }, (window.__PRICES__||window.PRICES||{}));
const DEMO_KEY='__bag_demo_blackjack_v2';

function inDemo(){ return window.__BAG_FORCE_DEMO===true || !window.__bagSession || !window.__bagSession.active || !window.__bagSession.active(); }
function getDemoBal(){ try{ const v=Number(localStorage.getItem(DEMO_KEY)); return Number.isFinite(v)&&v>0?v:1000 }catch{return 1000} }
function setDemoBal(v){ try{ localStorage.setItem(DEMO_KEY, String(Math.max(0,Number(v)||0))); }catch{} }
if(localStorage.getItem(DEMO_KEY)==null) setDemoBal(1000);

const demoTag = document.getElementById('demoTag');
const modePill = document.getElementById('modePill');
function renderMode(){ const live=!inDemo(); demoTag.style.display=live?'none':'inline-block'; modePill.textContent = 'Mode: ' + (live?'LIVE':'DEMO'); }

/* ===== Config ===== */
const CONFIG = {
  blackjackPayout: 2.0,
  regularWinPayout: 1.25,
  pushPayout: 1.0,
  allowDouble: true,
  allowSplit: true,
  dealerHitsSoft17: true,
  decks: 1
};

/* ===== State ===== */
renderMode();
let currency = 'BAG';     // display currency for the BET control only
let betDisplay = 0;       // amount user builds in current display currency
let shoe = [];
let playerHands = [];
let dealerHand = [];
let activeHandIndex = 0;
let hasSplit = false;
let roundOver = false;

/* ===== Elements ===== */
const elBalBAG = document.getElementById('balBAG');
const elBalXRP = document.getElementById('balXRP');
const elBalUSD = document.getElementById('balUSD');

const elBetBAG = document.getElementById('betBAG');
const elBetXRP = document.getElementById('betXRP');
const elBetUSD = document.getElementById('betUSD');

const elResBAG = document.getElementById('resBAG');
const elResXRP = document.getElementById('resXRP');
const elResUSD = document.getElementById('resUSD');
const elResNote= document.getElementById('resNote');

const elPxInfo = document.getElementById('pxInfo');

const elUnit = document.getElementById('unit');
const elBetDisplay = document.getElementById('betDisplay');

const elDealerHand = document.getElementById('dealerHand');
const elDealerTotal = document.getElementById('dealerTotal');
const elPlayerArea = document.getElementById('playerArea');
const elMessage = document.getElementById('message');
const elToast = document.getElementById('toast');

const btnDeal = document.getElementById('deal');
const btnHit = document.getElementById('hit');
const btnStand = document.getElementById('stand');
const btnDouble = document.getElementById('double');
const btnSplit = document.getElementById('split');
const btnNew = document.getElementById('newHand');
const btnClearBet = document.getElementById('clearBet');

/* ===== Audio ===== */
let _ac=null;
function ac(){ if(_ac && _ac.state!=='closed') return _ac; const AC=window.AudioContext||window.webkitAudioContext; if(!AC) return null; _ac=new AC(); return _ac; }
async function resumeAudio(){ const c=ac(); if(c && c.state==='suspended'){ try{ await c.resume(); }catch{} } }
function beep(freq=440, dur=0.08, type='triangle', gain=0.06){
  const c=ac(); if(!c || c.state!=='running') return;
  try{
    const o=c.createOscillator(), g=c.createGain();
    o.type=type; o.frequency.value=freq; g.gain.value=gain; o.connect(g); g.connect(c.destination);
    o.start(); setTimeout(()=>{ try{o.stop();o.disconnect();g.disconnect();}catch{} }, dur*1000);
  }catch{}
}
const sfx = {
  chip: () => beep(260, 0.05,'square',0.05),
  deal: () => beep(520, 0.06,'sawtooth',0.05),
  win:  () => [530,720,920].forEach((f,i)=>setTimeout(()=>beep(f,0.07,'sine',0.07),i*90)),
  lose: () => [210,170,140].forEach((f,i)=>setTimeout(()=>beep(f,0.09,'sine',0.06),i*120))
};
['click','touchstart','keydown'].forEach(ev=>addEventListener(ev, ()=>resumeAudio(), {passive:true, once:true}));

/* ===== Session helpers (BAG as base unit) ===== */
function sessionBalanceBAG(){
  if(inDemo()) return getDemoBal();
  try{ const s = window.__bagSession && window.__bagSession.get && window.__bagSession.get(); return s && Number(s.bag)>0 ? Number(s.bag) : 0; }catch{ return 0; }
}
function spendBAG(amount){
  if(!(amount>0)) return true;
  if(inDemo()){ const b=getDemoBal(); if(b<amount) return false; setDemoBal(b-amount); return true; }
  try{ return !!(window.__bagSession && __bagSession.spend && __bagSession.spend(amount)); }catch{ return false; }
}
function creditBAG(amount){
  if(!(amount>0)) return;
  if(inDemo()){ setDemoBal(getDemoBal()+amount); return; }
  try{ if(window.__bagSession && __bagSession.credit) __bagSession.credit(amount); }catch{}
}

/* ===== Conversions & formatting ===== */
function toUSD_BAG(bag){ return PRICES.bagUsd>0 ? bag*PRICES.bagUsd : 0; }
function toXRP_BAG(bag){ if(PRICES.bagUsd>0 && PRICES.xrpUsd>0) return bag*(PRICES.bagUsd/PRICES.xrpUsd); return 0; }
function fromDispToBAG(v){ // v is in current currency units
  if(currency==='BAG') return v;
  if(currency==='XRP'){ if(PRICES.xrpUsd>0 && PRICES.bagUsd>0) return v*(PRICES.xrpUsd/PRICES.bagUsd); return 0; }
  return 0;
}
const fmtUSD = n => '$' + Number(n||0).toFixed(2);
const fmtXRP = n => Number(n||0).toFixed(6) + ' XRP';
const fmtBAG = n => Number(n||0).toFixed(2) + ' BAG';
function sign(n){ return (n>0?'+':'') + n; }

/* ===== UI helpers ===== */
function showToast(txt){
  elToast.textContent = txt;
  elToast.classList.add('show');
  setTimeout(()=>elToast.classList.remove('show'), 1300);
}
function setResult(deltaBag, note){
  const x = toXRP_BAG(deltaBag);
  const u = toUSD_BAG(deltaBag);
  elResBAG.textContent = sign(deltaBag.toFixed(2));
  elResXRP.textContent = sign(x.toFixed(6));
  elResUSD.textContent = sign(u.toFixed(2));
  elResNote.textContent = note || '—';
}

/* ===== Rendering: cards ===== */
function suitColor(s){ return (s==='♥'||s==='♦') ? 'red' : 'black'; }
function suitSVG(s){
  // lightweight SVG paths for suits
  const map = {
    '♠': '<svg class="suit" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C9 6 3 9 3 13a4 4 0 0 0 7 2c-1 3-4 4-4 7h12c0-3-3-4-4-7a4 4 0 0 0 7-2c0-4-6-7-9-11z"/></svg>',
    '♥': '<svg class="suit" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21s-8-4.534-10-9.5C1 7.5 4.5 4 8 4c2 0 3.5 1 4 2 0.5-1 2-2 4-2 3.5 0 7 3.5 6 7.5C20 16.466 12 21 12 21z"/></svg>',
    '♦': '<svg class="suit" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l7 10-7 10L5 12 12 2z"/></svg>',
    '♣': '<svg class="suit" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4a4 4 0 0 0-4 4c0 .5.1 1 .3 1.5A4 4 0 1 0 9 16h2v3H9v1h6v-1h-2v-3h2a4 4 0 1 0 .7-6.5c.2-.5.3-1 .3-1.5a4 4 0 0 0-4-4z"/></svg>'
  };
  return map[s] || '';
}
function renderCard(node, card, facedown=false){
  if(facedown){
    const c = document.createElement('div');
    c.className='card back';
    node.appendChild(c);
    return;
  }
  const c = document.createElement('div');
  c.className = 'card ' + suitColor(card.s);
  c.innerHTML = `
    <div class="corner tl">${card.r}<br>${card.s}</div>
    <div class="pip">${suitSVG(card.s)}</div>
    <div class="corner br">${card.r}<br>${card.s}</div>
  `;
  node.appendChild(c);
}
function clearHands(){
  elDealerHand.innerHTML = '<div class="label">Dealer</div><div class="total-badge" id="dealerTotal">0</div>';
  document.getElementById('playerArea').innerHTML = `
    <div class="hand" id="playerHand0">
      <div class="label">You</div>
      <div class="total-badge" id="playerTotal0">0</div>
    </div>`;
}
function ensurePlayerHandsContainers(){
  const area = document.getElementById('playerArea');
  area.innerHTML='';
  playerHands.forEach((_,i)=>{
    const h = document.createElement('div');
    h.className='hand';
    h.id='playerHand'+i;
    h.innerHTML = `<div class="label">You ${playerHands.length>1?`(Hand ${i+1})`:''}</div>
                   <div class="total-badge" id="playerTotal${i}">0</div>`;
    area.appendChild(h);
    if(playerHands.length>1 && i===activeHandIndex){
      const r=document.createElement('div'); r.className='split-ribbon'; r.textContent='Active';
      h.appendChild(r);
    }
  });
}

/* ===== Shoe & values ===== */
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function buildShoe(){
  const ranks=['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
  const suits=['♠','♥','♦','♣'];
  const tmp=[]; for(let d=0; d<CONFIG.decks; d++) for(const r of ranks) for(const s of suits) tmp.push({r,s});
  shoe = shuffle(tmp);
}
function handValue(hand){
  let total=0, aces=0;
  for(const c of hand){
    if(c.r==='A'){ total+=11; aces++; }
    else if(['K','Q','J','10'].includes(c.r)) total+=10;
    else total+=parseInt(c.r,10);
  }
  while(total>21 && aces>0){ total-=10; aces--; }
  const soft = (aces>0 && total<=21);
  return {total, soft};
}
function isBlackjack(hand){
  if(hand.length!==2) return false;
  const vals = hand.map(c=>c.r);
  return vals.includes('A') && ['10','J','Q','K'].some(v=>vals.includes(v));
}
function canSplit(hand){
  if(!CONFIG.allowSplit || hasSplit) return false;
  if(hand.length!==2) return false;
  const [a,b]=hand;
  const v = (x)=> x.r==='A' ? 11 : ['K','Q','J','10'].includes(x.r) ? 10 : parseInt(x.r,10);
  return v(a)===v(b);
}

/* ===== Totals & HUD ===== */
function updateTotals(){
  const dv = handValue(dealerHand).total;
  document.getElementById('dealerTotal').textContent = dv>0? dv: 0;
  playerHands.forEach((h,i)=>{
    const pv = handValue(h).total;
    const tEl = document.getElementById('playerTotal'+i);
    if (tEl) tEl.textContent = pv;
  });
}
function updatePricesInfo(){
  const xu = PRICES.xrpUsd>0 ? ('$XRP ' + PRICES.xrpUsd.toFixed(4)) : '$XRP —';
  const bu = PRICES.bagUsd>0 ? ('$BAG ' + PRICES.bagUsd.toFixed(6)) : '$BAG —';
  elPxInfo.textContent = xu + '  |  ' + bu;
}
function updateBetHUD(){
  const bag = fromDispToBAG(betDisplay);
  const xrp = toXRP_BAG(bag);
  const usd = toUSD_BAG(bag);
  elBetBAG.textContent = bag.toFixed(2);
  elBetXRP.textContent = xrp.toFixed(6);
  elBetUSD.textContent = usd.toFixed(2);
  elBetDisplay.textContent = currency==='BAG' ? betDisplay.toFixed(2) : betDisplay.toFixed(6);
  elUnit.textContent = currency;
}
function updateBalanceHUD(){
  const bag = sessionBalanceBAG();
  elBalBAG.textContent = bag.toFixed(2);
  elBalXRP.textContent = toXRP_BAG(bag).toFixed(6);
  elBalUSD.textContent = toUSD_BAG(bag).toFixed(2);
}

/* ===== Flow ===== */
function resetRoundUI(){
  btnDeal.disabled = false;
  btnHit.disabled = true;
  btnStand.disabled = true;
  btnDouble.disabled = true;
  btnSplit.disabled = true;
  btnNew.style.display = 'none';
  elMessage.innerHTML = 'Place your bet then Deal';
}
function dealTo(targetHand, targetNode, facedown=false){
  if(shoe.length === 0) buildShoe();
  const c = shoe.pop(); targetHand.push(c); sfx.deal();
  renderCard(targetNode, c, facedown);
}
function startRound(){
  const stakeBag = fromDispToBAG(betDisplay);
  if(!(betDisplay>0) || !(stakeBag>0)){ showToast('Invalid bet'); return; }
  if(!spendBAG(stakeBag)){ showToast('Insufficient balance'); return; }
  updateBalanceHUD();

  hasSplit=false; activeHandIndex=0; roundOver=false;
  clearHands();
  dealerHand=[]; playerHands=[[]];
  ensurePlayerHandsContainers();

  const p0 = document.getElementById('playerHand0');
  dealTo(playerHands[0], p0);
  dealTo(dealerHand, elDealerHand);

  dealTo(playerHands[0], p0);

  // dealer hole card as flip face
  // render facedown then swap on reveal
  const hole = shoe.pop(); dealerHand.push(hole);
  const holeCard = document.createElement('div');
  holeCard.className='card back';
  elDealerHand.appendChild(holeCard);

  updateTotals();
  btnDeal.disabled = true;

  // naturals
  const pBJ = isBlackjack(playerHands[0]);
  if(pBJ){
    revealDealerHole();
    const dBJ = isBlackjack(dealerHand);
    const deltaBag = settleHandReturnBAG(playerHands[0], dBJ ? 'push-bj' : 'blackjack');
    if(deltaBag>0) creditBAG(deltaBag);
    updateBalanceHUD();
    endRoundControls();
    return;
  }

  btnHit.disabled = false;
  btnStand.disabled = false;
  btnDouble.disabled = CONFIG.allowDouble;
  btnSplit.disabled = canSplit(playerHands[0]);
  elMessage.innerHTML = 'Play your hand';
}
function revealDealerHole(){
  // swap back with real face card (flip illusion)
  const cards = elDealerHand.querySelectorAll('.card');
  // remove the last back and insert faceup
  for(let i=cards.length-1;i>=0;i--){
    if(cards[i].classList.contains('back')){ cards[i].remove(); break; }
  }
  renderCard(elDealerHand, dealerHand[1], false);
  updateTotals();
}

btnDeal.addEventListener('click', startRound);
btnHit.addEventListener('click', ()=>{
  const idx=activeHandIndex;
  const node=document.getElementById('playerHand'+idx);
  dealTo(playerHands[idx], node);
  updateTotals();
  btnDouble.disabled = true; // no double after hit
  const v=handValue(playerHands[idx]).total;
  if(v>21){
    markMessage(`Hand ${playerHands.length>1?idx+1:''} busts`);
    nextHandOrDealer(true);
  }
});
btnStand.addEventListener('click', ()=>{
  markMessage(`Hand ${playerHands.length>1?activeHandIndex+1:''} stands`);
  nextHandOrDealer(true);
});
btnDouble.addEventListener('click', ()=>{
  const idx=activeHandIndex;
  if(playerHands[idx].length!==2){ showToast('Double only on first turn'); return; }
  const extra = fromDispToBAG(betDisplay);
  if(!spendBAG(extra)){ showToast('Insufficient balance'); return; }
  updateBalanceHUD();
  playerHands[idx]._doubled = true;
  markMessage(`Hand ${playerHands.length>1?idx+1:''} doubled`);
  const node=document.getElementById('playerHand'+idx);
  dealTo(playerHands[idx], node);
  updateTotals();
  nextHandOrDealer(true);
});
btnSplit.addEventListener('click', ()=>{
  const h0=playerHands[0];
  if(!canSplit(h0)) return;
  const stake = fromDispToBAG(betDisplay);
  if(!spendBAG(stake)){ showToast('Insufficient balance'); return; }
  updateBalanceHUD();
  hasSplit=true;

  const c2=h0.pop();
  playerHands=[ [h0[0]], [c2] ];
  ensurePlayerHandsContainers();

  const h0Node = document.getElementById('playerHand0');
  const h1Node = document.getElementById('playerHand1');
  renderCard(h0Node, playerHands[0][0]);
  renderCard(h1Node, playerHands[1][0]);
  dealTo(playerHands[0], h0Node);
  dealTo(playerHands[1], h1Node);
  updateTotals();

  activeHandIndex = 0;
  highlightActive();
  btnSplit.disabled = true;
  btnDouble.disabled = false;
});
btnNew.addEventListener('click', ()=>{ resetRoundUI(); setResult(0,'—'); });

function highlightActive(){
  document.querySelectorAll('.split-ribbon').forEach(n=>n.remove());
  if(playerHands.length>1){
    const h=document.getElementById('playerHand'+activeHandIndex);
    if (h){
      const r=document.createElement('div'); r.className='split-ribbon'; r.textContent='Active';
      h.appendChild(r);
    }
  }
}
function nextHandOrDealer(){
  if(playerHands.length>1){
    activeHandIndex++;
    if(activeHandIndex<playerHands.length){
      highlightActive();
      btnDouble.disabled = !(CONFIG.allowDouble && playerHands[activeHandIndex].length===2);
      btnHit.disabled = false;
      btnStand.disabled = false;
      return;
    }
  }
  dealerPlayAndSettle();
}
function dealerPlayAndSettle(){
  revealDealerHole();
  let dv = handValue(dealerHand);
  while(dv.total<17 || (dv.total===17 && dv.soft && CONFIG.dealerHitsSoft17)){
    dealTo(dealerHand, elDealerHand);
    dv = handValue(dealerHand);
  }
  updateTotals();

  let totalBagDelta = 0;
  if(playerHands.length===1){
    totalBagDelta += settleHandReturnBAG(playerHands[0]);
  }else{
    playerHands.forEach((h,idx)=>{ totalBagDelta += settleHandReturnBAG(h, undefined, idx); });
  }
  if(totalBagDelta>0) creditBAG(totalBagDelta);
  updateBalanceHUD();
  endRoundControls();
}
function settleHandReturnBAG(hand, override, splitIndex){
  let bagDelta = 0;
  const pv = handValue(hand).total;
  const dv = handValue(dealerHand).total;
  const stakeBagBase = fromDispToBAG(betDisplay);
  const doubledFlag = hand._doubled === true;
  const stakeBag = stakeBagBase * (doubledFlag ? 2 : 1);

  if(pv>21){
    setResult(0, `Hand ${playerHands.length>1?(splitIndex+1):''} busts — dealer wins`);
    sfx.lose();
    return 0;
  }
  if(override==='blackjack'){
    const win = stakeBagBase * CONFIG.blackjackPayout;
    bagDelta += stakeBagBase + win;
    setResult(bagDelta, 'Blackjack paid 2×');
    sfx.win();
    return bagDelta;
  }
  if(override==='push-bj'){
    bagDelta += stakeBagBase;
    setResult(bagDelta, 'Both Blackjack — push');
    return bagDelta;
  }

  if(dv>21){
    const win = stakeBag * CONFIG.regularWinPayout;
    bagDelta += stakeBag + win;
    setResult(bagDelta, `Dealer busts — win ${CONFIG.regularWinPayout.toFixed(2)}×`);
    sfx.win();
  }else if(pv>dv){
    if(isBlackjack(hand) && !doubledFlag && !hasSplit){
      const win = stakeBag * CONFIG.blackjackPayout;
      bagDelta += stakeBag + win;
      setResult(bagDelta, 'Blackjack — paid 2×');
    }else{
      const win = stakeBag * CONFIG.regularWinPayout;
      bagDelta += stakeBag + win;
      setResult(bagDelta, `You win ${CONFIG.regularWinPayout.toFixed(2)}×`);
    }
    sfx.win();
  }else if(pv<dv){
    setResult(0, 'Dealer wins');
    sfx.lose();
  }else{
    bagDelta += stakeBag * CONFIG.pushPayout;
    setResult(bagDelta, 'Push — bet returned');
  }
  return bagDelta;
}
function endRoundControls(){
  btnHit.disabled = true;
  btnStand.disabled = true;
  btnDouble.disabled = true;
  btnSplit.disabled = true;
  btnDeal.disabled = true;
  btnNew.style.display = 'inline-block';
  roundOver = true;
}
function markMessage(t){ elMessage.innerHTML = `<strong>${t}</strong>`; }

/* ===== Betting & currency ===== */
document.querySelectorAll('.chip').forEach(ch=>{
  ch.addEventListener('click', ()=>{
    if(roundOver===true || btnDeal.disabled===false){
      const v=Number(ch.dataset.v)||0;
      const newDisplay = betDisplay + v;
      const needBag = fromDispToBAG(newDisplay) - fromDispToBAG(betDisplay);
      if(sessionBalanceBAG() >= needBag){
        betDisplay = newDisplay;
        updateBetHUD();
        sfx.chip();
      }else{
        showToast('Insufficient balance');
      }
    }else{
      showToast('Bet locked for this round');
    }
  }, {passive:true});
});
btnClearBet.addEventListener('click', ()=>{
  if(btnDeal.disabled){ showToast('Bet locked for this round'); return; }
  betDisplay=0; updateBetHUD();
});
document.getElementById('ccyToggle').addEventListener('click', (e)=>{
  if(e.target.tagName!=='BUTTON') return;
  document.querySelectorAll('#ccyToggle button').forEach(b=>b.classList.remove('active'));
  e.target.classList.add('active');
  currency = e.target.dataset.ccy;
  updateBetHUD();
});

/* ===== Init & timers ===== */
function init(){
  buildShoe();
  betDisplay = 0;
  updatePricesInfo();
  updateBalanceHUD();
  updateBetHUD();
  resetRoundUI();
}
init();

setInterval(()=>{ if(shoe.length<15){ buildShoe(); showToast('Shuffled'); } }, 2000);
addEventListener('bag:pricesUpdated', ()=>{ updatePricesInfo(); updateBetHUD(); updateBalanceHUD(); }, {passive:true});
addEventListener('bag:sessionUpdated', ()=>{ renderMode(); updateBalanceHUD(); }, {passive:true});
</script>
</body>
</html>
