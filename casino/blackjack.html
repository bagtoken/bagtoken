<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>BAG Blackjack</title>

<script>window.__BAG_FORCE_DEMO = true;</script>

<style>
  *{box-sizing:border-box}
  :root{
    --gold:#ffe175;--bg:#020703;--panel:#0b1b13;--panel2:#0d2217;--fg:#f5f7f4;
    --green:#2fbf6b;--line:#173524;--shadow:rgba(0,0,0,.35);
    --cardW:clamp(64px,16vw,96px); --cardH:calc(var(--cardW)*1.42);
  }
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.55}
  img{display:block;max-width:100%;height:auto}

  .back-casino{position:fixed;top:18px;left:18px;z-index:1000;background:linear-gradient(180deg,#ffe175,#f5c94c);
    color:#08130d;text-decoration:none;font-weight:800;padding:8px 14px;border-radius:10px;box-shadow:0 4px 0 #b08a19}
  .game-header{text-align:center;padding:28px 10px 12px}
  .game-header h2{font-size:clamp(1.6rem,5vw,2.2rem);margin:6px 0 0}

  .wrap{max-width:1080px;margin:0 auto;padding:10px 16px 48px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}

  .panel{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 24px var(--shadow)}
  .pad{padding:14px}

  .table{background:#07140e;border:1px solid #1b4a2f;border-radius:14px;padding:14px}
  .felt{background:#091a13;border:1px solid #24533a;border-radius:12px;padding:12px}
  .marquee{text-align:center;font-weight:900;letter-spacing:.08em;color:#ffe9a6;background:linear-gradient(180deg,#17311f,#0e2419);
    border:1px solid #254a33;border-radius:12px;padding:8px;margin-bottom:10px}

  .hand{position:relative;min-height:calc(var(--cardH) + 36px);padding-top:20px}
  .label{position:absolute;top:0;left:0;color:#bcd0c4;font-size:12px}
  .total{position:absolute;top:0;right:0;background:#0f2e20;border:1px solid #1a5136;color:#ffe175;padding:3px 10px;border-radius:999px;font-size:12px}
  .cards{display:flex;gap:8px;flex-wrap:nowrap}
  .card{width:var(--cardW);height:var(--cardH);border-radius:12px;border:2px solid #dcdcdc;background:#fff;overflow:hidden;box-shadow:0 10px 18px rgba(0,0,0,.32)}
  .card img{width:100%;height:100%;object-fit:contain;display:block;padding:2%;background:#fff}

  .btnbar{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:10px 0 0}
  .btn{min-width:120px;padding:12px 14px;border:0;border-radius:12px;font-weight:900;cursor:pointer;color:#08130d;background:linear-gradient(180deg,#ffe175,#f5c94c)}
  .btn.alt{color:#e9efe9;background:#15261c;border:1px solid #2b6a48}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  .hud{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin:8px 0 0}
  .pill{background:#0a1e15;border:1px solid #244330;border-radius:999px;padding:6px 10px;font-size:12px;color:#cfe6d8}
  .micro{font-size:.85rem;color:#a8b5ab}
</style>
</head>
<body>

<a href="/casino/" class="back-casino">‚¨ÖÔ∏è Back</a>

<section class="game-header">
  <h2>üé¥ $BAG Blackjack</h2>
  <p class="micro" style="opacity:.9">Demo balance enabled while testing.</p>
</section>

<div class="wrap">
  <div class="grid">
    <!-- LEFT: Controls -->
    <div class="panel pad">
      <div class="micro" style="margin-bottom:8px">Bet amount (BAG, whole number)</div>
      <input id="betQty" class="mono" type="number" inputmode="numeric" min="1" step="1" value="1"
        style="width:160px;background:#0b2217;border:1px solid #1b4a2f;border-radius:10px;color:#f3f5f0;padding:10px">
      <div class="micro" style="margin-top:8px">Balance (demo)</div>
      <div id="balanceLbl" class="mono">‚Äî BAG</div>
      <div class="micro" style="margin-top:8px;opacity:.85">Blackjack pays 2.00√ó ¬∑ Regular win pays 1.25√ó ¬∑ Push returns stake.</div>
    </div>

    <!-- RIGHT: Table -->
    <div class="panel pad">
      <div class="marquee">$BAG TABLE</div>
      <div class="felt">
        <div class="table">
          <div class="hand" id="dealer">
            <div class="label">Dealer</div><div class="total" id="dealerTotal">0</div>
            <div class="cards" id="dealerCards"></div>
          </div>
          <div class="hand" id="player">
            <div class="label">You</div><div class="total" id="playerTotal">0</div>
            <div class="cards" id="playerCards"></div>
          </div>

          <div class="btnbar">
            <button id="deal" class="btn">Deal</button>
            <button id="hit"  class="btn" disabled>Hit</button>
            <button id="stand"class="btn" disabled>Stand</button>
            <button id="double"class="btn alt" disabled>Double</button>
            <button id="split" class="btn alt" disabled>Split</button>
            <button id="again" class="btn" style="display:none">New Hand</button>
          </div>

          <div class="hud">
            <span class="pill">Mode: <b>Demo</b></span>
            <span class="pill">Bet: <b id="betLbl">1</b> BAG</span>
            <span class="pill">Last: <b id="lastLbl">‚Äî</b></span>
          </div>

          <div id="status" class="micro" style="text-align:center;margin-top:8px">Place a stake, then Deal</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- AUDIO (click + shuffle like Dice prime pattern) -->
<script>
(function(){
  try{
    const shuffle = new Audio('/assets/sounds/card_shuffle.mp3'); shuffle.preload='auto'; shuffle.volume=.6;
    const click   = new Audio('/assets/sounds/card_place.mp3');  click.preload='auto';  click.volume=.5;
    function prime(a){ a.muted=true; a.play().catch(()=>{}).finally(()=>{ a.pause(); a.currentTime=0; a.muted=false; }); }
    function primeAll(){ [shuffle,click].forEach(prime); removeEventListener('pointerdown', primeAll); }
    addEventListener('pointerdown', primeAll, {passive:true});
    window.__bagSfx = {
      shuffle(){ try{ shuffle.currentTime=0; shuffle.play().catch(()=>{});}catch{} },
      click(){ try{ click.currentTime=0; click.play().catch(()=>{});}catch{} }
    };
  }catch(e){}
})();
</script>

<!-- CARD FACTORY (single-size WebP in /assets/cards) -->
<script>
(function(){
  const ROOT = '/assets/cards';
  const BACK = `${ROOT}/back-black.webp`;
  const WORD = {'‚ô†':'spades','‚ô•':'hearts','‚ô¶':'diamonds','‚ô£':'clubs'};
  const R2B  = r => (r==='A'?'ace':r==='K'?'king':r==='Q'?'queen':r==='J'?'jack':r);

  // warm a single back image; nothing else
  (new Image()).src = BACK;

  function imgEl(src,isBack){
    const img = document.createElement('img');
    img.decoding='async';
    img.loading='eager';
    img.fetchPriority='high';
    img.width=256; img.height=Math.round(256*1.42); // give intrinsic size to avoid layout shift
    img.src = src;
    // if a face is missing/404, show back so you still see a card
    img.onerror = ()=>{ if(!isBack){ img.onerror=null; img.src=BACK; } };
    const wrap = document.createElement('div');
    wrap.className='card'+(isBack?' back':'');
    wrap.appendChild(img);
    return wrap;
  }
  function faceUrl(card){ return `${ROOT}/${R2B(card.r)}-${(WORD[card.s]||'spades')}.webp`; }

  window.__CARD_FACTORY__ = {
    makeCardEl(card, faceDown=false){
      return faceDown ? imgEl(BACK,true) : imgEl(faceUrl(card),false);
    }
  };
})();
</script>

<!-- GAME CORE (lean, no preloads) -->
<script>
/* Demo ‚Äúwallet‚Äù (same feel as Dice demo) */
(function(){
  const KEY='__bag_demo_bag_v1', START=1000;
  function get(){ try{ return Number(localStorage.getItem(KEY))||START; }catch{ return START; } }
  function set(v){ try{ localStorage.setItem(KEY,String(Math.max(0,Number(v)||0))); }catch{} }
  if(localStorage.getItem(KEY)==null) set(START);
  window.__bagSession = {
    get: ()=>({bag:get()}),
    spend:(n)=>{ const b=get(); if(!(n>0) || b<n) return false; set(b-n); refreshBal(); return true; },
    credit:(n)=>{ if(!(n>0)) return; set(get()+n); refreshBal(); }
  };
  function refreshBal(){
    const el=document.getElementById('balanceLbl');
    if (el) el.textContent = `${(get()).toLocaleString(undefined,{maximumFractionDigits:6})} BAG`;
  }
  addEventListener('DOMContentLoaded', refreshBal);
  window.refreshBal = refreshBal;
})();

/* Blackjack rules */
const CFG = { decks:1, hitSoft17:true, allowDouble:true, allowSplit:true, mBJ:2.00, mWIN:1.25, mPUSH:1.00 };
let shoe=[];
function buildShoe(){ const R=['A','2','3','4','5','6','7','8','9','10','J','Q','K'], S=['‚ô†','‚ô•','‚ô¶','‚ô£']; const t=[]; for(let d=0;d<CFG.decks;d++) for(const r of R) for(const s of S) t.push({r,s}); for(let i=t.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [t[i],t[j]]=[t[j],t[i]]; } shoe=t; }
function draw(){ if(!shoe.length) buildShoe(); return shoe.pop(); }
function val(hand){ let t=0,a=0; for(const c of hand){ if(c.r==='A'){t+=11;a++;} else if(['K','Q','J','10'].includes(c.r)) t+=10; else t+=parseInt(c.r,10); } while(t>21 && a>0){ t-=10; a--; } return {total:t, soft:(a>0 && t<=21)}; }
function isBJ(h){ if(h.length!==2) return false; const v=h.map(c=>c.r); return v.includes('A') && ['10','J','Q','K'].some(x=>v.includes(x)); }
function eqVal(a,b){ const fv=x=>x.r==='A'?11:(['K','Q','J','10'].includes(x.r)?10:parseInt(x.r,10)); return fv(a)===fv(b); }

/* UI */
const D=(id)=>document.getElementById(id);
const btnDeal=D('deal'), btnHit=D('hit'), btnStand=D('stand'), btnDouble=D('double'), btnSplit=D('split'), btnAgain=D('again');
function setStatus(t){ const el=D('status'); if(el) el.textContent=t; }
function last(t){ const el=D('lastLbl'); if(el) el.textContent=t; }
D('betQty').addEventListener('input',()=>{ D('betLbl').textContent = String(Math.max(0,Math.floor(parseFloat(D('betQty').value||'0')||0))); });

/* State */
const ST = { dealer:[], player:[], split:null, locked:0, live:false };

function clearBoard(){
  D('dealerCards').innerHTML=''; D('playerCards').innerHTML='';
  D('dealerTotal').textContent='0'; D('playerTotal').textContent='0';
  document.querySelectorAll('.splitRow').forEach(n=>n.remove());
}
function updTotals(){
  D('dealerTotal').textContent = val(ST.dealer).total;
  if (ST.split){
    D('playerTotal').textContent = val(ST.player[0]).total;
    D('pT_1').textContent = val(ST.player[1]).total;
  } else {
    D('playerTotal').textContent = val(ST.player).total;
  }
}
function addSplitRow(){
  const row=document.createElement('div'); row.className='hand splitRow';
  row.innerHTML=`<div class="label">You (Hand 2)</div><div class="total" id="pT_1">0</div><div class="cards" id="pC_1"></div>`;
  D('player').after(row);
}

function dealOne(toNode, arr, faceUp=true){
  const c=draw(); arr.push(c);
  const el = window.__CARD_FACTORY__.makeCardEl(c, !faceUp);
  toNode.appendChild(el);
  try{ window.__bagSfx && __bagSfx.click(); }catch{}
  updTotals();
}

function revealHole(){
  const dc=D('dealerCards');
  const back=dc.querySelector('.card.back');
  if(back){
    const el = window.__CARD_FACTORY__.makeCardEl(ST.dealer[1], false);
    back.replaceWith(el);
  }
  updTotals();
}

/* Flow */
function lockStake(){
  const q = Math.max(0, Math.floor(parseFloat(D('betQty').value||'0')||0));
  if(q<1) return [false,'Enter a whole-number BAG stake (min 1)'];
  if(!__bagSession.spend(q)) return [false,'Insufficient balance'];
  ST.locked = q; return [true,''];
}

function startRound(){
  const [ok,err]=lockStake(); if(!ok) return alert(err);
  clearBoard(); ST.dealer=[]; ST.player=[]; ST.split=null; ST.live=true;
  try{ window.__bagSfx && __bagSfx.shuffle(); }catch{}
  dealOne(D('playerCards'), ST.player, true);
  dealOne(D('dealerCards'), ST.dealer, true);
  // hole card face-down
  const hole = draw(); ST.dealer.push(hole); D('dealerCards').appendChild(window.__CARD_FACTORY__.makeCardEl(hole,true));
  dealOne(D('playerCards'), ST.player, true);

  btnDeal.disabled=true; btnHit.disabled=false; btnStand.disabled=false; btnDouble.disabled=false; btnSplit.disabled=(ST.player.length!==2 || !eqVal(ST.player[0],ST.player[1])); btnAgain.style.display='none';
  setStatus('Play your hand'); last('Dealt');

  if(isBJ(ST.player)){
    revealHole();
    if(isBJ(ST.dealer)) return settle('push-bj');
    return settle('blackjack');
  }
}

function hit(){
  if(ST.split){
    const act = (ST.player[0]._act?1:0);
    dealOne(act?D('pC_1'):D('playerCards'), ST.player[act], true);
    if(val(ST.player[act]).total>21){ ST.player[act]._done=true; setStatus(`Hand ${act+1} busts`); }
    if(val(ST.player[act]).total>=21 || ST.player[act]._done){ ST.player[act]._act=false; ST.player[1-act]._act=true; if(!ST.player[0]._act && !ST.player[1]._act) dealerTurn(); }
  } else {
    dealOne(D('playerCards'), ST.player, true);
    if(val(ST.player).total>21) dealerTurn();
  }
}

function stand(){
  if(ST.split){
    if(ST.player[0]._act){ ST.player[0]._act=false; ST.player[1]._act=true; setStatus('Hand 2: your move'); }
    else { ST.player[1]._act=false; dealerTurn(); }
  }else{
    dealerTurn();
  }
}

function dbl(){
  if(ST.split){ return; }
  if(ST.player.length!==2) return alert('Double only on first turn');
  if(!__bagSession.spend(ST.locked)) return alert('Insufficient balance');
  ST.player._dbl=true;
  dealOne(D('playerCards'), ST.player, true);
  dealerTurn();
}

function split(){
  if(ST.player.length!==2 || !eqVal(ST.player[0],ST.player[1])) return;
  if(!__bagSession.spend(ST.locked)) return alert('Insufficient balance');
  ST.split=true;
  const [a,b]=ST.player;
  ST.player=[ [a], [b] ];
  D('playerCards').innerHTML='';
  addSplitRow();
  D('playerCards').appendChild(window.__CARD_FACTORY__.makeCardEl(a,false));
  D('pC_1').appendChild(window.__CARD_FACTORY__.makeCardEl(b,false));
  ST.player[0]._act=true; ST.player[1]._act=false;
  hit(); // one card to each after split
  hit();
  updTotals();
  btnSplit.disabled=true;
}

function dealerTurn(){
  revealHole();
  let dv=val(ST.dealer);
  while(dv.total<17 || (dv.total===17 && dv.soft && CFG.hitSoft17)){
    dealOne(D('dealerCards'), ST.dealer, true);
    dv=val(ST.dealer);
  }
  settle();
}

function settle(override){
  const base=ST.locked; let credit=0;
  function resolveHand(h){
    const pv=val(h).total, dv=val(ST.dealer).total;
    const doubled = h._dbl===true; const stake = base*(doubled?2:1);

    if(override==='blackjack'){ credit += stake*CFG.mBJ; last('Blackjack 2√ó'); return; }
    if(override==='push-bj'){ credit += stake*CFG.mPUSH; last('Push'); return; }

    if(pv>21){ last('Scratch'); return; }
    if(dv>21 || pv>dv){
      const mult = (isBJ(h)&&!doubled&&!ST.split)?CFG.mBJ:CFG.mWIN;
      credit += stake*mult; last(mult===CFG.mBJ?'Blackjack 2√ó':'Win 1.25√ó');
    } else if(pv===dv){
      credit += stake*CFG.mPUSH; last('Push');
    } else {
      last('Scratch');
    }
  }
  if(ST.split){ ST.player.forEach(resolveHand); } else { resolveHand(ST.player); }
  if(credit>0) __bagSession.credit(credit);

  btnHit.disabled=true; btnStand.disabled=true; btnDouble.disabled=true; btnSplit.disabled=true; btnDeal.disabled=true; btnAgain.style.display='inline-block';
  ST.live=false; refreshBal();

  const dv=val(ST.dealer).total;
  const pv = ST.split ? `${val(ST.player[0]).total}/${val(ST.player[1]).total}` : val(ST.player).total;
  setStatus(`Dealer ${dv} ¬∑ You ${pv}`);
}

btnDeal.addEventListener('click', startRound);
btnHit.addEventListener('click', hit);
btnStand.addEventListener('click', stand);
btnDouble.addEventListener('click', dbl);
btnSplit.addEventListener('click', split);
btnAgain.addEventListener('click', ()=>{ clearBoard(); btnDeal.disabled=false; btnHit.disabled=true; btnStand.disabled=true; btnDouble.disabled=true; btnSplit.disabled=true; btnAgain.style.display='none'; setStatus('Place a stake, then Deal'); last('‚Äî'); });

(function boot(){
  buildShoe();
  document.getElementById('betLbl').textContent = String(Math.max(0,Math.floor(parseFloat(document.getElementById('betQty').value||'0')||0)));
})();
</script>

<script>
if('serviceWorker' in navigator){ navigator.serviceWorker.register('/service-worker.js').catch(()=>{}); }
</script>

</body>
</html>
