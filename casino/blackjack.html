<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>$BAG Blackjack</title>

<script>window.__BAG_FORCE_DEMO=false;</script>

<style>
  *{box-sizing:border-box}
  :root{
    --gold:#ffe175;--bg:#030905;--fg:#eef3ed;
    --panel:#0b1b13;--panel2:#0d2217;--line:#173524;--muted:#aeb7af;
    --ok:#2fbf6b;--lose:#e25b5b;--warn:#e8a85c;
    --cardW:clamp(70px,17.5vw,108px);--cardH:calc(var(--cardW)*1.42);
    --shadow:rgba(0,0,0,.35);
  }
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  button,input{font-size:16px}

  /* Back to Casino */
  .back-casino{
    position:fixed;top:18px;left:18px;z-index:1000;
    background:linear-gradient(180deg,#ffe175 0%,#f5c94c 100%);
    color:#08130d;text-decoration:none;font-weight:800;padding:8px 14px;border-radius:10px;
    box-shadow:0 4px 0 #b08a19;transition:all .15s ease
  }
  .back-casino:hover{filter:brightness(1.05);box-shadow:0 4px 0 #b08a19,0 14px 28px rgba(255,225,117,.22)}
  .back-casino:active{transform:translateY(1px);box-shadow:0 3px 0 #9a7315}

  /* Header (BIGGER banner) */
  .game-header{ text-align:center; padding:52px 0 16px; max-width:1600px; margin:0 auto }
  .game-header img.hero{
    display:block; margin:0 auto 10px;
    width:min(95vw,1280px);  /* << bigger */
    max-width:1280px; height:auto;
    filter:drop-shadow(0 10px 24px rgba(46,191,107,.18));
  }
  .game-header h1{font-size:clamp(1.9rem,6vw,2.8rem);margin:6px 12px 0}
  .micro{font-size:.9rem;color:#cbd7cd}
  .mono{font-variant-numeric:tabular-nums}

  /* Layout */
  .game-teaser{padding:10px 16px 60px;background:
    radial-gradient(1200px 600px at 10% -10%, #0e2c1d 0%, transparent 60%),
    radial-gradient(900px 500px at 110% 20%, #0b2318 0%, transparent 55%),#060806;
    border-top:1px solid #131313;border-bottom:1px solid #131313}
  .wrap{max-width:1120px;margin:0 auto;display:grid;grid-template-columns:1.12fr .88fr;gap:22px}
  @media (max-width:900px){.wrap{grid-template-columns:1fr}}

  .panel{background:linear-gradient(180deg,var(--panel),var(--panel2));
    border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 24px var(--shadow)}
  .pad{padding:14px}
  .section-title{font-weight:800;font-size:1.2rem;margin:0 0 12px}
  .stack{display:grid;gap:10px}
  .choice{display:flex;gap:10px;flex-wrap:wrap}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid #2b6a48;background:#0e2a1c;color:#e9efe9;font-weight:800}
  .chip input{accent-color:var(--ok)}
  input[type=number]{width:140px;background:#0b2217;border:1px solid #1b4a2f;border-radius:10px;color:#f3f5f0;padding:10px}

  /* GREEN preset chips (Dice parity) */
  .preset{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .preset button{
    appearance:none;border:1px solid #2b6a48;background:#0e2a1c;color:#e9efe9;
    border-radius:999px;padding:6px 10px;font-weight:800;cursor:pointer;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.06);
  }
  .preset button.active{background:#173c28;border-color:#3fa86a;box-shadow:0 0 0 2px rgba(63,168,106,.25) inset}
  .preset button:focus-visible{outline:2px solid var(--gold);outline-offset:2px}

  .marquee{text-align:center;font-weight:900;letter-spacing:.08em;color:#ffe9a6;
    background:linear-gradient(180deg,#17311f,#0e2419);border:1px solid #254a33;border-radius:12px;padding:8px;margin-bottom:10px}

  .felt{background:radial-gradient(1200px 600px at 50% -10%, #16432b 0%, #0f2c1e 55%, #0a2016 100%);border:1px solid #153b27;border-radius:14px;padding:12px}
  .table{background:#091a13;border:1px solid #24533a;border-radius:12px;padding:10px}

  .hand{position:relative;min-height:calc(var(--cardH) + 36px);padding-top:24px}
  .label{position:absolute;top:0;left:0;color:#bcd0c4;font-size:12px}
  .total{position:absolute;top:0;right:0;background:#0f2e20;border:1px solid #1a5136;color:#ffe175;padding:3px 10px;border-radius:999px;font-size:12px}
  .cards{display:flex;gap:10px;flex-wrap:nowrap}

  /* Card */
  .card{width:var(--cardW);height:var(--cardH);border-radius:12px;border:2px solid #e6e6e6;background:linear-gradient(#fff,#f4f7f6);box-shadow:0 10px 22px rgba(0,0,0,.35);display:grid;place-items:center;position:relative;transform:translateY(14px);opacity:0;animation:in .16s ease-out forwards}
  .card.back{background:repeating-linear-gradient(45deg,#0b1b13 0px,#0b1b13 6px,#0e2217 6px,#0e2217 12px);border-color:#193d2b}
  @keyframes in{to{transform:translateY(0);opacity:1}}
  .svg-card{width:92%;height:92%}

  .btnbar{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:10px 0 0}
  .btn{min-width:120px;padding:12px 14px;border:0;border-radius:12px;font-weight:900;cursor:pointer;color:#08130d;background:linear-gradient(180deg,#ffe175, #f5c94c);box-shadow:0 6px 0 #b08a19, 0 16px 32px rgba(255,225,117,.18)}
  .btn.alt{color:#e9efe9;background:#15261c;box-shadow:none;border:1px solid #2b6a48}
  .btn:disabled{opacity:.55;cursor:not-allowed}

  .hud{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin-top:8px}
  .pill{background:#0a1e15;border:1px solid #244330;border-radius:999px;padding:6px 10px;font-size:12px;color:#cfe6d8}
  .result{margin-top:10px;padding:10px;border:1px solid #1b4a2f;border-radius:12px;background:#0b2217;color:#dfece7}
  .t.win{color:#2fbf6b}.t.push{color:#e8a85c}.t.lose{color:#e25b5b}

  /* Footer tidy */
  footer{ text-align:center; padding:12px 0 16px; line-height:1.6; color:#d9e5db }
  footer a{ color:#e0c66f; text-decoration:none; font-weight:700 }
</style>
</head>
<body>

<a href="/casino/" class="back-casino">‚¨ÖÔ∏è Back to Casino</a>

<section class="game-header">
  <img src="/assets/bag-blackjack.png" alt="$BAG Blackjack" class="hero" loading="lazy" decoding="async">
  <h1>üé¥ $BAG Blackjack</h1>
  <p class="micro" style="margin-top:4px;opacity:.9;">üí∞ <b>All payouts settle in $BAG.</b> $XRP bets convert automatically at the live rate.</p>
</section>

<section class="game-teaser">
  <div class="wrap">
    <!-- LEFT: Controls -->
    <div class="panel pad">
      <div class="section-title">Stake & Prices</div>
      <div class="stack">
        <div>
          <div class="micro">Amount</div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <input id="usd" class="mono" type="number" inputmode="decimal" step="0.01" min="0" placeholder="0.00">
            <span class="micro">USD</span>
          </div>
          <div class="preset" id="usdPresets">
            <button data-u="1">$1</button><button data-u="2">$2</button><button data-u="5">$5</button>
            <button data-u="10">$10</button><button data-u="20">$20</button><button data-u="50">$50</button>
            <button data-u="100">$100</button><button data-u="2000">Max</button>
          </div>
        </div>

        <div>
          <div class="micro">Bet currency</div>
          <div class="choice" id="curToggle">
            <label class="chip"><input type="radio" name="cur" value="XRP" checked> XRP</label>
            <label class="chip"><input type="radio" name="cur" value="BAG"> BAG</label>
          </div>
        </div>

        <div>
          <div class="micro">Bet amount</div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <input id="qty" class="mono" type="number" inputmode="decimal" step="any" min="0" value="1">
            <span id="unit" class="micro">XRP</span>
          </div>
          <div class="micro" id="limits" style="margin-top:6px"></div>
        </div>

        <div class="micro">Live prices</div>
        <div class="mono micro">BAG $<span id="pBag">‚Äî</span> ¬∑ XRP $<span id="pXrp">‚Äî</span> <span id="pSrc" class="micro"></span></div>

        <div class="micro" id="payouts" style="margin-top:6px">
          Blackjack: ‚Äî BAG ($‚Äî) ¬∑ Win: ‚Äî BAG ($‚Äî) ¬∑ Push: ‚Äî BAG ($‚Äî)
        </div>
      </div>
    </div>

    <!-- RIGHT: Table -->
    <div class="panel pad">
      <div class="marquee">$BAG TABLE</div>
      <div class="felt">
        <div class="table">
          <div class="hand" id="dealer">
            <div class="label">Dealer</div><div class="total" id="dealerTotal">0</div>
            <div class="cards" id="dealerCards"></div>
          </div>
          <div class="hand" id="player">
            <div class="label">You</div><div class="total" id="playerTotal">0</div>
            <div class="cards" id="playerCards"></div>
          </div>

          <div class="btnbar">
            <button id="deal" class="btn">Deal</button>
            <button id="hit"  class="btn" disabled>Hit</button>
            <button id="stand"class="btn" disabled>Stand</button>
            <button id="double"class="btn alt" disabled>Double</button>
            <button id="split" class="btn alt" disabled>Split</button>
            <button id="again" class="btn" style="display:none">New Hand</button>
          </div>

          <div class="hud">
            <span class="pill">Mode: <b id="modeLbl">Demo</b></span>
            <span class="pill">Balance: <b id="balLbl">‚Äî</b> <span id="balUnit">BAG</span></span>
            <span class="pill">Bet: <b id="betLbl">1</b></span>
            <span class="pill">Last: <b id="lastLbl">‚Äî</b></span>
          </div>

          <div id="status" class="result">Place a stake, then Deal</div>
        </div>
      </div>
    </div>
  </div>
</section>

<footer>
  ¬© 2025 $BAG Protocol ¬∑ getthebag.io ¬∑ Powered by $XRP
  <br>
  <a href="https://x.com/getthebag_io" target="_blank" rel="noopener">ùïè @getthebag_io</a> ¬∑
  <a href="https://t.me/getthebag_io" target="_blank" rel="noopener">Telegram @getthebag_io</a>
</footer>

<!-- ========= Card Audio (file first; synth fallback) ========= -->
<script>
(function(){
  const AC = {ctx:null, master:null};
  const SOURCES = [
    '/assets/sounds/card-deal.mp3',
    '/assets/sounds/card-deal.wav',
    '/assets/sounds/card-flick.mp3'
  ];
  let buf=null, tag=null;

  function getAC(){
    if (AC.ctx && AC.ctx.state!=='closed') return AC.ctx;
    const C = window.AudioContext||window.webkitAudioContext; if(!C) return null;
    AC.ctx = new C();
    AC.master = AC.ctx.createGain(); AC.master.gain.value = .28;
    AC.master.connect(AC.ctx.destination);
    return AC.ctx;
  }
  async function resume(){ try{ const a=getAC(); if(a && a.state==='suspended') await a.resume(); }catch{} }
  addEventListener('pointerdown', resume, {passive:true});
  addEventListener('visibilitychange', ()=>{ if(!document.hidden) resume(); });

  async function loadFile(){
    const ac=getAC(); if(!ac) return false;
    for (const url of SOURCES){
      try{
        const r = await fetch(url, {cache:'force-cache'});
        if(!r.ok) continue;
        const arr = await r.arrayBuffer();
        buf = await ac.decodeAudioData(arr);
        return true;
      }catch{}
    }
    try{ // html <audio> fallback
      tag = new Audio(SOURCES[0]); tag.preload='auto'; tag.crossOrigin='anonymous'; tag.setAttribute('playsinline',''); tag.volume=.85;
    }catch{}
    return !!tag;
  }

  function synthDeal(){
    const ac=getAC(); if(!ac) return;
    // swish noise
    const dur=.12;
    const noise=ac.createBuffer(1, ac.sampleRate*dur, ac.sampleRate);
    const ch=noise.getChannelData(0);
    for(let i=0;i<ch.length;i++){ const t=i/ch.length; ch[i]=(Math.random()*2-1)*Math.pow(1-t,2); }
    const src=ac.createBufferSource(); src.buffer=noise;
    const bp=ac.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=1400; bp.Q.value=1.2;
    const g=ac.createGain(); const t=ac.currentTime; g.gain.setValueAtTime(.0001,t); g.gain.linearRampToValueAtTime(.32,t+.02); g.gain.exponentialRampToValueAtTime(.0001,t+dur);
    src.connect(bp).connect(g).connect(AC.master); src.start(t); src.stop(t+dur);

    // little ‚Äúflick‚Äù click
    const o=ac.createOscillator(), cg=ac.createGain();
    o.type='square'; o.frequency.value=2200 + Math.random()*200;
    cg.gain.setValueAtTime(.0001,t); cg.gain.linearRampToValueAtTime(.18,t+.015); cg.gain.exponentialRampToValueAtTime(.0001,t+.07);
    o.connect(cg).connect(AC.master); o.start(t+.015); o.stop(t+.09);
  }

  function playFile(){
    const ac=getAC(); if(ac && buf && ac.state==='running'){
      try{
        const s=ac.createBufferSource();
        s.buffer=buf;
        s.playbackRate.value=0.96 + Math.random()*0.08; // tiny variation
        const g=ac.createGain(); g.gain.value=.95;
        s.connect(g).connect(AC.master);
        s.start();
        return true;
      }catch{}
    }
    if(tag){
      try{
        tag.pause(); tag.currentTime=0;
        tag.play().catch(()=>{});
        return true;
      }catch{}
    }
    return false;
  }

  async function ensureLoaded(){ if(buf || tag) return; try{ await resume(); await loadFile(); }catch{} }

  async function deal(){
    await ensureLoaded();
    if(!playFile()) synthDeal();
  }

  window.__bagCardSound = { deal, resume };
})();
</script>

<!-- ========= Demo Session (never spends/credits in demo) ========= -->
<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const forceLive = qs.get('live') === '1';

  const KEY='__bag_demo_blackjack_parity_v3';
  const START=1000;
  if(localStorage.getItem(KEY)==null){ try{ localStorage.setItem(KEY, String(START)); }catch{} }

  const demoSession={
    active:()=>true,
    get:()=>({addr:'demo', bag:Number(localStorage.getItem(KEY))||START, ts:Date.now()}),
    spend(){ return true; }, credit(){ return true; } // demo never blocks
  };

  if (forceLive){
    window.__BAG_FORCE_DEMO=false;
    window.__bagSession = { active:()=>false };
  } else {
    try{ Object.defineProperty(window,'__BAG_FORCE_DEMO',{value:true, configurable:false}); }catch{ window.__BAG_FORCE_DEMO=true; }
    window.__bagSession = demoSession;
  }
})();
</script>

<!-- ========= Prices ========= -->
<script>
const PRICES = { bagUsd: 0.0001, xrpUsd: 0.50, source:'default' };
(async function fetchLive(){
  try{
    const r = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=ripple&vs_currencies=usd',{cache:'no-store'});
    const x = (await r.json())?.ripple?.usd; if(Number(x)>0) PRICES.xrpUsd = Number(x);
  }catch{}
  PRICES.source = (PRICES.xrpUsd ? 'live' : 'default');
  renderPrices(); dispatchEvent(new CustomEvent('prices'));
})();
function renderPrices(){
  const $ = (s)=>document.getElementById(s);
  $('pBag').textContent = Number(PRICES.bagUsd||0).toLocaleString(undefined,{maximumFractionDigits:6});
  $('pXrp').textContent = Number(PRICES.xrpUsd||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  $('pSrc').textContent = PRICES.source==='default' ? '(default)' : '(live)';
}
</script>

<!-- ========= Inputs & payouts ========= -->
<script>
const elUSD = document.getElementById('usd');
const elQty = document.getElementById('qty');
const elUnit= document.getElementById('unit');
const elLimits=document.getElementById('limits');
document.getElementById('usdPresets').addEventListener('click', (e)=>{
  const b=e.target.closest('button'); if(!b) return;
  [...e.currentTarget.children].forEach(x=>x.classList.remove('active')); b.classList.add('active');
  const v=Number(b.dataset.u)||0; elUSD.value=v.toFixed(2); elUSD.dataset.user='1'; syncFromUSD();
});
document.querySelectorAll('input[name="cur"]').forEach(r=>r.addEventListener('change',()=>{
  elUnit.textContent = currentCur();
  if(elUSD.dataset.user==='1'){ syncFromUSD(); } else { syncFromUnits(); }
  dispatchEvent(new CustomEvent('hud'));
}));
elUSD.addEventListener('input', ()=>{ elUSD.dataset.user = elUSD.value ? '1':'0'; syncFromUSD(); });
elQty.addEventListener('input', ()=>{ elUSD.dataset.user = '0'; syncFromUnits(); });

function currentCur(){ return (document.querySelector('input[name="cur"]:checked')?.value || 'XRP').toUpperCase(); }
function priceForCur(){ return currentCur()==='BAG' ? PRICES.bagUsd : PRICES.xrpUsd; }
function stakeUSD(){ const v=parseFloat(elUSD.value||''); if(Number.isFinite(v)&&v>0) return v; const q=parseFloat(elQty.value||'')||0; const px=priceForCur(); return px>0?q*px:0; }
function stakeBAG(){
  const q=parseFloat(elQty.value||'')||0;
  if(currentCur()==='BAG') return q;
  const {bagUsd,xrpUsd}=PRICES; return (bagUsd>0 && xrpUsd>0) ? q*(xrpUsd/bagUsd) : 0;
}
function syncFromUSD(){
  const u = Math.max(0, Number(elUSD.value)||0);
  const px = priceForCur();
  elQty.value = (px>0 && u>0) ? (Math.floor((u/px)*1e6)/1e6) : '';
  renderLimits(); renderPayouts(); dispatchEvent(new CustomEvent('hud'));
}
function syncFromUnits(){
  if(elUSD.dataset.user==='1') return;
  const px=priceForCur(), q=parseFloat(elQty.value||'')||0;
  elUSD.value = (px>0 && q>0) ? (Math.round(q*px*100)/100).toFixed(2) : '';
  renderLimits(); renderPayouts(); dispatchEvent(new CustomEvent('hud'));
}
function renderLimits(){
  const u = stakeUSD()||0;
  const warn = (u>0 && u<1) ? ' ¬∑ Min $1' : (u>2000 ? ' ¬∑ Max $2000' : '');
  elLimits.innerHTML = `Limits: $1‚Äì$2000 ¬∑ Your stake ‚âà $${u.toFixed(2)}${warn}`;
}
function renderPayouts(){
  const bag = stakeBAG(); const usd = stakeUSD();
  setText('payouts', `Blackjack: ${fmt(bag*2)} BAG ($${(usd*2).toFixed(2)}) ¬∑ Win: ${fmt(bag*1.25)} BAG ($${(usd*1.25).toFixed(2)}) ¬∑ Push: ${fmt(bag)} BAG ($${usd.toFixed(2)})`);
}
function fmt(n,max=6){ return Number(n||0).toLocaleString(undefined,{maximumFractionDigits:max}); }
function setText(id,txt){ document.getElementById(id).textContent = txt; }
</script>

<!-- ========= SVG Cards (no emoji) ========= -->
<script>
const SUITS = {
  '‚ô†': {fill:'#111', path:'M50 12 C40 0,20 0,12 12 C4 24,16 34,26 40 C18 36,8 44,8 52 C8 60,14 66,22 66 C30 66,34 62,36 58 L36 68 L64 68 L64 58 C66 62,70 66,78 66 C86 66,92 60,92 52 C92 44,82 36,74 40 C84 34,96 24,88 12 C80 0,60 0,50 12 Z' },
  '‚ô•': {fill:'#c1121f', path:'M50 76 C48 74,14 46,10 30 C6 16,16 6,28 6 C38 6,44 12,50 20 C56 12,62 6,72 6 C84 6,94 16,90 30 C86 46,52 74,50 76 Z'},
  '‚ô¶': {fill:'#c1121f', path:'M50 6 L14 42 L50 78 L86 42 Z'},
  '‚ô£': {fill:'#111', path:'M50 18 C40 18,32 26,32 36 C32 40,34 44,36 46 C30 44,24 48,22 54 C20 62,26 70,34 70 C40 70,44 66,46 62 L46 70 L54 70 L54 62 C56 66,60 70,66 70 C74 70,80 62,78 54 C76 48,70 44,64 46 C66 44,68 40,68 36 C68 26,60 18,50 18 Z'}
};
function cardSVG(rank, suit){
  const s=SUITS[suit]||SUITS['‚ô†'];
  const red = (suit==='‚ô•'||suit==='‚ô¶');
  const textFill = red ? '#b10d19' : '#101010';
  return `
  <svg viewBox="0 0 100 142" class="svg-card" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <rect x="2" y="2" width="96" height="138" rx="12" fill="url(#g)" stroke="#e6e6e6" stroke-width="2"/>
    <defs>
      <linearGradient id="g" x1="0" x2="0" y1="0" y2="1">
        <stop stop-color="#ffffff" offset="0"/>
        <stop stop-color="#f5f8f6" offset="1"/>
      </linearGradient>
    </defs>
    <g fill="${textFill}" font-family="system-ui, -apple-system, Segoe UI, Roboto, Arial" font-weight="800">
      <text x="8" y="16" font-size="14">${rank}</text>
      <text x="8" y="30" font-size="14">${suit}</text>
      <g transform="rotate(180 50 71)">
        <text x="8" y="16" font-size="14">${rank}</text>
        <text x="8" y="30" font-size="14">${suit}</text>
      </g>
    </g>
    <path d="${s.path}" fill="${s.fill}" transform="translate(0,6)"/>
  </svg>`;
}
function makeCardEl(card, back=false){
  const el=document.createElement('div'); el.className= back? 'card back':'card';
  if(!back){ el.innerHTML = cardSVG(card.r, card.s); }
  return el;
}
</script>

<!-- ========= Blackjack Logic ========= -->
<script>
const CONFIG = { decks:1, hitSoft17:true, allowDouble:true, allowSplit:true, mBJ:2.00, mWIN:1.25, mPUSH:1.00 };

let shoe=[];
function buildShoe(){ const R=['A','2','3','4','5','6','7','8','9','10','J','Q','K'], S=['‚ô†','‚ô•','‚ô¶','‚ô£']; const t=[]; for(let d=0;d<CONFIG.decks;d++) for(const r of R) for(const s of S) t.push({r,s}); for(let i=t.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [t[i],t[j]]=[t[j],t[i]]; } shoe=t; }
function draw(){ if(!shoe.length) buildShoe(); return shoe.pop(); }
function val(hand){ let t=0,a=0; for(const c of hand){ if(c.r==='A'){t+=11;a++;} else if(['K','Q','J','10'].includes(c.r)) t+=10; else t+=parseInt(c.r,10); } while(t>21 && a>0){ t-=10; a--; } return {total:t, soft:(a>0 && t<=21)}; }
function isBJ(h){ if(h.length!==2) return false; const v=h.map(c=>c.r); return v.includes('A') && ['10','J','Q','K'].some(x=>v.includes(x)); }
function canSplit(h){ if(!CONFIG.allowSplit || STATE.split) return false; if(h.length!==2) return false; const fv=(x)=>x.r==='A'?11:(['K','Q','J','10'].includes(x.r)?10:parseInt(x.r,10)); return fv(h[0])===fv(h[1]); }

const D = (id)=>document.getElementById(id);
function clearCards(){
  D('dealerCards').innerHTML=''; D('playerCards').innerHTML='';
  D('dealerTotal').textContent='0'; D('playerTotal').textContent='0';
  document.querySelectorAll('.splitRow').forEach(n=>n.remove());
}
function addSplitRow(i){
  const row=document.createElement('div'); row.className='hand splitRow';
  row.innerHTML = `<div class="label">You (Hand ${i+1})</div><div class="total" id="pT_${i}">0</div><div class="cards" id="pC_${i}"></div>`;
  D('player').after(row);
}
function updateTotals(){
  D('dealerTotal').textContent = val(STATE.dealer).total;
  if(STATE.hands.length===1){
    D('playerTotal').textContent = val(STATE.hands[0]).total;
  }else{
    STATE.hands.forEach((h,i)=>{
      const t = val(h).total;
      (i===0?D('playerTotal'):D('pT_'+i)).textContent = t;
    });
  }
}

/* Audio hook */
function playDeal(){ try{ window.__bagCardSound && __bagCardSound.deal(); }catch{} }

/* Only spend/credit in LIVE mode */
function spendBAG(n){ if(!(n>0)) return true; if(window.__BAG_FORCE_DEMO) return true; try{ return !!(__bagSession && __bagSession.spend && __bagSession.spend(n)); }catch{ return false; } }
function creditBAG(n){ if(!(n>0)) return; if(window.__BAG_FORCE_DEMO) return; try{ __bagSession && __bagSession.credit && __bagSession.credit(n);}catch{} }

/* State & controls */
const STATE = { dealer:[], hands:[], active:0, split:false, locked:0, live:false };
const btnDeal=D('deal'), btnHit=D('hit'), btnStand=D('stand'), btnDouble=D('double'), btnSplit=D('split'), btnAgain=D('again');
function setStatus(txt,cls){ const el=D('status'); el.className='result'+(cls?(' t '+cls):''); el.textContent=txt; }
function last(s){ D('lastLbl').textContent=s; }

function lockStake(){
  const bag=stakeBAG(), usd=stakeUSD();
  if(!window.__BAG_FORCE_DEMO){
    if(!(usd>=1) || usd>2000) return [false,'Stake must be $1‚Äì$2000'];
    if(!(bag>0)) return [false,'Enter a stake first'];
    if(!spendBAG(bag)) return [false,'Insufficient balance'];
  } else {
    if(!(usd>0)) return [false,'Enter a stake first']; // demo never blocks for balance
  }
  STATE.locked=bag; return [true,''];
}

function startRound(){
  const [ok,err]=lockStake(); if(!ok){ alert(err); return; }
  clearCards(); STATE.dealer=[]; STATE.hands=[[]]; STATE.active=0; STATE.split=false; STATE.live=true;

  const pc=D('playerCards'), dc=D('dealerCards');
  const c1=draw(), c2=draw(), c3=draw(), c4=draw();
  STATE.hands[0].push(c1); { const n=makeCardEl(c1); pc.appendChild(n); playDeal(); }
  STATE.dealer.push(c2);   { const n=makeCardEl(c2); dc.appendChild(n); playDeal(); }
  STATE.hands[0].push(c3); { const n=makeCardEl(c3); pc.appendChild(n); playDeal(); }
  STATE.dealer.push(c4);   { const n=makeCardEl(c4,true); dc.appendChild(n); playDeal(); }

  updateTotals();
  btnDeal.disabled=true; btnHit.disabled=false; btnStand.disabled=false; btnDouble.disabled=false; btnSplit.disabled=!canSplit(STATE.hands[0]); btnAgain.style.display='none';
  setStatus('Play your hand');
  last('Dealt');

  if(isBJ(STATE.hands[0])){
    revealHole();
    const dBJ=isBJ(STATE.dealer);
    settleAll(dBJ?'push-bj':'blackjack');
  }
}

function revealHole(){
  const dc=D('dealerCards'); const backs=[...dc.children].filter(n=>n.classList.contains('back'));
  if(backs[0]) backs[0].replaceWith(makeCardEl(STATE.dealer[1],false)), playDeal();
  updateTotals();
}

function hitHand(i){
  const node = (STATE.hands.length===1) ? D('playerCards') : (i===0?D('playerCards'):D('pC_'+i));
  const c=draw(); STATE.hands[i].push(c);
  node.appendChild(makeCardEl(c)); playDeal(); updateTotals();
}
function nextHandOrDealer(){
  if(STATE.hands.length>1){
    STATE.active++;
    if(STATE.active<STATE.hands.length){
      btnDouble.disabled = !(STATE.hands[STATE.active].length===2);
      btnHit.disabled=false; btnStand.disabled=false;
      setStatus(`Hand ${STATE.active+1}: your move`);
      return;
    }
  }
  dealerPhase();
}
function dealerPhase(){
  revealHole();
  let dv=val(STATE.dealer);
  while(dv.total<17 || (dv.total===17 && dv.soft && CONFIG.hitSoft17)){
    const c=draw(); STATE.dealer.push(c); D('dealerCards').appendChild(makeCardEl(c)); playDeal(); dv=val(STATE.dealer);
  }
  updateTotals();
  settleAll();
}

function settleAll(override){
  let credit=0; const base=STATE.locked;

  function doHand(h){
    const pv=val(h).total, dv=val(STATE.dealer).total;
    const doubled = h._dbl===true; const stake = base*(doubled?2:1);

    if(override==='blackjack'){
      credit += stake*CONFIG.mBJ; setStatus('Blackjack ‚Äî paid 2.00√ó','win'); last('Blackjack 2√ó'); return;
    }
    if(override==='push-bj'){ credit += stake*CONFIG.mPUSH; setStatus('Push (both Blackjack) ‚Äî stake returned','push'); last('Push'); return; }

    if(pv>21){ setStatus('Busted ‚Äî dealer wins','lose'); last('Scratch'); return; }
    if(dv>21 || pv>dv){
      const mult = (isBJ(h)&&!doubled&&!STATE.split) ? CONFIG.mBJ : CONFIG.mWIN;
      credit += stake*mult;
      setStatus(mult===CONFIG.mBJ?'Blackjack ‚Äî 2.00√ó':`You win ${CONFIG.mWIN.toFixed(2)}√ó`,'win'); last(mult===CONFIG.mBJ?'Blackjack 2√ó':'Win 1.25√ó');
    } else if(pv<dv){
      setStatus('Dealer wins','lose'); last('Scratch');
    } else {
      credit += stake*CONFIG.mPUSH; setStatus('Push ‚Äî stake returned','push'); last('Push');
    }
  }

  if(STATE.hands.length===1) doHand(STATE.hands[0]); else STATE.hands.forEach(doHand);
  if(credit>0) creditBAG(credit);

  btnHit.disabled=true; btnStand.disabled=true; btnDouble.disabled=true; btnSplit.disabled=true; btnDeal.disabled=true; btnAgain.style.display='inline-block';
  STATE.live=false;
}

/* Controls */
btnDeal.addEventListener('click', ()=>{ try{ window.__bagCardSound && __bagCardSound.resume(); }catch{} startRound(); });
btnHit.addEventListener('click', ()=>{
  btnDouble.disabled=true;
  hitHand(STATE.active);
  if(val(STATE.hands[STATE.active]).total>21){ setStatus(`Hand ${STATE.hands.length>1?STATE.active+1:''} busts`,'lose'); nextHandOrDealer(); }
});
btnStand.addEventListener('click', ()=>{ setStatus(`Hand ${STATE.hands.length>1?STATE.active+1:''} stands`); nextHandOrDealer(); });
btnDouble.addEventListener('click', ()=>{
  const h=STATE.hands[STATE.active]; if(h.length!==2) return alert('Double only on first turn');
  if(!window.__BAG_FORCE_DEMO && !spendBAG(STATE.locked)) return alert('Insufficient balance');
  h._dbl=true; hitHand(STATE.active); nextHandOrDealer();
});
btnSplit.addEventListener('click', ()=>{
  const h=STATE.hands[0]; if(!canSplit(h)) return;
  if(!window.__BAG_FORCE_DEMO && !spendBAG(STATE.locked)) return alert('Insufficient balance');
  STATE.split=true;
  const a=h[0], b=h[1];
  STATE.hands=[ [a], [b] ];
  D('playerCards').innerHTML=''; D('playerTotal').textContent='0';
  const rowIndex=1; // show second row
  const row=document.createElement('div'); row.className='hand splitRow';
  row.innerHTML = `<div class="label">You (Hand ${rowIndex+1})</div><div class="total" id="pT_${rowIndex}">0</div><div class="cards" id="pC_${rowIndex}"></div>`;
  D('player').after(row);
  D('playerCards').appendChild(makeCardEl(a)); playDeal();
  D('pC_1').appendChild(makeCardEl(b)); playDeal();
  hitHand(0); hitHand(1);
  updateTotals();
  STATE.active=0; btnSplit.disabled=true; btnDouble.disabled=false;
});
btnAgain.addEventListener('click', ()=>{ clearCards(); btnDeal.disabled=false; btnHit.disabled=true; btnStand.disabled=true; btnDouble.disabled=true; btnSplit.disabled=true; btnAgain.style.display='none'; setStatus('Place a stake, then Deal'); last('‚Äî'); });

/* HUD */
function HUD(){
  const mode = window.__BAG_FORCE_DEMO ? 'Demo' : 'Live';
  const bag  = Number(__bagSession?.get?.().bag)||0;
  D('modeLbl').textContent = mode;
  D('balLbl').textContent  = (bag||0).toLocaleString(undefined,{maximumFractionDigits:6});
  D('balUnit').textContent = 'BAG';
  D('betLbl').textContent  = String(parseFloat(elQty.value||0)||0);
}
addEventListener('hud', HUD);
addEventListener('prices', ()=>{ if(!elUSD.value || elUSD.dataset.user!=='1'){ elUSD.dataset.user='0'; syncFromUnits(); } HUD(); });
['input','change'].forEach(ev=>{
  elQty.addEventListener(ev, ()=>dispatchEvent(new CustomEvent('hud')));
  document.querySelectorAll('input[name="cur"]').forEach(r=>r.addEventListener(ev, ()=>dispatchEvent(new CustomEvent('hud'))));
});

/* Boot */
function boot(){
  buildShoe();
  // Default bet: 1 XRP; USD autofills after price fetch
  elQty.value='1'; elUnit.textContent='XRP'; elUSD.value=''; elUSD.dataset.user='0';
  syncFromUnits(); HUD(); setStatus('Place a stake, then Deal');
}
boot();
setInterval(()=>{ if(shoe.length<15) buildShoe(); }, 2000);

/* Helpers from inputs scope */
function stakeUSD(){ const v=parseFloat(elUSD.value||''); if(Number.isFinite(v)&&v>0) return v; const q=parseFloat(elQty.value||'')||0; const px=(document.querySelector('input[name="cur"]:checked')?.value||'XRP').toUpperCase()==='BAG'?PRICES.bagUsd:PRICES.xrpUsd; return px>0?q*px:0; }
function stakeBAG(){
  const q=parseFloat(elQty.value||'')||0;
  const cur=(document.querySelector('input[name="cur"]:checked')?.value||'XRP').toUpperCase();
  if(cur==='BAG') return q;
  const {bagUsd,xrpUsd}=PRICES; return (bagUsd>0 && xrpUsd>0) ? q*(xrpUsd/bagUsd) : 0;
}
</script>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/service-worker.js').catch(()=>{});
}
</script>

</body>
</html>
