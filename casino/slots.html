<!-- Xaman wallet connect -->
<script>
(function(){
  const WALLET_KEY = 'bag_wallet_v1';
  const API_KEY = '48d8a5b2-0f90-4c5a-b5c2-3d7c8fd6113f';

  const btn = document.getElementById('connectBtn');
  const statusEl = document.getElementById('connectStatus');
  if (!btn || !statusEl) return;

  const read  = () => { try { return JSON.parse(localStorage.getItem(WALLET_KEY)||'null'); } catch { return null; } };
  const write = (w) => { try { localStorage.setItem(WALLET_KEY, JSON.stringify(w)); } catch {} };
  const clear = () => { try { localStorage.removeItem(WALLET_KEY); } catch {} };

  function safeShort(a){ try{ const s = a == null ? '' : String(a); if (!s) return ''; return s.slice(0,6) + '…' + s.slice(-4); }catch{ return ''; } }

  let connectedNow = false;
  let currentAddr = '';

  function render(){
    try{
      if (connectedNow && currentAddr){
        statusEl.innerHTML = 'Wallet: <span style="color:#2fbf6b">'+safeShort(currentAddr)+'</span>';
        btn.textContent = 'Disconnect';
      } else {
        statusEl.innerHTML = 'Wallet: <span style="color:#e8a85c">not connected</span>';
        btn.textContent = 'Connect Xaman';
      }
    }catch(e){
      statusEl.textContent = 'Wallet: error'; btn.textContent = 'Connect Xaman';
    }
  }

  let xumm = null, ready = false, tries = 0;
  function initIfSdk(){
    if (ready) return true;
    if (typeof window.Xumm === 'function'){
      xumm = new Xumm(API_KEY);
      ready = true;
      xumm.on('success', () => {
        try{
          const acct = xumm?.user?.account || null;
          if (acct){
            connectedNow = true; currentAddr = String(acct);
            write({ address: currentAddr, ts: Date.now(), kind: 'xaman' });
            window.dispatchEvent(new CustomEvent('bag:walletConnected', { detail: { address: currentAddr }}));
            render();
          }
        }catch(e){}
      });
      xumm.on('ready', () => { render(); });
      return true;
    }
    if (tries++ < 60) setTimeout(initIfSdk, 200);
    return false;
  }

  async function connectXaman(){
    if (!ready && !initIfSdk()){ alert('Loading Xaman… try again in a moment.'); return; }
    btn.disabled = true;
    try {
      const auth = await xumm.authorize();
      const acct = (xumm && xumm.user && xumm.user.account) || auth?.me?.account || null;
      if (!acct) throw new Error('No account returned');
      connectedNow = true; currentAddr = String(acct);
      write({ address: currentAddr, ts: Date.now(), kind: 'xaman' });
      window.dispatchEvent(new CustomEvent('bag:walletConnected', { detail: { address: currentAddr }}));
      render();
    } catch (e) {
    } finally {
      btn.disabled = false;
    }
  }

  btn.addEventListener('click', async ()=>{
    if (connectedNow){
      connectedNow = false; currentAddr = '';
      clear();
      window.dispatchEvent(new CustomEvent('bag:walletDisconnected'));
      render();
    } else {
      await connectXaman();
    }
  });

  document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) render(); });

  render();
  initIfSdk();
})();
</script>

<!-- TAB SESSION (unchanged core) -->
<script>
(function(){
  const TREASURY = 'rNeYbfb9EDV8c7mNfUuooEEYYzMcEuDFbr';
  const SESSION_KEY = 'bag_session_v1';
  const MIN_DEPOSIT_USD = 1;
  const MAX_DEPOSIT_USD = 500;

  const $ = s => document.querySelector(s);
  const statusEl = $('#sessionStatus');
  const startBtn = $('#startSessionBtn');
  const topUpBtn = $('#topUpBtn');
  const endBtn = $('#endSessionBtn');

  const read = () => { try { return JSON.parse(localStorage.getItem(SESSION_KEY)||'null'); } catch { return null; } };
  const write = (v) => { try { localStorage.setItem(SESSION_KEY, JSON.stringify(v)); } catch {} };
  const clear = () => { try { localStorage.removeItem(SESSION_KEY); } catch {} };

  function fmt(n){ if (!Number.isFinite(n)) return '—'; if (Math.abs(n) >= 1) return n.toLocaleString(undefined, {maximumFractionDigits:4}); if (Math.abs(n) >= 1e-2) return n.toLocaleString(undefined, {maximumFractionDigits:6}); if (Math.abs(n) >= 1e-4) return n.toLocaleString(undefined, {maximumFractionDigits:8}); return n.toLocaleString(undefined, {maximumFractionDigits:10}); }
  function fmtUsd(n){ return '$'+(Number(n)||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }

  function sessionActive(){ const s = read(); return !!(s && s.addr && s.bag>0); }

  function render(){
    const s = read();
    if (s && s.addr){
      const bag = Number(s.bag)||0;
      const usd = (window.__PRICES__?.bagUsd||0) * bag;
      statusEl.innerHTML = 'Session: <span style="color:#2fbf6b">'+fmt(bag)+' BAG</span>' + (usd?` <span class="micro" style="opacity:.75">(${fmtUsd(usd)})</span>`:'');
      startBtn.style.display = 'none';
      if (topUpBtn) topUpBtn.style.display = 'inline-block';
      endBtn.style.display = 'inline-block';
    } else {
      statusEl.innerHTML = 'Session: <span style="color:#e8a85c">not started</span>';
      startBtn.style.display = 'inline-block';
      topUpBtn.style.display = 'none';
      endBtn.style.display = 'none';
    }
  }

  function suggestDepositUsd(){
    const PRICES = window.__PRICES__ || {bagUsd:0,xrpUsd:0};
    const betEl = document.getElementById('usdBet');
    const u = betEl && parseFloat(betEl.value) > 0 ? parseFloat(betEl.value) : 5;
    let usd = Math.max(MIN_DEPOSIT_USD, Math.min(MAX_DEPOSIT_USD, u * 20));
    if (!Number.isFinite(usd)) usd = MIN_DEPOSIT_USD;
    return usd;
  }

  async function waitForTx(txid, timeoutMs=30000){
    return new Promise(resolve=>{
      const ws = new WebSocket('wss://s1.ripple.com');
      const t = setTimeout(()=>{ try{ws.close();}catch{}; resolve(null); }, timeoutMs);
      ws.onopen = ()=> ws.send(JSON.stringify({id:1, command:'tx', transaction: txid, binary:false}));
      ws.onmessage = (ev)=>{
        try{
          const msg = JSON.parse(ev.data);
          if (msg?.result?.hash === txid && msg?.result?.validated){
            clearTimeout(t); try{ws.close();}catch{}; resolve(msg.result);
          }
        }catch{}
      };
      ws.onerror = ()=>{ clearTimeout(t); resolve(null); };
    });
  }

  async function startSession(){
    if (!window.Xumm){ alert('Xaman SDK not loaded'); return; }
    const PRICES = window.__PRICES__ || {};
    if (!(PRICES.xrpUsd>0 && PRICES.bagUsd>0)){ alert('Waiting for live prices — try again in a few seconds.'); return; }
    const depositUsd = Math.max(1, suggestDepositUsd());
    const depositXrp = depositUsd / PRICES.xrpUsd;
    const drops = Math.round(depositXrp * 1_000_000);
    const w = JSON.parse(localStorage.getItem('bag_wallet_v1')||'null');
    if (!w || !w.address){ alert('Connect Xaman first'); return; }
    const xumm = new Xumm('48d8a5b2-0f90-4c5a-b5c2-3d7c8fd6113f');
    startBtn.disabled = true; startBtn.textContent = 'Opening…';
    try{
      const { created, resolved } = await xumm.payload.createAndSubscribe({
        txjson: { TransactionType:'Payment', Destination: TREASURY, Amount: String(drops),
          Memos:[{Memo:{MemoType:btoa('BAG'), MemoData:btoa('SLOTS_SESSION')}}] },
        options: { submit:true, expire:300 }
      }, ev => { if (ev?.data && 'signed' in ev.data) return ev; });
      const res = await resolved;
      if (!res?.signed) throw new Error('User declined in Xaman');
      const txid = res.response?.txid || res?.meta?.txid || res?.created?.reference;
      if (!txid) throw new Error('No txid returned');
      const validated = await waitForTx(txid, 60000);
      if (!validated || validated.engine_result !== 'tesSUCCESS'){ throw new Error('Payment not validated on-ledger yet'); }
      const bag = (depositUsd / PRICES.bagUsd);
      write({ addr: w.address, bag, ts: Date.now(), tx: txid });
      render();
      window.dispatchEvent(new CustomEvent('bag:sessionStarted', { detail: { bag, txid } }));
      alert('Session started — you’re good to play!');
    } catch (err){
      alert('Session not started: ' + (err?.message || 'unknown error — see console'));
    } finally {
      startBtn.disabled = false; startBtn.textContent = 'Start Session';
    }
  }

  async function topUpSession(){
    if (!window.Xumm){ alert('Xaman SDK not loaded'); return; }
    const PRICES = window.__PRICES__ || {};
    if (!(PRICES.xrpUsd>0 && PRICES.bagUsd>0)){ alert('Waiting for live prices'); return; }
    const s = read();
    if (!(s && s.addr)){ alert('Start a session first.'); return; }
    const depositUsd = suggestDepositUsd();
    const depositXrp = depositUsd / PRICES.xrpUsd;
    const drops = Math.round(depositXrp * 1_000_000);
    const xumm = new Xumm('48d8a5b2-0f90-4c5a-b5c2-3d7c8fd6113f');
    if (topUpBtn) { topUpBtn.disabled = true; topUpBtn.textContent = 'Topping up…'; }
    try{
      const { created } = await xumm.payload.createAndSubscribe({
        txjson: { TransactionType:'Payment', Destination: TREASURY, Amount: String(drops),
          Memos:[{Memo:{MemoType:btoa('BAG'), MemoData:btoa('SLOTS_TOPUP')}}] },
        options: { submit:true, expire:300 }
      }, ()=>{});
      const resolved = await xumm.payload.get(created.uuid);
      const txid = resolved?.response?.txid || resolved?.meta?.txid;
      if (!txid) throw new Error('No txid (cancelled?)');
      const tx = await waitForTx(txid, 45000);
      if (!tx || tx.engine_result !== 'tesSUCCESS') throw new Error('Payment not validated');
      const addBag = (depositUsd / PRICES.bagUsd);
      const cur = read() || { addr: s.addr, bag: 0 };
      cur.bag = (Number(cur.bag)||0) + addBag; cur.ts = Date.now(); cur.lastTopUpTx = txid;
      write(cur); render();
      window.dispatchEvent(new CustomEvent('bag:sessionToppedUp', { detail: { addBag, txid } }));
    } catch(e){
      alert('Top-up cancelled or failed.');
    } finally {
      if (topUpBtn) { topUpBtn.disabled = false; topUpBtn.textContent = 'Top Up'; }
    }
  }

  function endSession(){ const s = read(); clear(); render(); window.dispatchEvent(new CustomEvent('bag:sessionEnded', { detail: s || {} })); }

  startBtn?.addEventListener('click', startSession);
  topUpBtn?.addEventListener('click', topUpSession);
  endBtn?.addEventListener('click', endSession);

  window.addEventListener('bag:pricesUpdated', render);
  render();

  window.__bagSession = {
    active: sessionActive,
    get: read,
    set: write,
    spend(bag){ const s = read(); if(!s) return false; if (s.bag < bag) return false; s.bag = Math.max(0, s.bag - bag); write(s); render(); return true; },
    credit(bag){ const s = read(); if(!s) return false; s.bag += bag; write(s); render(); return true; }
  };
})();
</script>

<!-- Practice Mode wrapper -->
<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const pathDemo = location.pathname.toLowerCase().includes('/demo');
  const liveSession = window.__bagSession;

  const $ = (s)=>document.querySelector(s);
  const statusEl  = $('#sessionStatus');
  const startBtn  = $('#startSessionBtn');
  const topUpBtn  = $('#topUpBtn');
  const endBtn    = $('#endSessionBtn');
  const connectEl = $('#connectBtn');

  const DEMO_KEY = '__bag_demo_bag_v1';
  const START_BAG = 1000;
  function getBal(){ try{ const n = Number(localStorage.getItem(DEMO_KEY)); return Number.isFinite(n) && n>0 ? n : START_BAG; }catch{ return START_BAG; } }
  function setBal(v){ try{ localStorage.setItem(DEMO_KEY, String(Math.max(0, Math.floor(v)))) }catch{} }
  if (localStorage.getItem(DEMO_KEY) == null) setBal(START_BAG);

  function fmt(n){ if (!Number.isFinite(n)) return '—'; if (Math.abs(n) >= 1) return n.toLocaleString(undefined, {maximumFractionDigits:4}); if (Math.abs(n) >= 1e-2) return n.toLocaleString(undefined, {maximumFractionDigits:6}); if (Math.abs(n) >= 1e-4) return n.toLocaleString(undefined, {maximumFractionDigits:8}); return n.toLocaleString(undefined, {maximumFractionDigits:10}); }
  function fmtUsd(n){ return '$'+(Number(n)||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }

  function renderDemoSession(){
    const bag = getBal();
    const bagUsd = (window.__PRICES__?.bagUsd||0) * bag;
    if (statusEl){
      statusEl.innerHTML = 'Practice: <span style="color:#2fbf6b">'+fmt(bag)+' BAG</span>' +
        (bagUsd ? ` <span class="micro" style="opacity:.75">(${fmtUsd(bagUsd)})</span>` : '');
    }
    if (startBtn) startBtn.style.display = 'inline-block';
    if (topUpBtn)  topUpBtn.style.display  = 'none';
    if (endBtn)    endBtn.style.display     = 'none';
  }

  function toast(msg){
    try{ if (window.__bagAudio) __bagAudio.scratch(); }catch(e){}
    try{
      let t = document.getElementById('bag-demo-toast');
      if (!t){
        t = document.createElement('div');
        t.id = 'bag-demo-toast';
        t.style.cssText = 'position:fixed;left:50%;bottom:18px;transform:translateX(-50%);padding:10px 14px;border-radius:10px;background:#0b2217;color:#eaf3ed;border:1px solid #1b4a2f;box-shadow:0 6px 24px rgba(0,0,0,.35);font:600 13px system-ui;z-index:2147483647';
        document.body.appendChild(t);
      }
      t.textContent = msg;
      t.style.display = 'block';
      clearTimeout(window.__bagDemoToastTimer);
      window.__bagDemoToastTimer = setTimeout(()=>{ t.style.display='none'; }, 2200);
    }catch{}
  }

  const demoSession = {
    active: () => true,
    get: () => ({ addr:'demo', bag: getBal(), ts: Date.now() }),
    set: () => {},
    spend(bag){ const b=getBal(); if(!(bag>0) || b<bag) return false; setBal(b-bag); renderDemoSession(); return true; },
    credit(bag){ if(!(bag>0)) return false; setBal(getBal()+bag); renderDemoSession(); return true; }
  };

  function enableDemo(){ window.__BAG_FORCE_DEMO = true; window.__bagSession = demoSession; renderDemoSession(); if (connectEl) connectEl.style.opacity='0.9'; }
  function enableLive(){ window.__BAG_FORCE_DEMO = false; if (liveSession) window.__bagSession = liveSession; window.dispatchEvent(new CustomEvent('bag:pricesUpdated')); toast('Wallet connected — Live mode enabled'); }

  const demoWanted = pathDemo || qs.get('demo') === '1' || window.__BAG_FORCE_DEMO === true;
  if (demoWanted) enableDemo();

  window.addEventListener('bag:pricesUpdated', ()=>{ if (window.__BAG_FORCE_DEMO) renderDemoSession(); });

  window.addEventListener('bag:slotsResult', (ev)=>{
    if (!window.__BAG_FORCE_DEMO) return;
    const d = ev?.detail || {};
    if (d.mult === 2.00)      toast('Jackpot pays 2× on-ledger. Connect when ready to play live');
    else if (d.mult === 1.25) toast('Win pays 1.25× on-ledger. Connect when ready to play live');
    else if (d.mult === 1.00) toast('Scratch returns 1.00×. Connect when ready to play live');
  });

  window.addEventListener('bag:walletConnected', enableLive);
  window.addEventListener('bag:walletDisconnected', enableDemo);
})();
</script>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/service-worker.js').catch(()=>{});
}
</script>

<footer class="footer" style="text-align:center; padding:12px 0; line-height:1.6;">
  © 2025 $BAG Protocol | getthebag.io | Powered by $XRP
  <br>
  <a href="https://x.com/getthebag_io" target="_blank" rel="noopener" style="color:#e0c66f;text-decoration:none;font-weight:700;">𝕏 @getthebag_io</a> |
  <a href="https://t.me/getthebag_io" target="_blank" rel="noopener" style="color:#e0c66f;text-decoration:none;font-weight:700;">Telegram @getthebag_io</a>
</footer>
</body>
</html>
