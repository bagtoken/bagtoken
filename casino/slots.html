<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>$BAG Slots</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f0b07; --wood:#2a1a10; --gold:#d7a646; --gold-2:#f2c76b;
    --green:#0c3b28; --muted:#7a6a58; --win:#22c55e; --lose:#ef4444;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:radial-gradient(1200px 700px at 50% 0%, #1d120a 0%, var(--bg) 60%) fixed;
       color:#f6eddc;font-family:Inter,system-ui,Arial,sans-serif;display:flex;flex-direction:column;align-items:center;gap:16px}
  a{color:inherit}
  header{margin:18px 0 8px;text-align:center}
  .marquee{font-weight:800;letter-spacing:.06em;font-size:clamp(26px,5.6vw,54px);
           text-shadow:0 0 14px rgba(242,199,107,.45), 0 0 2px #000;
           color:transparent;background:linear-gradient(#f8d78a,#e9b751);-webkit-background-clip:text;background-clip:text}
  .stage{width:min(980px,95vw);display:grid;grid-template-columns:1fr 420px;gap:22px;align-items:end}

  /* Plinko (decor) */
  .plinko{background:linear-gradient(180deg,#3a2a1f,#22160f); border:6px solid #3f2a17;border-radius:14px;
          padding:18px 16px 22px; position:relative; aspect-ratio:3/5; box-shadow:0 16px 80px rgba(0,0,0,.5), inset 0 0 0 1px rgba(255,255,255,.05);}
  .plinko::before{content:"";position:absolute;left:18px;right:18px;top:8px;height:18px;border-radius:10px;
                  background:linear-gradient(180deg, rgba(0,0,0,.7), rgba(0,0,0,0));box-shadow:inset 0 2px 0 rgba(255,255,255,.06);}
  .pegs{position:absolute;inset:50px 22px 70px 22px;display:grid;grid-template-rows:repeat(8,1fr)}
  .peg-row{display:flex;justify-content:space-evenly}
  .peg{width:10px;height:10px;border-radius:50%;background:radial-gradient(circle at 30% 30%, var(--gold-2), var(--gold) 60%, #8a6930);
       box-shadow:0 0 8px rgba(242,199,107,.25)}

  /* Slot cabinet */
  .cabinet{background:linear-gradient(180deg,#3c2818,#1c120b);border:8px solid #4b311a;border-radius:18px;padding:18px;position:relative;
           box-shadow:0 18px 100px rgba(0,0,0,.6), inset 0 0 0 1px rgba(255,255,255,.05)}
  .top-arch{text-align:center;padding:10px 0 4px;margin-bottom:6px;border-radius:12px;background:linear-gradient(180deg,#4b331d,#2d1c10);
            color:var(--gold-2);font-weight:800;letter-spacing:.08em}
  .reels{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;background:#130d08;border:3px solid #44301d;border-radius:12px;padding:12px;overflow:hidden}
  .reel{height:168px;border-radius:10px;background:linear-gradient(180deg,#24160e,#0d0805);position:relative;overflow:hidden;border:1px solid #3a2818}
  .strip{position:absolute;left:0;right:0;top:0;transition:transform 800ms cubic-bezier(.2,.7,.1,1)}
  .cell{height:56px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:22px;color:#f7e9c7;text-shadow:0 2px 0 #000}
  .sym-seven{color:#ff5236}.sym-diamond{color:#9be8ff}.sym-bagcoin{color:#f2c76b}
  .sym-duffle{color:#b8e5c8}.sym-bar{color:#e6d1b0}.sym-cherry{color:#ff9bb0}

  .panel{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-top:14px;flex-wrap:wrap}
  .display{background:#16100b;border:1px solid #3a2a1a;border-radius:10px;padding:10px 12px;min-width:160px;text-align:center}
  .btn{background:linear-gradient(180deg,#f2c76b,#d7a646);color:#2a1a10;font-weight:800;border:none;border-radius:12px;padding:12px 22px;
       box-shadow:0 6px 0 #7f5a20, 0 10px 32px rgba(242,199,107,.25);cursor:pointer;transition:transform .05s}
  .btn:active{transform:translateY(1px)} .btn[disabled]{opacity:.5;cursor:not-allowed;box-shadow:none}

  /* Payout drawer */
  .drawer-wrap{position:relative}
  .drawer{position:absolute;right:0;top:100%;margin-top:8px;background:#15100b;border:1px solid #3a2a1a;border-radius:12px;
          box-shadow:0 16px 70px rgba(0,0,0,.5);padding:10px 12px;min-width:260px;display:none}
  .drawer.open{display:block}
  .drawer table{width:100%;border-collapse:collapse;font-size:14px}
  .drawer th,.drawer td{padding:6px 4px;border-bottom:1px solid #2b2118;text-align:left}
  .drawer th{color:#f2c76b}

  /* Currency toggle */
  .toggle{display:flex;align-items:center;gap:8px;background:#16100b;border:1px solid #3a2a1a;border-radius:10px;padding:8px 10px}
  .toggle button{background:#0f0b07;color:#f6eddc;border:1px solid #3a2a1a;padding:6px 10px;border-radius:8px;cursor:pointer}
  .toggle .on{background:#2d1c10;border-color:#6c4a22}

  /* little bag prop */
  .prop{position:absolute;left:-16px;bottom:-18px;transform:scale(.78);filter:drop-shadow(0 10px 30px rgba(0,0,0,.6))}
  .prop .bag{width:160px;height:90px;border-radius:20px;background:linear-gradient(180deg,#155135,#072215);border:2px solid #0a3a26;position:relative}
  .prop .bag::after{content:"BAG"; position:absolute; right:8px; bottom:8px; font-weight:800; font-size:12px; letter-spacing:.05em;
                    color:#0e2e1f; padding:4px 6px; border:2px solid #0e2e1f; border-radius:6px;}
  .coins{position:absolute;left:100px;bottom:-6px;display:flex;gap:4px}
  .coin{width:26px;height:26px;border-radius:50%;background:radial-gradient(circle at 35% 35%, #ffd98c, #e0b45d 55%, #a47a32);
        display:grid;place-items:center;color:#3b2a10;font-weight:900;font-size:10px;border:1px solid #6a4a1f}

  nav{width:min(980px,95vw);display:flex;justify-content:flex-start;margin:8px 0 18px}
  nav a.back{opacity:.8;text-decoration:none;border:1px solid #3a2a1a;padding:8px 12px;border-radius:10px}
  footer{opacity:.6;font-size:12px;margin:12px 0 24px}
  @media (max-width:820px){.stage{grid-template-columns:1fr}.prop{display:none}}
</style>
</head>
<body>
  <header><div class="marquee">$BAG CASINO ‚Äî SLOTS</div></header>

  <nav><a href="/casino-hub.html" class="back">‚Üê Back to $BAG Casino</a></nav>

  <main class="stage">
    <!-- Left: Plinko board (decor only, open top) -->
    <section class="plinko" aria-label="Decorative Plinko board">
      <div class="pegs" id="pegs"></div>
    </section>

    <!-- Right: Slot cabinet -->
    <section class="cabinet" aria-label="$BAG Slots Machine">
      <div class="top-arch">$BAG SLOTS</div>

      <div class="reels" id="reels">
        <div class="reel"><div class="strip" data-col="0"></div></div>
        <div class="reel"><div class="strip" data-col="1"></div></div>
        <div class="reel"><div class="strip" data-col="2"></div></div>
      </div>

      <div class="panel">
        <div class="display"><strong>Balance:</strong> <span id="bal">‚Äî</span></div>

        <div class="display">
          <strong>Bet:</strong> <span id="betVal">10</span>
          <button id="betDown" class="btn" aria-label="Decrease bet">‚Äì</button>
          <button id="betUp" class="btn" aria-label="Increase bet">+</button>
        </div>

        <div class="toggle" role="group" aria-label="Currency">
          <span>Currency:</span>
          <button id="curBAG" class="on">$BAG</button>
          <button id="curXRP">XRP</button>
        </div>

        <div class="drawer-wrap">
          <button id="paytableBtn" class="btn" aria-expanded="false" aria-controls="paytable">Payouts</button>
          <div id="paytable" class="drawer" role="dialog" aria-label="Payout Table">
            <table>
              <thead><tr><th>3 in a line</th><th>Payout (√ó bet)</th></tr></thead>
              <tbody>
                <tr><td>777</td><td>10√ó</td></tr>
                <tr><td>Diamond</td><td>6√ó</td></tr>
                <tr><td>BAG Coin</td><td>4√ó</td></tr>
                <tr><td>Duffle</td><td>3√ó</td></tr>
                <tr><td>Bar</td><td>2√ó</td></tr>
                <tr><td>Cherry</td><td>1√ó</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <button id="spin" class="btn">SPIN</button>

        <div class="display"><strong>Win:</strong> <span id="win">0</span></div>
      </div>

      <!-- Signature small BAG prop -->
      <div class="prop" aria-hidden="true">
        <div class="bag"></div>
        <div class="coins"><div class="coin">BAG</div><div class="coin">BAG</div><div class="coin">BAG</div></div>
      </div>
    </section>
  </main>

  <footer>¬© $BAG Casino</footer>

  <!-- Sounds (replace paths with your assets) -->
  <audio id="sSpin" preload="auto" src="/assets/audio/spin.mp3"></audio>
  <audio id="sWin"  preload="auto" src="/assets/audio/win.mp3"></audio>

<script type="module">
  // ---------- Symbols
  const SYM = ["SEVEN","DIAMOND","BAGCOIN","DUFFLE","BAR","CHERRY"];
  const symToLabel = { SEVEN:'7', DIAMOND:'‚ô¶', BAGCOIN:'BAG', DUFFLE:'üëú', BAR:'BAR', CHERRY:'üçí' };
  const symToClass = { SEVEN:'sym-seven', DIAMOND:'sym-diamond', BAGCOIN:'sym-bagcoin', DUFFLE:'sym-duffle', BAR:'sym-bar', CHERRY:'sym-cherry' };

  // ---------- Build Plinko pegs (decor, open top already styled)
  (() => {
    const pegs = document.getElementById('pegs');
    for (let r=0;r<8;r++){
      const row = document.createElement('div'); row.className='peg-row';
      const count = 6 + (r%2);
      for (let c=0;c<count;c++){ const dot = document.createElement('div'); dot.className='peg'; row.appendChild(dot); }
      pegs.appendChild(row);
    }
  })();

  // ---------- Reels
  const strips = [...document.querySelectorAll('.strip')];
  const ROWS = 3, CELL_H = 56;
  const cell = s => { const d=document.createElement('div'); d.className='cell '+symToClass[s]; d.textContent=symToLabel[s]; return d; };
  const fillStrip = (strip, arr) => { strip.innerHTML=''; arr.forEach(s=>strip.appendChild(cell(s))); };

  strips.forEach((s,i)=>{ fillStrip(s, ["CHERRY","BAR","BAGCOIN"]); s.style.transform="translateY(0px)" });

  // ---------- UI elements
  let balance=10000, currency="BAG";
  const balEl = document.getElementById('bal'), betEl=document.getElementById('betVal'), winEl=document.getElementById('win');
  const spinBtn = document.getElementById('spin'), betUp=document.getElementById('betUp'), betDown=document.getElementById('betDown');
  const curBAG=document.getElementById('curBAG'), curXRP=document.getElementById('curXRP');
  const payBtn=document.getElementById('paytableBtn'), drawer=document.getElementById('paytable');

  balEl.textContent = balance;
  const setBet = v => { v=Math.max(1,Math.min(2000,v|0)); betEl.textContent=v; };
  setBet(10);
  betUp.onclick = ()=> setBet((+betEl.textContent)+10);
  betDown.onclick = ()=> setBet((+betEl.textContent)-10);

  // Currency toggle
  function setCurrency(cur){
    currency = cur;
    curBAG.classList.toggle('on', cur==='BAG');
    curXRP.classList.toggle('on', cur==='XRP');
  }
  curBAG.onclick = ()=> setCurrency('BAG');
  curXRP.onclick = ()=> setCurrency('XRP');
  setCurrency('BAG');

  // Payout drawer
  payBtn.onclick = () => {
    const open = !drawer.classList.contains('open');
    drawer.classList.toggle('open', open);
    payBtn.setAttribute('aria-expanded', open);
  };

  // Sounds (unlock on first interaction due to autoplay policies)
  const sSpin=document.getElementById('sSpin'), sWin=document.getElementById('sWin');
  const unlockAudio = () => { sSpin.muted=false; sWin.muted=false; window.removeEventListener('pointerdown', unlockAudio); };
  sSpin.muted=true; sWin.muted=true; window.addEventListener('pointerdown', unlockAudio, {once:true});

  // ---------- Spin (manual)
  spinBtn.addEventListener('click', async () => {
    const stake = +betEl.textContent;
    spinBtn.disabled = true; winEl.textContent = '‚Ä¶';
    try{
      sSpin.currentTime=0; sSpin.play().catch(()=>{});
      const res = await fetch('/api/slots/spin', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ address: window?.wallet?.address ?? 'demo', stake, currency })
      });
      const data = res.ok ? await res.json() : demoServer(stake);
      await animateToGrid(data.result);
      balance = data.balance ?? (balance - stake + data.totalPayout);
      balEl.textContent = balance;
      winEl.textContent = data.totalPayout;
      if (data.totalPayout > 0){ sWin.currentTime=0; sWin.play().catch(()=>{}); }
    }catch(e){
      console.error(e);
      const data = demoServer(+betEl.textContent);
      await animateToGrid(data.result);
      balance = balance - data.stake + data.totalPayout;
      balEl.textContent = balance;
      winEl.textContent = data.totalPayout;
      if (data.totalPayout > 0){ sWin.currentTime=0; sWin.play().catch(()=>{}); }
    }finally{
      spinBtn.disabled = false;
    }
  });

  async function animateToGrid(rows){
    // rows: [[r1c1,r1c2,r1c3],[r2...],[r3...]]
    const cols = [0,1,2].map(ci => [rows[0][ci], rows[1][ci], rows[2][ci]]);
    const CELL_MOVE = (arrLen) => (arrLen - ROWS) * CELL_H;

    await Promise.all(cols.map((colSyms, ci)=>new Promise(resolve=>{
      const strip = strips[ci];
      const filler = Array.from({length:6}, _=> SYM[(Math.random()*SYM.length)|0]);
      const stack = [...filler, ...colSyms];
      fillStrip(strip, stack);
      const total = CELL_MOVE(stack.length);
      requestAnimationFrame(()=>{
        strip.style.transform = `translateY(-${total}px)`;
        strip.addEventListener('transitionend', () => {
          fillStrip(strip, colSyms);
          strip.style.transition = 'none'; strip.style.transform = `translateY(0px)`;
          strip.getBoundingClientRect(); strip.style.transition = 'transform 800ms cubic-bezier(.2,.7,.1,1)';
          resolve();
        }, {once:true});
      });
    })));
  }

  // Demo fallback (client RNG)
  function demoServer(stake){
    const rng = () => SYM[Math.floor(Math.random()*SYM.length)];
    const g=[[rng(),rng(),rng()],[rng(),rng(),rng()],[rng(),rng(),rng()]];
    const lines = [
      [[0,0],[0,1],[0,2]], [[1,0],[1,1],[1,2]], [[2,0],[2,1],[2,2]],
      [[0,0],[1,1],[2,2]], [[2,0],[1,1],[0,2]],
    ];
    const pays = {SEVEN:10,DIAMOND:6,BAGCOIN:4,DUFFLE:3,BAR:2,CHERRY:1};
    let total=0; for(const L of lines){ const [a,b,c]=L;
      const s1=g[a[0]][a[1]], s2=g[b[0]][b[1]], s3=g[c[0]][c[1]];
      if(s1===s2 && s2===s3) total += pays[s1]*stake;
    }
    return {result:g, totalPayout:total, stake};
  }
</script>
</body>
</html>
