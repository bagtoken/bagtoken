<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="format-detection" content="telephone=no">
<title>BAG Slots</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b100c; --bg2:#0e1510;
    --cabinet:#0f2416; --cabinet2:#0a1a10;
    --bezel:#153220; --rim:#274a31;
    --gold:#d7a646; --gold2:#f2c76b;
    --panel:#0f130f; --stroke:#243425;
    --text:#f3f7f0;
  }
  *{box-sizing:border-box}
  html,body{height:100%;-webkit-text-size-adjust:100%}
  body{
    margin:0;color:var(--text);font-family:Inter,system-ui,Arial,sans-serif;
    background:radial-gradient(1400px 800px at 50% 0%, var(--bg2) 0%, var(--bg) 60%) fixed;
    display:flex;flex-direction:column;align-items:center
  }
  button,[role="button"],a.btn{touch-action:manipulation;font-size:16px}

  /* Topbar: Back left, Wallet/Session right */
  .topbar{
    width:min(1120px,94vw);display:flex;align-items:center;justify-content:space-between;margin:14px 0 6px;gap:10px
  }
  .wallet-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-left:auto}
  .tag{background:var(--panel);border:1px solid var(--stroke);border-radius:10px;padding:8px 10px;font-size:13px;opacity:.9;display:none}

  .btn{
    background:linear-gradient(180deg,var(--gold2),var(--gold));color:#1e231d;
    font-weight:800;border:none;border-radius:12px;padding:12px 22px;
    box-shadow:0 6px 0 #7f5a20, 0 10px 32px rgba(242,199,107,.25);
    cursor:pointer;transition:transform .05s;text-decoration:none;display:inline-flex;align-items:center;gap:8px
  }
  .btn:active{transform:translateY(1px)}
  .btn[disabled]{opacity:.55;cursor:not-allowed;box-shadow:none}
  .btn.slim{padding:10px 14px}

  /* Header */
  header{width:min(1120px,94vw);margin:6px 0 10px;text-align:center}
  .banner{width:100%;border-radius:14px;display:block;box-shadow:0 16px 60px rgba(0,0,0,.45)}
  .title{margin:10px 0 0;font-weight:800;letter-spacing:.06em;font-size:clamp(22px,4.6vw,40px);
         color:transparent;background:linear-gradient(#c6f0d5,#8fdfad);
         -webkit-background-clip:text;background-clip:text;text-shadow:0 0 10px rgba(143,223,173,.18)}

  /* Live pricing */
  .ticker{
    width:min(1120px,94vw);display:grid;gap:12px;grid-template-columns:repeat(4,1fr);
    margin:6px 0 16px
  }
  .tick{background:var(--panel);border:1px solid var(--stroke);border-radius:12px;padding:10px 12px;text-align:center}
  .tick small{display:block;opacity:.75}
  .tick strong{display:block;font-size:18px;margin-top:4px}
  .demoTag{font-size:11px;opacity:.7}

  /* Stage / cabinet */
  .stage{width:min(980px,94vw);margin:6px auto 24px;display:flex;justify-content:center}
  .cabinet{
    width:min(860px,100%);background:linear-gradient(180deg,var(--cabinet),var(--cabinet2));
    border:8px solid var(--rim);border-radius:18px;padding:20px;
    box-shadow:0 26px 120px rgba(0,0,0,.6), inset 0 0 0 1px rgba(255,255,255,.04); position:relative
  }
  .cabinet.win-glow{box-shadow:0 0 0 3px rgba(242,199,107,.55),0 60px 160px rgba(242,199,107,.35),inset 0 0 0 1px rgba(255,255,255,.05)}
  .cabinet.shake{animation:shake .6s ease}
  @keyframes shake{
    0%,100%{transform:translateX(0)}
    20%{transform:translateX(-6px)} 40%{transform:translateX(6px)}
    60%{transform:translateX(-4px)} 80%{transform:translateX(4px)}
  }

  .top-arch{
    text-align:center;padding:12px 0 8px;margin-bottom:12px;border-radius:12px;
    background:linear-gradient(180deg,#163722,#0f2618);border:1px solid var(--bezel);
    color:var(--gold2);font-weight:800;letter-spacing:.08em
  }

  /* Reels */
  .reels{
    display:grid;grid-template-columns:repeat(3,1fr);gap:16px;
    background:#0b140d;border:3px solid var(--bezel);border-radius:12px;padding:16px;position:relative;overflow:hidden
  }
  .reel{height:280px;border-radius:12px;background:linear-gradient(180deg,#0f1a12,#08100b);border:1px solid #1c2b1e;position:relative;overflow:hidden}
  .strip{position:absolute;left:0;right:0;top:0;transition:transform 2800ms cubic-bezier(.07,.95,.05,1)}
  .cell{height:93px;display:flex;align-items:center;justify-content:center;font-size:64px;text-shadow:0 3px 0 #0008, 0 0 8px #0f0a}

  /* Win overlay + confetti canvas */
  .win-overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:radial-gradient(800px 400px at 50% 50%, rgba(242,199,107,.18), transparent 60%);pointer-events:none}
  .win-overlay.show{display:flex}
  .badge{font-weight:900;font-size:44px;letter-spacing:.08em;padding:12px 18px;border-radius:14px;color:#132016;background:linear-gradient(180deg,#ffe6a8,#eac070);box-shadow:0 8px 40px rgba(242,199,107,.35)}
  canvas.confetti{position:absolute;inset:0;pointer-events:none}

  /* Big SPIN under rows */
  .spinBigWrap{display:flex;justify-content:center;margin:14px 0 6px}
  .spinBig{width:100%;max-width:560px;font-size:22px;padding:18px 26px}

  /* Controls */
  .panel{display:grid;gap:12px;margin-top:8px;grid-template-columns:repeat(4,1fr)}
  @media (max-width:980px){ .panel{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:620px){ .panel{grid-template-columns:1fr} }
  .display{background:var(--panel);border:1px solid var(--stroke);border-radius:12px;padding:12px;text-align:center}
  .usd{display:block;opacity:.78;font-size:12px;margin-top:4px}

  /* Sections */
  .section{width:min(980px,94vw);margin:0 auto 18px}
  .card{background:var(--panel);border:1px solid var(--stroke);border-radius:12px;padding:14px}
  .card h3{margin:0 0 10px;color:var(--gold2)}
  .paygrid{display:grid;grid-template-columns:1fr auto;gap:6px;border-top:1px solid #1e2b20;padding-top:8px}
  .paygrid div{padding:4px 0}
  .payhead{opacity:.85}
  .muted{opacity:.8;font-size:12px;margin-top:8px}

  /* Readouts */
  .readouts{width:min(980px,94vw);display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:10px 0 22px}
  .readouts .card h5{margin:0 0 6px;color:var(--gold2)}
  @media (max-width:820px){ .readouts{grid-template-columns:1fr} }

  footer{opacity:.6;font-size:12px;margin:12px 0 24px}
</style>
</head>
<body>
  <!-- Back (left) + Wallet/Session (right, inert for now) -->
  <div class="topbar">
    <a class="btn" href="/casino/index.html">‚¨ÖÔ∏è Back to Casino</a>
    <div class="wallet-row">
      <span id="addrTag" class="tag" title="Connected address"></span>
      <button id="btnConnect" class="btn slim" disabled title="Coming soon">Connect Xaman</button>
      <button id="btnSession" class="btn slim" disabled title="Coming soon">Start Session</button>
    </div>
  </div>

  <header>
    <img class="banner" src="/assets/bag-slots.png" alt="BAG Slots">
    <div class="title">BAG CASINO ‚Äî SLOTS</div>
  </header>

  <!-- Live pricing -->
  <section class="ticker" aria-label="Live Pricing">
    <div class="tick"><small>XRP / USD</small><strong id="xrpUsd">‚Äî</strong></div>
    <div class="tick"><small>BAG / XRP</small><strong id="bagXrp">‚Äî</strong></div>
    <div class="tick"><small>BAG / USD</small><strong id="bagUsd">‚Äî</strong></div>
    <div class="tick"><small>Updated</small><strong id="pxTime">‚Äî</strong><span id="pxDemo" class="demoTag"></span></div>
  </section>

  <main class="stage">
    <section class="cabinet" aria-label="BAG Slots Machine">
      <div class="top-arch">$BAG SLOTS</div>

      <div class="reels" id="reels">
        <div class="reel"><div class="strip" data-col="0"></div></div>
        <div class="reel"><div class="strip" data-col="1"></div></div>
        <div class="reel"><div class="strip" data-col="2"></div></div>
        <canvas id="confetti" class="confetti"></canvas>
        <div class="win-overlay" id="winOverlay"><div class="badge" id="winBadge">WIN! üéâ</div></div>
      </div>

      <!-- BIG SPIN under the rows -->
      <div class="spinBigWrap">
        <button id="spin" class="btn spinBig">SPIN</button>
      </div>

      <!-- Controls -->
      <div class="panel">
        <div class="display">
          <strong>Balance</strong>
          <div id="bal">‚Äî</div>
          <span class="usd" id="balUsd">‚Äî</span>
        </div>

        <div class="display">
          <strong>Bet</strong>
          <div style="display:flex;gap:8px;justify-content:center;align-items:center">
            <button id="betDown" class="btn" aria-label="Decrease bet">‚Äì</button>
            <span id="betVal">10</span>
            <button id="betUp" class="btn" aria-label="Increase bet">+</button>
          </div>
          <span class="usd" id="betUsd">‚Äî</span>
        </div>

        <div class="display">
          <strong>Currency</strong>
          <div role="group" aria-label="Currency" style="display:flex;gap:8px;justify-content:center;">
            <button id="curBAG" class="btn" style="padding:8px 12px">BAG</button>
            <button id="curXRP" class="btn" style="padding:8px 12px;opacity:.85">XRP</button>
          </div>
        </div>

        <!-- MISSING BEFORE: Win box (fixes JS error so spin works) -->
        <div class="display">
          <strong>Win</strong>
          <div id="win">0</div>
          <span class="usd" id="winUsd">‚Äî</span>
        </div>
      </div>
    </section>
  </main>

  <!-- How it plays -->
  <section class="section">
    <article class="card" aria-labelledby="howTitle">
      <h3 id="howTitle">How it plays</h3>
      <ol style="margin:0 0 8px 20px;padding:0;line-height:1.6">
        <li>Select currency: <strong>BAG</strong> or <strong>XRP</strong>.</li>
        <li>Set your <strong>Bet</strong> and press <strong>SPIN</strong>.</li>
        <li>There are <strong>3 paylines</strong> (the horizontal rows). Multiple line wins add together.</li>
        <li>Match three of a kind on a payline to get a payout.</li>
      </ol>
      <div class="muted">Pricing displays BAG‚ÜîXRP‚ÜîUSD in real time. Demo odds are used until backend is wired.</div>
    </article>
  </section>

  <!-- Payouts -->
  <section class="section">
    <article class="card" aria-labelledby="payoutTitle">
      <h3 id="payoutTitle">Payouts</h3>
      <div class="paygrid">
        <div class="payhead">Paylines</div><div>3 (horizontal rows)</div>
        <div class="payhead">Stacking</div><div>Multiple line wins add together</div>
      </div>
      <div class="paygrid" style="margin-top:10px">
        <div class="payhead">7Ô∏è‚É£ Jackpot</div><div>2√ó bet</div>
        <div class="payhead">üíé Win</div><div>1.25√ó bet</div>
        <div class="payhead">ü™ô Scratch</div><div>1.0√ó bet (push)</div>
      </div>
      <div class="muted">Example @ 100 bet ‚Üí Jackpot: 200 ‚Ä¢ Win: 125 ‚Ä¢ Scratch: 100</div>
    </article>
  </section>

  <!-- Readouts -->
  <section class="readouts" aria-label="Results">
    <div class="card"><h5>Last Result</h5><div id="lastResult">‚Äî</div></div>
    <div class="card"><h5>Multiplier</h5><div id="lastMult">‚Äî</div></div>
    <div class="card"><h5>Profit</h5><div id="lastProfit">‚Äî</div></div>
  </section>

  <footer>¬© BAG Casino</footer>

  <!-- Sounds -->
  <audio id="sSpin" preload="auto" src="/assets/audio/spin.mp3" loop></audio>
  <audio id="sWin"  preload="auto" src="/assets/audio/win.mp3"></audio>
  <audio id="sLose" preload="auto" src="/assets/audio/lose.mp3"></audio>

<script type="module">
(function(){
  // ---------- CONFIG ----------
  const ENDPOINTS = {
    xrpUsd: 'https://api.coingecko.com/api/v3/simple/price?ids=ripple&vs_currencies=usd',
    bagSpot: 'https://api.getthebag.io/bag-price.json'
  };

  // ---------- Symbols (emoji) ----------
  const SYM = ["7Ô∏è‚É£","üíé","ü™ô","üëú","‚ñ¨","üçí"]; // fillers + pay
  const PAY_SYMS=["ü™ô","üíé","7Ô∏è‚É£"];            // scratch common
  const PAYS    ={ "7Ô∏è‚É£":2.0, "üíé":1.25, "ü™ô":1.0 };

  // Paylines (3 horizontals only)
  const ROWS = [
    [[0,0],[0,1],[0,2]],
    [[1,0],[1,1],[1,2]],
    [[2,0],[2,1],[2,2]],
  ];

  // ---------- DOM refs ----------
  const strips=[...document.querySelectorAll('.strip')];
  const spinBtn=document.getElementById('spin');
  const betUp=document.getElementById('betUp'), betDown=document.getElementById('betDown');
  const curBAG=document.getElementById('curBAG'), curXRP=document.getElementById('curXRP');

  const balEl=document.getElementById('bal'), betEl=document.getElementById('betVal'), winEl=document.getElementById('win');
  const balUsdEl=document.getElementById('balUsd'), betUsdEl=document.getElementById('betUsd'), winUsdEl=document.getElementById('winUsd');

  const lastResult=document.getElementById('lastResult'), lastMult=document.getElementById('lastMult'), lastProfit=document.getElementById('lastProfit');
  const overlay=document.getElementById('winOverlay'), badge=document.getElementById('winBadge'); const cabinet=document.querySelector('.cabinet');

  const xrpUsdEl=document.getElementById('xrpUsd'), bagXrpEl=document.getElementById('bagXrp'), bagUsdEl=document.getElementById('bagUsd'), pxTimeEl=document.getElementById('pxTime'), pxDemoEl=document.getElementById('pxDemo');
  const ariaLive=document.getElementById('ariaLive');

  // Sounds + unlock (mobile autoplay policies)
  const sSpin=document.getElementById('sSpin'),
        sWin=document.getElementById('sWin'),
        sScratch=document.getElementById('sScratch'),
        sLose=document.getElementById('sLose');
  [sSpin,sWin,sScratch,sLose].forEach(a=>{ a.muted=true; a.volume=1; });
  sSpin.volume = 0.35; sWin.volume = 0.9; sScratch.volume = 0.7; sLose.volume = 0.55;

  const unlockAudio=()=>{
    [sSpin,sWin,sScratch,sLose].forEach(a=>{
      try{ a.muted=false; a.play().then(()=>a.pause()).catch(()=>{});}catch(e){}
    });
    window.removeEventListener('pointerdown',unlockAudio);
  };
  window.addEventListener('pointerdown',unlockAudio,{once:true});

  // ---------- State ----------
  let balance=10000, currency='BAG';
  let prices={xrpUsd:null, bagXrp:null, bagUsd:null};
  const CELL_H=93;

  // ---------- Reels (visible immediately) ----------
  const makeCell=s=>{const d=document.createElement('div'); d.className='cell'; d.textContent=s; return d;};
  const fillStrip=(strip,arr)=>{strip.innerHTML=''; arr.forEach(s=>strip.appendChild(makeCell(s)));};

  function initReelsVisible(){
    const starter=["üçí","‚ñ¨","ü™ô"]; // placeholders so nothing looks blank
    for(const strip of strips){ fillStrip(strip, starter); strip.style.transition='none'; strip.style.transform='translateY(0)'; }
    requestAnimationFrame(()=>{ for(const strip of strips){ strip.style.transition='transform 2800ms cubic-bezier(.07,.95,.05,1)'; }});
  }
  if (document.readyState === 'complete' || document.readyState === 'interactive') initReelsVisible();
  else window.addEventListener('load', initReelsVisible);

  // ---------- Pricing ----------
  const fmt=n=>(n==null)?'‚Äî':(Math.abs(n)>=1?n.toFixed(2):n.toFixed(6));
  const fmtUsd=n=>(n==null)?'‚Äî':'$'+(Math.abs(n)>=1?n.toFixed(2):n.toFixed(6));

  function setCurrency(cur){ currency=cur; curBAG.style.opacity=cur==='BAG'?1:.85; curXRP.style.opacity=cur==='XRP'?1:.85; renderUsd(); }
  curBAG.onclick=()=>setCurrency('BAG'); curXRP.onclick=()=>setCurrency('XRP');

  const setBet=v=>{ v=Math.max(1,Math.min(2000,v|0)); betEl.textContent=v; renderUsd(); };
  betUp.onclick=()=>setBet((+betEl.textContent)+10);
  betDown.onclick=()=>setBet((+betEl.textContent)-10);

  balEl.textContent=balance; setCurrency('BAG'); setBet(10);

  async function withTimeout(promise,ms=4000){let t;const timeout=new Promise((_,rej)=>t=setTimeout(()=>rej(new Error('timeout')),ms));try{return await Promise.race([promise,timeout]);}finally{clearTimeout(t);}}
  async function fetchXrpUsd(){const r=await withTimeout(fetch(ENDPOINTS.xrpUsd,{cache:'no-store'}));const j=await r.json();return j?.ripple?.usd ?? null;}
  async function fetchBagSpot(){
    const r=await withTimeout(fetch(ENDPOINTS.bagSpot,{cache:'no-store'}));
    const j=await r.json();
    if(j && typeof j.price_xrp==='number')return j.price_xrp;
    if(j && typeof j.bag_per_xrp==='number' && j.bag_per_xrp>0)return 1/j.bag_per_xrp;
    return null;
  }
  async function refreshPrices(){
    let demo=false;
    try{
      const [xusd,bxx]=await Promise.allSettled([fetchXrpUsd(),fetchBagSpot()]);
      if(xusd.status==='fulfilled'&&xusd.value)prices.xrpUsd=xusd.value; else demo=true;
      if(bxx.status==='fulfilled'&&bxx.value)prices.bagXrp=bxx.value; else demo=true;
      if(!prices.xrpUsd||!prices.bagXrp){demo=true;prices.xrpUsd=prices.xrpUsd??0.55;prices.bagXrp=prices.bagXrp??0.000002;}
      prices.bagUsd=prices.bagXrp*prices.xrpUsd;
      xrpUsdEl.textContent=fmt(prices.xrpUsd);
      bagXrpEl.textContent=fmt(prices.bagXrp);
      bagUsdEl.textContent=fmt(prices.bagUsd);
      pxTimeEl.textContent=new Date().toLocaleTimeString();
      pxDemoEl.textContent=demo?'(demo)':'';
      renderUsd();
    }catch(e){
      prices={xrpUsd:0.55,bagXrp:0.000002,bagUsd:0.55*0.000002};
      xrpUsdEl.textContent=fmt(prices.xrpUsd);
      bagXrpEl.textContent=fmt(prices.bagXrp);
      bagUsdEl.textContent=fmt(prices.bagUsd);
      pxTimeEl.textContent=new Date().toLocaleTimeString();
      pxDemoEl.textContent='(demo)';
      renderUsd();
    }
  }
  function renderUsd(){
    const bet=+betEl.textContent;
    let betUsd='‚Äî',balUsd='‚Äî',winUsd='‚Äî';
    if(currency==='BAG'&&prices.bagUsd){
      betUsd=fmtUsd(bet*prices.bagUsd); balUsd=fmtUsd(balance*prices.bagUsd); winUsd=fmtUsd((+winEl.textContent||0)*prices.bagUsd);
    }else if(currency==='XRP'&&prices.xrpUsd){
      betUsd=fmtUsd(bet*prices.xrpUsd); balUsd=fmtUsd(balance*prices.xrpUsd); winUsd=fmtUsd((+winEl.textContent||0)*prices.xrpUsd);
    }
    betUsdEl.textContent=betUsd; balUsdEl.textContent=balUsd; winUsdEl.textContent=winUsd;
  }
  refreshPrices(); setInterval(refreshPrices,30000);

  // ---------- Demo server now returns winning line + symbol ----------
  function demoServer(stake){
    const rng=()=>SYM[(Math.random()*SYM.length)|0];
    const winSpin=Math.random()<0.495;
    if(winSpin){
      const weights=[18,7,2]; // ü™ô, üíé, 7Ô∏è‚É£
      const tot=weights.reduce((a,b)=>a+b,0);
      let r=Math.random()*tot, idx=0;
      for(let i=0;i<weights.length;i++){ if((r-=weights[i])<=0){ idx=i; break; } }
      const sym=PAY_SYMS[idx];
      const line=(Math.random()*ROWS.length)|0;
      const g=[[rng(),rng(),rng()],[rng(),rng(),rng()],[rng(),rng(),rng()]];
      const set3=(a,b,c)=>{g[a[0]][a[1]]=sym; g[b[0]][b[1]]=sym; g[c[0]][c[1]]=sym;};
      set3(...ROWS[line]);
      return {result:g,totalPayout:PAYS[sym]*stake,stake, winLine:line, winSymbol:sym};
    }else{
      // ensure no paying 3-in-row
      let tries=0;
      while(true){
        const rng2=()=>SYM[(Math.random()*SYM.length)|0];
        const g=[[rng2(),rng2(),rng2()],[rng2(),rng2(),rng2()],[rng2(),rng2(),rng2()]];
        let paying=false;
        for(const L of ROWS){
          const [a,b,c]=L, sA=g[a[0]][a[1]];
          if(sA===g[b[0]][b[1]] && sA===g[c[0]][c[1]] && PAYS[sA]){ paying=true; break; }
        }
        if(!paying || tries++>20) return {result:g,totalPayout:0,stake, winLine:null, winSymbol:null};
      }
    }
  }

  // ---------- Highlight helpers (Dice-like feedback) ----------
  function clearHighlights(){
    for(const strip of strips){ [...strip.children].forEach(cell=>cell.classList.remove('win','scratch')); }
  }
  function highlightWinLine(lineIdx, type){
    if(lineIdx==null) return;
    const coords = ROWS[lineIdx]; // 3 coords
    coords.forEach(([row, col])=>{
      const cell = strips[col].children[row];
      if(cell){ cell.classList.add(type==='scratch' ? 'scratch' : 'win'); }
    });
  }
  function popReadouts(){ [lastResult,lastMult,lastProfit].forEach(el=>{ el.classList.remove('read-pop'); void el.offsetWidth; el.classList.add('read-pop'); }); }

  // ---------- Confetti ----------
  const confettiCanvas = document.getElementById('confetti');
  const ctx = confettiCanvas.getContext('2d');
  function fitConfetti(){ const r = confettiCanvas.getBoundingClientRect(); confettiCanvas.width = r.width * devicePixelRatio; confettiCanvas.height = r.height * devicePixelRatio; }
  new ResizeObserver(fitConfetti).observe(confettiCanvas); fitConfetti();

  function runConfetti(burst=80){
    const W=confettiCanvas.width, H=confettiCanvas.height;
    const parts = Array.from({length:burst}, ()=>({
      x: Math.random()*W, y: -20, vy: 2+Math.random()*3, vx: (Math.random()-.5)*2,
      s: 4+Math.random()*6, r: Math.random()*Math.PI, vr:(Math.random()-.5)*0.2,
      c: Math.random()>.5 ? '#f2c76b' : '#ffdfa0'
    }));
    let t=0, raf;
    function step(){
      ctx.clearRect(0,0,W,H);
      for(const p of parts){
        p.vy += 0.06; p.x+=p.vx; p.y+=p.vy; p.r+=p.vr;
        ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.r);
        ctx.fillStyle=p.c; ctx.fillRect(-p.s/2,-p.s/2,p.s,p.s);
        ctx.restore();
      }
      t++;
      if(t<120) raf=requestAnimationFrame(step); else ctx.clearRect(0,0,W,H);
    }
    cancelAnimationFrame(raf); step();
  }

  // ---------- Animation ----------
  async function animateToGrid(rows){
    const cols=[0,1,2].map(ci=>[rows[0][ci],rows[1][ci],rows[2][ci]]);
    const fillerLen=16; // longer spin
    await Promise.all(cols.map((colSyms,ci)=>new Promise(resolve=>{
      const strip=strips[ci];
      const filler=Array.from({length:fillerLen},_=>SYM[(Math.random()*SYM.length)|0]);
      const stack=[...filler,...colSyms];
      fillStrip(strip,stack);
      const total=(stack.length-3)*CELL_H;
      requestAnimationFrame(()=>{
        strip.style.transform=`translateY(-${total}px)`;
        strip.addEventListener('transitionend',()=>{
          fillStrip(strip,colSyms);
          strip.style.transition='none'; strip.style.transform='translateY(0)';
          strip.getBoundingClientRect(); strip.style.transition='transform 2800ms cubic-bezier(.07,.95,.05,1)';
          resolve();
        },{once:true});
      });
    })));
  }

  // ---------- Spin flow ----------
  spinBtn.addEventListener('click', async ()=>{
    const stake=+betEl.textContent;
    spinBtn.disabled=true; winEl.textContent='‚Ä¶';
    overlay.classList.remove('show'); badge.classList.remove('pop'); cabinet.classList.remove('win-glow','shake');
    clearHighlights();

    try{
      // spin loop sound
      sSpin.currentTime=0; sSpin.loop=true; sSpin.play().catch(()=>{});

      // DEMO spin (replace with backend if needed)
      const data = demoServer(stake);

      // animate reels
      await animateToGrid(data.result);

      // stop loop
      try{ sSpin.pause(); sSpin.currentTime=0; }catch(_){}

      const payout=data.totalPayout||0;
      winEl.textContent=payout;

      const mult=stake? (payout/stake) : 0;
      lastResult.textContent=(mult>1)?'Win ‚úÖ':(mult===1?'Scratch ‚è∏Ô∏è':'Lose ‚ùå');
      lastMult.textContent=mult?`${mult.toFixed(2)}√ó`:'0√ó';
      lastProfit.textContent=(payout-stake).toString();
      popReadouts();

      // celebrations aligned with Dice:
      if(mult>1){
        // WIN / JACKPOT
        badge.textContent=(mult>=2)?'JACKPOT! üéâ':'WIN! üéâ';
        overlay.classList.add('show'); badge.classList.add('pop');
        cabinet.classList.add('win-glow'); if(mult>=2) cabinet.classList.add('shake');
        highlightWinLine(data.winLine, 'win');
        sWin.currentTime=0; sWin.play().catch(()=>{});
        runConfetti(mult>=2 ? 140 : 80);
        setTimeout(()=>overlay.classList.remove('show'), 1400);
        setTimeout(()=>{ cabinet.classList.remove('win-glow','shake'); clearHighlights(); }, 1600);
      }else if(mult===1){
        // SCRATCH (push)
        badge.textContent='SCRATCH';
        overlay.classList.add('show'); badge.classList.add('pop');
        cabinet.classList.add('win-glow');
        highlightWinLine(data.winLine, 'scratch');
        sScratch.currentTime=0; sScratch.play().catch(()=>{});
        setTimeout(()=>overlay.classList.remove('show'), 900);
        setTimeout(()=>{ cabinet.classList.remove('win-glow'); clearHighlights(); }, 1000);
      }else{
        // LOSE
        sLose.currentTime=0; sLose.play().catch(()=>{});
      }

      // ARIA live feedback
      ariaLive.textContent = (mult>1) ? `Win, multiplier ${mult.toFixed(2)} times`
        : (mult===1 ? 'Scratch, push' : 'No win');

      balance = balance - stake + payout;
      balEl.textContent = balance; renderUsd();

    }catch(e){
      console.error(e);
      try{ sSpin.pause(); sSpin.currentTime=0; }catch(_){}
    }finally{
      spinBtn.disabled=false;
    }
  });

  // expose for quick QA
  window.__slotsDemoSpin = ()=>document.getElementById('spin').click();
})();
</script>

</body>
</html>
