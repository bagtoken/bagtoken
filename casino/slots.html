<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<!-- Prevent mobile zoom & keep text sizes stable -->
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="format-detection" content="telephone=no">
<title>BAG Slots</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f0b07; --wood:#2a1a10; --gold:#d7a646; --gold-2:#f2c76b;
    --muted:#7a6a58; --win:#22c55e; --lose:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%; -webkit-text-size-adjust:100%}
  body{
    margin:0;
    background:radial-gradient(1400px 800px at 50% 0%, #1d120a 0%, var(--bg) 60%) fixed;
    color:#f6eddc;
    font-family:Inter,system-ui,Arial,sans-serif;
    display:flex;flex-direction:column;align-items:center
  }
  button,[role="button"],a.btn{touch-action:manipulation;font-size:16px}

  /* Header + Banner */
  header{width:min(1120px,94vw);margin:14px 0 10px;text-align:center}
  .banner{width:100%;border-radius:14px;display:block;box-shadow:0 16px 60px rgba(0,0,0,.45)}
  .title{font-weight:800;letter-spacing:.06em;font-size:clamp(22px,4.6vw,40px);
         text-shadow:0 0 14px rgba(242,199,107,.45), 0 0 2px #000;
         color:transparent;background:linear-gradient(#f8d78a,#e9b751);
         -webkit-background-clip:text;background-clip:text;margin:10px 0 0}

  /* Back to Casino — EXACT Dice button style, centered */
  .cta-row{width:min(1120px,94vw);display:flex;justify-content:center;margin:10px 0 8px}
  .btn{
    background:linear-gradient(180deg,#f2c76b,#d7a646);color:#2a1a10;
    font-weight:800;border:none;border-radius:12px;padding:12px 22px;
    box-shadow:0 6px 0 #7f5a20, 0 10px 32px rgba(242,199,107,.25);
    cursor:pointer;transition:transform .05s;text-decoration:none;display:inline-flex;align-items:center;gap:8px
  }
  .btn:active{transform:translateY(1px)}
  .btn[disabled]{opacity:.5;cursor:not-allowed;box-shadow:none}

  /* Live pricing bar */
  .ticker{
    width:min(1120px,94vw);display:grid;grid-template-columns:repeat(4,1fr);
    gap:12px;margin:6px 0 16px
  }
  .tick{background:#16100b;border:1px solid #3a2a1a;border-radius:12px;padding:10px 12px;text-align:center}
  .tick small{display:block;opacity:.75}
  .tick strong{display:block;font-size:18px;margin-top:4px}
  .demoTag{font-size:11px;opacity:.7}

  /* Stage — hard-centered */
  .stage{width:min(980px,94vw);margin:6px auto 24px auto;display:flex;justify-content:center;align-items:flex-end}
  .cabinet{
    width:min(800px,100%); margin:0 auto;
    background:linear-gradient(180deg,#3c2818,#1c120b);
    border:8px solid #4b311a;border-radius:18px;padding:22px;position:relative;
    box-shadow:0 26px 120px rgba(0,0,0,.65), inset 0 0 0 1px rgba(255,255,255,.05)
  }
  .cabinet.win-glow{box-shadow:0 0 0 3px rgba(242,199,107,.5), 0 60px 160px rgba(242,199,107,.45), inset 0 0 0 1px rgba(255,255,255,.05)}
  .top-arch{
    text-align:center;padding:12px 0 8px;margin-bottom:12px;border-radius:12px;
    background:linear-gradient(180deg,#4b331d,#2d1c10);
    color:var(--gold-2);font-weight:800;letter-spacing:.08em
  }

  /* Reels (longer spin) */
  .reels{
    display:grid;grid-template-columns:repeat(3,1fr);gap:16px;
    background:#130d08;border:3px solid #44301d;border-radius:12px;padding:16px;overflow:hidden;position:relative
  }
  .reel{height:280px;border-radius:12px;background:linear-gradient(180deg,#24160e,#0d0805);
        position:relative;overflow:hidden;border:1px solid #3a2818}
  .strip{position:absolute;left:0;right:0;top:0;transition:transform 2600ms cubic-bezier(.07,.95,.05,1)}
  .cell{
    height:93px;display:flex;align-items:center;justify-content:center;
  }
  .cell svg{width:64px;height:64px;filter:drop-shadow(0 2px 0 rgba(0,0,0,.8)) drop-shadow(0 0 12px rgba(242,199,107,.2))}
  .sym-seven svg{width:72px}
  .sym-bar svg{width:84px;height:36px}

  /* Win overlay */
  .win-overlay{
    position:absolute;inset:0;display:none;align-items:center;justify-content:center;
    background:radial-gradient(800px 400px at 50% 50%, rgba(242,199,107,.18), transparent 60%);
    pointer-events:none
  }
  .win-overlay.show{display:flex}
  .badge{
    font-weight:900;font-size:44px;letter-spacing:.08em;padding:12px 18px;border-radius:14px;
    color:#1c130a;background:linear-gradient(180deg,#ffe6a8,#eac070);box-shadow:0 8px 40px rgba(242,199,107,.35)
  }

  /* Control panel — responsive, no overflow */
  .panel{
    margin-top:16px;
    display:grid;
    grid-template-columns: repeat(5, minmax(180px, 1fr));
    gap:14px; align-items:center
  }
  @media (max-width: 980px){ .panel{ grid-template-columns: repeat(3, minmax(180px, 1fr)); } }
  @media (max-width: 620px){ .panel{ grid-template-columns: 1fr; } }

  .display{ background:#16100b;border:1px solid #3a2a1a;border-radius:12px;padding:12px;text-align:center; overflow-wrap:anywhere }
  .usd{display:block;opacity:.78;font-size:12px;margin-top:4px}

  /* Drawer */
  .drawer-wrap{position:relative;justify-self:end}
  .drawer{
    position:absolute;right:0;top:100%;margin-top:8px;background:#15100b;border:1px solid #3a2a1a;border-radius:12px;
    box-shadow:0 16px 70px rgba(0,0,0,.5);padding:12px;min-width:360px;display:none;z-index:10
  }
  .drawer.open{display:block}
  .drawer h4{margin:4px 0 8px 0}
  .drawer table{width:100%;border-collapse:collapse;font-size:14px}
  .drawer th,.drawer td{padding:6px 4px;border-bottom:1px solid #2b2118;text-align:left}
  .drawer th{color:#f2c76b}
  .note{font-size:12px;opacity:.85;margin-top:6px}

  /* Readouts */
  .readouts{width:min(980px,94vw);display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:8px 0 20px}
  .card{background:#16100b;border:1px solid #3a2a1a;border-radius:12px;padding:12px}
  .card h5{margin:0 0 6px 0;color:#f2c76b}

  footer{opacity:.6;font-size:12px;margin:12px 0 24px}
</style>
</head>
<body>
  <header>
    <img class="banner" src="/assets/bag-slots.png" alt="BAG Slots">
    <div class="title">BAG CASINO — SLOTS</div>
  </header>

  <!-- Back to Casino (Dice-style button, centered) -->
  <div class="cta-row">
    <a class="btn" href="/casino/index.html">Back to Casino</a>
  </div>

  <!-- Live pricing -->
  <section class="ticker" aria-label="Live Pricing">
    <div class="tick"><small>XRP / USD</small><strong id="xrpUsd">—</strong></div>
    <div class="tick"><small>BAG / XRP</small><strong id="bagXrp">—</strong></div>
    <div class="tick"><small>BAG / USD</small><strong id="bagUsd">—</strong></div>
    <div class="tick"><small>Updated</small><strong id="pxTime">—</strong><span id="pxDemo" class="demoTag"></span></div>
  </section>

  <main class="stage">
    <section class="cabinet" aria-label="BAG Slots Machine">
      <div class="top-arch">BAG SLOTS</div>

      <div class="reels" id="reels">
        <div class="reel"><div class="strip" data-col="0"></div></div>
        <div class="reel"><div class="strip" data-col="1"></div></div>
        <div class="reel"><div class="strip" data-col="2"></div></div>
        <div class="win-overlay" id="winOverlay"><div class="badge" id="winBadge">WIN!</div></div>
      </div>

      <!-- Control panel -->
      <div class="panel">
        <div class="display">
          <strong>Balance</strong>
          <div id="bal">—</div>
          <span class="usd" id="balUsd">—</span>
        </div>

        <div class="display">
          <strong>Bet</strong>
          <div style="display:flex;gap:8px;justify-content:center;align-items:center">
            <button id="betDown" class="btn" aria-label="Decrease bet">–</button>
            <span id="betVal">10</span>
            <button id="betUp" class="btn" aria-label="Increase bet">+</button>
          </div>
          <span class="usd" id="betUsd">—</span>
        </div>

        <div class="display">
          <strong>Currency</strong>
          <div role="group" aria-label="Currency" style="display:flex;gap:8px;justify-content:center;">
            <button id="curBAG" class="btn" style="padding:8px 12px">BAG</button>
            <button id="curXRP" class="btn" style="padding:8px 12px;opacity:.85">XRP</button>
          </div>
        </div>

        <div class="drawer-wrap">
          <button id="paytableBtn" class="btn" aria-expanded="false" aria-controls="paytable">Payouts</button>
          <div id="paytable" class="drawer" role="dialog" aria-label="Payout Table">
            <h4>Paylines</h4>
            <div class="note">5 lines: 3 horizontals + 2 diagonals. Multiple wins add together.</div>
            <h4 style="margin-top:10px">Payouts (3-in-line)</h4>
            <table>
              <thead><tr><th>Symbol</th><th>× Bet</th></tr></thead>
              <tbody>
                <tr><td>777</td><td>10×</td></tr>
                <tr><td>Diamond</td><td>6×</td></tr>
                <tr><td>BAG coin</td><td>4×</td></tr>
                <tr><td>Duffle</td><td>3×</td></tr>
                <tr><td>Bar</td><td>2×</td></tr>
                <tr><td>Cherry</td><td>1×</td></tr>
              </tbody>
            </table>
            <div class="note">Labels use BAG and XRP (no $ prefix). Payouts are multipliers on your bet.</div>
          </div>
        </div>

        <!-- SPIN BUTTON -->
        <button id="spin" class="btn" style="justify-self:center;min-width:180px">SPIN</button>

        <div class="display">
          <strong>Win</strong>
          <div id="win">0</div>
          <span class="usd" id="winUsd">—</span>
        </div>
      </div>
    </section>
  </main>

  <!-- Readouts -->
  <section class="readouts" aria-label="Results">
    <div class="card"><h5>Last Result</h5><div id="lastResult">—</div></div>
    <div class="card"><h5>Multiplier</h5><div id="lastMult">—</div></div>
    <div class="card"><h5>Profit</h5><div id="lastProfit">—</div></div>
  </section>

  <footer>© BAG Casino</footer>

  <!-- Sounds -->
  <audio id="sSpin" preload="auto" src="/assets/audio/spin.mp3" loop></audio>
  <audio id="sWin"  preload="auto" src="/assets/audio/win.mp3"></audio>
  <audio id="sLose" preload="auto" src="/assets/audio/lose.mp3"></audio>

<script type="module">
  // -------------------- CONFIG: pricing endpoints --------------------
  const ENDPOINTS = {
    xrpUsd: 'https://api.coingecko.com/api/v3/simple/price?ids=ripple&vs_currencies=usd',
    // Must return either { "price_xrp": <XRP per 1 BAG> } OR { "bag_per_xrp": <BAG per 1 XRP> }
    bagSpot: 'https://api.getthebag.io/bag-price.json'
  };

  // -------------------- SVG ICONS --------------------
  const svg = {
    SEVEN: () => `
      <svg viewBox="0 0 120 90" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <defs>
          <linearGradient id="g7a" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0" stop-color="#ff805f"/><stop offset="1" stop-color="#ff4a2f"/>
          </linearGradient>
          <linearGradient id="g7b" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="#ffd6c9" stop-opacity=".9"/><stop offset="1" stop-color="#ffbdad" stop-opacity=".0"/>
          </linearGradient>
        </defs>
        <g filter="url(#f0)">
          <path d="M25 18h70l-40 58h-26l34-49H25z" fill="url(#g7a)" stroke="#5d0b00" stroke-width="4" />
          <path d="M25 18h70" stroke="url(#g7b)" stroke-width="6" opacity=".6"/>
        </g>
      </svg>`,
    DIAMOND: () => `
      <svg viewBox="0 0 90 90" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <defs>
          <linearGradient id="gd1" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="#d9f7ff"/><stop offset="1" stop-color="#7dd3fc"/>
          </linearGradient>
        </defs>
        <polygon points="45,8 82,45 45,82 8,45" fill="url(#gd1)" stroke="#1b3a4d" stroke-width="4"/>
        <path d="M45 8 L45 82 M8 45 L82 45" stroke="#eafaff" stroke-opacity=".6" stroke-width="3"/>
      </svg>`,
    BAGCOIN: () => `
      <svg viewBox="0 0 96 96" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <defs>
          <radialGradient id="gc1" cx=".35" cy=".3" r=".8">
            <stop offset="0" stop-color="#ffe8a9"/><stop offset="1" stop-color="#d7a646"/>
          </radialGradient>
        </defs>
        <circle cx="48" cy="48" r="40" fill="url(#gc1)" stroke="#7f5a20" stroke-width="6"/>
        <circle cx="48" cy="48" r="30" fill="none" stroke="#a57a33" stroke-width="5"/>
        <text x="48" y="56" font-family="Inter, system-ui" font-weight="900" font-size="28" text-anchor="middle" fill="#7f4f00" stroke="#ffdfa3" stroke-width="1">BAG</text>
      </svg>`,
    DUFFLE: () => `
      <svg viewBox="0 0 110 80" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <defs>
          <linearGradient id="gbag" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0" stop-color="#2f4b2f"/><stop offset="1" stop-color="#19361f"/>
          </linearGradient>
        </defs>
        <rect x="12" y="26" width="86" height="42" rx="10" fill="url(#gbag)" stroke="#0b2012" stroke-width="4"/>
        <path d="M26 26c0-12 10-20 29-20s29 8 29 20" fill="none" stroke="#1a3a22" stroke-width="6"/>
        <circle cx="55" cy="36" r="10" fill="#365b37"/>
      </svg>`,
    BAR: () => `
      <svg viewBox="0 0 120 50" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <rect x="4" y="4" width="112" height="42" rx="8" fill="#403026" stroke="#1f150f" stroke-width="4"/>
        <text x="60" y="34" font-family="Inter, system-ui" font-weight="900" font-size="26" text-anchor="middle" fill="#f0dec0">BAR</text>
      </svg>`,
    CHERRY: () => `
      <svg viewBox="0 0 100 90" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <circle cx="38" cy="52" r="18" fill="#ff6d86" stroke="#671019" stroke-width="4"/>
        <circle cx="62" cy="52" r="18" fill="#ff6d86" stroke="#671019" stroke-width="4"/>
        <path d="M50 16 C62 8, 78 18, 82 30" fill="none" stroke="#2f6a2f" stroke-width="6"/>
        <ellipse cx="74" cy="30" rx="8" ry="6" fill="#2f6a2f"/>
      </svg>`
  };

  // -------------------- Symbols & mapping --------------------
  const SYM = ["SEVEN","DIAMOND","BAGCOIN","DUFFLE","BAR","CHERRY"];
  const symToClass = { SEVEN:'sym-seven', DIAMOND:'sym-diamond', BAGCOIN:'sym-bagcoin', DUFFLE:'sym-duffle', BAR:'sym-bar', CHERRY:'sym-cherry' };

  // DOM refs
  const strips = [...document.querySelectorAll('.strip')];
  const spinBtn = document.getElementById('spin');
  const betUp=document.getElementById('betUp'), betDown=document.getElementById('betDown');
  const curBAG=document.getElementById('curBAG'), curXRP=document.getElementById('curXRP');
  const payBtn=document.getElementById('paytableBtn'), drawer=document.getElementById('paytable');

  const balEl=document.getElementById('bal'), betEl=document.getElementById('betVal'), winEl=document.getElementById('win');
  const balUsdEl=document.getElementById('balUsd'), betUsdEl=document.getElementById('betUsd'), winUsdEl=document.getElementById('winUsd');

  const lastResult=document.getElementById('lastResult'), lastMult=document.getElementById('lastMult'), lastProfit=document.getElementById('lastProfit');
  const overlay=document.getElementById('winOverlay'), badge=document.getElementById('winBadge'); const cabinet=document.querySelector('.cabinet');

  const xrpUsdEl=document.getElementById('xrpUsd'), bagXrpEl=document.getElementById('bagXrp'), bagUsdEl=document.getElementById('bagUsd'), pxTimeEl=document.getElementById('pxTime'), pxDemoEl=document.getElementById('pxDemo');

  // Audio unlock
  const sSpin=document.getElementById('sSpin'), sWin=document.getElementById('sWin'), sLose=document.getElementById('sLose');
  [sSpin,sWin,sLose].forEach(a=>a.muted=true);
  const unlockAudio = () => { [sSpin,sWin,sLose].forEach(a=>{ try{ a.muted=false; a.play().then(()=>a.pause()).catch(()=>{});}catch(e){} }); window.removeEventListener('pointerdown', unlockAudio); };
  window.addEventListener('pointerdown', unlockAudio, {once:true});

  // State
  let balance = 10000; // demo; backend should send real
  let currency = 'BAG';
  let prices = { xrpUsd:null, bagXrp:null, bagUsd:null };
  const CELL_H = 93;

  // ---- ICON cell builders ----
  const makeCell = (sym) => {
    const d=document.createElement('div');
    d.className='cell '+symToClass[sym];
    d.innerHTML = (svg[sym] ? svg[sym]() : '');
    return d;
  };
  const fillStrip = (strip, arr) => {
    strip.innerHTML=''; for(const s of arr) strip.appendChild(makeCell(s));
  };

  // Guaranteed visible reels on load
  function initReelsVisible(){
    const starter = ["CHERRY","BAR","BAGCOIN"]; // always shows something
    for(const strip of strips){
      fillStrip(strip, starter);
      strip.style.transition = 'none';
      strip.style.transform = 'translateY(0px)';
    }
    requestAnimationFrame(()=> {
      for(const strip of strips){
        strip.style.transition = 'transform 2600ms cubic-bezier(.07,.95,.05,1)';
      }
    });
  }
  window.addEventListener('load', initReelsVisible);

  // UI helpers
  const fmt = n => (n==null) ? '—' : (Math.abs(n)>=1 ? n.toFixed(2) : n.toFixed(6));
  const fmtUsd = n => (n==null) ? '—' : '$'+(Math.abs(n)>=1 ? n.toFixed(2) : n.toFixed(6));

  function setCurrency(cur){ currency=cur; curBAG.style.opacity = cur==='BAG'?1:.85; curXRP.style.opacity=cur==='XRP'?1:.85; renderUsd(); }
  curBAG.onclick = ()=> setCurrency('BAG');
  curXRP.onclick = ()=> setCurrency('XRP');

  const setBet = v => { v=Math.max(1,Math.min(2000,v|0)); betEl.textContent=v; renderUsd(); };
  betUp.onclick = ()=> setBet((+betEl.textContent)+10);
  betDown.onclick = ()=> setBet((+betEl.textContent)-10);

  balEl.textContent = balance; setCurrency('BAG'); setBet(10);

  payBtn.onclick = () => { const open=!drawer.classList.contains('open'); drawer.classList.toggle('open', open); payBtn.setAttribute('aria-expanded', open); };

  // Pricing (with robust fallback so you never see blanks)
  async function withTimeout(promise, ms=4000){ let t; const timeout=new Promise((_,rej)=>t=setTimeout(()=>rej(new Error('timeout')),ms)); try{ return await Promise.race([promise, timeout]); } finally{ clearTimeout(t); } }
  async function fetchXrpUsd(){ const r=await withTimeout(fetch(ENDPOINTS.xrpUsd,{cache:'no-store'})); const j=await r.json(); return j?.ripple?.usd ?? null; }
  async function fetchBagSpot(){
    const r=await withTimeout(fetch(ENDPOINTS.bagSpot,{cache:'no-store'}));
    const j=await r.json();
    if (j && typeof j.price_xrp==='number') return j.price_xrp;
    if (j && typeof j.bag_per_xrp==='number' && j.bag_per_xrp>0) return 1/j.bag_per_xrp;
    return null;
  }
  async function refreshPrices(){
    let demo=false;
    try{
      const [xusd,bxx] = await Promise.allSettled([fetchXrpUsd(), fetchBagSpot()]);
      if (xusd.status==='fulfilled' && xusd.value) prices.xrpUsd = xusd.value; else demo=true;
      if (bxx.status==='fulfilled' && bxx.value) prices.bagXrp = bxx.value; else demo=true;
      if (!prices.xrpUsd || !prices.bagXrp){
        demo = true;
        prices.xrpUsd = prices.xrpUsd ?? 0.55;
        prices.bagXrp = prices.bagXrp ?? 0.000002;
      }
      prices.bagUsd = prices.bagXrp * prices.xrpUsd;

      xrpUsdEl.textContent = fmt(prices.xrpUsd);
      bagXrpEl.textContent = fmt(prices.bagXrp);
      bagUsdEl.textContent = fmt(prices.bagUsd);
      pxTimeEl.textContent = new Date().toLocaleTimeString();
      pxDemoEl.textContent = demo ? '(demo)' : '';
      renderUsd();
    }catch(e){
      prices = { xrpUsd:0.55, bagXrp:0.000002, bagUsd:0.55*0.000002 };
      xrpUsdEl.textContent = fmt(prices.xrpUsd);
      bagXrpEl.textContent = fmt(prices.bagXrp);
      bagUsdEl.textContent = fmt(prices.bagUsd);
      pxTimeEl.textContent = new Date().toLocaleTimeString();
      pxDemoEl.textContent = '(demo)';
      renderUsd();
    }
  }
  function renderUsd(){
    const bet = +betEl.textContent;
    let betUsd='—', balUsd='—', winUsd='—';
    if (currency==='BAG' && prices.bagUsd){
      betUsd = fmtUsd(bet * prices.bagUsd);
      balUsd = fmtUsd(balance * prices.bagUsd);
      winUsd = fmtUsd((+winEl.textContent||0) * prices.bagUsd);
    } else if (currency==='XRP' && prices.xrpUsd){
      betUsd = fmtUsd(bet * prices.xrpUsd);
      balUsd = fmtUsd(balance * prices.xrpUsd);
      winUsd = fmtUsd((+winEl.textContent||0) * prices.xrpUsd);
    }
    betUsdEl.textContent = betUsd; balUsdEl.textContent = balUsd; winUsdEl.textContent = winUsd;
  }
  await refreshPrices(); setInterval(refreshPrices, 30000);

  // Demo RNG tuned to Dice feel (server should override)
  const DEMO_HIT_RATE = 0.495;
  const PAYS = {SEVEN:10, DIAMOND:6, BAGCOIN:4, DUFFLE:3, BAR:2, CHERRY:1};
  function demoServer(stake){
    const rng = () => SYM[Math.floor(Math.random()*SYM.length)];
    const lines = [
      [[0,0],[0,1],[0,2]], [[1,0],[1,1],[1,2]], [[2,0],[2,1],[2,2]],
      [[0,0],[1,1],[2,2]], [[2,0],[1,1],[0,2]],
    ];
    const winSpin = Math.random() < DEMO_HIT_RATE;
    if (winSpin){
      const paySyms = ["CHERRY","BAR","BAGCOIN","DUFFLE","DIAMOND","SEVEN"];
      const weights  = [40, 28, 14, 10, 5, 3];
      const pick=(arr,w)=>{const tot=w.reduce((a,b)=>a+b,0); let r=Math.random()*tot; for(let i=0;i<arr.length;i++){ if((r-=w[i])<=0) return arr[i]; } return arr.at(-1);};
      const sym = pick(paySyms,weights);
      const line = Math.floor(Math.random()*5);
      const g=[[rng(),rng(),rng()],[rng(),rng(),rng()],[rng(),rng(),rng()]];
      const set3=(a,b,c)=>{g[a[0]][a[1]]=sym; g[b[0]][b[1]]=sym; g[c[0]][c[1]]=sym;};
      set3(...lines[line]);
      return {result:g, totalPayout:PAYS[sym]*stake, stake};
    } else {
      let tries=0;
      while(true){
        const g=[[rng(),rng(),rng()],[rng(),rng(),rng()],[rng(),rng(),rng()]];
        let win=false;
        for(const L of lines){
          const [a,b,c]=L;
          if(g[a[0]][a[1]]===g[b[0]][b[1]] && g[b[0]][b[1]]===g[c[0]][c[1]]){ win=true; break; }
        }
        if(!win || tries++>20) return {result:g, totalPayout:0, stake};
      }
    }
  }

  // Animate reels to target grid (row-major)
  async function animateToGrid(rows){
    const cols = [0,1,2].map(ci => [rows[0][ci], rows[1][ci], rows[2][ci]]);
    const fillerLen = 14; // deeper stack => longer travel
    await Promise.all(cols.map((colSyms, ci)=>new Promise(resolve=>{
      const strip = strips[ci];
      const filler = Array.from({length:fillerLen}, _=> SYM[(Math.random()*SYM.length)|0]);
      const stack = [...filler, ...colSyms];
      fillStrip(strip, stack);
      const total = (stack.length - 3) * CELL_H;
      requestAnimationFrame(()=>{
        strip.style.transform = `translateY(-${total}px)`;
        strip.addEventListener('transitionend', () => {
          fillStrip(strip, colSyms);
          strip.style.transition = 'none'; strip.style.transform = `translateY(0px)`;
          strip.getBoundingClientRect(); strip.style.transition = 'transform 2600ms cubic-bezier(.07,.95,.05,1)';
          resolve();
        }, {once:true});
      });
    })));
  }

  // Spin flow
  balEl.textContent = balance;
  spinBtn.addEventListener('click', async () => {
    const stake = +betEl.textContent;
    spinBtn.disabled = true; winEl.textContent = '…';
    overlay.classList.remove('show'); cabinet.classList.remove('win-glow');

    try{
      // start looped spin audio
      sSpin.currentTime=0; sSpin.loop=true; sSpin.play().catch(()=>{});

      // server call (fallback to demo)
      const res = await fetch('/api/slots/spin', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ address: window?.wallet?.address ?? 'demo', stake, currency })
      }).catch(()=>null);
      const data = (res && res.ok) ? await res.json() : demoServer(stake);

      await animateToGrid(data.result);

      // stop spin, play result SFX
      try{ sSpin.pause(); sSpin.currentTime=0; }catch(e){}
      const payout = data.totalPayout || 0;
      winEl.textContent = payout;

      const mult = stake ? (payout / stake) : 0;
      lastResult.textContent = payout > 0 ? 'Win' : 'Lose';
      lastMult.textContent   = mult ? `${mult.toFixed(2)}×` : '0×';
      lastProfit.textContent = (payout - stake).toString();

      if (payout > 0){
        sWin.currentTime=0; sWin.play().catch(()=>{});
        cabinet.classList.add('win-glow');
        badge.textContent = mult >= 6 ? 'BIG WIN!' : 'WIN!';
        overlay.classList.add('show');
        setTimeout(()=>overlay.classList.remove('show'), 1400);
        setTimeout(()=>cabinet.classList.remove('win-glow'), 1600);
      } else {
        sLose.currentTime=0; sLose.play().catch(()=>{});
      }

      balance = data.balance ?? (balance - stake + payout);
      balEl.textContent = balance; renderUsd();

    }catch(e){
      console.error(e);
      try{ sSpin.pause(); sSpin.currentTime=0; }catch(_){}
      // graceful fallback
      const data = demoServer(+betEl.textContent);
      await animateToGrid(data.result);
      const payout = data.totalPayout;
      winEl.textContent = payout;

      const mult = payout / (+betEl.textContent || 1);
      lastResult.textContent = payout > 0 ? 'Win' : 'Lose';
      lastMult.textContent   = mult ? `${mult.toFixed(2)}×` : '0×';
      lastProfit.textContent = (payout - (+betEl.textContent||0)).toString();

      if (payout > 0){ sWin.currentTime=0; sWin.play().catch(()=>{}); }
      else { sLose.currentTime=0; sLose.play().catch(()=>{}); }

      balance = balance - data.stake + data.totalPayout;
      balEl.textContent = balance; renderUsd();
    }finally{
      spinBtn.disabled = false;
    }
  });
</script>
</body>
</html>
